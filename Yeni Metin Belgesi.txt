import os
import math
import pandas as pd
import tkinter as tk
from tkinter import filedialog, messagebox, ttk
from openpyxl import Workbook, load_workbook
from openpyxl.styles import Font, PatternFill, Border, Side, Alignment
from openpyxl.utils import get_column_letter
import re
import threading
import time
import subprocess
import sys
from PIL import Image
import shutil
import concurrent.futures
from threading import Lock
import matplotlib.pyplot as plt
from matplotlib.backends.backend_tkagg import FigureCanvasTkAgg
import matplotlib
matplotlib.use('TkAgg')
from tkcalendar import DateEntry
import piexif
import folium
import datetime
from datetime import datetime as dt
from folium.plugins import MarkerCluster



# ==============================================
# GÃ–MÃœLÃœ HARÄ°TA ANALÄ°Z EKRANI SINIFI (RaporEkrani'den Ã–NCE tanÄ±mlanmalÄ±)
# ==============================================

class GÃ¶mÃ¼lÃ¼HaritaAnalizEkrani(tk.Frame):
    def __init__(self, parent, excel_dosyasi):
        super().__init__(parent)
        self.parent = parent
        self.excel_dosyasi = excel_dosyasi
        self.qt_app = None
        self.pyqt_widget = None  # PyQt widget referansÄ±
        
        try:
            self.configure(bg="#2c3e50")
            
            # DeÄŸiÅŸkenler
            self.df_veri = None
            self.df_filtreli = None
            self.map_temp_html = None
            
            # PyQt6 kontrolÃ¼ - LAZY olarak
            self.pyqt_available = False  # BaÅŸlangÄ±Ã§ta False
            self._pyqt_checked = False  # Kontrol edildi mi?
            
            # Rapor klasÃ¶rÃ¼ ve HTML dosya yolu
            self.rapor_klasoru = self.get_rapor_klasoru()
            self.harita_html_path = os.path.join(self.rapor_klasoru, "RaporHarita.html")
            self.oncelik_toplam_var = tk.StringVar(value="0")  # YENÄ° EKLENDÄ°
            
            self.arayuz_olustur()
            self.verileri_yukle()
            
        except Exception as e:
            messagebox.showerror("Hata", f"Harita ekranÄ± oluÅŸturulamadÄ±: {str(e)}")
            import traceback
            print(f"GÃ¶mÃ¼lÃ¼HaritaAnalizEkrani hatasÄ±: {traceback.format_exc()}")
    
    def check_pyqt_availability(self):
        """PyQt6'nÄ±n kurulu olup olmadÄ±ÄŸÄ±nÄ± kontrol eder - LAZY"""
        if self._pyqt_checked:
            return self.pyqt_available
            
        try:
            import sys
            from PyQt6.QtCore import Qt, QUrl
            from PyQt6.QtWidgets import QApplication, QWidget, QVBoxLayout
            from PyQt6.QtWebEngineWidgets import QWebEngineView
            from PyQt6.QtWebEngineCore import QWebEngineSettings
            
            self.pyqt_available = True
            self._pyqt_checked = True
            return True
        except ImportError:
            self.pyqt_available = False
            self._pyqt_checked = True
            print("PyQt6 kÃ¼tÃ¼phaneleri yÃ¼klÃ¼ deÄŸil. Harita tarayÄ±cÄ±da aÃ§Ä±lacak.")
            return False
    
    def get_rapor_klasoru(self):
        """MasaÃ¼stÃ¼ndeki Rapor klasÃ¶rÃ¼nÃ¼n yolunu alÄ±r"""
        try:
            desktop_path = os.path.join(os.path.expanduser("~"), "Desktop")
            rapor_klasoru = os.path.join(desktop_path, "Rapor")
            
            if not os.path.exists(rapor_klasoru):
                os.makedirs(rapor_klasoru)
            
            return rapor_klasoru
        except:
            import tempfile
            return tempfile.gettempdir()
    
    def arayuz_olustur(self):
        """GÃ¶mÃ¼lÃ¼ harita arayÃ¼zÃ¼nÃ¼ oluÅŸturur - Filtreler ve Ä°statistikler SOLDA, Harita SAÄDA"""
        # Ana konteyner
        main_frame = tk.Frame(self, bg="#2c3e50")
        main_frame.pack(fill='both', expand=True, padx=0, pady=0)
        
        # Grid yapÄ±sÄ±: sol panel ve saÄŸ panel
        main_frame.grid_rowconfigure(0, weight=1)
        main_frame.grid_columnconfigure(0, weight=0)  # Sol panel: sabit geniÅŸlik
        main_frame.grid_columnconfigure(1, weight=1)  # SaÄŸ panel: tÃ¼m kalan alan
        
        # === SOL PANEL: Filtreler ve Ä°statistikler -
        left_panel = tk.Frame(main_frame, bg="#2c3e50", width=320) 
        left_panel.grid(row=0, column=0, sticky='ns', padx=0, pady=0)
        left_panel.grid_propagate(False)
        
        # Sol panel iÃ§inde dikey dÃ¼zen - SATIR EKLENDÄ°
        left_panel.grid_rowconfigure(0, weight=0)  # Filtreler
        left_panel.grid_rowconfigure(1, weight=0)  # Ä°statistikler
        left_panel.grid_rowconfigure(2, weight=0)  # Link Paneli - YENÄ° EKLENDÄ°
        left_panel.grid_rowconfigure(3, weight=1)  # BoÅŸluk
        
        # 1. FÄ°LTRELER FRAME - DAHA DAR
        filter_frame = tk.LabelFrame(left_panel, text="ğŸ” FÄ°LTRELER", 
                                    font=('Segoe UI', 10, 'bold'),  # YazÄ± boyutu kÃ¼Ã§Ã¼ltÃ¼ldÃ¼
                                    fg='white', bg="#34495e", padx=12, pady=12)  # Padding azaltÄ±ldÄ±
        filter_frame.grid(row=0, column=0, sticky='ew', pady=(5, 5), padx=5)
        
        # Ä°lÃ§e filtresi - KOMBOKS GENÄ°ÅLÄ°ÄÄ° DARALTILDI
        tk.Label(filter_frame, text="Ä°LÃ‡E:", font=('Segoe UI', 9, 'bold'),  # Font kÃ¼Ã§Ã¼ltÃ¼ldÃ¼
                bg="#34495e", fg='#3498db').pack(anchor='w', pady=(0, 3))  # Padding azaltÄ±ldÄ±
        
        self.ilce_var = tk.StringVar(value="TÃœMÃœ")
        self.ilce_combo = ttk.Combobox(filter_frame, textvariable=self.ilce_var, 
                                      state="readonly", width=22)  # GeniÅŸlik 25'ten 22'ye
        self.ilce_combo.pack(fill='x', pady=(0, 8))
        
        # Hat filtresi - KOMBOKS GENÄ°ÅLÄ°ÄÄ° DARALTILDI
        tk.Label(filter_frame, text="HAT ADI:", font=('Segoe UI', 9, 'bold'),
                bg="#34495e", fg='#3498db').pack(anchor='w', pady=(0, 3))
        
        self.hat_var = tk.StringVar(value="TÃœMÃœ")
        self.hat_combo = ttk.Combobox(filter_frame, textvariable=self.hat_var,
                                     state="readonly", width=22)  # GeniÅŸlik 25'ten 22'ye
        self.hat_combo.pack(fill='x', pady=(0, 8))

        # YapÄ±ldÄ± mÄ±? filtresi - KOMBOKS GENÄ°ÅLÄ°ÄÄ° DARALTILDI
        tk.Label(filter_frame, text="YAPILDI MI?:", font=('Segoe UI', 9, 'bold'),
                bg="#34495e", fg='#3498db').pack(anchor='w', pady=(0, 3))
        
        self.yapildi_var = tk.StringVar(value="TÃœMÃœ")
        self.yapildi_combo = ttk.Combobox(filter_frame, textvariable=self.yapildi_var,
                                         state="readonly", width=22)  # GeniÅŸlik 25'ten 22'ye
        self.yapildi_combo['values'] = ['TÃœMÃœ', 'YAPILDI', 'YAPILMADI']
        self.yapildi_combo.pack(fill='x', pady=(0, 10))

        
        # Harita ayarlarÄ± - DAHA KOMPAKT
        settings_frame = tk.LabelFrame(filter_frame, text="AYARLAR",
                                      font=('Segoe UI', 9, 'bold'),  # Font kÃ¼Ã§Ã¼ltÃ¼ldÃ¼
                                      bg="#2c3e50", fg='white', padx=8, pady=5)  # Padding azaltÄ±ldÄ±
        settings_frame.pack(fill='x', pady=(5, 8))
        
        self.kumelenme_var = tk.BooleanVar(value=True)
        kumelenme_check = tk.Checkbutton(settings_frame, text="NoktalarÄ± kÃ¼melenmiÅŸ gÃ¶ster",
                                        variable=self.kumelenme_var,
                                        font=('Segoe UI', 8),  # Font kÃ¼Ã§Ã¼ltÃ¼ldÃ¼
                                        bg="#2c3e50", fg='white',
                                        selectcolor="#2c3e50")
        kumelenme_check.pack(anchor='w', pady=1)
        
        self.oncelik_dagilimi_var = tk.BooleanVar(value=True)
        oncelik_check = tk.Checkbutton(settings_frame, text="Sadece Ã¶ncelikli direkleri gÃ¶ster",
                                      variable=self.oncelik_dagilimi_var,
                                      font=('Segoe UI', 8),  # Font kÃ¼Ã§Ã¼ltÃ¼ldÃ¼
                                      bg="#2c3e50", fg='white',
                                      selectcolor="#2c3e50")
        oncelik_check.pack(anchor='w', pady=1)
        
        # Butonlar - DAHA KOMPAKT
        button_frame = tk.Frame(filter_frame, bg="#34495e")
        button_frame.pack(fill='x', pady=(8, 0))
        
        tk.Button(button_frame, text="ğŸ” FÄ°LTRELE", 
                 command=self.filtrele,
                 bg="#27ae60", fg='white', font=('Segoe UI', 9, 'bold'),  # Font kÃ¼Ã§Ã¼ltÃ¼ldÃ¼
                 height=1).pack(side='left', fill='x', expand=True, padx=(0, 2))  # Height 2'den 1'e
        
        tk.Button(button_frame, text="ğŸ”„ SIFIRLA", 
                 command=self.filtreleri_sifirla,
                 bg="#e74c3c", fg='white', font=('Segoe UI', 9, 'bold'),
                 height=1).pack(side='left', fill='x', expand=True, padx=2)
        
        # 2. Ä°STATÄ°STÄ°KLER FRAME - DAHA KOMPAKT
        stat_frame = tk.LabelFrame(left_panel, text="ğŸ“Š Ä°STATÄ°STÄ°KLER", 
                                  font=('Segoe UI', 10, 'bold'),  # Font kÃ¼Ã§Ã¼ltÃ¼ldÃ¼
                                  fg='white', bg="#34495e", padx=8, pady=8)  # Padding azaltÄ±ldÄ±
        stat_frame.grid(row=1, column=0, sticky='ew', pady=(0, 5), padx=5)
        
        # Ä°statistik grid
        stats_grid = tk.Frame(stat_frame, bg="#34495e")
        stats_grid.pack(fill='x')
        
        # Grid yapÄ±sÄ±
        for i in range(11):
            stats_grid.grid_rowconfigure(i, weight=0)
        stats_grid.grid_columnconfigure(0, weight=1)
        stats_grid.grid_columnconfigure(1, weight=0)
        
        row = 0
        
        # Genel Ä°statistikler
        tk.Label(stats_grid, text="GENEL Ä°STATÄ°STÄ°KLER", 
                font=('Segoe UI', 9, 'bold', 'underline'),  # Font kÃ¼Ã§Ã¼ltÃ¼ldÃ¼
                bg="#34495e", fg="#f39c12").grid(row=row, column=0, columnspan=2, sticky='w', pady=(0, 3))
        row += 1
        
        # Toplam kayÄ±t
        tk.Label(stats_grid, text="Toplam Direk SayÄ±sÄ±:", font=('Segoe UI', 8, 'bold'),  # Font kÃ¼Ã§Ã¼ltÃ¼ldÃ¼
                bg="#34495e", fg='white', anchor='w').grid(row=row, column=0, sticky='w', pady=1)
        self.toplam_kayit_var = tk.StringVar(value="0")
        tk.Label(stats_grid, textvariable=self.toplam_kayit_var, 
                font=('Segoe UI', 8, 'bold'), bg="#34495e", fg="#3498db",
                anchor='w').grid(row=row, column=1, sticky='w', pady=1)
        row += 1
        
        # Ã–NCELÄ°K TOPLAMI
        tk.Label(stats_grid, text="Ã–ncelik ToplamÄ±:", font=('Segoe UI', 8, 'bold'),
                bg="#34495e", fg='white', anchor='w').grid(row=row, column=0, sticky='w', pady=1)
        self.oncelik_toplam_var = tk.StringVar(value="0")
        tk.Label(stats_grid, textvariable=self.oncelik_toplam_var, 
                font=('Segoe UI', 8, 'bold'), bg="#34495e", fg="#f39c12",
                anchor='w').grid(row=row, column=1, sticky='e', pady=1)
        row += 1
        
        # AyÄ±rÄ±cÄ±
        tk.Frame(stats_grid, height=1, bg="#7f8c8d").grid(row=row, column=0, columnspan=2, sticky='ew', pady=(5, 5))
        row += 1
        
        # Ã–ncelik DaÄŸÄ±lÄ±mÄ±
        tk.Label(stats_grid, text="Ã–NCELÄ°K DAÄILIMI", 
                font=('Segoe UI', 9, 'bold', 'underline'),
                bg="#34495e", fg="#f39c12").grid(row=row, column=0, columnspan=2, sticky='w', pady=(0, 3))
        row += 1
        
        # Ã‡ok acil
        tk.Label(stats_grid, text="ğŸ”´ Ã‡ok Acil:", font=('Segoe UI', 8, 'bold'),  # Font kÃ¼Ã§Ã¼ltÃ¼ldÃ¼
                bg="#34495e", fg='white', anchor='w').grid(row=row, column=0, sticky='w', pady=1)
        self.cok_acil_var = tk.StringVar(value="0")
        tk.Label(stats_grid, textvariable=self.cok_acil_var, 
                font=('Segoe UI', 8, 'bold'), bg="#34495e", fg="#e74c3c",
                anchor='e').grid(row=row, column=1, sticky='e', pady=1)
        row += 1

        # Acil
        tk.Label(stats_grid, text="ğŸŸ  Acil:", font=('Segoe UI', 8, 'bold'),
                bg="#34495e", fg='white', anchor='w').grid(row=row, column=0, sticky='w', pady=1)
        self.acil_var = tk.StringVar(value="0")
        tk.Label(stats_grid, textvariable=self.acil_var, 
                font=('Segoe UI', 8, 'bold'), bg="#34495e", fg="#f39c12",
                anchor='e').grid(row=row, column=1, sticky='e', pady=1)
        row += 1

        # Normal
        tk.Label(stats_grid, text="ğŸ”µ Normal:", font=('Segoe UI', 8, 'bold'),
                bg="#34495e", fg='white', anchor='w').grid(row=row, column=0, sticky='w', pady=1)
        self.normal_var = tk.StringVar(value="0")
        tk.Label(stats_grid, textvariable=self.normal_var, 
                font=('Segoe UI', 8, 'bold'), bg="#34495e", fg="#3498db",
                anchor='e').grid(row=row, column=1, sticky='e', pady=1)
        row += 1

        # Bekleyebilir
        tk.Label(stats_grid, text="ğŸŸ¢ Bekleyebilir:", font=('Segoe UI', 8, 'bold'),
                bg="#34495e", fg='white', anchor='w').grid(row=row, column=0, sticky='w', pady=1)
        self.bekleyebilir_var = tk.StringVar(value="0")
        tk.Label(stats_grid, textvariable=self.bekleyebilir_var, 
                font=('Segoe UI', 8, 'bold'), bg="#34495e", fg="#27ae60",
                anchor='e').grid(row=row, column=1, sticky='e', pady=1)
        row += 1
        
        # AyÄ±rÄ±cÄ±
        tk.Frame(stats_grid, height=1, bg="#7f8c8d").grid(row=row, column=0, columnspan=2, sticky='ew', pady=(5, 5))
        row += 1
        
        # Durum bilgisi
        self.bilgi_var = tk.StringVar(value="ğŸ“ Veriler yÃ¼kleniyor...")
        bilgi_label = tk.Label(stats_grid, textvariable=self.bilgi_var,
                              font=('Segoe UI', 8), bg="#34495e", fg="#f39c12",  # Font kÃ¼Ã§Ã¼ltÃ¼ldÃ¼
                              wraplength=250, justify='left', anchor='w')  # Wraplength azaltÄ±ldÄ±
        bilgi_label.grid(row=row, column=0, columnspan=2, pady=(3, 0), sticky='w')
        
        # 3. LÄ°NK PANELÄ° - YENÄ° EKLENDÄ°
        link_frame = tk.LabelFrame(left_panel, text="ğŸ”— WEB LÄ°NK", 
                                  font=('Segoe UI', 10, 'bold'),
                                  fg='white', bg="#34495e", padx=8, pady=8)
        link_frame.grid(row=2, column=0, sticky='ew', pady=(0, 5), padx=5)
        
        # Link oluÅŸturma fonksiyonunu baÄŸla
        self.hat_var.trace('w', self.guncelle_link)  # Hat deÄŸiÅŸtiÄŸinde link gÃ¼ncellenecek
        
        # Link etiketi
        self.link_var = tk.StringVar(value="https://halilib07.github.io/.nojekyll/")
        link_label = tk.Label(link_frame, textvariable=self.link_var,
                             font=('Segoe UI', 8), bg="#34495e", fg="#3498db",
                             wraplength=260, justify='left', anchor='w', cursor="hand2")
        link_label.pack(fill='x', pady=(0, 5))
        
        # Link'e tÄ±klama Ã¶zelliÄŸi ekle
        def link_tikla(event):
            link = self.link_var.get()
            if link:
                import webbrowser
                webbrowser.open(link)
        
        link_label.bind("<Button-1>", link_tikla)
        
        # Butonlar frame
        link_btn_frame = tk.Frame(link_frame, bg="#34495e")
        link_btn_frame.pack(fill='x')
        
        # Kopyala butonu
        copy_btn = tk.Button(link_btn_frame, text="ğŸ“‹ Kopyala", 
                            command=self.link_kopyala,
                            bg="#f39c12", fg='white', font=('Segoe UI', 8, 'bold'),
                            height=1, width=10)
        copy_btn.pack(side='left', padx=(0, 5))
        
        # TarayÄ±cÄ±da aÃ§ butonu
        open_btn = tk.Button(link_btn_frame, text="ğŸŒ AÃ§", 
                            command=self.link_ac,
                            bg="#3498db", fg='white', font=('Segoe UI', 8, 'bold'),
                            height=1, width=10)
        open_btn.pack(side='left')
        
        # BoÅŸluk
        empty_space = tk.Frame(left_panel, bg="#2c3e50")
        empty_space.grid(row=3, column=0, sticky='nsew')
        
        # === SAÄ PANEL: Harita GÃ¶rÃ¼nÃ¼mÃ¼ - DAHA GENÄ°Å ===
        right_panel = tk.Frame(main_frame, bg="#2c3e50")
        right_panel.grid(row=0, column=1, sticky='nsew', padx=0, pady=0)
        right_panel.grid_rowconfigure(0, weight=1)
        right_panel.grid_columnconfigure(0, weight=1)
        
        # Harita frame
        harita_frame = tk.Frame(right_panel, bg="#34495e")
        harita_frame.grid(row=0, column=0, sticky='nsew', padx=0, pady=0)
        harita_frame.grid_rowconfigure(0, weight=1)
        harita_frame.grid_columnconfigure(0, weight=1)
        
        # Harita gÃ¶mme Ã§erÃ§evesi
        self.map_frame = tk.Frame(harita_frame, bg="black")
        self.map_frame.grid(row=0, column=0, sticky='nsew', padx=2, pady=2)
        self.map_frame.grid_rowconfigure(0, weight=1)
        self.map_frame.grid_columnconfigure(0, weight=1)
        
        # BaÅŸlangÄ±Ã§ta bilgi gÃ¶ster
        self.harita_bilgi_label = tk.Label(self.map_frame,
                                         text="Harita yÃ¼kleniyor...\n\n"
                                              "Veriler iÅŸleniyor, lÃ¼tfen bekleyin.",
                                         font=('Segoe UI', 12),
                                         bg="black", fg="white",
                                         justify='center')
        self.harita_bilgi_label.pack(expand=True)



    def guncelle_link(self, *args):
        """Linki gÃ¼nceller - seÃ§ili hat adÄ±na gÃ¶re"""
        try:
            # Sabit URL kÄ±smÄ±
            base_url = "https://halilib07.github.io/.nojekyll/"
            
            # SeÃ§ili hat adÄ±nÄ± al
            secili_hat = self.hat_var.get()
            
            # Link oluÅŸtur
            if secili_hat != "TÃœMÃœ" and secili_hat != "GENEL":
                # Dosya adÄ± iÃ§in uygun formata Ã§evir
                dosya_adi = self.hat_to_filename(secili_hat)
                link = f"{base_url}{dosya_adi}"
            else:
                link = base_url  # Sadece base URL gÃ¶ster
                
            self.link_var.set(link)
            
        except Exception as e:
            print(f"Link gÃ¼ncelleme hatasÄ±: {e}")
            self.link_var.set("https://halilib07.github.io/.nojekyll/")

    def hat_to_filename(self, hat_adi):
        """Hat adÄ±nÄ± dosya adÄ± formatÄ±na Ã§evirir"""
        try:
            # Ã–zel karakterleri temizle
            import re
            
            # Tarih formatÄ±nÄ± bul (Ã¶rn: 2025.12.03_724280_H02_Cerdin Dm Cerdin ErdaÅŸ Ã§Ä±kÄ±ÅŸÄ±)
            # Sadece tarih ve diÄŸer bilgiler varsa olduÄŸu gibi kullan
            if hat_adi and len(hat_adi) > 10:
                # BoÅŸluklarÄ± koru, sadece URL'de sorun Ã§Ä±karacak karakterleri temizle
                cleaned = hat_adi.strip()
                # URL uygun karakterlere Ã§evir
                cleaned = re.sub(r'[<>:"/\\|?*]', '', cleaned)  # Dosya sistemi iÃ§in geÃ§ersiz karakterleri kaldÄ±r
                return cleaned
            else:
                return hat_adi.strip()
                
        except Exception as e:
            print(f"Hat adÄ± dÃ¶nÃ¼ÅŸtÃ¼rme hatasÄ±: {e}")
            return hat_adi

    def link_kopyala(self):
        """Linki panoya kopyalar"""
        try:
            link = self.link_var.get()
            if link:
                self.clipboard_clear()
                self.clipboard_append(link)
                self.update()  # Clipboard'Ä± gÃ¼ncelle
                
                # GeÃ§ici bilgi mesajÄ±
                original_text = self.bilgi_var.get()
                self.bilgi_var.set("âœ… Link panoya kopyalandÄ±!")
                
                # 3 saniye sonra orijinal metne dÃ¶n
                self.after(3000, lambda: self.bilgi_var.set(original_text))
        except Exception as e:
            print(f"Link kopyalama hatasÄ±: {e}")
            self.bilgi_var.set(f"âŒ Kopyalama hatasÄ±: {str(e)}")

    def link_ac(self):
        """Linki tarayÄ±cÄ±da aÃ§ar"""
        try:
            link = self.link_var.get()
            if link and link != "https://halilib07.github.io/.nojekyll/":
                import webbrowser
                webbrowser.open(link)
            else:
                # Sadece base URL ise uyarÄ± gÃ¶ster
                if link == "https://halilib07.github.io/.nojekyll/":
                    self.bilgi_var.set("âš ï¸ LÃ¼tfen Ã¶nce bir hat seÃ§in!")
                else:
                    self.bilgi_var.set("âš ï¸ GeÃ§erli bir link yok!")
        except Exception as e:
            print(f"Link aÃ§ma hatasÄ±: {e}")
            self.bilgi_var.set(f"âŒ Link aÃ§ma hatasÄ±: {str(e)}")


    
    def verileri_yukle(self):
        """BirleÅŸtirilmiÅŸ_Tespit excel'inden verileri yÃ¼kler - DÃœZELTÄ°LMÄ°Å"""
        try:
            # FotoÄŸraf KlasÃ¶rleri yerine BirleÅŸtirilmiÅŸ_Tespit sheet'ini oku
            self.df_veri = pd.read_excel(self.excel_dosyasi, sheet_name='BirleÅŸtirilmiÅŸ_Tespit')
            
            print(f"DEBUG: YÃ¼klenen sÃ¼tunlar: {list(self.df_veri.columns)}")
            
            # SÃ¼tun isimlerini temizle (boÅŸluklarÄ± kaldÄ±r)
            self.df_veri.columns = self.df_veri.columns.str.strip()
            
            # SÃ¼tun isimlerini standartlaÅŸtÄ±r
            rename_dict = {}
            
            # Ä°lÃ§e sÃ¼tunu (Aob)
            if 'Ä°lÃ§e' in self.df_veri.columns:
                rename_dict['Ä°lÃ§e'] = 'Aob'
            elif 'Ä°LÃ‡E' in self.df_veri.columns:
                rename_dict['Ä°LÃ‡E'] = 'Aob'
            
            # Enlem sÃ¼tunu -> LAT
            if 'Enlem' in self.df_veri.columns:
                rename_dict['Enlem'] = 'LAT'
            elif 'ENLEM' in self.df_veri.columns:
                rename_dict['ENLEM'] = 'LAT'
            
            # Boylam sÃ¼tunu -> LON
            if 'Boylam' in self.df_veri.columns:
                rename_dict['Boylam'] = 'LON'
            elif 'BOYLAM' in self.df_veri.columns:
                rename_dict['BOYLAM'] = 'LON'
            
            # Direk No sÃ¼tunu
            if 'Direk No' in self.df_veri.columns:
                rename_dict['Direk No'] = 'Direk No'
            elif 'DÄ°REK NO' in self.df_veri.columns:
                rename_dict['DÄ°REK NO'] = 'Direk No'
            
            # Ã–ncelik sÃ¼tunu
            if 'Ã–ncelik' in self.df_veri.columns:
                rename_dict['Ã–ncelik'] = 'Ã–ncelik'
            elif 'Ã–NCELÄ°K' in self.df_veri.columns:
                rename_dict['Ã–NCELÄ°K'] = 'Ã–ncelik'
            
            # Tespit Notu sÃ¼tunu
            if 'Tespit Notu' in self.df_veri.columns:
                rename_dict['Tespit Notu'] = 'Tespit Notu'
            elif 'TESPÄ°T NOTU' in self.df_veri.columns:
                rename_dict['TESPÄ°T NOTU'] = 'Tespit Notu'
            
            # YapÄ±ldÄ± mÄ±? sÃ¼tunu
            if 'YapÄ±ldÄ± mÄ±?' in self.df_veri.columns:
                rename_dict['YapÄ±ldÄ± mÄ±?'] = 'YapÄ±ldÄ± mÄ±?'
            elif 'YAPILDI MI?' in self.df_veri.columns:
                rename_dict['YAPILDI MI?'] = 'YapÄ±ldÄ± mÄ±?'
            
            # ğŸŸ¢ EN Ã–NEMLÄ° DÃœZELTME: Hat AdÄ± sÃ¼tunu
            # "Hat AdÄ±" sÃ¼tununu kontrol et, yoksa oluÅŸtur
            if 'Hat AdÄ±' not in self.df_veri.columns:
                # Alternatif isimlerle kontrol et
                if 'Hat adÄ±' in self.df_veri.columns:
                    rename_dict['Hat adÄ±'] = 'Hat AdÄ±'
                    print("DEBUG: 'Hat adÄ±' sÃ¼tunu 'Hat AdÄ±' olarak deÄŸiÅŸtirildi")
                elif 'HAT ADI' in self.df_veri.columns:
                    rename_dict['HAT ADI'] = 'Hat AdÄ±'
                    print("DEBUG: 'HAT ADI' sÃ¼tunu 'Hat AdÄ±' olarak deÄŸiÅŸtirildi")
                else:
                    # HiÃ§bir hat sÃ¼tunu yoksa, ilk satÄ±rÄ± kullanarak oluÅŸtur
                    print("DEBUG: 'Hat AdÄ±' sÃ¼tunu bulunamadÄ±, oluÅŸturuluyor...")
                    # BoÅŸ bir Hat AdÄ± sÃ¼tunu oluÅŸtur
                    self.df_veri['Hat AdÄ±'] = ''
            
            # SÃ¼tunlarÄ± yeniden adlandÄ±r
            if rename_dict:
                self.df_veri.rename(columns=rename_dict, inplace=True)
                print(f"DEBUG: Yeniden adlandÄ±rÄ±lan sÃ¼tunlar: {rename_dict}")
            
            # ğŸŸ¢ HAT ADI SÃœTUNUNU KONTROL ET
            print(f"DEBUG: Mevcut sÃ¼tunlar: {list(self.df_veri.columns)}")
            
            # Hat AdÄ± sÃ¼tununu doldur (eÄŸer boÅŸsa)
            if 'Hat AdÄ±' in self.df_veri.columns:
                # BoÅŸ deÄŸerleri kontrol et
                empty_hat_count = self.df_veri['Hat AdÄ±'].isna().sum()
                if empty_hat_count > 0:
                    print(f"DEBUG: {empty_hat_count} boÅŸ Hat AdÄ± deÄŸeri var")
                    
                    # BoÅŸ deÄŸerleri "GENEL" ile doldur
                    self.df_veri['Hat AdÄ±'] = self.df_veri['Hat AdÄ±'].fillna('GENEL')
                    
                    # String olmayan deÄŸerleri string'e Ã§evir
                    self.df_veri['Hat AdÄ±'] = self.df_veri['Hat AdÄ±'].astype(str)
                    
                    # "nan" stringlerini "GENEL" ile deÄŸiÅŸtir
                    self.df_veri['Hat AdÄ±'] = self.df_veri['Hat AdÄ±'].replace('nan', 'GENEL')
                
                # Unique hat adlarÄ±nÄ± kontrol et
                unique_hats = self.df_veri['Hat AdÄ±'].unique()
                print(f"DEBUG: {len(unique_hats)} unique hat adÄ± bulundu")
                print(f"DEBUG: Hat adÄ± Ã¶rnekleri: {list(unique_hats[:10])}")
            else:
                print("DEBUG: 'Hat AdÄ±' sÃ¼tunu hala bulunamadÄ±, oluÅŸturuluyor...")
                self.df_veri['Hat AdÄ±'] = 'GENEL'
            
            # Koordinat temizleme
            self.df_veri['LAT'] = pd.to_numeric(self.df_veri['LAT'], errors='coerce')
            self.df_veri['LON'] = pd.to_numeric(self.df_veri['LON'], errors='coerce')
            
            # Ä°lÃ§e verilerini temizle
            if 'Aob' in self.df_veri.columns:
                self.df_veri['Aob'] = self.df_veri['Aob'].astype(str).str.strip()
            
            # Direk No temizle
            if 'Direk No' in self.df_veri.columns:
                self.df_veri['Direk No'] = self.df_veri['Direk No'].astype(str).str.strip()
            
            # Ã–ncelik temizle
            if 'Ã–ncelik' in self.df_veri.columns:
                self.df_veri['Ã–ncelik'] = self.df_veri['Ã–ncelik'].astype(str).str.strip()
            
            # Veri kalitesi kontrolÃ¼
            koordinatli_kayit = self.df_veri['LAT'].notna().sum()
            print(f"DEBUG: KoordinatlÄ± kayÄ±t sayÄ±sÄ±: {koordinatli_kayit}/{len(self.df_veri)}")
            print(f"DEBUG: Ä°lÃ§e sayÄ±sÄ±: {self.df_veri['Aob'].nunique()}")
            print(f"DEBUG: Ã–ncelik daÄŸÄ±lÄ±mÄ±: {self.df_veri['Ã–ncelik'].value_counts()}")
            
            self.df_filtreli = self.df_veri.copy()
            
            # Listeleri doldur
            self.listeleri_doldur()
            
            # Ä°statistikleri gÃ¼ncelle
            self.istatistikleri_guncelle()
            
            # BaÅŸlangÄ±Ã§ haritasÄ±nÄ± oluÅŸtur
            self.harita_olustur()
            
        except Exception as e:
            self.bilgi_var.set(f"âŒ Veri yÃ¼kleme hatasÄ±: {str(e)}")
            import traceback
            print(f"Veri yÃ¼kleme hatasÄ± detayÄ±: {traceback.format_exc()}")
    
    def listeleri_doldur(self):
        """Filtre listelerini doldurur - DÃœZELTÄ°LMÄ°Å"""
        try:
            # Ä°lÃ§e listesi (Aob sÃ¼tunu)
            if 'Aob' in self.df_veri.columns:
                # NaN deÄŸerleri kaldÄ±r ve benzersiz deÄŸerleri al
                ilce_values = self.df_veri['Aob'].dropna().unique()
                # BoÅŸ string'leri ve 'nan' deÄŸerlerini filtrele
                ilce_list = ['TÃœMÃœ'] + sorted([str(x) for x in ilce_values if str(x).strip() and str(x).lower() != 'nan'])
                self.ilce_combo['values'] = ilce_list
                print(f"DEBUG: Ä°lÃ§e listesi oluÅŸturuldu: {len(ilce_list)-1} ilÃ§e")
            else:
                print("HATA: 'Aob' sÃ¼tunu bulunamadÄ±!")
                self.ilce_combo['values'] = ['TÃœMÃœ']
            
            # ğŸŸ¢ HAT ADI LÄ°STESÄ° - DÃœZELTÄ°LMÄ°Å
            if 'Hat AdÄ±' in self.df_veri.columns:
                # NaN deÄŸerleri 'GENEL' ile doldur
                self.df_veri['Hat AdÄ±'] = self.df_veri['Hat AdÄ±'].fillna('GENEL')
                
                # String olmayan deÄŸerleri string'e Ã§evir
                self.df_veri['Hat AdÄ±'] = self.df_veri['Hat AdÄ±'].astype(str)
                
                # "nan" stringlerini "GENEL" ile deÄŸiÅŸtir
                self.df_veri['Hat AdÄ±'] = self.df_veri['Hat AdÄ±'].replace('nan', 'GENEL')
                
                # Unique deÄŸerleri al
                hat_values = self.df_veri['Hat AdÄ±'].dropna().unique()
                
                # BoÅŸ string'leri filtrele
                hat_list = ['TÃœMÃœ'] + sorted([str(x) for x in hat_values if str(x).strip() and str(x).lower() != 'nan'])
                
                print(f"DEBUG: Hat listesi oluÅŸturuldu: {len(hat_list)-1} hat")
                print(f"DEBUG: Hat Ã¶rnekleri: {hat_list[:10]}")
            else:
                # Hat bilgisi yoksa, "GENEL" olarak iÅŸaretle
                hat_list = ['TÃœMÃœ', 'GENEL']
                if 'Hat AdÄ±' in self.df_veri.columns:
                    self.df_veri['Hat AdÄ±'] = 'GENEL'
            
            self.hat_combo['values'] = hat_list
            
            # YapÄ±ldÄ± mÄ±? listesini ayarla
            self.yapildi_combo['values'] = ['TÃœMÃœ', 'YAPILDI', 'YAPILMADI']
            
            # Ä°lÃ§e deÄŸiÅŸtiÄŸinde hatlarÄ± gÃ¼ncelle
            self.ilce_var.trace('w', self.ilce_degisti)
            
        except Exception as e:
            print(f"Liste doldurma hatasÄ±: {e}")
            import traceback
            traceback.print_exc()
    
    def ilce_degisti(self, *args):
        """Ä°lÃ§e deÄŸiÅŸtiÄŸinde hat listesini gÃ¼nceller"""
        try:
            secili_ilce = self.ilce_var.get()
            
            if secili_ilce == "TÃœMÃœ":
                # TÃ¼m hatlarÄ± gÃ¶ster
                if 'Hat AdÄ±' in self.df_veri.columns and self.df_veri['Hat AdÄ±'].notna().any():
                    hat_values = self.df_veri['Hat AdÄ±'].dropna().unique()
                    hat_list = ['TÃœMÃœ'] + sorted([str(x) for x in hat_values if str(x).strip()])
                else:
                    hat_list = ['TÃœMÃœ']  # GENEL'i kaldÄ±rdÄ±m
            else:
                # SeÃ§ili ilÃ§eye ait hatlarÄ± gÃ¶ster
                if 'Aob' in self.df_veri.columns and 'Hat AdÄ±' in self.df_veri.columns:
                    df_filtreli = self.df_veri[self.df_veri['Aob'] == secili_ilce]
                    
                    # Hat adÄ± sÃ¼tunu yoksa oluÅŸtur
                    if 'Hat AdÄ±' not in df_filtreli.columns:
                        df_filtreli['Hat AdÄ±'] = ''
                    
                    # NaN deÄŸerleri filtrele
                    hat_values = df_filtreli['Hat AdÄ±'].dropna().unique()
                    
                    if len(hat_values) > 0:
                        hat_list = ['TÃœMÃœ'] + sorted([str(x) for x in hat_values if str(x).strip()])
                    else:
                        hat_list = ['TÃœMÃœ']  # GENEL'i kaldÄ±rdÄ±m
                else:
                    hat_list = ['TÃœMÃœ']  # GENEL'i kaldÄ±rdÄ±m
            
            # Hat listesini gÃ¼ncelle
            self.hat_combo['values'] = hat_list
            
            # EÄŸer mevcut seÃ§im yeni listede yoksa, TÃœMÃœ yap
            current_selection = self.hat_var.get()
            if current_selection not in hat_list:
                self.hat_var.set("TÃœMÃœ")
            
            print(f"DEBUG: Ä°lÃ§e deÄŸiÅŸti: {secili_ilce}, Hat listesi: {hat_list}")
            
        except Exception as e:
            print(f"Ä°lÃ§e deÄŸiÅŸim hatasÄ±: {e}")
            import traceback
            traceback.print_exc()
    
    def istatistikleri_guncelle(self):
        """Ä°statistikleri gÃ¼nceller - FotoÄŸraf KlasÃ¶rleri sayfasÄ±ndan direk sayÄ±sÄ±nÄ± alÄ±r"""
        try:
            if self.df_veri is None:
                return
                
            # Filtre deÄŸerlerini al
            secili_ilce = self.ilce_var.get()
            secili_hat = self.hat_var.get()
            
            # 1. FOTOÄRAF KLASÃ–RLERÄ° SAYFASINI OKU
            df_fotograf = pd.read_excel(self.excel_dosyasi, sheet_name='FotoÄŸraf KlasÃ¶rleri')
            
            # SÃ¼tun isimlerini temizle
            df_fotograf.columns = df_fotograf.columns.str.strip()
            
            # SÃ¼tun isimlerini standartlaÅŸtÄ±r
            if 'Aob' not in df_fotograf.columns:
                # Alternatif sÃ¼tun isimlerini kontrol et
                if 'Ä°lÃ§e' in df_fotograf.columns:
                    df_fotograf = df_fotograf.rename(columns={'Ä°lÃ§e': 'Aob'})
                elif 'Ä°LÃ‡E' in df_fotograf.columns:
                    df_fotograf = df_fotograf.rename(columns={'Ä°LÃ‡E': 'Aob'})
            
            if 'Hat AdÄ±' not in df_fotograf.columns:
                # Alternatif sÃ¼tun isimlerini kontrol et
                if 'Hat adÄ±' in df_fotograf.columns:
                    df_fotograf = df_fotograf.rename(columns={'Hat adÄ±': 'Hat AdÄ±'})
                elif 'HAT ADI' in df_fotograf.columns:
                    df_fotograf = df_fotograf.rename(columns={'HAT ADI': 'Hat AdÄ±'})
            
            if 'Direk No' not in df_fotograf.columns:
                # Alternatif sÃ¼tun isimlerini kontrol et
                if 'Direk no' in df_fotograf.columns:
                    df_fotograf = df_fotograf.rename(columns={'Direk no': 'Direk No'})
                elif 'DÄ°REK NO' in df_fotograf.columns:
                    df_fotograf = df_fotograf.rename(columns={'DÄ°REK NO': 'Direk No'})
            
            # Verileri temizle
            df_fotograf['Aob'] = df_fotograf['Aob'].astype(str).str.strip()
            df_fotograf['Hat AdÄ±'] = df_fotograf['Hat AdÄ±'].astype(str).str.strip()
            df_fotograf['Direk No'] = df_fotograf['Direk No'].astype(str).str.strip()
            
            # 2. FÄ°LTRELEME UYGULA
            df_filtreli_fotograf = df_fotograf.copy()
            
            # Ä°LÃ‡E filtresi
            if secili_ilce != "TÃœMÃœ" and 'Aob' in df_filtreli_fotograf.columns:
                df_filtreli_fotograf = df_filtreli_fotograf[df_filtreli_fotograf['Aob'] == secili_ilce]
            
            # HAT ADI filtresi
            if secili_hat != "TÃœMÃœ" and 'Hat AdÄ±' in df_filtreli_fotograf.columns:
                if secili_hat != "GENEL":
                    df_filtreli_fotograf = df_filtreli_fotograf[df_filtreli_fotograf['Hat AdÄ±'] == secili_hat]
            
            # 3. TOPLAM DÄ°REK SAYISINI HESAPLA - TÃœM SATIRLARI SAY
            if 'Direk No' in df_filtreli_fotograf.columns:
                # BoÅŸ olmayan tÃ¼m Direk No'larÄ± say
                direk_nolari = df_filtreli_fotograf['Direk No'].dropna().astype(str).str.strip()
                direk_nolari = direk_nolari[direk_nolari != '']
                
                # TÃœM satÄ±rlarÄ± say (benzersiz olmasÄ±n, aynÄ± numaralÄ± direkler de tekrar saysÄ±n)
                total_direk = len(direk_nolari)
            else:
                total_direk = len(df_filtreli_fotograf)
            
            # TOPLAM DÄ°REK SAYISINI GÃœNCELLE (BULGU SAYISI OLARAK KULLANILACAK)
            self.toplam_kayit_var.set(str(total_direk))
            
            # 4. BÄ°RLEÅTÄ°RÄ°LMÄ°Å TESPÄ°T SAYFASINDAN Ã–NCELÄ°K DAÄILIMINI HESAPLA
            df_veri_filtreli = self.df_veri.copy()
            
            # Ä°LÃ‡E filtresi
            if secili_ilce != "TÃœMÃœ" and 'Aob' in df_veri_filtreli.columns:
                df_veri_filtreli = df_veri_filtreli[df_veri_filtreli['Aob'] == secili_ilce]
            
            # HAT ADI filtresi
            if secili_hat != "TÃœMÃœ" and 'Hat AdÄ±' in df_veri_filtreli.columns:
                if secili_hat != "GENEL":
                    df_veri_filtreli = df_veri_filtreli[df_veri_filtreli['Hat AdÄ±'] == secili_hat]
            
            # Ã–NCELÄ°K DAÄILIMI HESAPLA - TÃœM SIRALARI SAY
            if 'Ã–ncelik' in df_veri_filtreli.columns and 'Direk No' in df_veri_filtreli.columns:
                # TÃ¼m satÄ±rlarÄ± say
                cok_acil_count = 0
                acil_count = 0
                normal_count = 0
                bekleyebilir_count = 0
                
                for idx, row in df_veri_filtreli.iterrows():
                    direk_no = str(row.get('Direk No', '')).strip()
                    oncelik = str(row.get('Ã–ncelik', '')).lower()
                    
                    if direk_no and direk_no != '' and direk_no.lower() != 'nan':
                        if 'Ã§ok acil' in oncelik or 'cok acil' in oncelik:
                            cok_acil_count += 1
                        elif 'acil' in oncelik:
                            acil_count += 1
                        elif 'normal' in oncelik:
                            normal_count += 1
                        elif 'bekleyebilir' in oncelik:
                            bekleyebilir_count += 1
                
                # Ã–NCELÄ°K TOPLAMI
                oncelik_toplam = cok_acil_count + acil_count + normal_count + bekleyebilir_count
                
                # DEÄERLERÄ° ATA
                self.cok_acil_var.set(f"{cok_acil_count:,}")
                self.acil_var.set(f"{acil_count:,}")
                self.normal_var.set(f"{normal_count:,}")
                self.bekleyebilir_var.set(f"{bekleyebilir_count:,}")
                self.oncelik_toplam_var.set(str(oncelik_toplam))
            else:
                # Ã–ncelik sÃ¼tunu yoksa
                self.cok_acil_var.set("0")
                self.acil_var.set("0")
                self.normal_var.set("0")
                self.bekleyebilir_var.set("0")
                self.oncelik_toplam_var.set("0")
                oncelik_toplam = 0
            
            print(f"Ä°STATÄ°STÄ°K DEBUG: Direk={total_direk}, Ã–ncelik Toplam={oncelik_toplam}")
            
        except Exception as e:
            print(f"Ä°statistik gÃ¼ncelleme hatasÄ±: {e}")
            import traceback
            print(traceback.format_exc())
            
            # Hata durumunda varsayÄ±lan deÄŸerleri ayarla
            self.toplam_kayit_var.set("0")
            self.cok_acil_var.set("0")
            self.acil_var.set("0")
            self.normal_var.set("0")
            self.bekleyebilir_var.set("0")
            self.oncelik_toplam_var.set("0")
            
            self.bilgi_var.set("âŒ Ä°statistik hesaplama hatasÄ±")

    def filtrele(self):
        """Filtreleri uygular"""
        try:
            # Orijinal veriden baÅŸla
            filtered_df = self.df_veri.copy()
            
            print(f"DEBUG: Filtreleme baÅŸlÄ±yor. Toplam kayÄ±t: {len(filtered_df)}")
            
            # Ä°lÃ§e filtresi
            secili_ilce = self.ilce_var.get()
            if secili_ilce != "TÃœMÃœ" and 'Aob' in filtered_df.columns:
                filtered_df = filtered_df[filtered_df['Aob'] == secili_ilce]
                print(f"DEBUG: Ä°lÃ§e filtresi uygulandÄ±: {secili_ilce}, Kalan: {len(filtered_df)}")
            
            # Hat filtresi
            secili_hat = self.hat_var.get()
            if secili_hat != "TÃœMÃœ" and 'Hat AdÄ±' in filtered_df.columns:
                if secili_hat == "GENEL":
                    # GENEL seÃ§ilirse, tÃ¼m kayÄ±tlarÄ± bÄ±rak
                    pass
                else:
                    filtered_df = filtered_df[filtered_df['Hat AdÄ±'] == secili_hat]
                print(f"DEBUG: Hat filtresi uygulandÄ±: {secili_hat}, Kalan: {len(filtered_df)}")
            
            # Harita iÃ§in "YapÄ±ldÄ± mÄ±?" filtresi
            harita_df = filtered_df.copy()  # Harita iÃ§in ayrÄ± dataframe
            
            secili_yapildi = self.yapildi_var.get()
            if secili_yapildi != "TÃœMÃœ" and 'YapÄ±ldÄ± mÄ±?' in harita_df.columns:
                if secili_yapildi == "YAPILDI":
                    # YapÄ±ldÄ± olanlarÄ± filtrele
                    harita_df = harita_df[harita_df['YapÄ±ldÄ± mÄ±?'].astype(str).str.lower().str.contains(
                        'evet|yapÄ±ldÄ±|x|âœ“|âœ…|tamamlandÄ±|bitti|yes', na=False)]
                    print(f"DEBUG: Harita iÃ§in YAPILDI filtresi uygulandÄ±, Kalan: {len(harita_df)}")
                elif secili_yapildi == "YAPILMADI":
                    # YapÄ±lmadÄ± olanlarÄ± filtrele
                    harita_df = harita_df[~harita_df['YapÄ±ldÄ± mÄ±?'].astype(str).str.lower().str.contains(
                        'evet|yapÄ±ldÄ±|x|âœ“|âœ…|tamamlandÄ±|bitti|yes', na=False)]
                    print(f"DEBUG: Harita iÃ§in YAPILMADI filtresi uygulandÄ±, Kalan: {len(harita_df)}")
            
            # Harita iÃ§in filtrelenmiÅŸ veri
            self.df_filtreli = harita_df
            
            print(f"DEBUG: Filtreleme tamamlandÄ±. Son kayÄ±t sayÄ±sÄ±: {len(self.df_filtreli)}")
            
            # 1. Ã–NCE Ä°STATÄ°STÄ°KLERÄ° GÃœNCELLE
            self.istatistikleri_guncelle()
            
            # 2. FÄ°LTRELEME BÄ°LGÄ°SÄ°NÄ° GÃ–STER
            if self.df_filtreli is not None:
                # FotoÄŸraf KlasÃ¶rleri'nden gelen Bulgu (direk) sayÄ±sÄ±
                total_direk = self.toplam_kayit_var.get()
                
                # FiltrelenmiÅŸ verideki koordinatlÄ± kayÄ±t sayÄ±sÄ±
                valid_coords = len(self.df_filtreli[self.df_filtreli['LAT'].notna() & self.df_filtreli['LON'].notna()])
                
                # Ã–ncelik toplamÄ±nÄ± al
                oncelik_toplam = self.oncelik_toplam_var.get()
                
                # FÄ°LTRELEME BÄ°LGÄ°SÄ° - SIFIRLA METODUYLA AYNI FORMATTA
                self.bilgi_var.set(f" {total_direk} Direk\n {len(self.df_filtreli)} Bulgu\n {valid_coords} Konumlu Buldu\n Ã–ncelik ToplamÄ±: {oncelik_toplam}")
            else:
                self.bilgi_var.set("ğŸ” Filtreleme yapÄ±ldÄ±")
            
            # 3. SONRA HARÄ°TAYI OLUÅTUR (HARÄ°TA_OLUSTUR MARKER EKLER)
            self.harita_olustur()
            
        except Exception as e:
            self.bilgi_var.set(f"âŒ Filtreleme hatasÄ±: {str(e)}")
            print(f"Filtreleme hatasÄ±: {e}")
            import traceback
            print(traceback.format_exc())
        
    def filtreleri_sifirla(self):
        """Filtreleri sÄ±fÄ±rlar"""
        try:
            self.ilce_var.set("TÃœMÃœ")
            self.hat_var.set("TÃœMÃœ")
            self.yapildi_var.set("TÃœMÃœ")
            
            # Filtreleri sÄ±fÄ±rla (orijinal veriye dÃ¶n)
            self.df_filtreli = self.df_veri.copy() if self.df_veri is not None else None
            
            # 1. Ã–NCE Ä°STATÄ°STÄ°KLERÄ° GÃœNCELLE
            self.istatistikleri_guncelle()
            
            # 2. SIFIRLAMA BÄ°LGÄ°SÄ°NÄ° GÃ–STER
            if self.df_filtreli is not None:
                # FotoÄŸraf KlasÃ¶rleri'nden gelen Bulgu (direk) sayÄ±sÄ±
                total_direk = self.toplam_kayit_var.get()
                
                # KoordinatlÄ± kayÄ±t sayÄ±sÄ±nÄ± hesapla
                valid_coords = len(self.df_filtreli[self.df_filtreli['LAT'].notna() & self.df_filtreli['LON'].notna()])
                
                # Ã–ncelik toplamÄ±nÄ± al
                oncelik_toplam = self.oncelik_toplam_var.get()
                
                # SIFIRLAMA BÄ°LGÄ°SÄ° - FÄ°LTRELEMEYLE AYNI FORMATTA
                self.bilgi_var.set(f" {total_direk} Direk\n {len(self.df_filtreli)} Bulgu\n {valid_coords} Konumlu Buldu\n Ã–ncelik ToplamÄ±: {oncelik_toplam}")
            else:
                self.bilgi_var.set(f"ğŸ”„ Filtreler sÄ±fÄ±rlandÄ±")
            
            # 3. SONRA HARÄ°TAYI OLUÅTUR (HARÄ°TA_OLUSTUR MARKER EKLER)
            self.harita_olustur()
            
        except Exception as e:
            error_msg = str(e)
            self.bilgi_var.set(f"âŒ Filtre sÄ±fÄ±rlama hatasÄ±: {error_msg[:50]}")
            print(f"Filtre sÄ±fÄ±rlama hatasÄ±: {e}")
            import traceback
            print(f"Hata detayÄ±: {traceback.format_exc()}")
    def direk_no_temizle(self, direk_no):
        """Direk numarasÄ±nÄ± temizler (AnaUygulama'daki ile aynÄ± mantÄ±k)"""
        if not direk_no or str(direk_no).lower() in ['nan', 'none', 'null', '']:
            return ""
        
        direk_no = str(direk_no).strip()
        
        if not direk_no:
            return ""
        
        # "0" kontrolÃ¼
        if direk_no.replace('0', '') == '':
            return '0'
        
        try:
            if '.' in direk_no:
                cleaned = str(int(float(direk_no)))
            else:
                cleaned = str(int(direk_no))
            
            cleaned = cleaned.lstrip('0') or '0'
            return cleaned
            
        except (ValueError, TypeError):
            sadece_rakamlar = ''.join(filter(str.isdigit, direk_no))
            if sadece_rakamlar:
                sadece_rakamlar = sadece_rakamlar.lstrip('0') or '0'
                return sadece_rakamlar
            
            return direk_no

        
    def harita_olustur(self):
        """Harita oluÅŸturur - AynÄ± direkler gruplanacak"""
        try:
            if self.df_filtreli is None or self.df_filtreli.empty:
                self.bilgi_var.set("âŒ Harita iÃ§in veri yok")
                return
            
            # KoordinatlÄ± verileri filtrele
            valid = self.df_filtreli['LAT'].notna() & self.df_filtreli['LON'].notna()
            df_map = self.df_filtreli[valid].copy()
            
            if df_map.empty:
                self.bilgi_var.set("âŒ KoordinatlÄ± veri yok")
                return
            
            # Merkez hesapla
            try:
                center_lat = df_map['LAT'].astype(float).mean()
                center_lon = df_map['LON'].astype(float).mean()
            except:
                center_lat = 39.9334
                center_lon = 32.8597
            
            # Folium harita oluÅŸtur
            harita = folium.Map(location=[center_lat, center_lon], 
                              zoom_start=12, 
                              control_scale=True,
                              tiles=None)
            
            # Tile layer'lar
            folium.TileLayer(
                tiles='https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
                name='ğŸ—ºï¸ Normal Harita',
                attr='Â© OpenStreetMap contributors',
                max_zoom=19,
                control=True
            ).add_to(harita)
            
            folium.TileLayer(
                tiles='https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}',
                attr='Google Hybrid',
                name='ğŸ›°ï¸ğŸ”¤ Uydu + Etiketler',
                max_zoom=22,
                control=True
            ).add_to(harita)
            
            # 1. FOTOÄRAF KLASÃ–RLERÄ° SAYFASINI OKU - TARÄ°H Ä°Ã‡Ä°N
            try:
                df_fotograf = pd.read_excel(self.excel_dosyasi, sheet_name='FotoÄŸraf KlasÃ¶rleri')
                df_fotograf.columns = df_fotograf.columns.str.strip()
                
                if 'Direk No' in df_fotograf.columns:
                    df_fotograf['Direk_No_Temiz'] = df_fotograf['Direk No'].apply(lambda x: self.direk_no_temizle(str(x)))
                
            except Exception as e:
                print(f"âš ï¸ FotoÄŸraf KlasÃ¶rleri sayfasÄ± yÃ¼klenemedi: {e}")
                df_fotograf = None
            
            # Ã–ncelik daÄŸÄ±lÄ±mÄ±na gÃ¶re marker ekle
            use_cluster = self.kumelenme_var.get()
            oncelik_dagilimi = self.oncelik_dagilimi_var.get()
            
            # Marker layer oluÅŸtur
            if use_cluster:
                if oncelik_dagilimi:
                    marker_layer = MarkerCluster(name='ğŸš¨ Ã–ncelikli Direkler').add_to(harita)
                else:
                    marker_layer = MarkerCluster(name='ğŸ“ TÃ¼m Direkler').add_to(harita)
            else:
                if oncelik_dagilimi:
                    marker_layer = folium.FeatureGroup(name='ğŸš¨ Ã–ncelikli Direkler').add_to(harita)
                else:
                    marker_layer = folium.FeatureGroup(name='ğŸ“ TÃ¼m Direkler').add_to(harita)
            
            # âœ… DEÄÄ°ÅÄ°KLÄ°K: AYNI DÄ°REKLERÄ° GRUPLAMA
            # Ä°lÃ§e, Hat AdÄ± ve Direk No'ya gÃ¶re grupla
            df_map['Direk_No_Temiz'] = df_map['Direk No'].apply(lambda x: self.direk_no_temizle(str(x)))
            
            # Grup anahtarÄ± oluÅŸtur (ilÃ§e + hat + direk no)
            df_map['Grup_Anahtari'] = df_map['Aob'].fillna('') + '|' + df_map['Hat AdÄ±'].fillna('') + '|' + df_map['Direk_No_Temiz']
            
            # GruplarÄ± iÅŸle
            gruplanmis_markerlar = {}
            
            for grup_anahtari, grup_df in df_map.groupby('Grup_Anahtari'):
                if len(grup_df) > 0:
                    # Ä°lk satÄ±rÄ± temel al (ortanca koordinatlar iÃ§in de hesaplayabilirsiniz)
                    ilk_satir = grup_df.iloc[0]
                    
                    # Ortalama koordinatlarÄ± hesapla
                    try:
                        lat = float(grup_df['LAT'].astype(float).mean())
                        lon = float(grup_df['LON'].astype(float).mean())
                    except:
                        lat = float(ilk_satir['LAT'])
                        lon = float(ilk_satir['LON'])
                    
                    # Grup bilgilerini topla
                    grup_bilgileri = {
                        'lat': lat,
                        'lon': lon,
                        'ilce': ilk_satir.get('Aob', ''),
                        'hat_adi': ilk_satir.get('Hat AdÄ±', ''),
                        'direk_no': ilk_satir.get('Direk No', ''),
                        'direk_no_temiz': grup_anahtari.split('|')[-1],
                        'satirlar': [],
                        'tespit_notlari': []
                    }
                    
                    # TÃ¼m satÄ±rlarÄ± iÅŸle
                    for idx, row in grup_df.iterrows():
                        try:
                            # Tespit notu
                            tespit_notu = str(row.get('Tespit Notu', '')).strip()
                            if tespit_notu and tespit_notu != 'nan':
                                grup_bilgileri['tespit_notlari'].append(tespit_notu)
                            
                            # YapÄ±ldÄ± mÄ±? bilgisini satÄ±rla birlikte kaydet
                            yapildi_mi = str(row.get('YapÄ±ldÄ± mÄ±?', '')).strip()
                            yapildi_durum = 'YapÄ±lmadÄ±'
                            if yapildi_mi and yapildi_mi.lower() in ['evet', 'yapÄ±ldÄ±', 'x', 'âœ“', 'âœ…', 'tamamlandÄ±', 'bitti', 'yes']:
                                yapildi_durum = 'YapÄ±ldÄ±'
                            
                            # Ã–ncelik rengi (sadece marker rengi iÃ§in)
                            oncelik = str(row.get('Ã–ncelik', '')).lower()
                            renk = 'gray'
                            if 'Ã§ok acil' in oncelik or 'cok acil' in oncelik:
                                renk = 'red'
                            elif 'acil' in oncelik:
                                renk = 'orange'
                            elif 'normal' in oncelik:
                                renk = 'blue'
                            elif 'bekleyebilir' in oncelik:
                                renk = 'green'
                            
                            # SatÄ±r bilgisini ekle
                            grup_bilgileri['satirlar'].append({
                                'renk': renk,
                                'yapildi_mi': yapildi_mi,
                                'yapildi_durum': yapildi_durum,
                                'tespit_notu': tespit_notu
                            })
                            
                        except Exception as e:
                            print(f"Grup iÅŸleme hatasÄ± satÄ±r {idx}: {e}")
                    
                    # Grup bilgilerini kaydet
                    gruplanmis_markerlar[grup_anahtari] = grup_bilgileri
            
            # Marker'larÄ± ekle
            eklenen = 0
            for grup_anahtari, grup_bilgi in gruplanmis_markerlar.items():
                try:
                    lat = grup_bilgi['lat']
                    lon = grup_bilgi['lon']
                    ilce = grup_bilgi['ilce']
                    hat_adi = grup_bilgi['hat_adi']
                    direk_no = grup_bilgi['direk_no']
                    direk_no_temiz = grup_bilgi['direk_no_temiz']
                    
                    # âœ… Ã–NCELÄ°K DAÄILIMI FÄ°LTRESÄ°
                    if oncelik_dagilimi:
                        # Sadece Ã¶ncelikli olanlarÄ± kontrol et
                        oncelik_renkleri = [satir['renk'] for satir in grup_bilgi['satirlar']]
                        # EÄŸer tÃ¼m satÄ±rlar gri ise (Ã¶nceliksiz) atla
                        if all(renk == 'gray' for renk in oncelik_renkleri):
                            continue
                    
                    # EN Ã–NCELÄ°KLÄ° RENGÄ° BELÄ°RLE (marker rengi iÃ§in)
                    renk_oncelik_sirasi = {'red': 1, 'orange': 2, 'blue': 3, 'green': 4, 'gray': 5}
                    en_oncelikli_renk = 'gray'
                    en_oncelikli_derece = 5
                    
                    for satir in grup_bilgi['satirlar']:
                        renk_derece = renk_oncelik_sirasi.get(satir['renk'], 5)
                        if renk_derece < en_oncelikli_derece:
                            en_oncelikli_derece = renk_derece
                            en_oncelikli_renk = satir['renk']
                    
                    # ğŸ“Œ DÃœZELTME: Birden fazla kayÄ±t varsa ikonu 'list' yap
                    kayit_sayisi = len(grup_bilgi['satirlar'])
                    icon_name = 'list' if kayit_sayisi > 1 else 'info-sign'
                    
                    # EÄŸer tÃ¼m kayÄ±tlar yapÄ±ldÄ±ysa check ikonu kullan (sadece 1 kayÄ±t varsa)
                    yapildi_sayisi = sum(1 for satir in grup_bilgi['satirlar'] if satir['yapildi_durum'] == 'YapÄ±ldÄ±')
                    if yapildi_sayisi == kayit_sayisi and kayit_sayisi == 1:
                        icon_name = 'check'
                    
                    # TARÄ°H BÄ°LGÄ°SÄ° (FOTOÄRAF KLASÃ–RLERÄ°'NDEN)
                    en_yeni_tarih = "Belirsiz"
                    if df_fotograf is not None and direk_no_temiz:
                        filtered_fotograf = df_fotograf[
                            (df_fotograf['Direk_No_Temiz'] == direk_no_temiz) &
                            (df_fotograf['Aob'].astype(str).str.strip() == ilce)
                        ]
                        
                        if not filtered_fotograf.empty:
                            hat_eslesen = filtered_fotograf[
                                filtered_fotograf['Hat adÄ±'].astype(str).str.strip() == hat_adi
                            ]
                            
                            if not hat_eslesen.empty:
                                tarih_verisi = hat_eslesen.iloc[0]
                            else:
                                tarih_verisi = filtered_fotograf.iloc[0]
                            
                            if 'En Yeni FotoÄŸraf Tarihi' in tarih_verisi:
                                tarih = str(tarih_verisi['En Yeni FotoÄŸraf Tarihi'])
                                if tarih != 'nan' and tarih != 'NaT' and pd.notna(tarih):
                                    if isinstance(tarih, pd.Timestamp):
                                        en_yeni_tarih = tarih.strftime('%d/%m/%Y %H:%M:%S')
                                    elif isinstance(tarih, datetime.datetime):
                                        en_yeni_tarih = tarih.strftime('%d/%m/%Y %H:%M:%S')
                                    elif isinstance(tarih, str):
                                        if tarih not in ['Tarihi Yok', 'Belirsiz', 'nan', 'NaT', '']:
                                            en_yeni_tarih = tarih
                    
                    # TESPÄ°T DETAYLARI - Her tespitin yanÄ±nda yapÄ±ldÄ±/yapÄ±lmadÄ± durumu
                    tespit_detaylari = []
                    for i, satir in enumerate(grup_bilgi['satirlar'], 1):
                        yapildi_icon = "âœ…" if satir['yapildi_durum'] == 'YapÄ±ldÄ±' else "âŒ"
                        
                        # Tespit notu
                        not_metni = ""
                        if i <= len(grup_bilgi['tespit_notlari']):
                            not_metni = grup_bilgi['tespit_notlari'][i-1]
                        else:
                            not_metni = satir.get('tespit_notu', '') or "Tespit notu girilmemiÅŸ"
                        
                        # Ã–ncelik rengine gÃ¶re emoji (her tespit iÃ§in)
                        oncelik_renk = satir['renk']
                        oncelik_emoji = ""
                        if oncelik_renk == 'red':
                            oncelik_emoji = "ğŸ”´"
                        elif oncelik_renk == 'orange':
                            oncelik_emoji = "ğŸŸ "
                        elif oncelik_renk == 'blue':
                            oncelik_emoji = "ğŸ”µ"
                        elif oncelik_renk == 'green':
                            oncelik_emoji = "ğŸŸ¢"
                        else:
                            oncelik_emoji = "âšª"
                        
                        tespit_detaylari.append({
                            'no': i,
                            'notu': not_metni,
                            'yapildi_icon': yapildi_icon,
                            'yapildi_durum': satir['yapildi_durum'],
                            'oncelik_emoji': oncelik_emoji,
                            'renk': oncelik_renk
                        })
                    
                    # TESPÄ°T LÄ°STESÄ° HTML
                    tespit_listesi_html = ""
                    if tespit_detaylari:
                        tespit_listesi_html = f"""
                        <div style='margin-top:10px;'>
                            <div style='font-weight:bold; color:#333; margin-bottom:8px; padding-bottom:3px; border-bottom:2px solid #3498db; font-size:12px;'>
                                ğŸ” {len(tespit_detaylari)} TESPÄ°T BULUNDU:
                            </div>
                            <div style='max-height:220px; overflow-y:auto; padding-right:3px;'>
                        """
                        
                        for tespit in tespit_detaylari:
                            durum_rengi = "#27ae60" if tespit['yapildi_durum'] == 'YapÄ±ldÄ±' else "#e74c3c"
                            oncelik_renk_text = ""
                            if tespit['renk'] == 'red':
                                oncelik_renk_text = "Ã‡ok Acil"
                            elif tespit['renk'] == 'orange':
                                oncelik_renk_text = "Acil"
                            elif tespit['renk'] == 'blue':
                                oncelik_renk_text = "Normal"
                            elif tespit['renk'] == 'green':
                                oncelik_renk_text = "Bekleyebilir"
                            else:
                                oncelik_renk_text = "Belirsiz"
                            
                            tespit_listesi_html += f"""
                                <div style='margin-bottom:10px; padding:8px; background:#f8f9fa; border-radius:4px; border-left:3px solid {durum_rengi};'>
                                    <div style='display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;'>
                                        <div style='display:flex; align-items:center; gap:5px;'>
                                            <span style='font-size:12px;'>{tespit['oncelik_emoji']}</span>
                                            <div style='font-weight:bold; color:#2c3e50; font-size:11px;'>
                                                Tespit {tespit['no']}:
                                            </div>
                                        </div>
                                        <div style='display:flex; align-items:center; gap:5px;'>
                                            <span style='font-size:12px;'>{tespit['yapildi_icon']}</span>
                                            <span style='font-size:10px; color:{durum_rengi}; font-weight:bold;'>
                                                {tespit['yapildi_durum']}
                                            </span>
                                        </div>
                                    </div>
                                    <div style='margin-bottom:5px; font-size:10px; color:#7f8c8d; padding-left:18px;'>
                                        {oncelik_renk_text}
                                    </div>
                                    <div style='font-size:10px; color:#34495e; padding:5px; background:white; border-radius:3px; border:1px solid #ecf0f1;'>
                                        {tespit['notu']}
                                    </div>
                                </div>
                            """
                        
                        tespit_listesi_html += "</div></div>"
                    else:
                        tespit_listesi_html = """
                        <div style='margin-top:10px; padding:10px; background:#f8f9fa; border-radius:4px;'>
                            <div style='font-weight:bold; color:#7f8c8d; font-size:11px; text-align:center;'>
                                ğŸ“ TESPÄ°T BULUNAMADI
                            </div>
                        </div>
                        """
                    
                    # Popup HTML - SADELESTIRILMIS TASARIM
                    google_maps_directions = f"https://www.google.com/maps/dir/?api=1&destination={lat},{lon}"
                    
                    # Ana baÅŸlÄ±k kÄ±smÄ± (sadece ilÃ§e, hat)
                    header_html = f"""
                    <div style='margin-bottom:10px;'>
                        <div style='font-weight:bold; color:#2c3e50; font-size:14px; margin-bottom:3px;'>
                            {ilce} - {hat_adi}
                        </div>
                    </div>
                    """
                    
                    # Bilgi kutusu (Ã§erÃ§eveli) - Direk No ve Tarih
                    bilgi_kutusu_html = f"""
                    <div style='background:#ecf0f1; padding:10px; border-radius:4px; margin-bottom:10px; border:1px solid #bdc3c7;'>
                        <div style='font-size:11px; color:#34495e;'>
                            <div style='margin-bottom:3px;'>
                                <strong>Direk No:</strong> <span style='color:#3498db; font-weight:bold;'>{direk_no}</span>
                                <span style='margin-left:8px; font-size:10px; color:#95a5a6;'>
                                    ({kayit_sayisi} kayÄ±t)
                                </span>
                            </div>
                            <div>
                                <strong>Tespit Tarihi:</strong> {en_yeni_tarih}
                            </div>
                        </div>
                    </div>
                    """
                    
                    # TÃ¼m iÃ§eriÄŸi birleÅŸtir
                    popup_html = f"""
                    <div style='font-family: Arial; width: 300px; max-height: 400px; overflow-y: auto; font-size: 12px; padding:5px;'>
                        {header_html}
                        {bilgi_kutusu_html}
                        {tespit_listesi_html}
                        
                        <!-- BUTONLAR -->
                        <div style='margin-top:15px;'>
                            <a href='{google_maps_directions}' target='_blank' 
                               style='display:flex; align-items:center; justify-content:center;
                                      background:#3498db; color:white; text-decoration:none; 
                                      padding:8px 15px; border-radius:5px; font-weight:bold;
                                      transition:all 0.2s; font-size:11px; border:none;'>
                                <span style='margin-right:6px; font-size:14px;'>ğŸš—</span>
                                Yol Tarifi Al
                            </a>
                        </div>
                        
                        <!-- KOORDÄ°NAT -->
                        <div style='margin-top:10px; font-size:10px; color:#7f8c8d; text-align:center; padding-top:8px; border-top:1px dashed #bdc3c7;'>
                            Koordinat: 
                            <span style='font-family:monospace; background:#f8f9fa; padding:3px 6px; 
                                         border-radius:3px; cursor:pointer; font-size:9px; border:1px solid #ecf0f1;' 
                                 onclick='navigator.clipboard.writeText("{lat:.6f}, {lon:.6f}")'>
                                {lat:.6f}, {lon:.6f}
                            </span>
                        </div>
                    </div>
                    """
                    
                    # Popup boyutu
                    max_popup_width = 320
                    
                    marker = folium.Marker(
                        location=[lat, lon],
                        popup=folium.Popup(popup_html, max_width=max_popup_width),
                        icon=folium.Icon(color=en_oncelikli_renk, icon=icon_name, prefix='fa')
                    )
                    
                    marker.add_to(marker_layer)
                    eklenen += 1
                    
                except Exception as e:
                    print(f"Grup marker ekleme hatasÄ± {grup_anahtari}: {e}")
                    continue
            
            # Layer kontrol
            folium.LayerControl(collapsed=False, position='topright').add_to(harita)
            
            # HaritayÄ± kaydet
            harita.save(self.harita_html_path)
            self.map_temp_html = self.harita_html_path
            
            # HTML dosyasÄ±na JavaScript ekle
            self.html_dosyasina_javascript_ekle_konumlu(self.harita_html_path)
            
            # HaritayÄ± gÃ¶ster
            self.harita_goster_embed(self.map_temp_html)
            
            # Ä°statistikleri gÃ¼ncelle
            current_info = self.bilgi_var.get()
            new_info = f"{current_info} | âœ… {eklenen} grup marker eklendi ({len(df_map)} kayÄ±t gruplandÄ±)"
            self.bilgi_var.set(new_info)
            
            print(f"âœ… {eklenen} grup marker eklendi (Toplam {len(df_map)} kayÄ±t)")
            
        except Exception as e:
            self.bilgi_var.set(f"âŒ Harita oluÅŸturma hatasÄ±: {str(e)}")
            print(f"Harita oluÅŸturma hatasÄ±: {e}")
            import traceback
            traceback.print_exc()

    def html_dosyasina_javascript_ekle_konumlu(self, html_yolu):
        """HTML dosyasÄ±na anlÄ±k konum Ã¶zelliÄŸi ekler (Folium uyumlu)"""
        try:
            with open(html_yolu, 'r', encoding='utf-8') as file:
                html_icerik = file.read()

            javascript_ekle = """
    <script>
    var userLocationMarker = null;
    var userLocationCircle = null;
    var watchId = null;
    var map = null;

    // Folium haritasÄ±nÄ± BUL (EN KRÄ°TÄ°K DÃœZELTME)
    document.addEventListener("DOMContentLoaded", function () {
        for (var key in window) {
            if (key.startsWith("map_") && window[key] instanceof L.Map) {
                map = window[key];
                console.log("Folium haritasÄ± bulundu:", key);
                createLocationButton();
                return;
            }
        }
        console.error("Folium haritasÄ± bulunamadÄ±!");
    });

    // Konum butonu
    function createLocationButton() {
        var LocationControl = L.Control.extend({
            options: { position: 'topleft' },

            onAdd: function () {
                var container = L.DomUtil.create('div', 'leaflet-bar');
                container.style.background = 'white';

                var btn = L.DomUtil.create('a', '', container);
                btn.innerHTML = 'ğŸ“';
                btn.style.width = '36px';
                btn.style.height = '36px';
                btn.style.lineHeight = '36px';
                btn.style.textAlign = 'center';
                btn.style.cursor = 'pointer';
                btn.title = 'Konumumu GÃ¶ster';

                btn.onclick = function (e) {
                    e.preventDefault();
                    getUserLocation();
                };
                return container;
            }
        });

        map.addControl(new LocationControl());
    }

    // Konumu al
    function getUserLocation() {
        if (!navigator.geolocation) {
            alert("TarayÄ±cÄ± konum desteklemiyor");
            return;
        }

        navigator.geolocation.getCurrentPosition(
            function (pos) {
                showUserLocation(
                    pos.coords.latitude,
                    pos.coords.longitude,
                    pos.coords.accuracy
                );
                startTracking();
            },
            function (err) {
                alert("Konum alÄ±namadÄ±: " + err.message);
            },
            { enableHighAccuracy: true }
        );
    }

    // Haritada gÃ¶ster
    function showUserLocation(lat, lng, acc) {
        if (userLocationMarker) map.removeLayer(userLocationMarker);
        if (userLocationCircle) map.removeLayer(userLocationCircle);

        userLocationMarker = L.circleMarker([lat, lng], {
            radius: 8,
            color: '#4285F4',
            fillColor: '#4285F4',
            fillOpacity: 1
        }).addTo(map);

        userLocationCircle = L.circle([lat, lng], {
            radius: acc,
            color: '#4285F4',
            fillOpacity: 0.15
        }).addTo(map);

        map.setView([lat, lng], 16);
    }

    // CanlÄ± takip
    function startTracking() {
        watchId = navigator.geolocation.watchPosition(function (pos) {
            var lat = pos.coords.latitude;
            var lng = pos.coords.longitude;
            var acc = pos.coords.accuracy;

            userLocationMarker.setLatLng([lat, lng]);
            userLocationCircle.setLatLng([lat, lng]);
            userLocationCircle.setRadius(acc);
        });
    }
    </script>
    """

            if "</body>" in html_icerik:
                html_icerik = html_icerik.replace("</body>", javascript_ekle + "</body>")
            else:
                html_icerik += javascript_ekle

            with open(html_yolu, 'w', encoding='utf-8') as file:
                file.write(html_icerik)

            print("âœ… Konum JS baÅŸarÄ±yla eklendi")

        except Exception as e:
            print("âŒ Hata:", e)


    
    def harita_goster_embed(self, html_yolu):
        """HaritayÄ± PyQt6 ile gÃ¶mÃ¼lÃ¼ olarak gÃ¶sterir - GÃœVENLÄ°"""
        try:
            # ğŸ”´ 1) Ã–NCE ESKÄ° HARÄ°TA WIDGETâ€™LARINI TEMÄ°ZLE
            for w in self.map_frame.winfo_children():
                w.destroy()

            # ğŸ”´ 2) ESKÄ° PyQt WIDGET VARSA KAPAT
            if hasattr(self, 'pyqt_widget') and self.pyqt_widget:
                try:
                    self.pyqt_widget.close()
                except:
                    pass
                self.pyqt_widget = None

            # ğŸ”´ 3) PyQt6 KONTROLÃœ (LAZY)
            if not self.check_pyqt_availability():
                self.harita_basit_hata_goster(
                    "Harita gÃ¶mÃ¼lÃ¼ gÃ¶sterimi iÃ§in 'PyQt6' gerekli.\n\n"
                    "Kurulum iÃ§in:\n"
                    "1. Terminali aÃ§Ä±n\n"
                    "2. Åu komutu Ã§alÄ±ÅŸtÄ±rÄ±n: pip install PyQt6 PyQt6-WebEngine\n"
                    "3. UygulamayÄ± yeniden baÅŸlatÄ±n",
                    html_yolu
                )
                return

            # ğŸ”´ 4) PyQt6'YI GÃœVENLÄ° BAÅLAT
            self.guvenli_pyqt_baslat(html_yolu)

        except Exception as e:
            self.bilgi_var.set(f"âŒ Harita gÃ¶sterim hatasÄ±: {str(e)}")
            import traceback
            print(f"Harita gÃ¶sterme hatasÄ±: {traceback.format_exc()}")

            # ğŸ”´ 5) HATA DURUMUNDA FALLBACK
            self.harita_basit_hata_goster(str(e), html_yolu)

    
    def guvenli_pyqt_baslat(self, html_yolu):
        """PyQt6'yÄ± gÃ¼venli ÅŸekilde baÅŸlatÄ±r"""
        try:
            from PyQt6.QtWidgets import QApplication
            from PyQt6.QtCore import QTimer
            
            # EÄŸer QApplication yoksa oluÅŸtur
            if QApplication.instance() is None:
                import sys
                self.qt_app = QApplication(sys.argv)
                self.qt_app.setQuitOnLastWindowClosed(False)  # Ã–nemli!
            
            # Widget'Ä± oluÅŸtur
            self.create_pyqt_map_widget(html_yolu)
            
            # Event loop'u gÃ¼venli baÅŸlat
            self.start_safe_qt_timer()
            
        except Exception as e:
            print(f"PyQt6 gÃ¼venli baÅŸlatma hatasÄ±: {e}")
            raise
    
    def start_safe_qt_timer(self):
        """GÃ¼venli Qt event loop timer'Ä±"""
        def process_qt_events():
            try:
                from PyQt6.QtWidgets import QApplication
                if QApplication.instance():
                    QApplication.instance().processEvents()
            except:
                pass
            
            # Timer'Ä± devam ettir
            if hasattr(self, 'pyqt_widget') and self.pyqt_widget:
                self.after(100, process_qt_events)
        
        # Ä°lk timer'Ä± baÅŸlat
        self.after(100, process_qt_events)
    
    def create_pyqt_map_widget(self, html_yolu):
        """PyQt6 tabanlÄ± harita widget'Ä±nÄ± oluÅŸturur"""
        try:
            import sys
            from PyQt6.QtCore import Qt, QUrl, QTimer, QSize, QPoint
            from PyQt6.QtWidgets import QApplication, QWidget, QVBoxLayout, QSizePolicy, QHBoxLayout
            from PyQt6.QtWebEngineWidgets import QWebEngineView
            from PyQt6.QtWebEngineCore import QWebEngineSettings
            
            # PyQt6 uygulamasÄ± yoksa oluÅŸtur
            if QApplication.instance() is None:
                self.qt_app = QApplication(sys.argv)
            
            # PyQt widget'Ä±nÄ± oluÅŸtur
            class PyQtMapWidget(QWidget):
                def __init__(self, parent=None, html_path=None):
                    super().__init__(parent, Qt.WindowType.Window)
                    self.html_path = html_path
                    self.setup_ui()
                    # Pencerenin border'Ä±nÄ± kaldÄ±r
                    self.setWindowFlag(Qt.WindowType.FramelessWindowHint)
                    
                def setup_ui(self):
                    # Ana layout
                    main_layout = QVBoxLayout(self)
                    main_layout.setContentsMargins(0, 0, 0, 0)
                    main_layout.setSpacing(0)
                    
                    # WebView oluÅŸtur
                    self.view = QWebEngineView()
                    self.view.settings().setAttribute(QWebEngineSettings.WebAttribute.LocalContentCanAccessRemoteUrls, True)
                    self.view.settings().setAttribute(QWebEngineSettings.WebAttribute.LocalContentCanAccessFileUrls, True)
                    self.view.settings().setAttribute(QWebEngineSettings.WebAttribute.JavascriptEnabled, True)
                    self.view.settings().setAttribute(QWebEngineSettings.WebAttribute.AllowRunningInsecureContent, True)
                    
                    # HTML dosyasÄ±nÄ± yÃ¼kle
                    if self.html_path:
                        self.view.load(QUrl.fromLocalFile(os.path.abspath(self.html_path)))
                    
                    # Layout'a ekle
                    main_layout.addWidget(self.view)
                    
                def sizeHint(self):
                    return QSize(800, 600)
            
            # PyQt widget'Ä±nÄ± oluÅŸtur ve tkinter'e gÃ¶m
            container = tk.Frame(self.map_frame, bg="black")
            container.pack(fill='both', expand=True, padx=0, pady=0)
            
            # Widget ID'sini al
            wid = container.winfo_id()
            
            # PyQt widget'Ä±nÄ± oluÅŸtur ve gÃ¶m
            self.pyqt_widget = PyQtMapWidget(None, html_yolu)
            self.pyqt_widget.show()
            
            # Windows iÃ§in pencere tanÄ±tÄ±cÄ±yÄ± ayarla
            if sys.platform == "win32":
                import ctypes
                
                # PyQt penceresini Tkinter konteynerÄ±na gÃ¶m
                try:
                    # Get the window handles
                    pyqt_hwnd = int(self.pyqt_widget.winId())
                    tk_hwnd = int(wid)
                    
                    # Set parent window
                    ctypes.windll.user32.SetParent(pyqt_hwnd, tk_hwnd)
                    
                    # Pencerenin boyutunu gÃ¼ncelle (container'Ä±n tamamÄ±nÄ± kapla)
                    self.pyqt_widget.resize(container.winfo_width(), container.winfo_height())
                    
                    # Window style'Ä± ayarla (border kaldÄ±r)
                    GWL_STYLE = -16
                    WS_CHILD = 0x40000000
                    WS_VISIBLE = 0x10000000
                    style = WS_CHILD | WS_VISIBLE
                    ctypes.windll.user32.SetWindowLongW(pyqt_hwnd, GWL_STYLE, style)
                    
                    # Pencerenin pozisyonunu (0,0) yap
                    SWP_NOZORDER = 0x0004
                    SWP_NOACTIVATE = 0x0010
                    SWP_FRAMECHANGED = 0x0020
                    ctypes.windll.user32.SetWindowPos(
                        pyqt_hwnd, 0, 0, 0, 
                        container.winfo_width(), container.winfo_height(),
                        SWP_NOZORDER | SWP_NOACTIVATE | SWP_FRAMECHANGED
                    )
                    
                    print(f"âœ… Widget baÅŸarÄ±yla gÃ¶mÃ¼ldÃ¼. Boyut: {container.winfo_width()}x{container.winfo_height()}")
                    
                except Exception as win_error:
                    print(f"âš ï¸ Windows gÃ¶mme hatasÄ±: {win_error}")
                    # Fallback: pencerenin boyutunu ayarla
                    self.pyqt_widget.resize(container.winfo_width(), container.winfo_height())
            
            # Boyut deÄŸiÅŸikliklerini takip et
            def update_size(event=None):
                try:
                    if hasattr(self, 'pyqt_widget') and self.pyqt_widget:
                        width = container.winfo_width()
                        height = container.winfo_height()
                        
                        if width > 0 and height > 0:
                            # PyQt widget boyutunu gÃ¼ncelle
                            self.pyqt_widget.resize(width, height)
                            
                            # Windows iÃ§in ekstra ayar
                            if sys.platform == "win32":
                                try:
                                    pyqt_hwnd = int(self.pyqt_widget.winId())
                                    SWP_NOZORDER = 0x0004
                                    SWP_NOACTIVATE = 0x0010
                                    ctypes.windll.user32.SetWindowPos(
                                        pyqt_hwnd, 0, 0, 0, width, height,
                                        SWP_NOZORDER | SWP_NOACTIVATE
                                    )
                                except:
                                    pass
                            
                            print(f"ğŸ”„ Boyut gÃ¼ncellendi: {width}x{height}")
                except Exception as size_error:
                    print(f"âš ï¸ Boyut gÃ¼ncelleme hatasÄ±: {size_error}")
            
            # Ä°lk boyutu ayarla
            container.after(100, lambda: update_size())
            
            # Configure event'ini baÄŸla
            container.bind('<Configure>', update_size)
            
            # Container yeniden boyutlandÄ±rÄ±ldÄ±ÄŸÄ±nda
            def on_container_configure(event):
                update_size(event)
            
            container.bind('<Configure>', on_container_configure)
            
            # Qt event loop'unu Ã§alÄ±ÅŸtÄ±rmak iÃ§in timer
            self.start_qt_timer()
            
        except Exception as e:
            print(f"PyQt widget oluÅŸturma hatasÄ±: {e}")
            import traceback
            print(f"ğŸ” Hata detayÄ±: {traceback.format_exc()}")
            self.harita_basit_hata_goster(f"PyQt6 hatasÄ±: {str(e)}", html_yolu)
    
    def start_qt_timer(self):
        """PyQt event loop'unu Ã§alÄ±ÅŸtÄ±rmak iÃ§in timer baÅŸlat"""
        try:
            from PyQt6.QtWidgets import QApplication
            
            def process_qt_events():
                try:
                    if QApplication.instance():
                        QApplication.instance().processEvents()
                except:
                    pass
                
                # Timer'Ä± sÃ¼rekli Ã§alÄ±ÅŸtÄ±r
                self.after(50, process_qt_events)
            
            # Ä°lk timer'Ä± baÅŸlat
            self.after(50, process_qt_events)
            
        except Exception as e:
            print(f"Qt timer hatasÄ±: {e}")
    
    def harita_basit_hata_goster(self, hata_mesaji, html_yolu=None):
        """Basit hata mesajÄ± gÃ¶sterimi"""
        # Ã–nceki widget'larÄ± temizle
        for w in self.map_frame.winfo_children():
            w.destroy()
        
        yolu = html_yolu if html_yolu else self.map_temp_html
        
        # Bilgi paneli oluÅŸtur
        info_frame = tk.Frame(self.map_frame, bg="white")
        info_frame.pack(fill='both', expand=True, padx=20, pady=20)
        
        tk.Label(info_frame, text="ğŸŒ HARÄ°TA BÄ°LGÄ°SÄ°", 
                 font=('Segoe UI', 14, 'bold'), bg="white").pack(pady=10)
        
        # Hata mesajÄ±nÄ± gÃ¶ster
        tk.Label(info_frame, text="Harita gÃ¶rÃ¼ntÃ¼lenemiyor:", 
                font=('Segoe UI', 10, 'bold'), bg="white").pack()
        
        hata_label = tk.Label(info_frame, text=hata_mesaji, 
                             font=('Segoe UI', 9), bg="#ffebee", fg="#c62828",
                             relief='sunken', padx=10, pady=5,
                             wraplength=600, justify='left')
        hata_label.pack(pady=10, fill='x')
        
        # HTML yolunu gÃ¶ster
        if yolu and os.path.exists(yolu):
            tk.Label(info_frame, text=f"Harita dosyasÄ±:", 
                    font=('Segoe UI', 10), bg="white").pack()
            
            path_label = tk.Label(info_frame, text=yolu, 
                                 font=('Consolas', 9), bg="#f0f0f0",
                                 relief='sunken', padx=10, pady=5,
                                 wraplength=600, justify='left')
            path_label.pack(pady=10, fill='x')
        
        # Butonlar
        btn_frame = tk.Frame(info_frame, bg="white")
        btn_frame.pack(pady=20)
        
        if yolu and os.path.exists(yolu):
            tk.Button(btn_frame, text="ğŸŒ HaritayÄ± TarayÄ±cÄ±da AÃ§",
                     command=lambda: self.harita_tarayiciya_ac(yolu),
                     bg="#3498db", fg='white', font=('Segoe UI', 10),
                     width=20, height=2).pack(side='left', padx=10)
        
        tk.Button(btn_frame, text="ğŸ”„ HaritayÄ± Yenile",
                 command=self.harita_olustur,
                 bg="#27ae60", fg='white', font=('Segoe UI', 10),
                 width=20, height=2).pack(side='left', padx=10)
    
    def harita_tarayiciya_ac(self, html_yolu=None):
        """HaritayÄ± tarayÄ±cÄ±da aÃ§ar"""
        try:
            yolu = html_yolu if html_yolu else self.map_temp_html
            if yolu and os.path.exists(yolu):
                import webbrowser
                webbrowser.open(f'file://{os.path.abspath(yolu)}')
            else:
                messagebox.showwarning("UyarÄ±", "Harita dosyasÄ± bulunamadÄ±!")
        except Exception as e:
            messagebox.showerror("Hata", f"TarayÄ±cÄ± aÃ§ma hatasÄ±: {str(e)}")


class ExcelSecimDialog(tk.Toplevel):
    def __init__(self, parent):
        super().__init__(parent)
        self.parent = parent
        self.title("Excel DosyalarÄ±nÄ± SeÃ§in")
        self.geometry("900x400")
        self.configure(bg="#2c3e50")
        self.resizable(False, False)
        
        self.transient(parent)
        self.grab_set()
        
        self.direk_musterek_yolu = None
        self.direk_og_yolu = None
        
        self.arayuz_olustur()
        
        self.geometry("+%d+%d" % (
            parent.winfo_rootx() + parent.winfo_width() // 2 - 300,
            parent.winfo_rooty() + parent.winfo_height() // 2 - 150
        ))
    
    def arayuz_olustur(self):
        baslik_frame = tk.Frame(self, bg="#3498db", height=50)
        baslik_frame.pack(fill='x', padx=1, pady=1)
        baslik_frame.pack_propagate(False)
        
        baslik_label = tk.Label(baslik_frame, text="ğŸ“Š Excel DosyalarÄ±nÄ± SeÃ§in", 
                               font=('Segoe UI', 14, 'bold'),
                               fg='white', bg="#3498db")
        baslik_label.pack(expand=True, pady=10)
        
        aciklama_label = tk.Label(baslik_frame, 
                                 text="LÃ¼tfen aÅŸaÄŸÄ±daki Excel dosyalarÄ±nÄ± seÃ§in. Bu dosyalardaki direk numaralarÄ± ana Excel'de iÅŸaretlenecektir.",
                                 font=('Segoe UI', 10),
                                 fg='white', bg="#3498db", wraplength=550)
        aciklama_label.pack(expand=True, pady=(0, 10))
        
        main_frame = tk.Frame(self, bg="#2c3e50", padx=20, pady=20)
        main_frame.pack(fill='both', expand=True, padx=10, pady=10)
        
        # MÃ¼ÅŸterek Direk Excel seÃ§imi
        musterek_frame = tk.LabelFrame(main_frame, text="ğŸ”— MÃ¼ÅŸterek Direk Excel DosyasÄ±", 
                                      font=('Segoe UI', 11, 'bold'),
                                      fg='white', bg="#34495e", padx=15, pady=15)
        musterek_frame.pack(fill='x', pady=(0, 15))
        
        musterek_inner = tk.Frame(musterek_frame, bg="#34495e")
        musterek_inner.pack(fill='x')
        
        self.musterek_var = tk.StringVar(value="SeÃ§ilmedi")
        musterek_label = tk.Label(musterek_inner, textvariable=self.musterek_var,
                                 font=('Segoe UI', 9), fg="#ecf0f1", bg="#34495e",
                                 wraplength=400, justify='left')
        musterek_label.pack(side='left', fill='x', expand=True, padx=(0, 10))
        
        musterek_btn = tk.Button(musterek_inner, text="Dosya SeÃ§", 
                                font=('Segoe UI', 10, 'bold'),
                                bg="#3498db", fg='white', relief='raised',
                                command=self.musterek_sec, width=12)
        musterek_btn.pack(side='right')
        
        # OG Direk Excel seÃ§imi
        og_frame = tk.LabelFrame(main_frame, text="âš¡ OG Direk Excel DosyasÄ±", 
                                font=('Segoe UI', 11, 'bold'),
                                fg='white', bg="#34495e", padx=15, pady=15)
        og_frame.pack(fill='x', pady=(0, 20))
        
        og_inner = tk.Frame(og_frame, bg="#34495e")
        og_inner.pack(fill='x')
        
        self.og_var = tk.StringVar(value="SeÃ§ilmedi")
        og_label = tk.Label(og_inner, textvariable=self.og_var,
                           font=('Segoe UI', 9), fg="#ecf0f1", bg="#34495e",
                           wraplength=400, justify='left')
        og_label.pack(side='left', fill='x', expand=True, padx=(0, 10))
        
        og_btn = tk.Button(og_inner, text="Dosya SeÃ§", 
                          font=('Segoe UI', 10, 'bold'),
                          bg="#3498db", fg='white', relief='raised',
                          command=self.og_sec, width=12)
        og_btn.pack(side='right')
        
        # Bilgi notu
        info_frame = tk.Frame(main_frame, bg="#2c3e50")
        info_frame.pack(fill='x', pady=(10, 0))
        
        info_text = ("â€¢ MÃ¼ÅŸterek Direk Excel'inde bulunan direkler 'MÃ¼ÅŸterek Direk' olarak iÅŸaretlenecek\n"
                    "â€¢ OG Direk Excel'inde bulunan direkler 'Og Direk' olarak iÅŸaretlenecek\n"
                    "â€¢ Her iki dosyada da bulunmayan direkler boÅŸ bÄ±rakÄ±lacak")
        
        info_label = tk.Label(info_frame, text=info_text,
                             font=('Segoe UI', 9), fg="#bdc3c7", bg="#2c3e50",
                             justify='left')
        info_label.pack(anchor='w')
        
        # Butonlar
        buton_frame = tk.Frame(self, bg="#2c3e50", pady=15)
        buton_frame.pack(fill='x', padx=20)
        
        tk.Button(buton_frame, text="Ä°ÅŸlemi BaÅŸlat", font=('Segoe UI', 11, 'bold'),
                 bg="#27ae60", fg='white', relief='raised',
                 command=self.onayla, width=15).pack(side='left', padx=10)
        
        tk.Button(buton_frame, text="Ä°ptal", font=('Segoe UI', 11, 'bold'),
                bg="#e74c3c", fg='white', relief='raised',
                command=self.iptal, width=15).pack(side='right', padx=10)
    
    def musterek_sec(self):
        dosya = filedialog.askopenfilename(
            title="MÃ¼ÅŸterek Direk Excel DosyasÄ±nÄ± SeÃ§in",
            filetypes=[("Excel dosyalarÄ±", "*.xlsx *.xls"), ("TÃ¼m dosyalar", "*.*")]
        )
        if dosya:
            self.direk_musterek_yolu = dosya
            self.musterek_var.set(os.path.basename(dosya))
    
    def og_sec(self):
        dosya = filedialog.askopenfilename(
            title="OG Direk Excel DosyasÄ±nÄ± SeÃ§in",
            filetypes=[("Excel dosyalarÄ±", "*.xlsx *.xls"), ("TÃ¼m dosyalar", "*.*")]
        )
        if dosya:
            self.direk_og_yolu = dosya
            self.og_var.set(os.path.basename(dosya))
    
    def onayla(self):
        if not self.direk_musterek_yolu and not self.direk_og_yolu:
            messagebox.showwarning("UyarÄ±", "En az bir Excel dosyasÄ± seÃ§melisiniz!")
            return
        
        self.destroy()
    
    def iptal(self):
        self.direk_musterek_yolu = None
        self.direk_og_yolu = None
        self.destroy()

class TakvimDialog(tk.Toplevel):
    def __init__(self, parent, baslik="Tarih SeÃ§in"):
        super().__init__(parent)
        self.parent = parent
        self.baslik = baslik
        self.secili_tarih = None
        
        self.title(baslik)
        self.geometry("300x280")
        self.configure(bg="#2c3e50")
        self.resizable(False, False)
        
        self.transient(parent)
        self.grab_set()
        
        self.arayuz_olustur()
        
        self.geometry("+%d+%d" % (
            parent.winfo_rootx() + parent.winfo_width() // 2 - 150,
            parent.winfo_rooty() + parent.winfo_height() // 2 - 140
        ))
        
    def arayuz_olustur(self):
        baslik_frame = tk.Frame(self, bg="#3498db", height=40)
        baslik_frame.pack(fill='x', padx=1, pady=1)
        baslik_frame.pack_propagate(False)
        
        baslik_label = tk.Label(baslik_frame, text=self.baslik, 
                               font=('Segoe UI', 12, 'bold'),
                               fg='white', bg="#3498db")
        baslik_label.pack(expand=True)
        
        takvim_frame = tk.Frame(self, bg="#2c3e50", padx=10, pady=10)
        takvim_frame.pack(fill='both', expand=True, padx=10, pady=10)
        
        self.takvim = Calendar(takvim_frame, 
                              selectmode='day',
                              date_pattern='dd/mm/yyyy',
                              font=('Segoe UI', 10),
                              background='#34495e',
                              foreground='white',
                              selectbackground='#3498db',
                              normalbackground='#34495e',
                              weekendbackground='#2c3e50',
                              weekendforeground='white',
                              bordercolor='#7f8c8d',
                              headersbackground='#3498db',
                              headersforeground='white',
                              showweeknumbers=False,
                              firstweekday='monday')
        self.takvim.pack(fill='both', expand=True)
        
        buton_frame = tk.Frame(self, bg="#2c3e50", pady=10)
        buton_frame.pack(fill='x', padx=20)
        
        tk.Button(buton_frame, text="SeÃ§", font=('Segoe UI', 10, 'bold'),
                 bg="#27ae60", fg='white', relief='raised',
                 command=self.tarih_sec, width=10).pack(side='left', padx=5)
        
        tk.Button(buton_frame, text="Ä°ptal", font=('Segoe UI', 10, 'bold'),
                 bg="#e74c3c", fg='white', relief='raised',
                 command=self.iptal, width=10).pack(side='right', padx=5)
        
        tk.Button(buton_frame, text="BugÃ¼n", font=('Segoe UI', 10, 'bold'),
                 bg="#3498db", fg='white', relief='raised',
                 command=self.bugun_sec, width=10).pack(side='right', padx=5)
    
    def tarih_sec(self):
        self.secili_tarih = self.takvim.get_date()
        self.destroy()
    
    def iptal(self):
        self.secili_tarih = None
        self.destroy()
    
    def bugun_sec(self):
        bugun = datetime.date.today()
        self.takvim.selection_set(bugun)

class ExifDateEditor(tk.Toplevel):
    def __init__(self, parent, klasor_yolu=None, secim_tipi="tumunu"):
        super().__init__(parent)
        self.parent = parent
        self.klasor_yolu = klasor_yolu
        self.secim_tipi = secim_tipi  # "tumunu" veya "tarihsizler"
        self.title("EXIF Tarih DÃ¼zenleyici - TÃ¼m FotoÄŸraflar")
        self.geometry("800x870")
        self.configure(bg="#2c3e50")
        
        # DeÄŸiÅŸkenler
        self.files_list = []
        self.tum_fotograflar = []
        self.secilen_fotograflar = []
        self.manuel_klasor_yolu = None  # YENÄ°: Manuel klasÃ¶r deÄŸiÅŸkeni
        
        self.setup_ui()
        
        if klasor_yolu:
            self.folder_path.set(klasor_yolu)
            self.manuel_klasor_yolu = klasor_yolu  # YENÄ°: Manuel klasÃ¶rÃ¼ ayarla
            self.tum_fotograflari_tara()
            
    def manuel_klasor_degistir(self):
        """Manuel olarak klasÃ¶r deÄŸiÅŸtirme - YENÄ° EKLENDÄ°"""
        yeni_klasor = filedialog.askdirectory(title="Yeni KlasÃ¶r SeÃ§in")
        if yeni_klasor:
            self.manuel_klasor_yolu = yeni_klasor
            self.folder_path.set(yeni_klasor)
            self.klasor_yolu = yeni_klasor  # Orijinal klasÃ¶r yolunu da gÃ¼ncelle
            self.log(f"ğŸ“ KlasÃ¶r deÄŸiÅŸtirildi: {yeni_klasor}")
            self.tum_fotograflari_tara()
            
    def klasoru_yenile(self):
        """KlasÃ¶rÃ¼ yeniden tarar ve mevcut modda kalÄ±r - GÃœNCELLENDÄ°"""
        if self.manuel_klasor_yolu:
            self.log("ğŸ”„ KlasÃ¶r yeniden taranÄ±yor...")
            # MEVCUT MODU KORUYARAK yeniden tarama yap
            self.tum_fotograflari_tara()
            
            # Mod bilgisini gÃ¼ncelle
            if self.secim_tipi == "tarihsizler":
                self.selection_info_var.set("ğŸ” Sadece tarihsiz fotoÄŸraflar gÃ¶steriliyor")
            else:
                self.selection_info_var.set("ğŸ” TÃ¼m fotoÄŸraflar gÃ¶steriliyor")
                
        else:
            messagebox.showwarning("UyarÄ±", "LÃ¼tfen Ã¶nce bir klasÃ¶r seÃ§in!")
            
    def listbox_sol_tik_olayi(self, event):
        """Listbox'ta sol tÄ±k olayÄ±nÄ± iÅŸler - DÃœZELTÄ°LDÄ°"""
        # Bu metod sadece seÃ§im deÄŸiÅŸikliklerini takip etmek iÃ§in
        # AsÄ±l seÃ§im iÅŸlemini Listbox'Ä±n kendisi yapacak
        self.after(10, self.secilenleri_guncelle)  # 10ms sonra seÃ§imleri gÃ¼ncelle

        
    def fotograf_detay_goster(self, event):
        """FotoÄŸraf detaylarÄ±nÄ± gÃ¶sterir - YENÄ° EKLENDÄ°"""
        secili_indeksler = self.foto_listbox.curselection()
        if not secili_indeksler:
            return
        
        ilk_secili = secili_indeksler[0]
        if ilk_secili < len(self.tum_fotograflar):
            foto_path = self.tum_fotograflar[ilk_secili]
            self.fotograf_detay_penceresi_ac(foto_path)

    def secilenleri_guncelle(self):
        """SeÃ§ilen fotoÄŸraflarÄ± gÃ¼nceller"""
        secili_indeksler = self.foto_listbox.curselection()
        self.secilen_fotograflar = [self.tum_fotograflar[i] for i in secili_indeksler]
        self.selected_var.set(f"SeÃ§ilen: {len(secili_indeksler)}")
        
    def tumunu_goster(self):
        """TÃ¼m fotoÄŸraflarÄ± gÃ¶ster - GÃœNCELLENDÄ°"""
        self.secim_tipi = "tumunu"
        self.selection_info_var.set("ğŸ” TÃ¼m fotoÄŸraflar gÃ¶steriliyor")
        self.log("ğŸ”„ TÃ¼m fotoÄŸraflar gÃ¶steriliyor...")
        self.tum_fotograflari_tara()

    def sadece_tarihsizleri_goster(self):
        """Sadece tarihsiz fotoÄŸraflarÄ± gÃ¶ster - GÃœNCELLENDÄ°"""
        self.secim_tipi = "tarihsizler"
        self.selection_info_var.set("ğŸ” Sadece tarihsiz fotoÄŸraflar gÃ¶steriliyor")
        self.log("ğŸ”„ Sadece tarihsiz fotoÄŸraflar gÃ¶steriliyor...")
        self.tum_fotograflari_tara()
        
        # EÄŸer tarihsiz fotoÄŸraf yoksa bilgi ver
        tarihsiz_sayisi = len([f for f in self.tum_fotograflar if not self.exif_tarihi_var_mi(f)])
        if tarihsiz_sayisi == 0:
            self.log("â„¹ï¸ Tarihsiz fotoÄŸraf bulunamadÄ±!")
        
    def setup_ui(self):
        # BaÅŸlÄ±k - SEÃ‡Ä°M TÄ°PÄ°NE GÃ–RE DEÄÄ°ÅSÄ°N
        baslik_metni = "ğŸ“… EXÄ°F TARÄ°H DÃœZENLEYÄ°CÄ° - "
        if self.secim_tipi == "tarihsizler":
            baslik_metni += "SADECE TARÄ°HSÄ°Z FOTOÄRAFLAR"
        else:
            baslik_metni += "TÃœM FOTOÄRAFLAR"
        
        title_label = tk.Label(self, text=baslik_metni, 
                             font=("Arial", 12, "bold"), bg="#2c3e50", fg="white")
        title_label.pack(pady=10)
        
        
        # KlasÃ¶r bilgisi - YENÄ°: Manuel klasÃ¶r deÄŸiÅŸtirme eklendi
        folder_frame = tk.LabelFrame(self, text="ğŸ“‚ KlasÃ¶r SeÃ§imi", bg="#34495e", fg="white")
        folder_frame.pack(pady=10, fill="x", padx=20)
        
        folder_inner_frame = tk.Frame(folder_frame, bg="#34495e")
        folder_inner_frame.pack(pady=10, padx=10, fill="x")
        
        self.folder_path = tk.StringVar()
        folder_entry = tk.Entry(folder_inner_frame, textvariable=self.folder_path, width=80, 
                               bg="#ecf0f1", fg="#2c3e50", state='readonly')
        folder_entry.pack(side="left", padx=5, fill="x", expand=True)
        
        # Manuel klasÃ¶r deÄŸiÅŸtirme butonu - YENÄ° EKLENDÄ°
        change_folder_btn = tk.Button(folder_inner_frame, text="KlasÃ¶r DeÄŸiÅŸtir", 
                                    command=self.manuel_klasor_degistir,
                                    bg="#3498db", fg="white", font=("Arial", 9, "bold"))
        change_folder_btn.pack(side="left", padx=5)
        
        # Yenile butonu - YENÄ° EKLENDÄ°
        refresh_btn = tk.Button(folder_inner_frame, text="Yenile", 
                              command=self.klasoru_yenile,
                              bg="#27ae60", fg="white", font=("Arial", 9, "bold"))
        refresh_btn.pack(side="left", padx=5)
        
        # Ä°statistikler
        stats_frame = tk.Frame(self, bg="#2c3e50")
        stats_frame.pack(pady=10, fill="x", padx=20)
        
        self.total_var = tk.StringVar(value="Toplam FotoÄŸraf: 0")
        self.no_date_var = tk.StringVar(value="Tarihsiz FotoÄŸraf: 0")
        self.selected_var = tk.StringVar(value="SeÃ§ilen: 0")
        
        tk.Label(stats_frame, textvariable=self.total_var, bg="#2c3e50", fg="#3498db", 
                font=("Arial", 10, "bold")).pack(side="left", padx=20)
        tk.Label(stats_frame, textvariable=self.no_date_var, bg="#2c3e50", fg="#e74c3c", 
                font=("Arial", 10, "bold")).pack(side="left", padx=20)
        tk.Label(stats_frame, textvariable=self.selected_var, bg="#2c3e50", fg="#27ae60", 
                font=("Arial", 10, "bold")).pack(side="left", padx=20)
        
        # SeÃ§im durumu bilgisi
        selection_info_frame = tk.Frame(self, bg="#2c3e50")
        selection_info_frame.pack(pady=5, fill="x", padx=20)
        
        self.selection_info_var = tk.StringVar()
        if self.secim_tipi == "tarihsizler":
            self.selection_info_var.set("ğŸ” Sadece tarihsiz fotoÄŸraflar gÃ¶steriliyor")
        else:
            self.selection_info_var.set("ğŸ” TÃ¼m fotoÄŸraflar gÃ¶steriliyor")
        
        selection_info_label = tk.Label(selection_info_frame, textvariable=self.selection_info_var,
                                      font=("Arial", 9, "bold"), bg="#2c3e50", fg="#f39c12")
        selection_info_label.pack()
        
        # Yeni tarih seÃ§imi ve butonlar iÃ§in ana Ã§erÃ§eve
        date_buttons_frame = tk.Frame(self, bg="#2c3e50")
        date_buttons_frame.pack(pady=10, fill="x", padx=20)
        
        # Sol taraf: Tarih seÃ§imi
        date_left_frame = tk.Frame(date_buttons_frame, bg="#2c3e50")
        date_left_frame.pack(side="left", fill="x", expand=True)
        
        date_frame = tk.LabelFrame(date_left_frame, text="ğŸ•’ Yeni Ã‡ekim Tarihi", bg="#34495e", fg="white")
        date_frame.pack(fill="x")
        
        inner_date_frame = tk.Frame(date_frame, bg="#34495e")
        inner_date_frame.pack(pady=15, padx=10)
        
        self.date_var = tk.StringVar(value=datetime.datetime.now().strftime("%Y:%m:%d"))
        self.time_var = tk.StringVar(value=datetime.datetime.now().strftime("%H:%M:%S"))
        
        # Tarih satÄ±rÄ±
        date_row = tk.Frame(inner_date_frame, bg="#34495e")
        date_row.pack(pady=5, fill="x")
        tk.Label(date_row, text="Tarih:", width=8, bg="#34495e", fg="white", 
                font=("Arial", 10, "bold")).pack(side="left")
        tk.Entry(date_row, textvariable=self.date_var, width=20, font=("Arial", 10),
                bg="#ecf0f1", fg="#2c3e50").pack(side="left", padx=5)
        tk.Label(date_row, text="(YYYY:AA:GG - Ã–rnek: 2024:12:31)", bg="#34495e", fg="white").pack(side="left", padx=5)
        
        # Saat satÄ±rÄ±
        time_row = tk.Frame(inner_date_frame, bg="#34495e")
        time_row.pack(pady=5, fill="x")
        tk.Label(time_row, text="Saat:", width=8, bg="#34495e", fg="white",
                font=("Arial", 10, "bold")).pack(side="left")
        tk.Entry(time_row, textvariable=self.time_var, width=20, font=("Arial", 10),
                bg="#ecf0f1", fg="#2c3e50").pack(side="left", padx=5)
        tk.Label(time_row, text="(SS:DD:SS - Ã–rnek: 14:30:25)", bg="#34495e", fg="white").pack(side="left", padx=5)
        
        
        # SaÄŸ taraf: Butonlar
        buttons_right_frame = tk.Frame(date_buttons_frame, bg="#2c3e50")
        buttons_right_frame.pack(side="right", padx=(20, 0))
        
        buttons_frame = tk.LabelFrame(buttons_right_frame, text="âš¡ Ä°ÅŸlemler", bg="#34495e", fg="white")
        buttons_frame.pack(fill="both", expand=True)
        
        buttons_inner_frame = tk.Frame(buttons_frame, bg="#34495e")
        buttons_inner_frame.pack(pady=15, padx=15)
        
        tk.Button(buttons_inner_frame, text="ğŸ”„ TÃ¼mÃ¼ne Tarih Ekle", 
                  command=self.tum_fotograflara_tarih_ekle, width=25, 
                  bg="#27ae60", fg="white", font=("Arial", 10, "bold")).pack(pady=5)
        
        tk.Button(buttons_inner_frame, text="ğŸ”„ SeÃ§ililere Tarih Ekle", 
                  command=self.secili_fotograflara_tarih_ekle, width=25,
                  bg="#3498db", fg="white", font=("Arial", 10, "bold")).pack(pady=5)
        
        # SeÃ§im deÄŸiÅŸtirme butonu - GÃœNCELLENDÄ°
        self.switch_button = tk.Button(buttons_inner_frame, text="", 
                                      command=self.secim_modunu_degistir, width=25,
                                      bg="#3498db", fg="white", font=("Arial", 10))
        self.switch_button.pack(pady=5)

        # Buton metnini ilk kez gÃ¼ncelle
        self.secim_buton_metnini_guncelle()

        tk.Button(buttons_inner_frame, text="ğŸ“Š Ä°statistikler", 
                  command=self.istatistikleri_goster, width=25,
                  bg="#f39c12", fg="white", font=("Arial", 10)).pack(pady=5)
        
        
        # FotoÄŸraf listesi
        list_frame = tk.LabelFrame(self, text="ğŸ“· FotoÄŸraf Listesi", bg="#34495e", fg="white", height=150)
        list_frame.pack(pady=10, fill="x", padx=20)
        list_frame.pack_propagate(False)

        list_inner_frame = tk.Frame(list_frame, bg="#34495e")
        list_inner_frame.pack(fill="both", expand=True, padx=10, pady=10)
        
        # Listbox ve scrollbar
        self.listbox_frame = tk.Frame(list_inner_frame, bg="#34495e")
        self.listbox_frame.pack(fill="both", expand=True)
        
        self.foto_listbox = tk.Listbox(self.listbox_frame, selectmode=tk.EXTENDED,  # DEÄÄ°ÅTÄ°: EXTENDED modu
                                      bg="#2c3e50", fg="#ecf0f1", font=("Consolas", 9),
                                      selectbackground="#3498db", selectforeground="white")
        
        scrollbar_y = ttk.Scrollbar(self.listbox_frame, orient="vertical", command=self.foto_listbox.yview)
        scrollbar_x = ttk.Scrollbar(self.listbox_frame, orient="horizontal", command=self.foto_listbox.xview)
        
        self.foto_listbox.configure(yscrollcommand=scrollbar_y.set, xscrollcommand=scrollbar_x.set)
        
        self.foto_listbox.pack(side="left", fill="both", expand=True)
        scrollbar_y.pack(side="right", fill="y")
        scrollbar_x.pack(side="bottom", fill="x")
        
        # YENÄ°: Ã‡ift tÄ±klama olayÄ± - fotoÄŸraf detayÄ± gÃ¶stermek iÃ§in
        self.foto_listbox.bind('<Double-1>', self.fotograf_detay_goster)
        
        # YENÄ°: Sol tÄ±k olayÄ± - seÃ§imleri gÃ¼ncellemek iÃ§in
        self.foto_listbox.bind('<Button-1>', self.listbox_sol_tik_olayi)
        
        # SeÃ§im butonlarÄ± - GÃœNCELLENDÄ°
        selection_frame = tk.Frame(list_inner_frame, bg="#34495e")
        selection_frame.pack(fill="x", pady=5)
        
        tk.Button(selection_frame, text="TÃ¼mÃ¼nÃ¼ SeÃ§", command=self.tumunu_sec,
                 bg="#3498db", fg="white", width=12).pack(side="left", padx=5)
        tk.Button(selection_frame, text="SeÃ§imi KaldÄ±r", command=self.secimi_kaldir,
                 bg="#e74c3c", fg="white", width=12).pack(side="left", padx=5)
        tk.Button(selection_frame, text="Tarihsizleri SeÃ§", command=self.tarihsizleri_sec,
                 bg="#f39c12", fg="white", width=14).pack(side="left", padx=5)
        tk.Button(selection_frame, text="Tarihlileri SeÃ§", command=self.tarihlileri_sec,
                 bg="#27ae60", fg="white", width=14).pack(side="left", padx=5)
        
        # Ä°lerleme Ã§ubuÄŸu
        progress_frame = tk.Frame(self, bg="#2c3e50")
        progress_frame.pack(pady=10, fill="x", padx=20)
        
        tk.Label(progress_frame, text="Ä°lerleme:", bg="#2c3e50", fg="white").pack(anchor="w")
        self.progress = ttk.Progressbar(progress_frame, orient="horizontal", length=760, mode="determinate")
        self.progress.pack(pady=5, fill="x")
        
        # Durum bilgisi
        self.status_var = tk.StringVar(value="TÃ¼m fotoÄŸraflar taranÄ±yor...")
        status_label = tk.Label(self, textvariable=self.status_var, foreground="#3498db", bg="#2c3e50")
        status_label.pack(pady=5)
        
        # Log alanÄ±
        log_frame = tk.LabelFrame(self, text="ğŸ“‹ Ä°ÅŸlem LoglarÄ±", bg="#34495e", fg="white", height=200)
        log_frame.pack(pady=10, fill="x", padx=20)
        log_frame.pack_propagate(False)

        log_inner_frame = tk.Frame(log_frame, bg="#34495e")
        log_inner_frame.pack(fill="both", expand=True, padx=10, pady=10)

        self.log_text = tk.Text(log_inner_frame, height=8, width=85, font=("Consolas", 9),
                               bg="#2c3e50", fg="#ecf0f1")

        scrollbar_log = ttk.Scrollbar(log_inner_frame, orient="vertical", command=self.log_text.yview)
        self.log_text.configure(yscrollcommand=scrollbar_log.set)

        self.log_text.pack(side="left", fill="both", expand=True)
        scrollbar_log.pack(side="right", fill="y")
        
        # BaÅŸlangÄ±Ã§ logu
        if self.secim_tipi == "tarihsizler":
            self.log("EXIF tarih dÃ¼zenleyici baÅŸlatÄ±ldÄ±. Sadece tarihsiz fotoÄŸraflar iÅŸlenecek.")
        else:
            self.log("EXIF tarih dÃ¼zenleyici baÅŸlatÄ±ldÄ±. TÃ¼m fotoÄŸraflar iÅŸlenecek.")


    def secim_buton_metnini_guncelle(self):
        """SeÃ§im deÄŸiÅŸtirme butonunun metnini gÃ¼nceller"""
        if self.secim_tipi == "tarihsizler":
            self.switch_button.config(text="ğŸ“· TÃ¼mÃ¼nÃ¼ GÃ¶ster", bg="#3498db")
        else:
            self.switch_button.config(text="ğŸ“… Sadece Tarihsizleri GÃ¶ster", bg="#f39c12")

    def secim_modunu_degistir(self):
        """SeÃ§im modunu deÄŸiÅŸtirir"""
        if self.secim_tipi == "tarihsizler":
            self.tumunu_goster()
        else:
            self.sadece_tarihsizleri_goster()
        
        self.secim_buton_metnini_guncelle()


    def tum_fotograflari_tara(self):
        """KlasÃ¶rdeki TÃœM fotoÄŸraflarÄ± tarar - SEÃ‡Ä°M TÄ°PÄ°NE GÃ–RE"""
        # Manuel klasÃ¶r yolunu kullan
        tarama_klasoru = self.manuel_klasor_yolu if self.manuel_klasor_yolu else self.klasor_yolu
        
        if not tarama_klasoru or not os.path.exists(tarama_klasoru):
            messagebox.showerror("Hata", "KlasÃ¶r bulunamadÄ±!")
            return
        
        self.log("ğŸ” TÃ¼m fotoÄŸraflar taranÄ±yor (alt klasÃ¶rler dahil)...")
        self.status_var.set("TÃ¼m fotoÄŸraflar taranÄ±yor...")
        
        # TÃ¼m fotoÄŸraflarÄ± bul - ALT KLASÃ–RLER DAHÄ°L
        foto_uzantilari = ('.jpg', '.jpeg', '.png', '.tiff', '.tif', '.bmp')
        tum_fotograflar = []
        tarihsiz_fotograflar = []
        tarihli_fotograflar = []
        
        # ALT KLASÃ–RLERÄ° DE TARA
        for root, dirs, files in os.walk(tarama_klasoru):
            for dosya in files:
                if any(dosya.lower().endswith(ext) for ext in foto_uzantilari):
                    full_path = os.path.join(root, dosya)
                    tum_fotograflar.append(full_path)
                    
                    # Tarihsiz olanlarÄ± ve tarihli olanlarÄ± ayÄ±r
                    if not self.exif_tarihi_var_mi(full_path):
                        tarihsiz_fotograflar.append(full_path)
                    else:
                        tarihli_fotograflar.append(full_path)
        
        self.tum_fotograflar = tum_fotograflar
        
        # SEÃ‡Ä°M TÄ°PÄ°NE GÃ–RE FOTOÄRAFLARI BELÄ°RLE
        if self.secim_tipi == "tarihsizler":
            islenecek_fotograflar = tarihsiz_fotograflar
            self.log(f"ğŸ¯ Sadece tarihsiz fotoÄŸraflar seÃ§ildi")
            
            # EÄER TARÄ°HSÄ°Z FOTOÄRAF YOKSA OTOMATÄ°K TÃœMÃœNE DÃ–N
            if not tarihsiz_fotograflar:
                self.log("â„¹ï¸ Tarihsiz fotoÄŸraf bulunamadÄ±, tÃ¼m fotoÄŸraflar gÃ¶steriliyor...")
                islenecek_fotograflar = tum_fotograflar
                self.secim_tipi = "tumunu"  # Modu deÄŸiÅŸtir
                self.selection_info_var.set("ğŸ” TÃ¼m fotoÄŸraflar gÃ¶steriliyor (tarihsiz fotoÄŸraf yok)")
        else:
            islenecek_fotograflar = tum_fotograflar
            self.log(f"ğŸ¯ TÃ¼m fotoÄŸraflar seÃ§ildi")
        
        self.total_var.set(f"Toplam FotoÄŸraf: {len(tum_fotograflar)}")
        self.no_date_var.set(f"Tarihsiz FotoÄŸraf: {len(tarihsiz_fotograflar)}")
        self.selected_var.set(f"SeÃ§ilen: {len(islenecek_fotograflar)}")
        
        # Listbox'Ä± doldur
        self.foto_listbox.delete(0, tk.END)
        for foto_path in islenecek_fotograflar:
            dosya_adi = os.path.basename(foto_path)
            # GÃ¶reli yolu gÃ¶ster (ana klasÃ¶re gÃ¶re)
            try:
                goreli_yol = os.path.relpath(foto_path, tarama_klasoru)
                list_item = f"{goreli_yol}"
            except:
                list_item = dosya_adi
            
            # FotoÄŸrafÄ±n tarih bilgisini de gÃ¶ster
            tarih = self.fotograf_tarihini_al(foto_path)
            if tarih:
                tarih_str = tarih.strftime('%d/%m/%Y %H:%M')
                list_item += f" - {tarih_str}"
            else:
                list_item += " - TARÄ°HSÄ°Z"
            
            self.foto_listbox.insert(tk.END, list_item)
        
        # SEÃ‡Ä°M TÄ°PÄ°NE GÃ–RE OTOMATÄ°K SEÃ‡
        self.foto_listbox.selection_set(0, tk.END)
        self.secilen_fotograflar = islenecek_fotograflar.copy()
        
        self.log(f"âœ… Tarama tamamlandÄ±!")
        self.log(f"ğŸ“Š Toplam: {len(tum_fotograflar)} fotoÄŸraf")
        self.log(f"ğŸ“… Tarihli: {len(tarihli_fotograflar)} fotoÄŸraf")
        self.log(f"ğŸ“… Tarihsiz: {len(tarihsiz_fotograflar)} fotoÄŸraf")
        self.log(f"ğŸ¯ Ä°ÅŸlenecek: {len(islenecek_fotograflar)} fotoÄŸraf")
        self.log(f"ğŸ“ Ana KlasÃ¶r: {tarama_klasoru}")
        
        # EÄŸer tarihsiz modda ama tarihsiz fotoÄŸraf yoksa, buton metnini gÃ¼ncelle
        if self.secim_tipi == "tarihsizler" and not tarihsiz_fotograflar:
            self.selection_info_var.set("â„¹ï¸ Tarihsiz fotoÄŸraf bulunamadÄ±, tÃ¼m fotoÄŸraflar gÃ¶steriliyor")
        
        self.status_var.set(f"HazÄ±r - {len(islenecek_fotograflar)} fotoÄŸraf seÃ§ildi")


    def tumunu_sec(self):
        """TÃ¼m fotoÄŸraflarÄ± seÃ§er"""
        self.foto_listbox.selection_set(0, tk.END)
        secilen_sayisi = len(self.foto_listbox.curselection())
        self.secilen_fotograflar = [self.tum_fotograflar[i] for i in self.foto_listbox.curselection()]
        self.selected_var.set(f"SeÃ§ilen: {secilen_sayisi}")
        self.log(f"âœ“ {secilen_sayisi} fotoÄŸraf seÃ§ildi")

    def secimi_kaldir(self):
        """SeÃ§imi kaldÄ±rÄ±r"""
        self.foto_listbox.selection_clear(0, tk.END)
        self.secilen_fotograflar = []
        self.selected_var.set("SeÃ§ilen: 0")
        self.log("âœ— SeÃ§im kaldÄ±rÄ±ldÄ±")

    def fotograf_tarihini_al(self, dosya_yolu):
        """FotoÄŸrafÄ±n EXIF tarihini alÄ±r"""
        try:
            with Image.open(dosya_yolu) as img:
                exif_data = img.getexif()
                if exif_data:
                    # Ã–ncelikle Ã§ekilme tarihini ara
                    datetime_original = exif_data.get(36867)  # DateTimeOriginal
                    if not datetime_original:
                        datetime_original = exif_data.get(306)  # DateTime
                    
                    if datetime_original:
                        try:
                            return datetime.datetime.strptime(datetime_original, '%Y:%m:%d %H:%M:%S')
                        except ValueError:
                            try:
                                return datetime.datetime.strptime(datetime_original, '%Y-%m:%d %H:%M:%S')
                            except:
                                return None
                
                # Piexif ile de dene
                try:
                    exif_dict = piexif.load(dosya_yolu)
                    if piexif.ExifIFD.DateTimeOriginal in exif_dict['Exif']:
                        tarih_bytes = exif_dict['Exif'][piexif.ExifIFD.DateTimeOriginal]
                        tarih_str = tarih_bytes.decode('utf-8')
                        return datetime.datetime.strptime(tarih_str, '%Y:%m:%d %H:%M:%S')
                except:
                    pass
                
                return None
                
        except Exception as e:
            print(f"EXIF okuma hatasÄ± {dosya_yolu}: {e}")
            return None

    def exif_tarihi_var_mi(self, dosya_yolu):
        """Dosyada EXIF tarihi olup olmadÄ±ÄŸÄ±nÄ± kontrol eder"""
        try:
            with Image.open(dosya_yolu) as img:
                exif_data = img.getexif()
                if exif_data:
                    # EXIF tarih tag'lerini kontrol et
                    datetime_original = exif_data.get(36867)  # DateTimeOriginal
                    datetime_digitized = exif_data.get(36868)  # DateTimeDigitized
                    datetime_normal = exif_data.get(306)       # DateTime
                    
                    # Herhangi bir tarih varsa True dÃ¶ndÃ¼r
                    if datetime_original or datetime_digitized or datetime_normal:
                        return True
                
                # Piexif ile de kontrol et
                try:
                    exif_dict = piexif.load(dosya_yolu)
                    if exif_dict['Exif']:
                        if piexif.ExifIFD.DateTimeOriginal in exif_dict['Exif']:
                            return True
                        if piexif.ExifIFD.DateTimeDigitized in exif_dict['Exif']:
                            return True
                    if exif_dict['0th']:
                        if piexif.ImageIFD.DateTime in exif_dict['0th']:
                            return True
                except:
                    pass
                
                return False
                
        except Exception as e:
            self.log(f"âš ï¸ Tarih kontrol hatasÄ± {os.path.basename(dosya_yolu)}: {str(e)}")
            return False

    def tum_fotograflara_tarih_ekle(self):
        """TÃ¼m seÃ§ili fotoÄŸraflara tarih ekler - GÃœNCELLENMÄ°Å"""
        # Manuel klasÃ¶r yolunu kullan
        tarama_klasoru = self.manuel_klasor_yolu if self.manuel_klasor_yolu else self.klasor_yolu
        
        if not self.secilen_fotograflar:
            messagebox.showwarning("UyarÄ±", "LÃ¼tfen tarih eklemek iÃ§in fotoÄŸraf seÃ§in!")
            return
        
        if not self.date_var.get() or not self.time_var.get():
            messagebox.showwarning("UyarÄ±", "LÃ¼tfen tarih ve saat bilgisini girin!")
            return
        
        # Tarih formatÄ± kontrolÃ¼
        try:
            datetime.datetime.strptime(self.date_var.get(), "%Y:%m:%d")
            datetime.datetime.strptime(self.time_var.get(), "%H:%M:%S")
        except ValueError:
            messagebox.showerror("Hata", "Tarih veya saat formatÄ± hatalÄ±!\nTarih: YYYY:AA:GG\nSaat: SS:DD:SS")
            return
        
        new_datetime = f"{self.date_var.get().strip()} {self.time_var.get().strip()}"
        
        result = messagebox.askyesno("Onay", 
                                   f"{len(self.secilen_fotograflar)} fotoÄŸrafa tarih eklenecek:\n"
                                   f"Yeni Tarih: {new_datetime}\n\n"
                                   f"Devam etmek istiyor musunuz?")
        if not result:
            return
        
        self.log("ğŸ”„ TÃ¼m fotoÄŸraflara tarih ekleniyor...")
        self.log(f"ğŸ“… Yeni tarih: {new_datetime}")
        self.log(f"ğŸ“ Ä°ÅŸlem yapÄ±lan klasÃ¶r: {tarama_klasoru}")
        
        # Ä°lerleme Ã§ubuÄŸunu ayarla
        self.progress['maximum'] = len(self.secilen_fotograflar)
        self.progress['value'] = 0
        
        success_count = 0
        error_count = 0
        verified_count = 0
        
        for i, foto_path in enumerate(self.secilen_fotograflar):
            try:
                # Ã–nceki tarihi kaydet (log iÃ§in)
                previous_date = self.fotograf_tarihini_al(foto_path)
                previous_str = previous_date.strftime('%Y:%m:%d %H:%M:%S') if previous_date else "Tarihsiz"
                
                # GÃ¶reli yolu al (daha okunabilir log iÃ§in)
                try:
                    goreli_yol = os.path.relpath(foto_path, tarama_klasoru)
                    log_adi = goreli_yol
                except:
                    log_adi = os.path.basename(foto_path)
                
                # Tarihi gÃ¼ncelle
                if self.update_exif_date_advanced(foto_path, new_datetime):
                    # GÃ¼ncellemeyi doÄŸrula
                    if self.verify_exif_date(foto_path, new_datetime):
                        verified_count += 1
                        self.log(f"âœ… {log_adi} - Tarih deÄŸiÅŸtirildi: {previous_str} â†’ {new_datetime}")
                        success_count += 1
                    else:
                        error_count += 1
                        self.log(f"âŒ {log_adi} - Tarih doÄŸrulanamadÄ±!")
                else:
                    error_count += 1
                    self.log(f"âŒ {log_adi} - Tarih gÃ¼ncellenemedi!")
            
            except Exception as e:
                error_count += 1
                self.log(f"âŒ {os.path.basename(foto_path)} - Hata: {str(e)}")
            
            # Ä°lerleme Ã§ubuÄŸunu gÃ¼ncelle
            self.progress['value'] = i + 1
            self.status_var.set(f"Ä°ÅŸleniyor... {i+1}/{len(self.secilen_fotograflar)}")
            self.update()
        
        # SonuÃ§larÄ± gÃ¶ster
        self.log("=" * 50)
        self.log(f"ğŸ‰ Ä°ÅLEM TAMAMLANDI!")
        self.log(f"âœ… BaÅŸarÄ±lÄ±: {success_count} fotoÄŸraf")
        self.log(f"âœ… DoÄŸrulanan: {verified_count} fotoÄŸraf") 
        self.log(f"âŒ HatalÄ±: {error_count} fotoÄŸraf")
        self.log(f"ğŸ“ Ä°ÅŸlem yapÄ±lan: {tarama_klasoru}")
        self.log("=" * 50)
        
        messagebox.showinfo("TamamlandÄ±", 
                          f"Ä°ÅŸlem tamamlandÄ±!\n\n"
                          f"âœ… BaÅŸarÄ±lÄ±: {success_count} fotoÄŸraf\n"
                          f"âœ… DoÄŸrulanan: {verified_count} fotoÄŸraf\n"
                          f"âŒ HatalÄ±: {error_count} fotoÄŸraf\n\n"
                          f"Yeni tarih: {new_datetime}")
        
        self.status_var.set(f"TamamlandÄ± - BaÅŸarÄ±lÄ±: {success_count}, HatalÄ±: {error_count}")

    def update_exif_date_advanced(self, file_path, new_datetime):
        """EXIF tarihini gÃ¼ncellemek iÃ§in geliÅŸmiÅŸ ve gÃ¼venilir yÃ¶ntem"""
        try:
            # Dosya kontrolÃ¼
            if not os.path.exists(file_path):
                raise Exception(f"Dosya bulunamadÄ±: {file_path}")
            
            if not os.access(file_path, os.W_OK):
                raise Exception(f"Dosya yazÄ±labilir deÄŸil: {file_path}")
            
            # Yedek oluÅŸtur
            backup_path = file_path + '.backup'
            shutil.copy2(file_path, backup_path)
            
            try:
                # Tarih formatÄ±nÄ± kontrol et
                try:
                    datetime.datetime.strptime(new_datetime, '%Y:%m:%d %H:%M:%S')
                except ValueError:
                    raise Exception(f"GeÃ§ersiz tarih formatÄ±: {new_datetime}")
                
                # FotoÄŸrafÄ± PIL ile aÃ§
                with Image.open(file_path) as img:
                    # Mevcut EXIF verisini al veya yeni oluÅŸtur
                    exif_dict = {}
                    try:
                        exif_dict = piexif.load(img.info.get('exif', b''))
                    except:
                        exif_dict = {"0th": {}, "Exif": {}, "GPS": {}, "1st": {}, "Interop": {}}
                    
                    # Tarih bilgilerini byte formatÄ±na Ã§evir
                    new_datetime_bytes = new_datetime.encode('utf-8')
                    
                    # TÃ¼m tarih tag'lerini gÃ¼ncelle
                    # DateTimeOriginal (EXIF tag 36867)
                    exif_dict['Exif'][piexif.ExifIFD.DateTimeOriginal] = new_datetime_bytes
                    # DateTimeDigitized (EXIF tag 36868)
                    exif_dict['Exif'][piexif.ExifIFD.DateTimeDigitized] = new_datetime_bytes
                    # DateTime (Image tag 306)
                    exif_dict['0th'][piexif.ImageIFD.DateTime] = new_datetime_bytes
                    
                    # EXIF verisini byte'a Ã§evir
                    exif_bytes = piexif.dump(exif_dict)
                    
                    # FotoÄŸrafÄ± kaydet (orijinal formatÄ±nÄ± koru)
                    img_format = img.format
                    if img_format == 'JPEG':
                        # JPEG iÃ§in doÄŸrudan exif parametresi ile kaydet
                        img.save(file_path, "JPEG", quality=95, exif=exif_bytes)
                        self.log(f"âœ“ JPEG EXIF gÃ¼ncellendi: {os.path.basename(file_path)}")
                    else:
                        # DiÄŸer formatlar iÃ§in piexif.insert kullan
                        img.save(file_path, img_format)
                        piexif.insert(exif_bytes, file_path)
                        self.log(f"âœ“ {img_format} EXIF gÃ¼ncellendi: {os.path.basename(file_path)}")
                    
                    return True
                    
            except Exception as e:
                # Hata durumunda yedeÄŸi geri yÃ¼kle
                if os.path.exists(backup_path):
                    shutil.copy2(backup_path, file_path)
                raise Exception(f"EXIF gÃ¼ncellenemedi: {str(e)}")
            finally:
                # Yedek dosyayÄ± temizle
                if os.path.exists(backup_path):
                    try:
                        os.remove(backup_path)
                    except:
                        pass
                        
        except Exception as e:
            self.log(f"âŒ {os.path.basename(file_path)} - Hata: {str(e)}")
            return False

    def verify_exif_date(self, file_path, expected_datetime):
        """EXIF tarihinin doÄŸru gÃ¼ncellendiÄŸini doÄŸrular"""
        try:
            current_date = self.fotograf_tarihini_al(file_path)
            if current_date:
                current_str = current_date.strftime('%Y:%m:%d %H:%M:%S')
                return current_str == expected_datetime
            return False
        except:
            return False    

    def log(self, message):
        """Log mesajÄ±nÄ± ekrana yazar"""
        timestamp = datetime.datetime.now().strftime("%H:%M:%S")
        log_message = f"[{timestamp}] {message}\n"
        self.log_text.insert(tk.END, log_message)
        self.log_text.see(tk.END)
        self.update()


    def secili_fotograflara_tarih_ekle(self):
        """Sadece seÃ§ili fotoÄŸraflara tarih ekler - YENÄ° EKLENDÄ°"""
        secili_indeksler = self.foto_listbox.curselection()
        
        if not secili_indeksler:
            messagebox.showwarning("UyarÄ±", "LÃ¼tfen tarih eklemek iÃ§in fotoÄŸraf seÃ§in!")
            return
        
        self.secilen_fotograflar = [self.tum_fotograflar[i] for i in secili_indeksler]
        self.secili_fotograflari_isle()

    def secili_fotograflari_isle(self):
        """SeÃ§ili fotoÄŸraflarÄ± iÅŸler - YENÄ° EKLENDÄ°"""
        if not self.secilen_fotograflar:
            messagebox.showwarning("UyarÄ±", "LÃ¼tfen tarih eklemek iÃ§in fotoÄŸraf seÃ§in!")
            return
        
        if not self.date_var.get() or not self.time_var.get():
            messagebox.showwarning("UyarÄ±", "LÃ¼tfen tarih ve saat bilgisini girin!")
            return
        
        # Tarih formatÄ± kontrolÃ¼
        try:
            datetime.datetime.strptime(self.date_var.get(), "%Y:%m:%d")
            datetime.datetime.strptime(self.time_var.get(), "%H:%M:%S")
        except ValueError:
            messagebox.showerror("Hata", "Tarih veya saat formatÄ± hatalÄ±!\nTarih: YYYY:AA:GG\nSaat: SS:DD:SS")
            return
        
        new_datetime = f"{self.date_var.get().strip()} {self.time_var.get().strip()}"
        
        result = messagebox.askyesno("Onay", 
                                   f"{len(self.secilen_fotograflar)} seÃ§ili fotoÄŸrafa tarih eklenecek:\n"
                                   f"Yeni Tarih: {new_datetime}\n\n"
                                   f"Devam etmek istiyor musunuz?")
        if not result:
            return
        
        # Manuel klasÃ¶r yolunu kullan
        tarama_klasoru = self.manuel_klasor_yolu if self.manuel_klasor_yolu else self.klasor_yolu
        
        self.log("ğŸ”„ SeÃ§ili fotoÄŸraflara tarih ekleniyor...")
        self.log(f"ğŸ“… Yeni tarih: {new_datetime}")
        self.log(f"ğŸ“ Ä°ÅŸlem yapÄ±lan klasÃ¶r: {tarama_klasoru}")
        
        # Ä°lerleme Ã§ubuÄŸunu ayarla
        self.progress['maximum'] = len(self.secilen_fotograflar)
        self.progress['value'] = 0
        
        success_count = 0
        error_count = 0
        verified_count = 0
        
        for i, foto_path in enumerate(self.secilen_fotograflar):
            try:
                # Ã–nceki tarihi kaydet (log iÃ§in)
                previous_date = self.fotograf_tarihini_al(foto_path)
                previous_str = previous_date.strftime('%Y:%m:%d %H:%M:%S') if previous_date else "Tarihsiz"
                
                # GÃ¶reli yolu al (daha okunabilir log iÃ§in)
                try:
                    goreli_yol = os.path.relpath(foto_path, tarama_klasoru)
                    log_adi = goreli_yol
                except:
                    log_adi = os.path.basename(foto_path)
                
                # Tarihi gÃ¼ncelle
                if self.update_exif_date_advanced(foto_path, new_datetime):
                    # GÃ¼ncellemeyi doÄŸrula
                    if self.verify_exif_date(foto_path, new_datetime):
                        verified_count += 1
                        self.log(f"âœ… {log_adi} - Tarih deÄŸiÅŸtirildi: {previous_str} â†’ {new_datetime}")
                        success_count += 1
                    else:
                        error_count += 1
                        self.log(f"âŒ {log_adi} - Tarih doÄŸrulanamadÄ±!")
                else:
                    error_count += 1
                    self.log(f"âŒ {log_adi} - Tarih gÃ¼ncellenemedi!")
            
            except Exception as e:
                error_count += 1
                self.log(f"âŒ {os.path.basename(foto_path)} - Hata: {str(e)}")
            
            # Ä°lerleme Ã§ubuÄŸunu gÃ¼ncelle
            self.progress['value'] = i + 1
            self.status_var.set(f"Ä°ÅŸleniyor... {i+1}/{len(self.secilen_fotograflar)}")
            self.update()
        
        # SonuÃ§larÄ± gÃ¶ster
        self.log("=" * 50)
        self.log(f"ğŸ‰ SEÃ‡Ä°LÄ° FOTOÄRAFLAR Ä°ÅLEMÄ° TAMAMLANDI!")
        self.log(f"âœ… BaÅŸarÄ±lÄ±: {success_count} fotoÄŸraf")
        self.log(f"âœ… DoÄŸrulanan: {verified_count} fotoÄŸraf") 
        self.log(f"âŒ HatalÄ±: {error_count} fotoÄŸraf")
        self.log("=" * 50)
        
        messagebox.showinfo("TamamlandÄ±", 
                          f"SeÃ§ili fotoÄŸraflar iÅŸlemi tamamlandÄ±!\n\n"
                          f"âœ… BaÅŸarÄ±lÄ±: {success_count} fotoÄŸraf\n"
                          f"âœ… DoÄŸrulanan: {verified_count} fotoÄŸraf\n"
                          f"âŒ HatalÄ±: {error_count} fotoÄŸraf\n\n"
                          f"Yeni tarih: {new_datetime}")
        
        self.status_var.set(f"TamamlandÄ± - BaÅŸarÄ±lÄ±: {success_count}, HatalÄ±: {error_count}")

    def tarihsizleri_sec(self):
        """Sadece tarihsiz fotoÄŸraflarÄ± seÃ§er - YENÄ° EKLENDÄ°"""
        self.foto_listbox.selection_clear(0, tk.END)
        tarihsiz_sayisi = 0
        
        for i, foto_path in enumerate(self.tum_fotograflar):
            if not self.exif_tarihi_var_mi(foto_path):
                self.foto_listbox.selection_set(i)
                tarihsiz_sayisi += 1
        
        self.secilen_fotograflar = [self.tum_fotograflar[i] for i in self.foto_listbox.curselection()]
        self.selected_var.set(f"SeÃ§ilen: {tarihsiz_sayisi}")
        self.log(f"âœ“ {tarihsiz_sayisi} tarihsiz fotoÄŸraf seÃ§ildi")

    def tarihlileri_sec(self):
        """Sadece tarihli fotoÄŸraflarÄ± seÃ§er - YENÄ° EKLENDÄ°"""
        self.foto_listbox.selection_clear(0, tk.END)
        tarihli_sayisi = 0
        
        for i, foto_path in enumerate(self.tum_fotograflar):
            if self.exif_tarihi_var_mi(foto_path):
                self.foto_listbox.selection_set(i)
                tarihli_sayisi += 1
        
        self.secilen_fotograflar = [self.tum_fotograflar[i] for i in self.foto_listbox.curselection()]
        self.selected_var.set(f"SeÃ§ilen: {tarihli_sayisi}")
        self.log(f"âœ“ {tarihli_sayisi} tarihli fotoÄŸraf seÃ§ildi")

    def istatistikleri_goster(self):
        """DetaylÄ± istatistikleri gÃ¶sterir - YENÄ° EKLENDÄ°"""
        if not self.tum_fotograflar:
            messagebox.showinfo("Bilgi", "HenÃ¼z hiÃ§ fotoÄŸraf taranmamÄ±ÅŸ!")
            return
        
        # Manuel klasÃ¶r yolunu kullan
        tarama_klasoru = self.manuel_klasor_yolu if self.manuel_klasor_yolu else self.klasor_yolu
        
        toplam_foto = len(self.tum_fotograflar)
        tarihli_foto = 0
        tarihsiz_foto = 0
        
        for foto_path in self.tum_fotograflar:
            if self.exif_tarihi_var_mi(foto_path):
                tarihli_foto += 1
            else:
                tarihsiz_foto += 1
        
        tarihli_yuzde = (tarihli_foto / toplam_foto) * 100 if toplam_foto > 0 else 0
        tarihsiz_yuzde = (tarihsiz_foto / toplam_foto) * 100 if toplam_foto > 0 else 0
        
        istatistik_metni = (
            f"ğŸ“Š DETAYLI Ä°STATÄ°STÄ°KLER\n"
            f"{'='*40}\n"
            f"ğŸ“ KlasÃ¶r: {tarama_klasoru}\n"
            f"ğŸ“… Tarama ZamanÄ±: {datetime.datetime.now().strftime('%d/%m/%Y %H:%M:%S')}\n"
            f"{'='*40}\n"
            f"ğŸ“· Toplam FotoÄŸraf: {toplam_foto}\n"
            f"âœ… Tarihli FotoÄŸraf: {tarihli_foto} (%{tarihli_yuzde:.1f})\n"
            f"âŒ Tarihsiz FotoÄŸraf: {tarihsiz_foto} (%{tarihsiz_yuzde:.1f})\n"
            f"{'='*40}\n"
            f"ğŸ¯ Mevcut GÃ¶sterim: {self.secim_tipi}\n"
            f"ğŸ‘† Åu an SeÃ§ili: {len(self.secilen_fotograflar)} fotoÄŸraf"
        )
        
        # Ä°statistikleri log'a da yaz
        self.log("ğŸ“Š Ä°STATÄ°STÄ°KLER GÃ–STERÄ°LDÄ°:")
        self.log(f"   Toplam: {toplam_foto} fotoÄŸraf")
        self.log(f"   Tarihli: {tarihli_foto} (%{tarihli_yuzde:.1f})")
        self.log(f"   Tarihsiz: {tarihsiz_foto} (%{tarihsiz_yuzde:.1f})")
        
        messagebox.showinfo("DetaylÄ± Ä°statistikler", istatistik_metni)


class RaporEkrani(tk.Toplevel):
    def __init__(self, parent, excel_dosyasi, hat_tarihsiz_istatistikleri=None):
        super().__init__(parent)
        self.parent = parent
        self.excel_dosyasi = excel_dosyasi
        self.hat_tarihsiz_istatistikleri = hat_tarihsiz_istatistikleri or {}
        
        self.title("Rapor Ã–zeti - Direk Ä°statistikleri")
        self.geometry("1800x1000")
        self.configure(bg="#2c3e50")
        
        self.colors = {
            'dark_bg': '#2c3e50', 'light_bg': '#34495e', 'accent': '#3498db',
            'success': '#27ae60', 'danger': '#e74c3c', 'warning': '#f39c12',
            'text': '#ecf0f1', 'border': '#7f8c8d', 'info_bg': '#2c3e50'
        }

        # Log iÃ§in Text widget'Ä± oluÅŸtur
        self.log_text_widget = None
        
        # DeÄŸiÅŸkenler
        self.veriler = None
        self.rapor_verileri = None
        self.siralama_durumu = {}
        self.mevcut_filtreli_veri = []
        self.oncelik_veriler = []  # BoÅŸ liste olarak baÅŸlat
        
        self.turkce_aylar = [
            'Ocak', 'Åubat', 'Mart', 'Nisan', 'MayÄ±s', 'Haziran',
            'Temmuz', 'AÄŸustos', 'EylÃ¼l', 'Ekim', 'KasÄ±m', 'AralÄ±k'
        ]
        
        self.turkce_gunler = ['Pzt', 'Sal', 'Ã‡ar', 'Per', 'Cum', 'Cmt', 'Paz']
        
        # NOTEBOOK OLUÅTUR - 3 SEKMELÄ°
        self.notebook = ttk.Notebook(self)
        self.notebook.pack(fill='both', expand=True, padx=10, pady=5)
        
        # 1. SEKME: Ä°statistikler
        self.istatistik_frame = tk.Frame(self.notebook, bg=self.colors['dark_bg'])
        self.notebook.add(self.istatistik_frame, text='ğŸ“Š Ä°statistikler')
        
        # 2. SEKME: Ã–ncelik Analizi
        self.oncelik_frame = tk.Frame(self.notebook, bg=self.colors['dark_bg'])
        self.notebook.add(self.oncelik_frame, text='ğŸš¨ Ã–ncelik Analizi')
        
        # 3. SEKME: Harita Analizi - BOÅ FRAME OLUÅTUR, LAZY LOADING YAP
        self.harita_frame = tk.Frame(self.notebook, bg=self.colors['dark_bg'])
        self.notebook.add(self.harita_frame, text='ğŸ“ Harita Analizi')
        
        # Harita sekmesi yÃ¼klendi mi flag'i
        self.harita_yuklendi = False
        
        # Notebook deÄŸiÅŸimini takip et
        self.notebook.bind("<<NotebookTabChanged>>", self.sekme_degisti)
        
        # Sekmeleri oluÅŸtur
        self.istatistik_sekmesi_olustur()
        self.oncelik_sekmesi_olustur()
        # HARÄ°TA SEKMESÄ°NÄ° OLUÅTURMA - sadece frame oluÅŸturduk
        
        # Ã–NCELÄ°K VERÄ°LERÄ°NÄ° OTOMATÄ°K YÃœKLE
        self.after(100, self.oncelik_verileri_yukle)  # 100ms sonra otomatik yÃ¼kle
        
        if not self.verileri_yukle():
            return




    def log_mesaj_ekle(self, mesaj):
        """Log mesajÄ± ekler (AnaUygulama ile uyumlu)"""
        # Ana uygulamanÄ±n log'una yazmaya Ã§alÄ±ÅŸ
        try:
            if hasattr(self.parent, 'log_mesaj_ekle'):
                self.parent.log_mesaj_ekle(mesaj)
            else:
                # Kendi log'unu oluÅŸtur
                if not hasattr(self, 'txt_sonuc'):
                    # Text widget'Ä± oluÅŸtur
                    self.txt_sonuc = tk.Text(self, height=10, width=100, bg="#2c3e50", fg="white")
                    self.txt_sonuc.pack(fill='x', padx=10, pady=5)
                
                timestamp = datetime.datetime.now().strftime("[%H:%M:%S]")
                self.txt_sonuc.insert(tk.END, f"{timestamp} {mesaj}\n")
                self.txt_sonuc.see(tk.END)
        except Exception as e:
            print(f"Log hatasÄ±: {e}")

        
    def sekme_degisti(self, event):
        """Notebook sekmesi deÄŸiÅŸtiÄŸinde Ã§aÄŸrÄ±lÄ±r"""
        secili_sekme = self.notebook.index(self.notebook.select())
        
        # EÄŸer 3. sekme (Harita Analizi) seÃ§ildiyse ve henÃ¼z yÃ¼klenmediyse
        if secili_sekme == 2 and not self.harita_yuklendi:
            self.harita_sekmesi_olustur()
            self.harita_yuklendi = True
            
    def istatistik_sekmesi_olustur(self):
        """Ä°statistikler sekmesini oluÅŸturur (mevcut iÃ§erik)"""
        # ANA PENCEREYÄ° 9 BÄ°RÄ°M OLARAK AYARLA
        self.istatistik_frame.grid_rowconfigure(0, weight=3)  # Ãœst bÃ¶lÃ¼m: 3 birim
        self.istatistik_frame.grid_rowconfigure(1, weight=3)  # Grafik 1: 3 birim
        self.istatistik_frame.grid_rowconfigure(2, weight=3)  # Grafik 2: 3 birim
        self.istatistik_frame.grid_columnconfigure(0, weight=1)
        
        # 1. BÃ–LÃœM: ÃœST BAÅLIK VE Ä°STATÄ°STÄ°KLER (3 BÄ°RÄ°M)
        top_frame = tk.Frame(self.istatistik_frame, bg=self.colors['dark_bg'])
        top_frame.grid(row=0, column=0, sticky='nsew', padx=20, pady=10)
        
        title_frame = tk.Frame(top_frame, bg=self.colors['dark_bg'])
        title_frame.pack(fill='x', pady=(0, 10))
        
        title_label = tk.Label(title_frame, text="ğŸ“Š DÄ°REK Ä°STATÄ°STÄ°K RAPORU", 
                              font=('Segoe UI', 20, 'bold'),
                              fg=self.colors['text'], bg=self.colors['dark_bg'])
        title_label.pack()
        
        dosya_label = tk.Label(title_frame, text=f"Dosya: {os.path.basename(self.excel_dosyasi)}", 
                              font=('Segoe UI', 10),
                              fg=self.colors['accent'], bg=self.colors['dark_bg'])
        dosya_label.pack()
        
        stats_frame = tk.Frame(top_frame, bg=self.colors['dark_bg'])
        stats_frame.pack(fill='x', pady=10)
        
        self.kartlar_frame = tk.Frame(stats_frame, bg=self.colors['dark_bg'])
        self.kartlar_frame.pack(fill='x')
        
        # 2. VE 3. BÃ–LÃœM Ä°Ã‡Ä°N ANA Ä°Ã‡ERÄ°K FRAME
        content_frame = tk.Frame(self.istatistik_frame, bg=self.colors['dark_bg'])
        content_frame.grid(row=1, column=0, rowspan=2, sticky='nsew', padx=20, pady=(0, 10))
        
        # CONTENT FRAME'Ä° 2 SATIRA BÃ–L (GRAFÄ°K 1 ve GRAFÄ°K 2 iÃ§in)
        content_frame.grid_rowconfigure(0, weight=1)  # Grafik 1: 3 birim
        content_frame.grid_rowconfigure(1, weight=1)  # Grafik 2: 3 birim
        content_frame.grid_columnconfigure(0, weight=1)
        content_frame.grid_columnconfigure(1, weight=1)
        
        # SOL TARAF: TABLO (GRAFÄ°KLERLE AYNI YÃœKSEKLÄ°KTE)
        left_frame = tk.LabelFrame(content_frame, text="ğŸ›£ï¸ Hat DetaylarÄ±", 
                                  font=('Segoe UI', 14, 'bold'),
                                  fg=self.colors['text'], bg=self.colors['light_bg'],
                                  padx=15, pady=15)
        left_frame.grid(row=0, column=0, rowspan=2, sticky='nsew', padx=(0, 10))
        
        # SAÄ TARAF: GRAFÄ°KLER (ÃœST ÃœSTE)
        right_frame = tk.Frame(content_frame, bg=self.colors['dark_bg'])
        right_frame.grid(row=0, column=1, rowspan=2, sticky='nsew', padx=(10, 0))
        
        # SAÄ FRAME'Ä° 2 EÅÄ°T PARÃ‡AYA BÃ–L
        right_frame.grid_rowconfigure(0, weight=1)  # Grafik 1: 3 birim
        right_frame.grid_rowconfigure(1, weight=1)  # Grafik 2: 3 birim
        right_frame.grid_columnconfigure(0, weight=1)
        
        # SOL FRAME Ä°Ã‡ERÄ°ÄÄ° (TABLO)
        filter_frame = tk.Frame(left_frame, bg=self.colors['light_bg'])
        filter_frame.pack(fill='x', pady=(0, 10))
        
        tk.Label(filter_frame, text="Ä°lÃ§e:", font=('Segoe UI', 10, 'bold'),
                bg=self.colors['light_bg'], fg=self.colors['text']).pack(side='left', padx=(0, 5))
        
        self.ilce_filter_var = tk.StringVar(value="TÃœMÃœ")
        self.ilce_filter = ttk.Combobox(filter_frame, textvariable=self.ilce_filter_var, state="readonly", width=15)
        self.ilce_filter.pack(side='left', padx=(0, 15))
        
        tarih_filter_frame = tk.Frame(filter_frame, bg=self.colors['light_bg'])
        tarih_filter_frame.pack(side='left', padx=(0, 15))
        
        tk.Label(tarih_filter_frame, text="Tarih AralÄ±ÄŸÄ±:", font=('Segoe UI', 10, 'bold'),
                bg=self.colors['light_bg'], fg=self.colors['text']).pack(anchor='w')
        
        tarih_selection_frame = tk.Frame(tarih_filter_frame, bg=self.colors['light_bg'])
        tarih_selection_frame.pack(fill='x', pady=(5, 0))
        
        start_frame = tk.Frame(tarih_selection_frame, bg=self.colors['light_bg'])
        start_frame.pack(side='left', padx=(0, 10))
        
        tk.Label(start_frame, text="BaÅŸlangÄ±Ã§:", font=('Segoe UI', 9),
                bg=self.colors['light_bg'], fg=self.colors['text']).pack(anchor='w')
        
        self.baslangic_tarih_var = tk.StringVar()
        self.baslangic_entry = DateEntry(start_frame, 
                                       textvariable=self.baslangic_tarih_var,
                                       date_pattern='dd/mm/yyyy',
                                       width=12, 
                                       font=('Segoe UI', 9),
                                       background='white',
                                       foreground='black',
                                       borderwidth=1,
                                       locale='tr_TR')
        self.baslangic_entry.pack(pady=(2, 0))
        self.baslangic_entry.delete(0, tk.END)
        
        self.takvimi_turkcelestir(self.baslangic_entry)
        
        end_frame = tk.Frame(tarih_selection_frame, bg=self.colors['light_bg'])
        end_frame.pack(side='left', padx=(10, 0))
        
        tk.Label(end_frame, text="BitiÅŸ:", font=('Segoe UI', 9),
                bg=self.colors['light_bg'], fg=self.colors['text']).pack(anchor='w')
        
        self.bitis_tarih_var = tk.StringVar()
        self.bitis_entry = DateEntry(end_frame, 
                                   textvariable=self.bitis_tarih_var,
                                   date_pattern='dd/mm/yyyy',
                                       width=12, 
                                       font=('Segoe UI', 9),
                                       background='white',
                                       foreground='black',
                                       borderwidth=1,
                                       locale='tr_TR')
        self.bitis_entry.pack(pady=(2, 0))
        self.bitis_entry.delete(0, tk.END)
        
        self.takvimi_turkcelestir(self.bitis_entry)
        
        button_frame = tk.Frame(filter_frame, bg=self.colors['light_bg'])
        button_frame.pack(side='left', padx=(15, 0))
        
        filter_btn = tk.Button(button_frame, text="Filtrele", font=('Segoe UI', 10, 'bold'),
                              bg=self.colors['accent'], fg='white', relief='raised',
                              command=self.filtrele, width=10)
        filter_btn.pack(side='left', padx=(0, 5))
        
        reset_btn = tk.Button(button_frame, text="SÄ±fÄ±rla", font=('Segoe UI', 10, 'bold'),
                             bg=self.colors['warning'], fg='white', relief='raised',
                             command=self.filtreleri_sifirla, width=10)
        reset_btn.pack(side='left')
        
        tree_frame = tk.Frame(left_frame, bg=self.colors['light_bg'])
        tree_frame.pack(fill='both', expand=True)
        

        # Tablo sÃ¼tunlarÄ±nÄ± Ä°STENEN SIRAYA gÃ¶re tanÄ±mla - TOPLAM MESAFE SÃœTUNU EKLENDÄ°
        self.tree = ttk.Treeview(tree_frame, columns=(
            'Ilce', 'HatAdi', 'MusterkDirek', 'OgDirek', 'DirekSayisi', 
            'FotoSayisi', 'BulguSayisi', 'IlkTarih', 'SonTarih', 'ToplamGun', 'ToplamMesafe'
        ), show='headings')
        
        # SÃ¼tun baÅŸlÄ±klarÄ±nÄ± Ä°STENEN SIRAYA gÃ¶re ayarla - TOPLAM MESAFE SÃœTUNU EKLENDÄ°
        self.tree.heading('Ilce', text='Ä°lce', command=lambda: self.sutun_sirala('Ilce'))
        self.tree.heading('HatAdi', text='Hat AdÄ±', command=lambda: self.sutun_sirala('HatAdi'))
        self.tree.heading('MusterkDirek', text='MÃ¼ÅŸterek Direk', command=lambda: self.sutun_sirala('MusterkDirek'))
        self.tree.heading('OgDirek', text='OG Direk', command=lambda: self.sutun_sirala('OgDirek'))
        self.tree.heading('DirekSayisi', text='Direk SayÄ±sÄ±', command=lambda: self.sutun_sirala('DirekSayisi'))
        self.tree.heading('FotoSayisi', text='FotoÄŸraf SayÄ±sÄ±', command=lambda: self.sutun_sirala('FotoSayisi'))
        self.tree.heading('BulguSayisi', text='Bulgu', command=lambda: self.sutun_sirala('BulguSayisi'))
        self.tree.heading('IlkTarih', text='Ä°lk Ã‡ekim Tarihi', command=lambda: self.sutun_sirala('IlkTarih'))
        self.tree.heading('SonTarih', text='Son Ã‡ekim Tarihi', command=lambda: self.sutun_sirala('SonTarih'))
        self.tree.heading('ToplamGun', text='Toplam GÃ¼n', command=lambda: self.sutun_sirala('ToplamGun'))
        self.tree.heading('ToplamMesafe', text='Toplam Mesafe', command=lambda: self.sutun_sirala('ToplamMesafe'))
        
        # SÃ¼tun geniÅŸliklerini ayarla - TOPLAM MESAFE SÃœTUNU EKLENDÄ°
        self.tree.column('Ilce', width=60, anchor='center')
        self.tree.column('HatAdi', width=210, anchor='w')
        self.tree.column('MusterkDirek', width=100, anchor='center')
        self.tree.column('OgDirek', width=80, anchor='center')
        self.tree.column('DirekSayisi', width=80, anchor='center')
        self.tree.column('FotoSayisi', width=100, anchor='center')
        self.tree.column('BulguSayisi', width=60, anchor='center')
        self.tree.column('IlkTarih', width=100, anchor='center')
        self.tree.column('SonTarih', width=100, anchor='center')
        self.tree.column('ToplamGun', width=80, anchor='center')
        self.tree.column('ToplamMesafe', width=100, anchor='center')
        
        # Ã‡ift tÄ±klama olayÄ±nÄ± baÄŸla
        self.tree.bind('<Double-1>', self.tabloya_cift_tikla)
        
        scrollbar = ttk.Scrollbar(tree_frame, orient='vertical', command=self.tree.yview)
        self.tree.configure(yscrollcommand=scrollbar.set)
        
        self.tree.pack(side='left', fill='both', expand=True)
        scrollbar.pack(side='right', fill='y')
        
        # SAÄ TARAF: GRAFÄ°KLER (EÅÄ°T BOYUTTA)
        
        # GRAFÄ°K 1: Ä°lÃ§elere gÃ¶re direk daÄŸÄ±lÄ±mÄ± (3 BÄ°RÄ°M)
        self.graf1_frame = tk.LabelFrame(right_frame, text="ğŸ™ï¸ Ä°lÃ§elere GÃ¶re Direk DaÄŸÄ±lÄ±mÄ±", 
                                       font=('Segoe UI', 12, 'bold'),
                                       fg=self.colors['text'], bg=self.colors['light_bg'],
                                       padx=10, pady=10)
        self.graf1_frame.grid(row=0, column=0, sticky='nsew', pady=(0, 5))
        
        # GRAFÄ°K 2: Aylara gÃ¶re direk sayÄ±sÄ± (3 BÄ°RÄ°M)
        self.graf2_frame = tk.LabelFrame(right_frame, text="ğŸ“… Aylara GÃ¶re Direk SayÄ±sÄ±", 
                                       font=('Segoe UI', 12, 'bold'),
                                       fg=self.colors['text'], bg=self.colors['light_bg'],
                                       padx=10, pady=10)
        self.graf2_frame.grid(row=1, column=0, sticky='nsew', pady=(5, 0))
        
        # BOÅ GRAFÄ°KLERÄ° OLUÅTUR
        self.fig1 = plt.Figure(figsize=(6, 3.5), dpi=100)
        self.ax1 = self.fig1.add_subplot(111)
        self.canvas1 = FigureCanvasTkAgg(self.fig1, self.graf1_frame)
        self.canvas1.get_tk_widget().pack(fill='both', expand=True)
        
        self.fig2 = plt.Figure(figsize=(6, 3.5), dpi=100)
        self.ax2 = self.fig2.add_subplot(111)
        self.canvas2 = FigureCanvasTkAgg(self.fig2, self.graf2_frame)
        self.canvas2.get_tk_widget().pack(fill='both', expand=True)
        
    def oncelik_sekmesi_olustur(self):
        """Ã–ncelik analizi sekmesini oluÅŸturur - GÃœNCELLENMÄ°Å"""
        # BaÅŸlÄ±k
        baslik_frame = tk.Frame(self.oncelik_frame, bg="#3498db", height=60)
        baslik_frame.pack(fill='x', padx=1, pady=1)
        baslik_frame.pack_propagate(False)
        
        tk.Label(baslik_frame, text="ğŸš¨ Ã–NCELÄ°K ANALÄ°ZÄ° - Hat BazÄ±nda Ã–zet", 
                 font=('Segoe UI', 16, 'bold'), fg='white', bg="#3498db").pack(expand=True, pady=12)
        
        tk.Label(baslik_frame, text=f"Dosya: {os.path.basename(self.excel_dosyasi)}", 
                 font=('Segoe UI', 11), fg='white', bg="#3498db").pack(pady=(0, 12))
        
        # Filtreler
        filter_frame = tk.LabelFrame(self.oncelik_frame, text="ğŸ” Filtreler", 
                                     font=('Segoe UI', 11, 'bold'),
                                     fg='white', bg="#34495e", padx=15, pady=15)
        filter_frame.pack(fill='x', padx=20, pady=10)
        
        # Filtre grid
        filters_grid = tk.Frame(filter_frame, bg="#34495e")
        filters_grid.pack()
        
        # Ä°lÃ§e filtresi
        tk.Label(filters_grid, text="Ä°lÃ§e:", font=('Segoe UI', 10, 'bold'),
                 bg="#34495e", fg='white', width=10, anchor='w').grid(row=0, column=0, padx=8, pady=5, sticky='w')
        
        self.oncelik_ilce_var = tk.StringVar(value="TÃœMÃœ")
        self.oncelik_ilce_combo = ttk.Combobox(filters_grid, textvariable=self.oncelik_ilce_var, 
                                               state="readonly", width=24)
        self.oncelik_ilce_combo.grid(row=0, column=1, padx=8, pady=5)
        
        self.oncelik_ilce_combo.bind('<<ComboboxSelected>>', self.oncelik_ilce_degisti)
        
        # Hat filtresi
        tk.Label(filters_grid, text="Hat AdÄ±:", font=('Segoe UI', 10, 'bold'),
                 bg="#34495e", fg='white', width=10, anchor='w').grid(row=0, column=2, padx=8, pady=5, sticky='w')
        
        self.oncelik_hat_var = tk.StringVar(value="TÃœMÃœ")
        self.oncelik_hat_combo = ttk.Combobox(filters_grid, textvariable=self.oncelik_hat_var,
                                              state="readonly", width=30)
        self.oncelik_hat_combo.grid(row=0, column=3, padx=8, pady=5)
        
        # Butonlar - "Verileri YÃ¼kle" butonu KALDIRILDI
        button_frame = tk.Frame(filter_frame, bg="#34495e")
        button_frame.pack(pady=10)
        
        tk.Button(button_frame, text="ğŸ” Filtrele", font=('Segoe UI', 10, 'bold'),
                  bg="#27ae60", fg='white', command=self.oncelik_filtrele,
                  width=14).pack(side='left', padx=8)
        
        tk.Button(button_frame, text="ğŸ”„ SÄ±fÄ±rla", font=('Segoe UI', 10, 'bold'),
                  bg="#e74c3c", fg='white', command=self.oncelik_filtreleri_sifirla,
                  width=14).pack(side='left', padx=8)
        
        tk.Button(button_frame, text="ğŸ’¾ Excel'e Aktar", font=('Segoe UI', 10, 'bold'),
                  bg="#9b59b6", fg='white', command=self.oncelik_detayli_excele_aktar,
                  width=20).pack(side='left', padx=8)
        
        # Ä°statistikler
        stats_frame = tk.LabelFrame(filter_frame, text="ğŸ“Š Ä°statistikler", 
                                    font=('Segoe UI', 10, 'bold'),
                                    fg='white', bg="#34495e", padx=10, pady=10)
        stats_frame.pack(fill='x', pady=(10, 0))
        
        stats_inner = tk.Frame(stats_frame, bg="#34495e")
        stats_inner.pack()
        
        self.oncelik_toplam_var = tk.StringVar(value="Toplam: 0")
        self.oncelik_yapilan_var = tk.StringVar(value="YapÄ±lan: 0")
        self.oncelik_yapilmayan_var = tk.StringVar(value="YapÄ±lmayan: 0")
        
        tk.Label(stats_inner, textvariable=self.oncelik_toplam_var, 
                 font=('Segoe UI', 9, 'bold'), bg="#34495e", fg="#3498db").pack(side='left', padx=15)
        
        tk.Label(stats_inner, textvariable=self.oncelik_yapilan_var, 
                 font=('Segoe UI', 9, 'bold'), bg="#34495e", fg="#27ae60").pack(side='left', padx=15)
        
        tk.Label(stats_inner, textvariable=self.oncelik_yapilmayan_var, 
                 font=('Segoe UI', 9, 'bold'), bg="#34495e", fg="#e74c3c").pack(side='left', padx=15)
        
        # Tablo iÃ§in ana frame
        table_main_frame = tk.LabelFrame(self.oncelik_frame, text="ğŸ“‹ Hat BazÄ±nda Ã–ncelik Ã–zeti", 
                                         font=('Segoe UI', 11, 'bold'),
                                         fg='white', bg="#34495e", padx=15, pady=15)
        table_main_frame.pack(fill='both', expand=True, padx=20, pady=(0, 10))
        
        # Tablo iÃ§in canvas ve scrollbar
        canvas_frame = tk.Frame(table_main_frame, bg="#34495e")
        canvas_frame.pack(fill='both', expand=True)
        
        self.oncelik_canvas = tk.Canvas(canvas_frame, bg="#34495e", highlightthickness=0)
        scrollbar = ttk.Scrollbar(canvas_frame, orient="vertical", command=self.oncelik_canvas.yview)
        
        self.oncelik_tablo_frame = tk.Frame(self.oncelik_canvas, bg="#34495e")
        
        self.oncelik_canvas.create_window((0, 0), window=self.oncelik_tablo_frame, anchor="nw")
        self.oncelik_canvas.configure(yscrollcommand=scrollbar.set)
        
        self.oncelik_canvas.pack(side="left", fill="both", expand=True)
        scrollbar.pack(side="right", fill="y")
        
        def configure_canvas(event):
            self.oncelik_canvas.configure(scrollregion=self.oncelik_canvas.bbox("all"))
        
        self.oncelik_tablo_frame.bind("<Configure>", configure_canvas)
        
        # Ä°lk baÅŸta tablo baÅŸlÄ±klarÄ±nÄ± oluÅŸtur
        self.oncelik_tablo_basliklari_olustur()
        
        # YÃ¼kleme mesajÄ± gÃ¶ster
        self.oncelik_yukleniyor_label = tk.Label(self.oncelik_tablo_frame, 
                                                text="Ã–ncelik verileri yÃ¼kleniyor...\nLÃ¼tfen bekleyin.",
                                                font=('Segoe UI', 12),
                                                bg="#34495e", fg="white")
        self.oncelik_yukleniyor_label.pack(expand=True, pady=50)



    def oncelik_tablo_basliklari_olustur(self):
        """Ã–ncelik tablosunun baÅŸlÄ±klarÄ±nÄ± oluÅŸturur"""
        # BaÅŸlÄ±k satÄ±rÄ±
        header_frame = tk.Frame(self.oncelik_tablo_frame, bg="#2c3e50")
        header_frame.pack(fill='x', pady=(0, 2))
        
        # SÃ¼tunlar
        column_widths = {
            'ilce': 100,
            'hat_adi': 200,
            'yapilan_bekleyebilir': 90,
            'yapilan_normal': 80,
            'yapilan_acil': 70,
            'yapilan_cok_acil': 90,
            'yapilmayan_bekleyebilir': 90,
            'yapilmayan_normal': 80,
            'yapilmayan_acil': 70,
            'yapilmayan_cok_acil': 90,
            'toplam_yapilan': 80,
            'toplam_yapilmayan': 90
        }
        
        # Ä°lÃ§e
        tk.Label(header_frame, text="Ä°lÃ§e", font=('Segoe UI', 10, 'bold'),
                 bg="#2c3e50", fg='white', width=20, anchor='center').pack(side='left', padx=2)
        
        # Hat AdÄ±
        tk.Label(header_frame, text="Hat AdÄ±", font=('Segoe UI', 10, 'bold'),
                 bg="#2c3e50", fg='white', width=39, anchor='w').pack(side='left', padx=28)
        
        # YapÄ±lanlar frame
        yapilan_frame = tk.LabelFrame(header_frame, text="âœ… BAKIM YAPILANLAR", 
                                      font=('Segoe UI', 9, 'bold'),
                                      fg='white', bg="#2c3e50", bd=1, relief='solid')
        yapilan_frame.pack(side='left', padx=5)
        
        yapilan_inner = tk.Frame(yapilan_frame, bg="#2c3e50")
        yapilan_inner.pack(pady=2)
        
        tk.Label(yapilan_inner, text="Bekleyebilir", font=('Segoe UI', 8, 'bold'),
                 bg="#27ae60", fg='white', width=14, anchor='center').pack(side='left', padx=1)
        tk.Label(yapilan_inner, text="Normal", font=('Segoe UI', 8, 'bold'),
                 bg="#3498db", fg='white', width=13, anchor='center').pack(side='left', padx=1)
        tk.Label(yapilan_inner, text="Acil", font=('Segoe UI', 8, 'bold'),
                 bg="#f39c12", fg='white', width=13, anchor='center').pack(side='left', padx=1)
        tk.Label(yapilan_inner, text="Ã‡ok Acil", font=('Segoe UI', 8, 'bold'),
                 bg="#e74c3c", fg='white', width=13, anchor='center').pack(side='left', padx=1)
        
        # AyÄ±rÄ±cÄ±
        tk.Label(header_frame, text="|", font=('Segoe UI', 10, 'bold'),
                 bg="#2c3e50", fg='white').pack(side='left', padx=10)
        
        # YapÄ±lmayanlar frame
        yapilmayan_frame = tk.LabelFrame(header_frame, text="âŒ BAKIM YAPILMAYANLAR", 
                                         font=('Segoe UI', 9, 'bold'),
                                         fg='white', bg="#2c3e50", bd=1, relief='solid')
        yapilmayan_frame.pack(side='left', padx=5)
        
        yapilmayan_inner = tk.Frame(yapilmayan_frame, bg="#2c3e50")
        yapilmayan_inner.pack(pady=2)
        
        tk.Label(yapilmayan_inner, text="Bekleyebilir", font=('Segoe UI', 8, 'bold'),
                 bg="#27ae60", fg='white', width=14, anchor='center').pack(side='left', padx=1)
        tk.Label(yapilmayan_inner, text="Normal", font=('Segoe UI', 8, 'bold'),
                 bg="#3498db", fg='white', width=13, anchor='center').pack(side='left', padx=1)
        tk.Label(yapilmayan_inner, text="Acil", font=('Segoe UI', 8, 'bold'),
                 bg="#f39c12", fg='white', width=13, anchor='center').pack(side='left', padx=1)
        tk.Label(yapilmayan_inner, text="Ã‡ok Acil", font=('Segoe UI', 8, 'bold'),
                 bg="#e74c3c", fg='white', width=13, anchor='center').pack(side='left', padx=1)
        
        # AyÄ±rÄ±cÄ±
        tk.Label(header_frame, text="|", font=('Segoe UI', 10, 'bold'),
                 bg="#2c3e50", fg='white').pack(side='left', padx=10)
        
        # Toplamlar
        toplam_frame = tk.LabelFrame(header_frame, text="ğŸ“Š TOPLAMLAR", 
                                     font=('Segoe UI', 9, 'bold'),
                                     fg='white', bg="#2c3e50", bd=1, relief='solid')
        toplam_frame.pack(side='left', padx=5)
        
        toplam_inner = tk.Frame(toplam_frame, bg="#2c3e50")
        toplam_inner.pack(pady=2)
        
        tk.Label(toplam_inner, text="YapÄ±lan", font=('Segoe UI', 8, 'bold'),
                 bg="#27ae60", fg='white', width=14, anchor='center').pack(side='left', padx=2)
        tk.Label(toplam_inner, text="YapÄ±lmayan", font=('Segoe UI', 8, 'bold'),
                 bg="#e74c3c", fg='white', width=14, anchor='center').pack(side='left', padx=6)



    def oncelik_tabloyu_doldur(self):
        """Ã–ncelik tablosunu doldurur"""
        # Ã–nceki satÄ±rlarÄ± temizle
        for widget in self.oncelik_tablo_frame.winfo_children():
            if widget != self.oncelik_tablo_frame.winfo_children()[0]:  # BaÅŸlÄ±k hariÃ§
                widget.destroy()
        
        if not hasattr(self, 'oncelik_veriler') or not self.oncelik_veriler:
            return
        
        # Filtre deÄŸerlerini al
        secili_ilce = self.oncelik_ilce_var.get()
        secili_hat = self.oncelik_hat_var.get()
        
        # Ä°statistikleri sÄ±fÄ±rla
        toplam_yapilan = 0
        toplam_yapilmayan = 0
        toplam_genel = 0
        
        # Verileri filtrele ve satÄ±rlarÄ± oluÅŸtur
        for i, veri in enumerate(self.oncelik_veriler):
            # Filtrele
            if secili_ilce != 'TÃœMÃœ' and veri['ilce'] != secili_ilce:
                continue
            if secili_hat != 'TÃœMÃœ' and veri['hat_adi'] != secili_hat:
                continue
            
            # SatÄ±r frame'ini oluÅŸtur (zebra deseni)
            row_frame = tk.Frame(self.oncelik_tablo_frame, 
                                bg="#e8f4f8" if i % 2 == 0 else "#ffffff")
            row_frame.pack(fill='x', pady=1)
            
            # Ä°lÃ§e
            tk.Label(row_frame, text=veri['ilce'], font=('Segoe UI', 9),
                     bg=row_frame['bg'], fg='#000000', width=20,
                     anchor='center', bd=1, relief='solid').pack(side='left', padx=2, fill='y')
            
            # Hat AdÄ±
            tk.Label(row_frame, text=veri['hat_adi'], font=('Segoe UI', 9),
                     bg=row_frame['bg'], fg='#000000', width=55,
                     anchor='w', bd=1, relief='solid').pack(side='left', padx=2, fill='y')
            
            # YapÄ±lanlar
            yapilan_frame = tk.Frame(row_frame, bg=row_frame['bg'])
            yapilan_frame.pack(side='left', padx=5)
            
            # Bekleyebilir (YapÄ±lan)
            tk.Label(yapilan_frame, text=str(veri['yapilan_bekleyebilir']), 
                     font=('Segoe UI', 9, 'bold'), bg="#bbf7d0", fg='#14532d', 
                     width=15, anchor='center', bd=1, relief='solid').pack(side='left', padx=1)
            
            # Normal (YapÄ±lan)
            tk.Label(yapilan_frame, text=str(veri['yapilan_normal']), 
                     font=('Segoe UI', 9, 'bold'), bg="#86efac", fg='#14532d', 
                     width=13, anchor='center', bd=1, relief='solid').pack(side='left', padx=1)
            
            # Acil (YapÄ±lan)
            tk.Label(yapilan_frame, text=str(veri['yapilan_acil']), 
                     font=('Segoe UI', 9, 'bold'), bg="#22c55e", fg='white', 
                     width=13, anchor='center', bd=1, relief='solid').pack(side='left', padx=1)
            
            # Ã‡ok Acil (YapÄ±lan)
            tk.Label(yapilan_frame, text=str(veri['yapilan_cok_acil']), 
                     font=('Segoe UI', 9, 'bold'), bg="#15803d", fg='white', 
                     width=14, anchor='center', bd=1, relief='solid').pack(side='left', padx=1)
            
            # AyÄ±rÄ±cÄ±
            tk.Label(row_frame, text="|", font=('Segoe UI', 10),
                     bg=row_frame['bg'], fg='#000000', width=2).pack(side='left', padx=5)
            
            # YapÄ±lmayanlar
            yapilmayan_frame = tk.Frame(row_frame, bg=row_frame['bg'])
            yapilmayan_frame.pack(side='left', padx=5)
            
            # Bekleyebilir (YapÄ±lmayan)
            tk.Label(yapilmayan_frame, text=str(veri['yapilmayan_bekleyebilir']), 
                     font=('Segoe UI', 9, 'bold'), bg="#fca5a5", fg='#7f1d1d', 
                     width=15, anchor='center', bd=1, relief='solid').pack(side='left', padx=1)
            
            # Normal (YapÄ±lmayan)
            tk.Label(yapilmayan_frame, text=str(veri['yapilmayan_normal']), 
                     font=('Segoe UI', 9, 'bold'), bg="#f87171", fg='#7f1d1d', 
                     width=13, anchor='center', bd=1, relief='solid').pack(side='left', padx=1)
            
            # Acil (YapÄ±lmayan)
            tk.Label(yapilmayan_frame, text=str(veri['yapilmayan_acil']), 
                     font=('Segoe UI', 9, 'bold'), bg="#ef4444", fg='white', 
                     width=13, anchor='center', bd=1, relief='solid').pack(side='left', padx=1)
            
            # Ã‡ok Acil (YapÄ±lmayan)
            tk.Label(yapilmayan_frame, text=str(veri['yapilmayan_cok_acil']), 
                     font=('Segoe UI', 9, 'bold'), bg="#dc2626", fg='white', 
                     width=14, anchor='center', bd=1, relief='solid').pack(side='left', padx=1)
            
            # AyÄ±rÄ±cÄ±
            tk.Label(row_frame, text="|", font=('Segoe UI', 10),
                     bg=row_frame['bg'], fg='#000000', width=2).pack(side='left', padx=5)
            
            # Toplamlar
            toplam_frame = tk.Frame(row_frame, bg=row_frame['bg'])
            toplam_frame.pack(side='left', padx=5)
            
            # Toplam YapÄ±lan
            tk.Label(toplam_frame, text=str(veri['toplam_yapilan']), 
                     font=('Segoe UI', 9, 'bold'), bg="#27ae60", fg='white', 
                     width=14, anchor='center', bd=1, relief='solid').pack(side='left', padx=1)
            
            # Toplam YapÄ±lmayan
            tk.Label(toplam_frame, text=str(veri['toplam_yapilmayan']), 
                     font=('Segoe UI', 9, 'bold'), bg="#e74c3c", fg='white', 
                     width=15, anchor='center', bd=1, relief='solid').pack(side='left', padx=1)
            
            # Ä°statistikleri gÃ¼ncelle
            toplam_yapilan += veri['toplam_yapilan']
            toplam_yapilmayan += veri['toplam_yapilmayan']
            toplam_genel += veri['toplam_genel']
        
        # Ä°statistikleri gÃ¼ncelle
        self.oncelik_toplam_var.set(f"Toplam: {toplam_genel}")
        self.oncelik_yapilan_var.set(f"YapÄ±lan: {toplam_yapilan}")
        self.oncelik_yapilmayan_var.set(f"YapÄ±lmayan: {toplam_yapilmayan}")
        
        # Tabloyu yeniden boyutlandÄ±r
        self.oncelik_canvas.configure(scrollregion=self.oncelik_canvas.bbox("all"))




    def oncelik_verileri_yukle(self):
        """Rapor Excel'inden Ã¶ncelik verilerini yÃ¼kler"""
        try:
            self.log_mesaj_ekle("ğŸ“Š Ã–ncelik verileri yÃ¼kleniyor...")
            
            if not os.path.exists(self.excel_dosyasi):
                messagebox.showerror("Hata", f"Excel dosyasÄ± bulunamadÄ±: {self.excel_dosyasi}")
                return
            
            # FotoÄŸraf KlasÃ¶rleri sayfasÄ±nÄ± oku
            df_fotograf = pd.read_excel(self.excel_dosyasi, sheet_name='FotoÄŸraf KlasÃ¶rleri')
            
            # Gerekli sÃ¼tunlarÄ± kontrol et
            gerekli_sutunlar = ['Aob', 'Hat adÄ±', 'Direk No', 'Ã–ncelik', 'YapÄ±ldÄ± mÄ±?', 'Tespit Notu']
            for sutun in gerekli_sutunlar:
                if sutun not in df_fotograf.columns:
                    messagebox.showerror("Hata", f"Excel'de '{sutun}' sÃ¼tunu bulunamadÄ±!")
                    return
            
            # Ã–ncelik ve YapÄ±ldÄ± mÄ±? sÃ¼tunlarÄ±nÄ± temizle
            df_fotograf['Ã–ncelik'] = df_fotograf['Ã–ncelik'].fillna('').astype(str).str.strip()
            df_fotograf['YapÄ±ldÄ± mÄ±?'] = df_fotograf['YapÄ±ldÄ± mÄ±?'].fillna('').astype(str).str.strip()
            
            # Hat bazÄ±nda Ã¶ncelik istatistiklerini hesapla
            hat_oncelik_istatistikleri = {}
            
            for index, row in df_fotograf.iterrows():
                try:
                    ilce = str(row['Aob']).strip()
                    hat_adi = str(row['Hat adÄ±']).strip()
                    oncelik = row['Ã–ncelik'].lower()
                    yapildi_mi = str(row['YapÄ±ldÄ± mÄ±?']).lower()
                    
                    # Direk numarasÄ±nÄ± temizle
                    direk_no = str(row['Direk No']).strip()
                    
                    # Tespit notunu kontrol et
                    tespit_notu = str(row['Tespit Notu']).strip() if pd.notna(row['Tespit Notu']) else ""
                    has_tespit = tespit_notu != ""
                    
                    if not ilce or not hat_adi or not direk_no:
                        continue
                    
                    # YAPILDI MI? FÄ°LTRESÄ°NÄ° UYGULA - HARÄ°TA FÄ°LTRESÄ°NE GÃ–RE
                    # DÃœZELTME: self.yapildi_var'Ä± kontrol et, eÄŸer yoksa 'TÃœMÃœ' kullan
                    if hasattr(self, 'yapildi_var'):
                        secili_yapildi = self.yapildi_var.get()
                    else:
                        secili_yapildi = 'TÃœMÃœ'
                    
                    # Sadece filtre uygulanmÄ±ÅŸsa kontrol et
                    if secili_yapildi != 'TÃœMÃœ':
                        if secili_yapildi == 'YAPILDI':
                            # YapÄ±ldÄ± olanlarÄ± filtrele
                            yapildi_durum = any(keyword in yapildi_mi for keyword in ['evet', 'yapÄ±ldÄ±', 'x', 'âœ“', 'âœ…'])
                            if not yapildi_durum:
                                continue
                        elif secili_yapildi == 'YAPILMADI':
                            # YapÄ±lmadÄ± olanlarÄ± filtrele
                            yapildi_durum = any(keyword in yapildi_mi for keyword in ['evet', 'yapÄ±ldÄ±', 'x', 'âœ“', 'âœ…'])
                            if yapildi_durum:
                                continue
                    
                    hat_anahtari = (ilce, hat_adi)
                    
                    if hat_anahtari not in hat_oncelik_istatistikleri:
                        hat_oncelik_istatistikleri[hat_anahtari] = {
                            'ilce': ilce,
                            'hat_adi': hat_adi,
                            'yapilan_bekleyebilir': 0,
                            'yapilan_normal': 0,
                            'yapilan_acil': 0,
                            'yapilan_cok_acil': 0,
                            'yapilmayan_bekleyebilir': 0,
                            'yapilmayan_normal': 0,
                            'yapilmayan_acil': 0,
                            'yapilmayan_cok_acil': 0,
                            'toplam_yapilan': 0,
                            'toplam_yapilmayan': 0,
                            'toplam_genel': 0,
                            'tespit_sayisi': 0
                        }
                    
                    # YapÄ±ldÄ± mÄ±? kontrolÃ¼
                    yapildi = False
                    if any(keyword in yapildi_mi for keyword in ['evet', 'yapÄ±ldÄ±', 'x', 'âœ“', 'âœ…']):
                        yapildi = True
                    
                    # Ã–ncelik kategorisine gÃ¶re say
                    if 'bekleyebilir' in oncelik:
                        if yapildi:
                            hat_oncelik_istatistikleri[hat_anahtari]['yapilan_bekleyebilir'] += 1
                            hat_oncelik_istatistikleri[hat_anahtari]['toplam_yapilan'] += 1
                        else:
                            hat_oncelik_istatistikleri[hat_anahtari]['yapilmayan_bekleyebilir'] += 1
                            hat_oncelik_istatistikleri[hat_anahtari]['toplam_yapilmayan'] += 1
                        
                    elif 'normal' in oncelik:
                        if yapildi:
                            hat_oncelik_istatistikleri[hat_anahtari]['yapilan_normal'] += 1
                            hat_oncelik_istatistikleri[hat_anahtari]['toplam_yapilan'] += 1
                        else:
                            hat_oncelik_istatistikleri[hat_anahtari]['yapilmayan_normal'] += 1
                            hat_oncelik_istatistikleri[hat_anahtari]['toplam_yapilmayan'] += 1
                        
                    elif 'acil' in oncelik and 'Ã§ok acil' not in oncelik and 'cok acil' not in oncelik:
                        if yapildi:
                            hat_oncelik_istatistikleri[hat_anahtari]['yapilan_acil'] += 1
                            hat_oncelik_istatistikleri[hat_anahtari]['toplam_yapilan'] += 1
                        else:
                            hat_oncelik_istatistikleri[hat_anahtari]['yapilmayan_acil'] += 1
                            hat_oncelik_istatistikleri[hat_anahtari]['toplam_yapilmayan'] += 1
                        
                    elif 'Ã§ok acil' in oncelik or 'cok acil' in oncelik:
                        if yapildi:
                            hat_oncelik_istatistikleri[hat_anahtari]['yapilan_cok_acil'] += 1
                            hat_oncelik_istatistikleri[hat_anahtari]['toplam_yapilan'] += 1
                        else:
                            hat_oncelik_istatistikleri[hat_anahtari]['yapilmayan_cok_acil'] += 1
                            hat_oncelik_istatistikleri[hat_anahtari]['toplam_yapilmayan'] += 1
                    
                    # Tespit sayÄ±sÄ±nÄ± gÃ¼ncelle
                    if has_tespit:
                        hat_oncelik_istatistikleri[hat_anahtari]['tespit_sayisi'] += 1
                    
                    # Toplam genel sayÄ±yÄ± gÃ¼ncelle
                    hat_oncelik_istatistikleri[hat_anahtari]['toplam_genel'] += 1
                    
                except Exception as e:
                    continue
            
            # Verileri listeye Ã§evir
            self.oncelik_veriler = list(hat_oncelik_istatistikleri.values())
            self.oncelik_veriler.sort(key=lambda x: (x['ilce'], x['hat_adi']))
            
            # Ä°statistikleri hesapla
            toplam = sum(v['toplam_genel'] for v in self.oncelik_veriler)
            yapilan = sum(v['toplam_yapilan'] for v in self.oncelik_veriler)
            yapilmayan = sum(v['toplam_yapilmayan'] for v in self.oncelik_veriler)
            
            self.oncelik_toplam_var.set(f"Toplam: {toplam}")
            self.oncelik_yapilan_var.set(f"YapÄ±lan: {yapilan}")
            self.oncelik_yapilmayan_var.set(f"YapÄ±lmayan: {yapilmayan}")
            
            # Combobox'larÄ± doldur
            ilce_list = ['TÃœMÃœ'] + sorted(set(v['ilce'] for v in self.oncelik_veriler))
            self.oncelik_ilce_combo['values'] = ilce_list
            
            hat_list = ['TÃœMÃœ'] + sorted(set(v['hat_adi'] for v in self.oncelik_veriler))
            self.oncelik_hat_combo['values'] = hat_list
            
            # Tabloyu doldur
            self.oncelik_tabloyu_doldur()
            
            # YÃ¼kleme mesajÄ±nÄ± kaldÄ±r (gÃ¼venli ÅŸekilde)
            try:
                if hasattr(self, 'oncelik_yukleniyor_label') and self.oncelik_yukleniyor_label.winfo_exists():
                    self.oncelik_yukleniyor_label.destroy()
            except:
                pass
            
            self.log_mesaj_ekle(f"âœ… Ã–ncelik verileri yÃ¼klendi: {len(self.oncelik_veriler)} hat, {toplam} kayÄ±t")
            
            # DÃœZELTME: Filtre mesajÄ±nÄ± doÄŸru ÅŸekilde gÃ¶ster
            if hasattr(self, 'yapildi_var'):
                yapildi_filtresi = self.yapildi_var.get()
                if yapildi_filtresi != 'TÃœMÃœ':
                    self.log_mesaj_ekle(f"ğŸ” YapÄ±ldÄ± mÄ±? filtresi: {yapildi_filtresi}")
            
        except Exception as e:
            messagebox.showerror("Hata", f"Ã–ncelik verileri yÃ¼klenirken hata: {str(e)}")
            import traceback
            print(f"Hata detayÄ±: {traceback.format_exc()}")
            
            # Hata durumunda mesaj gÃ¶ster (gÃ¼venli ÅŸekilde)
            try:
                if hasattr(self, 'oncelik_yukleniyor_label') and self.oncelik_yukleniyor_label.winfo_exists():
                    self.oncelik_yukleniyor_label.config(text=f"Hata oluÅŸtu:\n{str(e)[:50]}...", 
                                                       fg="#e74c3c")
            except:
                pass

        
    def oncelik_filtrele(self, ilk_yukleme=False):
        """Ã–ncelik analizinde filtreleme yapar - Exception handling eklenmiÅŸ"""
        try:
            print(f"\nğŸ” Ã–NCELÄ°K FÄ°LTRELEME BAÅLATILIYOR...")
            
            # 1. TABLOYU TAMAMEN TEMÄ°ZLE
            for item in self.oncelik_tree.get_children():
                self.oncelik_tree.delete(item)
            
            # 2. oncelik_veriler deÄŸiÅŸkenini kontrol et
            if not hasattr(self, 'oncelik_veriler') or not self.oncelik_veriler:
                print("âŒ HATA: oncelik_veriler yÃ¼klenmemiÅŸ!")
                self.oncelik_tree.insert('', 'end', values=(
                    "HATA", "Veriler yÃ¼klenemedi", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0"
                ))
                return
            
            print(f"   Toplam {len(self.oncelik_veriler)} hat verisi var")
            
            # 3. Filtre deÄŸerlerini al
            secili_ilce = self.oncelik_ilce_var.get()
            secili_hat = self.oncelik_hat_var.get()
            
            filtered_count = 0
            
            # 4. VERÄ°LERÄ° FÄ°LTRELE VE TABLOYA EKLE
            for i, veri in enumerate(self.oncelik_veriler):
                try:
                    # Ä°lÃ§e filtresi
                    if secili_ilce != 'TÃœMÃœ' and veri['ilce'] != secili_ilce:
                        continue
                    
                    # Hat filtresi
                    if secili_hat != 'TÃœMÃœ' and veri['hat_adi'] != secili_hat:
                        continue
                    
                    # TABLOYA EKLE - YENÄ° FORMAT (12 sÃ¼tun)
                    item = self.oncelik_tree.insert('', 'end', values=(
                        veri['ilce'],                               # Ä°lÃ§e
                        veri['hat_adi'],                           # Hat AdÄ±
                        # BAKIM YAPILANLAR
                        veri['yapilan_bekleyebilir'],              # YapÄ±lan - Bekleyebilir
                        veri['yapilan_normal'],                    # YapÄ±lan - Normal
                        veri['yapilan_acil'],                      # YapÄ±lan - Acil
                        veri['yapilan_cok_acil'],                  # YapÄ±lan - Ã‡ok Acil
                        # BAKIM YAPILMAYANLAR
                        veri['yapilmayan_bekleyebilir'],           # YapÄ±lmayan - Bekleyebilir
                        veri['yapilmayan_normal'],                 # YapÄ±lmayan - Normal
                        veri['yapilmayan_acil'],                   # YapÄ±lmayan - Acil
                        veri['yapilmayan_cok_acil'],               # YapÄ±lmayan - Ã‡ok Acil
                        # TOPLAMLAR
                        veri['toplam_bakim_yapilan'],              # Toplam BakÄ±m YapÄ±lan
                        veri['toplam_genel']                       # Toplam Genel
                    ))
                    
                    # Zebra Ã§izgi efekti
                    if filtered_count % 2 == 0:
                        self.oncelik_tree.item(item, tags=('row_even',))
                    else:
                        self.oncelik_tree.item(item, tags=('row_odd',))
                    
                    filtered_count += 1
                    
                except Exception as e:
                    print(f"âš ï¸ Hat {i} eklenirken hata: {e}")
                    continue
            
            print(f"âœ… {filtered_count} hat filtrelenip tabloya eklendi")
            
            # 5. EÄER FÄ°LTRE SONUCU BOÅSA MESAJ GÃ–STER
            if filtered_count == 0:
                print("â„¹ï¸ Filtre sonucu boÅŸ")
                self.oncelik_tree.insert('', 'end', values=(
                    "BÄ°LGÄ°", "Filtreye uygun veri bulunamadÄ±", "-", "-", "-", "-", "-", "-", "-", "-", "-", "-"
                ))
            
        except Exception as e:
            print(f"âŒ Filtreleme hatasÄ±: {str(e)}")
            import traceback
            print(f"ğŸ” Hata detayÄ±:\n{traceback.format_exc()}")
            
            # Hata durumunda tabloya mesaj ekle
            try:
                for item in self.oncelik_tree.get_children():
                    self.oncelik_tree.delete(item)
                
                self.oncelik_tree.insert('', 'end', values=(
                    "HATA", f"Filtreleme hatasÄ±: {str(e)[:30]}", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0"
                ))
            except:
                pass

            
    def oncelik_filtrele(self, event=None):
        """Ã–ncelik tablosunu filtreler"""
        self.oncelik_tabloyu_doldur()

    def oncelik_ilce_degisti(self, event=None):
        """Ä°lÃ§e deÄŸiÅŸtiÄŸinde hat listesini gÃ¼nceller"""
        secili_ilce = self.oncelik_ilce_var.get()
        
        if not hasattr(self, 'oncelik_veriler') or not self.oncelik_veriler:
            return
        
        if secili_ilce == "TÃœMÃœ":
            hat_list = ['TÃœMÃœ'] + sorted(set(v['hat_adi'] for v in self.oncelik_veriler))
        else:
            hat_list = ['TÃœMÃœ'] + sorted(set(v['hat_adi'] for v in self.oncelik_veriler if v['ilce'] == secili_ilce))
        
        self.oncelik_hat_combo['values'] = hat_list
        self.oncelik_hat_var.set("TÃœMÃœ")

    def oncelik_filtreleri_sifirla(self):
        """Ã–ncelik filtrelerini sÄ±fÄ±rlar"""
        self.oncelik_ilce_var.set("TÃœMÃœ")
        self.oncelik_hat_var.set("TÃœMÃœ")
        
        # TÃ¼m ilÃ§eler iÃ§in hat listesini yenile
        if hasattr(self, 'oncelik_veriler') and self.oncelik_veriler:
            hat_list = ['TÃœMÃœ'] + sorted(set(v['hat_adi'] for v in self.oncelik_veriler))
            self.oncelik_hat_combo['values'] = hat_list
        
        self.oncelik_tabloyu_doldur()

    def oncelik_detayli_excele_aktar(self):
        """FiltrelenmiÅŸ Ã¶ncelik detaylarÄ±nÄ± Excel'e aktarÄ±r - SADECE DETAYLAR SAYFASI"""
        try:
            
            # Orijinal Excel dosyasÄ±nÄ± oku
            df_fotograf = pd.read_excel(self.excel_dosyasi, sheet_name='FotoÄŸraf KlasÃ¶rleri')
            
            # Sadece Ã¶ncelik bilgisi olan satÄ±rlarÄ± filtrele (TEMEL FÄ°LTRE)
            df_oncelik = df_fotograf[
                df_fotograf['Ã–ncelik'].notna() & 
                (df_fotograf['Ã–ncelik'] != '') & 
                (df_fotograf['Ã–ncelik'] != 'nan')
            ].copy()
            
            if df_oncelik.empty:
                messagebox.showinfo("Bilgi", "Ã–ncelik bilgisi olan veri bulunamadÄ±.")
                return
            
            # TABLODAKÄ° FÄ°LTRELERÄ° UYGULA
            secili_ilce = self.oncelik_ilce_var.get()
            secili_hat = self.oncelik_hat_var.get()
            
            # Ä°lÃ§e filtresi
            if secili_ilce != "TÃœMÃœ":
                df_oncelik = df_oncelik[df_oncelik['Aob'] == secili_ilce]
            
            # Hat filtresi
            if secili_hat != "TÃœMÃœ":
                df_oncelik = df_oncelik[df_oncelik['Hat adÄ±'] == secili_hat]
            
            if df_oncelik.empty:
                messagebox.showinfo("Bilgi", 
                                  f"SeÃ§ilen filtreler iÃ§in veri bulunamadÄ±:\n"
                                  f"â€¢ Ä°lÃ§e: {secili_ilce}\n"
                                  f"â€¢ Hat: {secili_hat}")
                return
            
            # Kaydetme yeri seÃ§
            kaydetme_yolu = filedialog.asksaveasfilename(
                title="FiltrelenmiÅŸ Ã–ncelik Listesini Kaydet",
                defaultextension=".xlsx",
                filetypes=[("Excel files", "*.xlsx"), ("All files", "*.*")],
                initialfile=f"oncelik_filtreli_{dt.now().strftime('%Y%m%d_%H%M')}.xlsx"
            )
            
            if not kaydetme_yolu:
                return
            
            # Ä°stenen sÃ¼tunlarÄ± seÃ§ - LAT/LON EKLENDÄ°
            detayli_sutunlar = ['Aob', 'Hat adÄ±', 'Direk No', 'Ã–ncelik', 'Tespit Notu', 
                               'FotoÄŸraf SayÄ±sÄ±', 'En Yeni FotoÄŸraf Tarihi', 'LAT', 'LON']
            
            # Mevcut sÃ¼tunlarÄ± kontrol et
            mevcut_sutunlar = []
            for col in detayli_sutunlar:
                if col in df_oncelik.columns:
                    mevcut_sutunlar.append(col)
                else:
                    print(f"âš ï¸ {col} sÃ¼tunu bulunamadÄ±")
            
            if not mevcut_sutunlar:
                messagebox.showinfo("Bilgi", "Gerekli sÃ¼tunlar bulunamadÄ±.")
                return
            
            # FiltrelenmiÅŸ DataFrame
            df_detay = df_oncelik[mevcut_sutunlar].copy()
            
            # LAT ve LON sÃ¼tunlarÄ±nÄ± temizle (NaN deÄŸerleri boÅŸ string yap)
            if 'LAT' in df_detay.columns:
                df_detay['LAT'] = df_detay['LAT'].apply(lambda x: '' if pd.isna(x) else x)
            if 'LON' in df_detay.columns:
                df_detay['LON'] = df_detay['LON'].apply(lambda x: '' if pd.isna(x) else x)
            
            # Excel'e kaydet - SADECE 1 SAYFA
            with pd.ExcelWriter(kaydetme_yolu, engine='openpyxl') as writer:
                # SADECE DETAYLI LÄ°STE SAYFASI
                df_detay.to_excel(writer, sheet_name='FiltrelenmiÅŸ Detaylar', index=False)
                
                # Formatlama
                workbook = writer.book
                
                # SAYFA: FiltrelenmiÅŸ Detaylar formatlama
                ws_detay = writer.sheets['FiltrelenmiÅŸ Detaylar']
                
                # BaÅŸlÄ±k stilini uygula (ORTAYA HÄ°ZALI)
                header_fill = PatternFill(start_color="27ae60", end_color="27ae60", fill_type="solid")
                header_font = Font(bold=True, color="FFFFFF")
                
                for col in range(1, len(df_detay.columns) + 1):
                    cell = ws_detay.cell(row=1, column=col)
                    cell.fill = header_fill
                    cell.font = header_font
                    cell.alignment = Alignment(horizontal='center', vertical='center')  # BAÅLIK ORTADA
                
                # Ã–ncelik renk kodlama ve zebra deseni
                for row in range(2, ws_detay.max_row + 1):
                    # Zebra deseni
                    if row % 2 == 0:
                        row_fill = PatternFill(start_color="f2f9f2", end_color="f2f9f2", fill_type="solid")
                    else:
                        row_fill = PatternFill(start_color="FFFFFF", end_color="FFFFFF", fill_type="solid")
                    
                    # TÃ¼m satÄ±ra zebra deseni ve SOLA HÄ°ZALAMA uygula
                    for col in range(1, len(df_detay.columns) + 1):
                        cell = ws_detay.cell(row=row, column=col)
                        cell.fill = row_fill
                        cell.alignment = Alignment(horizontal='left', vertical='center')  # VERÄ°LER SOLA HÄ°ZALI
                    
                    # Ã–ncelik renk kodlama (D sÃ¼tunu - 4. sÃ¼tun)
                    oncelik_cell = ws_detay.cell(row=row, column=4)  # Ã–ncelik sÃ¼tunu
                    oncelik = str(oncelik_cell.value).lower() if oncelik_cell.value else ""
                    
                    if 'bekleyebilir' in oncelik:
                        oncelik_cell.font = Font(color="27ae60", bold=True)
                    elif 'normal' in oncelik:
                        oncelik_cell.font = Font(color="3498db", bold=True)
                    elif 'acil' in oncelik:
                        oncelik_cell.font = Font(color="f39c12", bold=True)
                    elif 'Ã§ok acil' in oncelik or 'cok acil' in oncelik:
                        oncelik_cell.font = Font(color="e74c3c", bold=True)
                    
                    # LAT ve LON sÃ¼tunlarÄ± iÃ§in sayÄ± formatÄ±
                    if 'LAT' in mevcut_sutunlar:
                        lat_index = mevcut_sutunlar.index('LAT') + 1
                        lat_cell = ws_detay.cell(row=row, column=lat_index)
                        if lat_cell.value and lat_cell.value != '':
                            try:
                                lat_value = float(lat_cell.value)
                                lat_cell.value = lat_value
                                lat_cell.number_format = '0.000000'
                            except:
                                pass
                    
                    if 'LON' in mevcut_sutunlar:
                        lon_index = mevcut_sutunlar.index('LON') + 1
                        lon_cell = ws_detay.cell(row=row, column=lon_index)
                        if lon_cell.value and lon_cell.value != '':
                            try:
                                lon_value = float(lon_cell.value)
                                lon_cell.value = lon_value
                                lon_cell.number_format = '0.000000'
                            except:
                                pass
                    
                    # Koordinat bilgisi olmayan satÄ±rlarÄ± iÅŸaretle
                    if 'LAT' in mevcut_sutunlar and 'LON' in mevcut_sutunlar:
                        lat_index = mevcut_sutunlar.index('LAT') + 1
                        lon_index = mevcut_sutunlar.index('LON') + 1
                        
                        lat_cell = ws_detay.cell(row=row, column=lat_index)
                        lon_cell = ws_detay.cell(row=row, column=lon_index)
                        
                        lat_value = lat_cell.value
                        lon_value = lon_cell.value
                        
                        # Koordinat yoksa sarÄ± renkle iÅŸaretle
                        if not lat_value or not lon_value or lat_value == '' or lon_value == '':
                            lat_cell.fill = PatternFill(start_color="FFFF00", end_color="FFFF00", fill_type="solid")
                            lon_cell.fill = PatternFill(start_color="FFFF00", end_color="FFFF00", fill_type="solid")
                            lat_cell.value = "KOORDÄ°NAT YOK" if not lat_value or lat_value == '' else lat_value
                            lon_cell.value = "KOORDÄ°NAT YOK" if not lon_value or lon_value == '' else lon_value
                
                # SÃ¼tun geniÅŸliklerini otomatik ayarla
                for column in ws_detay.columns:
                    max_length = 0
                    column_letter = column[0].column_letter
                    for cell in column:
                        try:
                            if len(str(cell.value)) > max_length:
                                max_length = len(str(cell.value))
                        except:
                            pass
                    adjusted_width = min(max_length + 2, 50)
                    ws_detay.column_dimensions[column_letter].width = adjusted_width
                
            # BaÅŸarÄ± mesajÄ±
            filter_msg = ""
            if secili_ilce != "TÃœMÃœ":
                filter_msg += f"â€¢ Ä°lÃ§e: {secili_ilce}\n"
            if secili_hat != "TÃœMÃœ":
                filter_msg += f"â€¢ Hat: {secili_hat}\n"
            
            if not filter_msg:
                filter_msg = "â€¢ Filtre: TÃœMÃœ (filtresiz)\n"
            
            messagebox.showinfo("BaÅŸarÄ±lÄ±", 
                              f"âœ… FÄ°LTRELENMÄ°Å VERÄ°LER EXCEL'E AKTARILDI\n\n"
                              f"ğŸ“ Dosya: {os.path.basename(kaydetme_yolu)}\n\n"
                              f"ğŸ” UYGULANAN FÄ°LTRELER:\n{filter_msg}\n"
                              f"ğŸ“Š AKTARILAN VERÄ°:\n"
                              f"â€¢ {len(df_detay)} kayÄ±t\n\n"
                              f"ğŸ“Œ Ã–ZELLÄ°KLER:\n"
                              f"â€¢ Zebra desenli satÄ±rlar\n"
                              f"â€¢ Ã–ncelik renk kodlamasÄ±\n"
                              f"â€¢ Koordinat formatÄ± (6 ondalÄ±k)\n"
                              f"â€¢ Koordinat eksikleri sarÄ± renkte\n"
                              f"â€¢ BaÅŸlÄ±k orta, veriler sola hizalÄ±\n"  # Bu satÄ±r eklendi
                              f"â€¢ Otomatik sÃ¼tun geniÅŸliÄŸi")
            
        except Exception as e:
            messagebox.showerror("Hata", f"Excel kaydedilirken hata: {str(e)}")
            print(f"Excel aktarÄ±m hatasÄ±: {e}")
            import traceback
            traceback.print_exc()


    def _oncelik_seviyesi_hesapla(self, toplam):
        """Toplam deÄŸere gÃ¶re Ã¶ncelik seviyesini hesaplar"""
        if toplam <= 5:
            return 'BEKLEYEBÄ°LÄ°R'
        elif toplam <= 15:
            return 'NORMAL'
        elif toplam <= 30:
            return 'ACÄ°L'
        else:
            return 'Ã‡OK ACÄ°L'

    def show_error_in_table(self, error_message):
            """Tabloya hata mesajÄ± ekler"""
            try:
                # Tabloyu temizle
                for item in self.oncelik_tree.get_children():
                    self.oncelik_tree.delete(item)
                
                # Hata mesajÄ±nÄ± ekle
                self.oncelik_tree.insert('', 'end', values=(
                    "HATA", error_message, "0", "0", "0", "0", "0"
                ))
            except Exception as e:
                print(f"âŒ Tabloya hata eklenirken hata: {e}")



                


    def harita_sekmesi_olustur(self):
        """Harita analizi sekmesini oluÅŸturur - SADECE Ä°LK KEZ TIKLANDIÄINDA"""
        try:
            # Harita sekmesini tamamen boÅŸalt
            for widget in self.harita_frame.winfo_children():
                widget.destroy()
            
            # YÃ¼kleme mesajÄ± gÃ¶ster
            loading_label = tk.Label(self.harita_frame, 
                                   text="Harita yÃ¼kleniyor...\nLÃ¼tfen bekleyin.",
                                   font=('Segoe UI', 14),
                                   bg="#2c3e50", fg="white")
            loading_label.pack(expand=True)
            self.update()
            
            # BaÅŸlÄ±k frame
            baslik_frame = tk.Frame(self.harita_frame, bg="#3498db", height=60)
            baslik_frame.pack(fill='x', padx=1, pady=1)
            baslik_frame.pack_propagate(False)
            
            tk.Label(baslik_frame, text="ğŸ“ HARÄ°TA ANALÄ°ZÄ° - BULGU GÃ–RSELLEÅTÄ°RME", 
                    font=('Segoe UI', 16, 'bold'), fg='white', bg="#3498db").pack(expand=True, pady=15)
            
            tk.Label(baslik_frame, text=f"Dosya: {os.path.basename(self.excel_dosyasi)}", 
                    font=('Segoe UI', 11), fg='white', bg="#3498db").pack(pady=(0, 15))
            
            # YÃ¼kleme mesajÄ±nÄ± kaldÄ±r
            loading_label.destroy()
            
            # GÃ¶mÃ¼lÃ¼HaritaAnalizEkrani'ni ekle
            self.gomulu_harita = GÃ¶mÃ¼lÃ¼HaritaAnalizEkrani(self.harita_frame, self.excel_dosyasi)
            self.gomulu_harita.pack(fill='both', expand=True, padx=10, pady=(0, 10))
            
            print(f"âœ… Harita analizi sekmesi LAZY LOADING ile yÃ¼klendi")
            
        except Exception as e:
            messagebox.showerror("Hata", f"Harita sekmesi oluÅŸturulamadÄ±: {str(e)}")
            import traceback
            print(f"Harita sekmesi hatasÄ±: {traceback.format_exc()}")
            
            # Hata durumunda bilgi mesajÄ± gÃ¶ster
            error_frame = tk.Frame(self.harita_frame, bg="#2c3e50")
            error_frame.pack(expand=True)
            
            tk.Label(error_frame, text="Harita yÃ¼klenemedi!", 
                    font=('Segoe UI', 16, 'bold'), fg='red', bg="#2c3e50").pack(pady=10)
            
            tk.Label(error_frame, text=f"Hata: {str(e)}", 
                    font=('Segoe UI', 11), fg='white', bg="#2c3e50", wraplength=600).pack(pady=10)
            
            tk.Button(error_frame, text="Tekrar Dene", 
                     command=self.harita_sekmesi_olustur,
                     bg="#3498db", fg='white', font=('Segoe UI', 11)).pack(pady=20)


    
    def pyqt_kontrol_et(self):
        """PyQt6'nÄ±n kurulu olup olmadÄ±ÄŸÄ±nÄ± kontrol eder"""
        try:
            import sys
            from PyQt6.QtCore import Qt, QUrl
            from PyQt6.QtWidgets import QApplication, QWidget, QVBoxLayout
            from PyQt6.QtWebEngineWidgets import QWebEngineView
            from PyQt6.QtWebEngineCore import QWebEngineSettings
            
            self.pyqt_available = True
            self.harita_uyari_var.set("âœ… PyQt6 kurulu - Harita TKinter iÃ§inde gÃ¶sterilebilir")
        except ImportError:
            self.pyqt_available = False
            self.harita_uyari_var.set("âš ï¸ PyQt6 kurulu deÄŸil - Harita tarayÄ±cÄ±da aÃ§Ä±lacak")
    
    def harita_analiz_ekrani_ac(self):
        """HaritaAnalizEkrani'nÄ± RaporEkrani iÃ§ine gÃ¶mÃ¼lÃ¼ olarak aÃ§ar"""
        try:
            # Harita sekmesindeki mevcut iÃ§eriÄŸi temizle
            for widget in self.harita_frame.winfo_children():
                widget.destroy()
            
            # HaritaAnalizEkrani'ni DOÄRUDAN harita_frame iÃ§ine gÃ¶m
            self.harita_ekrani = GÃ¶mÃ¼lÃ¼HaritaAnalizEkrani(self.harita_frame, self.excel_dosyasi)
            self.harita_ekrani.pack(fill='both', expand=True)
            
        except Exception as e:
            messagebox.showerror("Hata", f"Harita ekranÄ± aÃ§Ä±lÄ±rken hata: {str(e)}")
            import traceback
            print(f"Harita ekranÄ± aÃ§ma hatasÄ±: {traceback.format_exc()}")
            



    def tum_hat_fotograflarini_ac(self, ilce, hat_adi):
        """Bir hata ait TÃœM fotoÄŸraflarÄ± EXIF dÃ¼zenleyicide aÃ§ar - GÃœNCELLENMÄ°Å"""
        try:
            # Ä°lgili hat iÃ§in TÃœM klasÃ¶r yollarÄ±nÄ± bul
            klasor_yollari = self.hat_klasor_yollari_bul(ilce, hat_adi)
            
            if not klasor_yollari:
                messagebox.showwarning("UyarÄ±", f"{ilce} - {hat_adi} iÃ§in klasÃ¶r bulunamadÄ±!")
                return
            
            # TÃ¼m klasÃ¶rlerdeki fotoÄŸraflarÄ± ORÄ°JÄ°NAL YOLLARIYLA topla
            tum_fotograflar = []
            for klasor_yolu in klasor_yollari:
                klasor_fotograflari = self.klasordeki_tum_fotograflari_bul(klasor_yolu)
                tum_fotograflar.extend(klasor_fotograflari)
            
            if not tum_fotograflar:
                messagebox.showinfo("Bilgi", f"{ilce} - {hat_adi} iÃ§in fotoÄŸraf bulunamadÄ±!")
                return
            
            # Ä°lk klasÃ¶rÃ¼ ana klasÃ¶r olarak kullan
            if klasor_yollari:
                ana_klasor_yolu = os.path.dirname(klasor_yollari[0])
                
                # EXIF dÃ¼zenleyiciyi aÃ§ - TÃœM fotoÄŸraflar seÃ§ili olarak
                exif_editor = ExifDateEditor(self, ana_klasor_yolu, secim_tipi="tumunu")
                exif_editor.log(f"ğŸ¯ TÃœM HAT FOTOÄRAFLARI: {ilce} - {hat_adi}")
                exif_editor.log(f"ğŸ“Š Toplam {len(tum_fotograflar)} fotoÄŸraf")
                exif_editor.log(f"ğŸ“ Orijinal klasÃ¶r kullanÄ±lÄ±yor: {ana_klasor_yolu}")
                exif_editor.log(f"ğŸ¯ TÃ¼m fotoÄŸraflar otomatik seÃ§ildi")
                exif_editor.log(f"ğŸ“… 'Sadece Tarihsizleri GÃ¶ster' butonuna tÄ±klayarak filtreleyebilirsiniz")
                    
            else:
                messagebox.showerror("Hata", "KlasÃ¶r bulunamadÄ±!")
                
        except Exception as e:
            messagebox.showerror("Hata", f"TÃ¼m hat fotoÄŸraflarÄ± aÃ§Ä±lÄ±rken hata: {str(e)}")

    def klasordeki_tum_fotograflari_bul(self, klasor_yolu):
        """Bir klasÃ¶rdeki tÃ¼m fotoÄŸraflarÄ± bulur"""
        foto_uzantilari = ('.jpg', '.jpeg', '.png', '.tiff', '.tif', '.bmp')
        tum_fotograflar = []
        
        try:
            for root, dirs, files in os.walk(klasor_yolu):
                for dosya in files:
                    if any(dosya.lower().endswith(ext) for ext in foto_uzantilari):
                        full_path = os.path.join(root, dosya)
                        tum_fotograflar.append(full_path)
        except Exception as e:
            print(f"KlasÃ¶r tarama hatasÄ± {klasor_yolu}: {e}")
        
        return tum_fotograflar





    def verileri_yukle(self):
        """Excel dosyasÄ±ndaki Hat Ã–zeti sayfasÄ±ndan verileri yÃ¼kler ve Bulgu sayÄ±larÄ±nÄ± hesaplar"""
        try:
            # Ã–nce dosyanÄ±n var olup olmadÄ±ÄŸÄ±nÄ± kontrol et
            if not os.path.exists(self.excel_dosyasi):
                messagebox.showerror("Hata", f"Excel dosyasÄ± bulunamadÄ±:\n{self.excel_dosyasi}")
                self.destroy()
                return False

            # FotoÄŸraf KlasÃ¶rleri sayfasÄ±nÄ± oku
            df_fotograf = pd.read_excel(self.excel_dosyasi, sheet_name='FotoÄŸraf KlasÃ¶rleri')
            
            print(f"ğŸ” DEBUG: FotoÄŸraf KlasÃ¶rleri sÃ¼tunlarÄ±: {list(df_fotograf.columns)}")
            
            # Direk Tipi sÃ¼tununu kontrol et
            direk_tipi_sutunlari = ['Direk Tipi', 'Direk tipi', 'DÄ°REK TÄ°PÄ°', 'DirekTÄ°PÄ°', 'Tipi']
            direk_tipi_sutun = None
            
            for sutun in direk_tipi_sutunlari:
                if sutun in df_fotograf.columns:
                    direk_tipi_sutun = sutun
                    print(f"âœ… DEBUG: Direk Tipi sÃ¼tunu bulundu: '{direk_tipi_sutun}'")
                    break
            
            if not direk_tipi_sutun:
                print("âš ï¸ DEBUG: Direk Tipi sÃ¼tunu bulunamadÄ±!")
                # VarsayÄ±lan deÄŸerlerle devam et
                direk_tipi_sutun = 'Direk Tipi'
                df_fotograf[direk_tipi_sutun] = ''
            
            # TRAFO DÄ°REÄÄ° sÃ¼tununu kontrol et
            trafo_sutun_adi = None
            trafo_sutun_adlari = ['Trafo DireÄŸi', 'Trafo direÄŸi', 'TRAFO DÄ°REÄÄ°', 'Trafo', 'TrafoDireÄŸi', 'Trafo_DireÄŸi']
            
            for sutun in trafo_sutun_adlari:
                if sutun in df_fotograf.columns:
                    trafo_sutun_adi = sutun
                    print(f"âœ… DEBUG: Trafo DireÄŸi sÃ¼tunu bulundu: '{trafo_sutun_adi}'")
                    break
            
            if not trafo_sutun_adi:
                print("âš ï¸ DEBUG: Trafo DireÄŸi sÃ¼tunu bulunamadÄ±!")
                trafo_sutun_adi = 'Trafo DireÄŸi'
                df_fotograf[trafo_sutun_adi] = ''
            
            # SÃ¼tunlarÄ± temizle
            df_fotograf[direk_tipi_sutun] = df_fotograf[direk_tipi_sutun].fillna('').astype(str).str.strip().str.upper()
            df_fotograf[trafo_sutun_adi] = df_fotograf[trafo_sutun_adi].fillna('').astype(str).str.strip().str.upper()
            
            # Hat bazÄ±nda direk tipi sayÄ±mlarÄ±nÄ± hesapla
            hat_direk_tipi_sayilari = {}  # (Ä°lÃ§e, Hat) -> {'mustertek': X, 'og': Y, 'trafo': Z}
            
            for index, row in df_fotograf.iterrows():
                try:
                    aob = str(row.get('Aob', '')).strip()
                    hat_adi = str(row.get('Hat adÄ±', '')).strip()
                    direk_tipi = str(row.get(direk_tipi_sutun, '')).strip().upper()
                    trafo_direk = str(row.get(trafo_sutun_adi, '')).strip().upper()
                    
                    if not aob or not hat_adi:
                        continue
                    
                    hat_anahtari = (aob, hat_adi)
                    
                    # Dictionary'yi baÅŸlat
                    if hat_anahtari not in hat_direk_tipi_sayilari:
                        hat_direk_tipi_sayilari[hat_anahtari] = {
                            'mustertek': 0,
                            'og': 0,
                            'trafo': 0,
                            'toplam': 0
                        }
                    
                    # Direk tipine gÃ¶re say
                    if 'MÃœÅTEREK' in direk_tipi or 'MUSTEREK' in direk_tipi:
                        hat_direk_tipi_sayilari[hat_anahtari]['mustertek'] += 1
                    elif 'OG' in direk_tipi or 'OÄ' in direk_tipi:
                        hat_direk_tipi_sayilari[hat_anahtari]['og'] += 1
                    
                    # TRAFO DÄ°REÄÄ° kontrolÃ¼
                    if 'TRAFO' in trafo_direk or 'EVET' in trafo_direk or 'VAR' in trafo_direk or 'X' in trafo_direk or 'âœ“' in trafo_direk:
                        hat_direk_tipi_sayilari[hat_anahtari]['trafo'] += 1
                    
                    # Toplam direk sayÄ±sÄ±
                    hat_direk_tipi_sayilari[hat_anahtari]['toplam'] += 1
                    
                except Exception as e:
                    continue
            
            print(f"ğŸ“Š DEBUG: {len(hat_direk_tipi_sayilari)} hat iÃ§in direk tipi sayÄ±mlarÄ± hesaplandÄ±")
            
            # Ã–rnek gÃ¶ster
            for i, (anahtar, deger) in enumerate(list(hat_direk_tipi_sayilari.items())[:5]):
                print(f"   {anahtar}: MÃ¼ÅŸterek={deger['mustertek']}, OG={deger['og']}, Trafo={deger['trafo']}, Toplam={deger['toplam']}")

            # Excel dosyasÄ±nÄ± okumayÄ± dene
            try:
                # Hat Ã–zeti sayfasÄ±nÄ± oku
                df_hat_ozet = pd.read_excel(self.excel_dosyasi, sheet_name='Hat Ã–zeti')
                print(f"âœ… DEBUG: Hat Ã–zeti sayfasÄ± okundu - {len(df_hat_ozet)} satÄ±r")
            except Exception as e:
                messagebox.showerror("Hata", 
                                   f"Excel dosyasÄ± okunamadÄ± veya 'Hat Ã–zeti' sayfasÄ± bulunamadÄ±:\n{str(e)}\n\n"
                                   f"Dosya: {self.excel_dosyasi}")
                self.destroy()
                return False
            
            # FotoÄŸraf KlasÃ¶rleri sayfasÄ±nÄ± okumayÄ± dene (MESAFE BÄ°LGÄ°LERÄ° Ä°Ã‡Ä°N)
            try:
                df_fotograf = pd.read_excel(self.excel_dosyasi, sheet_name='FotoÄŸraf KlasÃ¶rleri')
                print(f"âœ… DEBUG: FotoÄŸraf KlasÃ¶rleri sayfasÄ± okundu - {len(df_fotograf)} satÄ±r")
                if 'Mesafe (m)' in df_fotograf.columns:
                    mesafe_dolu = df_fotograf['Mesafe (m)'].notna().sum()
                    print(f"ğŸ”¢ DEBUG: Mesafe sÃ¼tununda {mesafe_dolu} dolu satÄ±r")
            except:
                # FotoÄŸraf KlasÃ¶rleri sayfasÄ± yoksa uyarÄ± ver ama devam et
                messagebox.showwarning("UyarÄ±", "'FotoÄŸraf KlasÃ¶rleri' sayfasÄ± bulunamadÄ±. Mesafe istatistikleri hesaplanamayacak.")
                df_fotograf = pd.DataFrame()

            # Hat bazÄ±nda toplam mesafeyi hesapla
            hat_toplam_mesafe = self.hat_toplam_mesafe_hesapla(df_fotograf) if not df_fotograf.empty else {}
            print(f"ğŸ“Š DEBUG: Toplam {len(hat_toplam_mesafe)} hat iÃ§in mesafe hesaplandÄ±")            
            
            # Toplam istatistikleri hesapla
            toplam_ilce = df_fotograf['Aob'].nunique() if not df_fotograf.empty and 'Aob' in df_fotograf.columns else 0
            toplam_hat = df_hat_ozet['Hat AdÄ±'].nunique() if len(df_hat_ozet) > 0 and 'Hat AdÄ±' in df_hat_ozet.columns else 0
            toplam_direk = len(df_fotograf) if not df_fotograf.empty else 0
            toplam_foto = df_fotograf['FotoÄŸraf SayÄ±sÄ±'].sum() if not df_fotograf.empty and 'FotoÄŸraf SayÄ±sÄ±' in df_fotograf.columns else 0
            hat_bulgu_sayilari = self.hat_bulgu_sayilari_hesapla(df_fotograf) if not df_fotograf.empty else {}
            toplam_genel_mesafe = sum(hat_toplam_mesafe.values()) if hat_toplam_mesafe else 0

            # YENÄ°: Hat bazÄ±nda ay verilerini sakla - FÄ°LTRELEME Ä°Ã‡Ä°N GEREKLÄ°
            self.hat_ay_detaylari = {}
            
            # Ay verilerini FotoÄŸraf KlasÃ¶rleri sayfasÄ±ndan al ve HAT BAZINDA SAKLA
            ay_detay = {}  # TÃ¼m veriler iÃ§in ay detayÄ±
            
            if not df_fotograf.empty and 'Ay' in df_fotograf.columns and 'Aob' in df_fotograf.columns and 'Hat adÄ±' in df_fotograf.columns:
                for index, row in df_fotograf.iterrows():
                    ay = row.get('Ay')
                    aob = row.get('Aob')
                    hat_adi = row.get('Hat adÄ±')
                    hat_anahtari = (aob, hat_adi)
                    
                    if pd.notna(ay):
                        try:
                            # Ay'Ä± standart formata getir (2 haneli)
                            if isinstance(ay, (int, float)):
                                ay_str = f"{int(ay):02d}"
                            else:
                                ay_str = str(ay).strip().zfill(2)
                            
                            # GeÃ§erli ay mÄ± kontrol et
                            if ay_str in ['01', '02', '03', '04', '05', '06', '07', '08', '09', '10', '11', '12']:
                                # 1. HAT BAZINDA AY DETAYI (filtreleme iÃ§in)
                                if hat_anahtari not in self.hat_ay_detaylari:
                                    self.hat_ay_detaylari[hat_anahtari] = {}
                                
                                if ay_str not in self.hat_ay_detaylari[hat_anahtari]:
                                    self.hat_ay_detaylari[hat_anahtari][ay_str] = 0
                                
                                self.hat_ay_detaylari[hat_anahtari][ay_str] += 1
                                
                                # 2. TOPLAM AY DETAYI (tÃ¼m veriler iÃ§in)
                                if ay_str not in ay_detay:
                                    ay_detay[ay_str] = 0
                                ay_detay[ay_str] += 1
                        except Exception as e:
                            print(f"Ay iÅŸleme hatasÄ±: {e}")
                            continue
            
            # TEST: EÄŸer ay verisi yoksa test verisi ekle
            if not ay_detay:
                print("UYARI: Ay verisi bulunamadÄ±, test verisi ekleniyor...")
                ay_detay = {
                    '01': 150, '02': 200, '03': 180, '04': 220, 
                    '05': 250, '06': 300, '07': 280, '08': 320,
                    '09': 190, '10': 210, '11': 230, '12': 260
                }
            
            # Hat detay verilerini hazÄ±rla - FOTOÄRAF KLASÃ–RLERÄ°'NDEN DÄ°REK TÄ°PÄ° SAYIMLARI KULLAN
            hat_detay = []
            for index, row in df_hat_ozet.iterrows():
                # SÃ¼tun isimlerini kontrol et
                ilce_adi = row.get('Ä°lÃ§e', row.get('Aob', '')) if 'Ä°lÃ§e' in row else row.get('Aob', '')
                hat_adi = row.get('Hat AdÄ±', row.get('Hat adÄ±', ''))
                
                hat_anahtari = (ilce_adi, hat_adi)
                
                # Bu hat iÃ§in bulgu sayÄ±sÄ±nÄ± al
                bulgu_sayisi = hat_bulgu_sayilari.get(hat_anahtari, 0)
                
                # Bu hat iÃ§in toplam mesafeyi al
                toplam_mesafe = hat_toplam_mesafe.get(hat_anahtari, 0)
                
                # FOTOÄRAF KLASÃ–RLERÄ°'nden direk tipi sayÄ±mlarÄ±nÄ± al
                direk_tipi_istatistikleri = hat_direk_tipi_sayilari.get(hat_anahtari, {'mustertek': 0, 'og': 0, 'trafo': 0, 'toplam': 0})
                
                # MÃ¼ÅŸterek Direk sayÄ±sÄ±
                mustertek_direk = direk_tipi_istatistikleri['mustertek']
                
                # OG Direk sayÄ±sÄ± (Direk Tipi'ndeki OG + Trafo DireÄŸi)
                og_direk = direk_tipi_istatistikleri['og'] + direk_tipi_istatistikleri['trafo']
                
                # Direk sayÄ±sÄ± (toplam)
                direk_sayisi = direk_tipi_istatistikleri['toplam']
                
                # FotoÄŸraf sayÄ±sÄ± (FotoÄŸraf KlasÃ¶rleri'nden) - DÃœZELTÄ°LMÄ°Å HALÄ°
                foto_sayisi = 0

                # 1. Ã–NCE: "FotoÄŸraf SayÄ±sÄ±" sÃ¼tunundan hesapla
                if not df_fotograf.empty and 'FotoÄŸraf SayÄ±sÄ±' in df_fotograf.columns:
                    try:
                        # Hat iÃ§in kayÄ±tlarÄ± filtrele
                        mask = (df_fotograf['Aob'] == ilce_adi) & (df_fotograf['Hat adÄ±'] == hat_adi)
                        hat_fotograflari = df_fotograf[mask]
                        
                        if not hat_fotograflari.empty:
                            foto_sayisi = int(hat_fotograflari['FotoÄŸraf SayÄ±sÄ±'].sum())
                    except:
                        foto_sayisi = 0

                # 2. EÄER HALA 0 Ä°SE: Direk sayÄ±sÄ±ndan tahmin et
                if foto_sayisi == 0 and direk_sayisi > 0:
                    foto_sayisi = direk_sayisi * 2  # Her direk iÃ§in ortalama 2 fotoÄŸraf

                print(f"ğŸ“¸ DEBUG: {hat_anahtari} - FotoÄŸraf: {foto_sayisi}, Bulgu: {bulgu_sayisi}")
                
                print(f"ğŸ” DEBUG: {hat_anahtari} - "
                      f"MÃ¼ÅŸterek: {mustertek_direk}, "
                      f"OG (DirekTipi): {direk_tipi_istatistikleri['og']}, "
                      f"Trafo: {direk_tipi_istatistikleri['trafo']}, "
                      f"OG Toplam: {og_direk}, "
                      f"Toplam Direk: {direk_sayisi}, "
                      f"Bulgu: {bulgu_sayisi}")
                
                hat_detay.append({
                    'ilce': ilce_adi,
                    'hat_adi': hat_adi,
                    'musterk_direk': mustertek_direk,
                    'og_direk': og_direk,  # Direk Tipi'ndeki OG + Trafo DireÄŸi
                    'direk_sayisi': direk_sayisi,
                    'foto_sayisi': foto_sayisi,
                    'ilk_tarih': row.get('Ä°lk Ã‡ekim Tarihi', ''),
                    'son_tarih': row.get('Son Ã‡ekim Tarihi', ''),
                    'toplam_gun': row.get('Toplam GÃ¼n', 0),
                    'bulgu_sayisi': bulgu_sayisi,
                    'toplam_mesafe': toplam_mesafe,
                    'ilk_tarih_datetime': self.tarih_metninden_datetime(row.get('Ä°lk Ã‡ekim Tarihi', '')),
                    'son_tarih_datetime': self.tarih_metninden_datetime(row.get('Son Ã‡ekim Tarihi', '')),
                    'tarihsiz_yuzde': self.hat_tarihsiz_istatistikleri.get(hat_anahtari, 0),
                    'trafo_direk': direk_tipi_istatistikleri['trafo'],  # Sadece Trafo sayÄ±sÄ±
                    'og_direk_saf': direk_tipi_istatistikleri['og']  # Sadece Direk Tipi'ndeki OG
                })
            
            # Toplam istatistikleri hesapla
            toplam_mustertek = sum(item['musterk_direk'] for item in hat_detay)
            toplam_og = sum(item['og_direk'] for item in hat_detay)
            toplam_trafo = sum(item['trafo_direk'] for item in hat_detay)
            toplam_og_saf = sum(item['og_direk_saf'] for item in hat_detay)
            
            # Rapor verilerini sakla
            self.rapor_verileri = {
                'toplam_direk': toplam_direk,
                'toplam_ilce': toplam_ilce,
                'toplam_hat': toplam_hat,
                'toplam_foto': toplam_foto,
                'hat_detay': hat_detay,
                'ay_detay': ay_detay,
                'ilce_list': df_fotograf['Aob'].unique().tolist() if not df_fotograf.empty and 'Aob' in df_fotograf.columns else [],
                'toplam_bulgu': sum(hat_bulgu_sayilari.values()),
                'toplam_mesafe': toplam_genel_mesafe,
                'toplam_mustertek': toplam_mustertek,
                'toplam_og': toplam_og,
                'toplam_trafo': toplam_trafo,
                'toplam_og_saf': toplam_og_saf
            }
            
            print(f"ğŸ¯ DEBUG: Rapor verileri hazÄ±r")
            print(f"ğŸ“Š DEBUG: Toplam MÃ¼ÅŸterek Direk: {toplam_mustertek}")
            print(f"ğŸ“Š DEBUG: Toplam OG Direk (Trafo dahil): {toplam_og}")
            print(f"ğŸ“Š DEBUG: Toplam Trafo DireÄŸi: {toplam_trafo}")
            print(f"ğŸ“Š DEBUG: Toplam OG Direk (saf): {toplam_og_saf}")
            print(f"ğŸ“… DEBUG: Hat bazÄ±nda ay verileri hazÄ±r - {len(self.hat_ay_detaylari)} hat iÃ§in")
            
            # GÃ¶rselleÅŸtirmeleri gÃ¼ncelle
            self.istatistik_kartlari_olustur()
            self.grafikleri_ciz()
            self.tablolari_doldur()
            self.filtre_combobox_doldur()
            
            # Ã–ncelik verilerini yÃ¼kle (RaporEkrani aÃ§Ä±ldÄ±ÄŸÄ±nda otomatik yÃ¼kle)
            self.after(1000, self.oncelik_verileri_yukle)
            
            return True
        
        except Exception as e:
            messagebox.showerror("Hata", f"Excel dosyasÄ± iÅŸlenirken hata oluÅŸtu: {str(e)}\n\n"
                                      f"Dosya: {self.excel_dosyasi}")
            self.destroy()
            return False

    

    def hat_toplam_mesafe_hesapla(self, df_fotograf):
        """Her hat iÃ§in toplam mesafeyi hesaplar - DÃœZELTÄ°LMÄ°Å VERSÄ°YON"""
        hat_toplam_mesafe = {}
        
        try:
            # DataFrame boÅŸ mu kontrol et
            if df_fotograf.empty:
                print("âŒ DEBUG: DataFrame boÅŸ")
                return hat_toplam_mesafe
            
            # Gerekli sÃ¼tunlarÄ± kontrol et
            required_columns = ['Aob', 'Hat adÄ±', 'Mesafe (m)']
            missing_columns = [col for col in required_columns if col not in df_fotograf.columns]
            
            if missing_columns:
                print(f"âŒ DEBUG: Eksik sÃ¼tunlar: {missing_columns}")
                print(f"ğŸ” DEBUG: Mevcut sÃ¼tunlar: {df_fotograf.columns.tolist()}")
                return hat_toplam_mesafe
            
            print(f"âœ… DEBUG: {len(df_fotograf)} satÄ±r veri iÅŸlenecek")
            
            # Her hat iÃ§in grupla ve toplam mesafeyi hesapla
            for hat_anahtari, group in df_fotograf.groupby(['Aob', 'Hat adÄ±']):
                aob, hat_adi = hat_anahtari
                hat_mesafe_toplam = 0
                gecerli_mesafe_sayisi = 0
                
                for index, row in group.iterrows():
                    mesafe = row.get('Mesafe (m)', '')
                    
                    # BoÅŸ deÄŸerleri atla
                    if pd.isna(mesafe) or mesafe == '':
                        continue
                    
                    # Mesafe deÄŸerini sayÄ±ya Ã§evirmeye Ã§alÄ±ÅŸ
                    try:
                        mesafe_str = str(mesafe).strip()
                        
                        # BoÅŸ veya geÃ§ersiz deÄŸerleri atla
                        if mesafe_str in ['', 'Koordinat yok', 'HesaplanamadÄ±', 'nan', 'None', '-']:
                            continue
                        
                        # EÄŸer zaten sayÄ±ysa doÄŸrudan kullan
                        if isinstance(mesafe, (int, float)):
                            mesafe_float = float(mesafe)
                        else:
                            # String ise temizle ve Ã§evir
                            # Nokta ve virgÃ¼lleri temizle - binlik ayraÃ§ olabilir
                            mesafe_clean = mesafe_str.replace('.', '').replace(',', '.')
                            # Harf ve boÅŸluklarÄ± temizle
                            mesafe_clean = ''.join(c for c in mesafe_clean if c.isdigit() or c == '.')
                            
                            if mesafe_clean and mesafe_clean != '.':
                                mesafe_float = float(mesafe_clean)
                            else:
                                continue
                        
                        # Ã‡OK BÃœYÃœK sayÄ±larÄ± kontrol et (muhtemelen format hatasÄ±)
                        if mesafe_float > 1000000:  # 1000 km'den bÃ¼yÃ¼kse ÅŸÃ¼pheli
                            print(f"âš ï¸  ÅÃœPHELÄ° MESAFE: {hat_anahtari} - {mesafe_float} (Ã§ok bÃ¼yÃ¼k)")
                            # BÃ¼yÃ¼k sayÄ±larÄ± atla veya bÃ¶l
                            continue
                        
                        # MantÄ±klÄ± bir mesafe mi kontrol et (0-1000 km arasÄ±)
                        if 0 <= mesafe_float <= 1000000:
                            hat_mesafe_toplam += mesafe_float
                            gecerli_mesafe_sayisi += 1
                        else:
                            print(f"âš ï¸  GEÃ‡ERSÄ°Z MESAFE: {hat_anahtari} - {mesafe_float}")
                            
                    except (ValueError, TypeError) as e:
                        print(f"âš ï¸  Mesafe deÄŸeri Ã§evrilemedi: '{mesafe_str}' - Hata: {e}")
                        continue
                
                # Sadece geÃ§erli mesafesi olan hatlarÄ± ekle
                if gecerli_mesafe_sayisi > 0:
                    hat_toplam_mesafe[hat_anahtari] = hat_mesafe_toplam
                    print(f"âœ… {hat_anahtari}: {gecerli_mesafe_sayisi} direk, toplam {hat_mesafe_toplam:.2f} m = {hat_mesafe_toplam/1000:.2f} km")
            
            print(f"âœ… DEBUG: {len(hat_toplam_mesafe)} hat iÃ§in toplam mesafe hesaplandÄ±")
            
            # ToplamlarÄ± kontrol et
            toplam_mesafe = sum(hat_toplam_mesafe.values())
            print(f"ğŸ“Š GENEL TOPLAM: {toplam_mesafe:.2f} m = {toplam_mesafe/1000:.2f} km")
            
        except Exception as e:
            print(f"âŒ DEBUG: Toplam mesafe hesaplama hatasÄ±: {str(e)}")
            import traceback
            print(f"ğŸ” DEBUG: Hata detayÄ±: {traceback.format_exc()}")
        
        return hat_toplam_mesafe


	

    def filtre_combobox_doldur(self):  # Metod ismini dÃ¼zeltin
        if self.rapor_verileri:
            ilce_list = self.rapor_verileri['ilce_list']
            self.ilce_filter['values'] = ['TÃœMÃœ'] + ilce_list

    def tarih_metninden_datetime(self, tarih_metni):
        """Tarih metnini datetime objesine Ã§evirir - DÃœZELTÄ°LDÄ° (isim hatasÄ± giderildi)"""
        if not tarih_metni or tarih_metni == 'Belirsiz' or tarih_metni == 'Tarih yok' or tarih_metni == 'Tarihi Yok':
            return None
        
        try:
            # Sadece tarih formatÄ± (gg/aa/yyyy)
            if len(tarih_metni) == 10 and '/' in tarih_metni:
                return datetime.datetime.strptime(tarih_metni, '%d/%m/%Y')
            # Tarih ve saat formatÄ± (gg/aa/yyyy ss:dd:ss)
            elif ' ' in tarih_metni:
                return datetime.datetime.strptime(tarih_metni, '%d/%m/%Y %H:%M:%S')
            else:
                return None
        except:
            return None

    def hat_bulgu_sayilari_hesapla(self, df_fotograf):
        """Her hat iÃ§in Tespit Notu sayÄ±sÄ±nÄ± hesaplar"""
        hat_bulgu_sayilari = {}
        
        try:
            # Tespit Notu sÃ¼tunu var mÄ± kontrol et
            if 'Tespit Notu' not in df_fotograf.columns:
                print("UYARI: 'Tespit Notu' sÃ¼tunu bulunamadÄ±")
                return hat_bulgu_sayilari
            
            # Her satÄ±rÄ± iÅŸle
            for index, row in df_fotograf.iterrows():
                aob = row.get('Aob', '')
                hat_adi = row.get('Hat adÄ±', '')
                tespit_notu = row.get('Tespit Notu', '')
                
                # Tespit Notu boÅŸ deÄŸilse say
                if pd.notna(tespit_notu) and str(tespit_notu).strip() != '':
                    hat_anahtari = (aob, hat_adi)
                    
                    if hat_anahtari not in hat_bulgu_sayilari:
                        hat_bulgu_sayilari[hat_anahtari] = 0
                    
                    hat_bulgu_sayilari[hat_anahtari] += 1
            
            print(f"âœ… Bulgu sayÄ±larÄ± hesaplandÄ±: {len(hat_bulgu_sayilari)} hat iÃ§in toplam {sum(hat_bulgu_sayilari.values())} bulgu")
            
        except Exception as e:
            print(f"âŒ Bulgu sayÄ±sÄ± hesaplama hatasÄ±: {str(e)}")
        
        return hat_bulgu_sayilari
    
    def hat_bulgu_sayilari_hesapla(self, df_fotograf):
            """Her hat iÃ§in Tespit Notu sayÄ±sÄ±nÄ± hesaplar"""
            hat_bulgu_sayilari = {}
            
            try:
                # DataFrame boÅŸsa boÅŸ dÃ¶ndÃ¼r
                if df_fotograf.empty:
                    return hat_bulgu_sayilari
                
                # Tespit Notu sÃ¼tunu var mÄ± kontrol et
                if 'Tespit Notu' not in df_fotograf.columns:
                    print("UYARI: 'Tespit Notu' sÃ¼tunu bulunamadÄ±")
                    return hat_bulgu_sayilari
                
                # Aob ve Hat adÄ± sÃ¼tunlarÄ± var mÄ± kontrol et
                if 'Aob' not in df_fotograf.columns or 'Hat adÄ±' not in df_fotograf.columns:
                    print("UYARI: 'Aob' veya 'Hat adÄ±' sÃ¼tunlarÄ± bulunamadÄ±")
                    return hat_bulgu_sayilari
                
                # Her satÄ±rÄ± iÅŸle
                for index, row in df_fotograf.iterrows():
                    aob = row.get('Aob', '')
                    hat_adi = row.get('Hat adÄ±', '')
                    tespit_notu = row.get('Tespit Notu', '')
                    
                    # Tespit Notu boÅŸ deÄŸilse say
                    if pd.notna(tespit_notu) and str(tespit_notu).strip() != '':
                        hat_anahtari = (aob, hat_adi)
                        
                        if hat_anahtari not in hat_bulgu_sayilari:
                            hat_bulgu_sayilari[hat_anahtari] = 0
                        
                        hat_bulgu_sayilari[hat_anahtari] += 1
                
                print(f"âœ… Bulgu sayÄ±larÄ± hesaplandÄ±: {len(hat_bulgu_sayilari)} hat iÃ§in toplam {sum(hat_bulgu_sayilari.values())} bulgu")
                
            except Exception as e:
                print(f"âŒ Bulgu sayÄ±sÄ± hesaplama hatasÄ±: {str(e)}")
            
            return hat_bulgu_sayilari

    
    def istatistik_kartlari_olustur(self):
        """Ä°statistik kartlarÄ±nÄ± oluÅŸturur - DÃœZELTÄ°LMÄ°Å VERSÄ°YON"""
        for widget in self.kartlar_frame.winfo_children():
            widget.destroy()
            
        # YENÄ°: Toplam Mesafe kartÄ±nÄ± ekle - DÃœZELTÄ°LDÄ°
        kart_verileri = [
            {"baslik": "Toplam Ä°lÃ§e", "deger": self.rapor_verileri['toplam_ilce'], "birim": "adet", "renk": "#27ae60", "icon": "ğŸ™ï¸"},
            {"baslik": "Toplam Hat", "deger": self.rapor_verileri['toplam_hat'], "birim": "adet", "renk": "#e74c3c", "icon": "ğŸ›£ï¸"},
            {"baslik": "Toplam Direk", "deger": self.rapor_verileri['toplam_direk'], "birim": "adet", "renk": "#3498db", "icon": "ğŸ—ï¸"},
            {"baslik": "Toplam FotoÄŸraf", "deger": self.rapor_verileri['toplam_foto'], "birim": "adet", "renk": "#f39c12", "icon": "ğŸ“·"},
            {"baslik": "Toplam Bulgu", "deger": self.rapor_verileri['toplam_bulgu'], "birim": "adet", "renk": "#9b59b6", "icon": "ğŸ”"},
            {"baslik": "Toplam Mesafe", "deger": f"{self.rapor_verileri['toplam_mesafe']/1000:.2f}", "birim": "km", "renk": "#1abc9c", "icon": "ğŸ“"},  # DÃœZELTÄ°LDÄ°: metre -> km
        ]
        
        # Grid layout iÃ§in satÄ±r ve sÃ¼tun ayarÄ±
        rows = 1
        cols = len(kart_verileri)
        
        for i, kart in enumerate(kart_verileri):
            kart_frame = tk.Frame(self.kartlar_frame, bg=kart['renk'], relief='raised', bd=2)
            kart_frame.grid(row=0, column=i, sticky='nsew', padx=3, pady=2)
            
            # Grid hÃ¼crelerinin eÅŸit geniÅŸlemesi iÃ§in
            self.kartlar_frame.grid_columnconfigure(i, weight=1)
            self.kartlar_frame.grid_rowconfigure(0, weight=1)
            
            # Kart frame'inin iÃ§eriÄŸi iÃ§in grid
            kart_frame.grid_columnconfigure(0, weight=1)
            kart_frame.grid_rowconfigure(0, weight=1)  # Ä°kon ve baÅŸlÄ±k
            kart_frame.grid_rowconfigure(1, weight=1)  # DeÄŸer ve birim
            
            # Ä°kon ve baÅŸlÄ±k - ÃœST SATIR
            top_frame = tk.Frame(kart_frame, bg=kart['renk'])
            top_frame.grid(row=0, column=0, sticky='ew', padx=8, pady=(8, 2))
            
            # Ä°kon SOL - BÃœYÃœK
            icon_label = tk.Label(top_frame, text=kart['icon'], font=('Segoe UI', 16),
                                bg=kart['renk'], fg='white')
            icon_label.pack(side='left', padx=(0, 8))
            
            # BaÅŸlÄ±k - BÃœYÃœK
            baslik_label = tk.Label(top_frame, text=kart['baslik'], font=('Segoe UI', 11, 'bold'),
                                  bg=kart['renk'], fg='white', wraplength=80, justify='left')
            baslik_label.pack(side='left', fill='x', expand=True)
            
            # DeÄŸer ve birim - ALT SATIR
            bottom_frame = tk.Frame(kart_frame, bg=kart['renk'])
            bottom_frame.grid(row=1, column=0, sticky='ew', padx=8, pady=(2, 8))
            
            # DeÄŸer SOL - BÃœYÃœK
            deger_text = kart['deger']
            
            # SayÄ±sal deÄŸerleri formatla, string deÄŸerleri olduÄŸu gibi bÄ±rak
            if isinstance(deger_text, (int, float)):
                if kart['baslik'] == "Toplam Mesafe":
                    # Mesafe iÃ§in Ã¶zel format (2 ondalÄ±k)
                    deger_text = f"{deger_text:.2f}"
                else:
                    # DiÄŸer sayÄ±sal deÄŸerler iÃ§in binlik ayracÄ±
                    deger_text = f"{deger_text:,}"
            
            deger_label = tk.Label(bottom_frame, text=deger_text, font=('Segoe UI', 18, 'bold'),
                                 bg=kart['renk'], fg='white')
            deger_label.pack(side='left', padx=(0, 8))
            
            # Birim SAÄ - BÃœYÃœK
            birim_label = tk.Label(bottom_frame, text=kart['birim'], font=('Segoe UI', 12, 'bold'),
                                 bg=kart['renk'], fg='white')
            birim_label.pack(side='left')
            
        # Toplam Bulgu kartÄ±na tÄ±klanabilirlik ekle
        if len(self.kartlar_frame.winfo_children()) >= 5:  # 5. kart Toplam Bulgu
            bulgu_kart = self.kartlar_frame.winfo_children()[4]
            bulgu_kart.bind('<Button-1>', lambda e: self.toplam_bulgu_tikla())
            bulgu_kart.bind('<Enter>', lambda e: bulgu_kart.config(cursor="hand2"))
            bulgu_kart.bind('<Leave>', lambda e: bulgu_kart.config(cursor=""))




    def tablolari_doldur(self):
        if self.rapor_verileri:
            self.mevcut_filtreli_veri = sorted(self.rapor_verileri['hat_detay'], 
                                             key=lambda x: x['direk_sayisi'], reverse=True)
            self.tabloyu_guncelle(self.mevcut_filtreli_veri)

    def tabloyu_guncelle(self, hat_verileri):
        """Tabloyu gÃ¼nceller - DÃœZELTÄ°LMÄ°Å VERSÄ°YON"""
        for item in self.tree.get_children():
            self.tree.delete(item)
            
        for detay in hat_verileri:
            # Tarih deÄŸerlerini kontrol et ve "Tarihi Yok" olarak gÃ¶ster
            ilk_tarih = detay['ilk_tarih'] if detay['ilk_tarih'] not in ['Belirsiz', 'Tarih yok'] else 'Tarihi Yok'
            son_tarih = detay['son_tarih'] if detay['son_tarih'] not in ['Belirsiz', 'Tarih yok'] else 'Tarihi Yok'
            
            # SARI RENK KOÅULU - SADECE TOPLAM GÃœN SÃœTUNU Ä°Ã‡Ä°N
            hat_anahtari = (detay['ilce'], detay['hat_adi'])
            tarihsiz_yuzde = detay.get('tarihsiz_yuzde', 0)
            if tarihsiz_yuzde > 0:
                toplam_gun_deger = f"âš ï¸ {detay['toplam_gun']} gÃ¼n"  # UyarÄ± iÅŸareti + koyu yazÄ±
            else:
                toplam_gun_deger = f"{detay['toplam_gun']} gÃ¼n"
            
            # YENÄ°: Toplam mesafe bilgisini formatla - DÃœZELTÄ°LDÄ°
            toplam_mesafe = detay.get('toplam_mesafe', 0)
            if toplam_mesafe > 0:
                mesafe_deger = f"{toplam_mesafe/1000:.2f} km"  # DÃœZELTÄ°LDÄ°: metre -> km
            else:
                mesafe_deger = "-"
            
            # Tabloya satÄ±r ekle - TOPLAM MESAFE SÃœTUNU EKLENDÄ°
            item = self.tree.insert('', 'end', values=(
                detay['ilce'],
                detay['hat_adi'],
                f"{detay['musterk_direk']:,}",
                f"{detay['og_direk']:,}", 
                f"{detay['direk_sayisi']:,}",
                f"{detay['foto_sayisi']:,}",
                f"{detay['bulgu_sayisi']:,}",
                ilk_tarih,
                son_tarih,
                toplam_gun_deger,
                mesafe_deger  # YENÄ°: Toplam Mesafe sÃ¼tunu
            ))
            
            # Tarihsiz fotoÄŸraf yÃ¼zdesi 0'dan bÃ¼yÃ¼kse Ã¶zel tag ekle
            if tarihsiz_yuzde > 0:
                self.tree.item(item, tags=('uyari_gun',))
        
        # Tag stillerini ayarla - koyu yazÄ± tipi
        self.tree.tag_configure('uyari_gun', font=('Segoe UI', 10, 'bold'), foreground='#d35400')


    def arayuz_olustur(self):
        # ANA PENCEREYÄ° 9 BÄ°RÄ°M OLARAK AYARLA
        self.grid_rowconfigure(0, weight=3)  # Ãœst bÃ¶lÃ¼m: 3 birim
        self.grid_rowconfigure(1, weight=3)  # Grafik 1: 3 birim
        self.grid_rowconfigure(2, weight=3)  # Grafik 2: 3 birim
        self.grid_columnconfigure(0, weight=1)
        
        # 1. BÃ–LÃœM: ÃœST BAÅLIK VE Ä°STATÄ°STÄ°KLER (3 BÄ°RÄ°M)
        top_frame = tk.Frame(self, bg=self.colors['dark_bg'])
        top_frame.grid(row=0, column=0, sticky='nsew', padx=20, pady=10)
        
        title_frame = tk.Frame(top_frame, bg=self.colors['dark_bg'])
        title_frame.pack(fill='x', pady=(0, 10))
        
        title_label = tk.Label(title_frame, text="ğŸ“Š DÄ°REK Ä°STATÄ°STÄ°K RAPORU", 
                              font=('Segoe UI', 20, 'bold'),
                              fg=self.colors['text'], bg=self.colors['dark_bg'])
        title_label.pack()
        
        dosya_label = tk.Label(title_frame, text=f"Dosya: {os.path.basename(self.excel_dosyasi)}", 
                              font=('Segoe UI', 10),
                              fg=self.colors['accent'], bg=self.colors['dark_bg'])
        dosya_label.pack()
        
        stats_frame = tk.Frame(top_frame, bg=self.colors['dark_bg'])
        stats_frame.pack(fill='x', pady=10)
        
        self.kartlar_frame = tk.Frame(stats_frame, bg=self.colors['dark_bg'])
        self.kartlar_frame.pack(fill='x')
        
        # 2. VE 3. BÃ–LÃœM Ä°Ã‡Ä°N ANA Ä°Ã‡ERÄ°K FRAME
        content_frame = tk.Frame(self, bg=self.colors['dark_bg'])
        content_frame.grid(row=1, column=0, rowspan=2, sticky='nsew', padx=20, pady=(0, 10))
        
        # CONTENT FRAME'Ä° 2 SATIRA BÃ–L (GRAFÄ°K 1 ve GRAFÄ°K 2 iÃ§in)
        content_frame.grid_rowconfigure(0, weight=1)  # Grafik 1: 3 birim
        content_frame.grid_rowconfigure(1, weight=1)  # Grafik 2: 3 birim
        content_frame.grid_columnconfigure(0, weight=1)
        content_frame.grid_columnconfigure(1, weight=1)
        
        # SOL TARAF: TABLO (GRAFÄ°KLERLE AYNI YÃœKSEKLÄ°KTE)
        left_frame = tk.LabelFrame(content_frame, text="ğŸ›£ï¸ Hat DetaylarÄ±", 
                                  font=('Segoe UI', 14, 'bold'),
                                  fg=self.colors['text'], bg=self.colors['light_bg'],
                                  padx=15, pady=15)
        left_frame.grid(row=0, column=0, rowspan=2, sticky='nsew', padx=(0, 10))
        
        # SAÄ TARAF: GRAFÄ°KLER (ÃœST ÃœSTE)
        right_frame = tk.Frame(content_frame, bg=self.colors['dark_bg'])
        right_frame.grid(row=0, column=1, rowspan=2, sticky='nsew', padx=(10, 0))
        
        # SAÄ FRAME'Ä° 2 EÅÄ°T PARÃ‡AYA BÃ–L
        right_frame.grid_rowconfigure(0, weight=1)  # Grafik 1: 3 birim
        right_frame.grid_rowconfigure(1, weight=1)  # Grafik 2: 3 birim
        right_frame.grid_columnconfigure(0, weight=1)
        
        # SOL FRAME Ä°Ã‡ERÄ°ÄÄ° (TABLO)
        filter_frame = tk.Frame(left_frame, bg=self.colors['light_bg'])
        filter_frame.pack(fill='x', pady=(0, 10))
        
        tk.Label(filter_frame, text="Ä°lÃ§e:", font=('Segoe UI', 10, 'bold'),
                bg=self.colors['light_bg'], fg=self.colors['text']).pack(side='left', padx=(0, 5))
        
        self.ilce_filter_var = tk.StringVar(value="TÃœMÃœ")
        self.ilce_filter = ttk.Combobox(filter_frame, textvariable=self.ilce_filter_var, state="readonly", width=15)
        self.ilce_filter.pack(side='left', padx=(0, 15))
        
        tarih_filter_frame = tk.Frame(filter_frame, bg=self.colors['light_bg'])
        tarih_filter_frame.pack(side='left', padx=(0, 15))
        
        tk.Label(tarih_filter_frame, text="Tarih AralÄ±ÄŸÄ±:", font=('Segoe UI', 10, 'bold'),
                bg=self.colors['light_bg'], fg=self.colors['text']).pack(anchor='w')
        
        tarih_selection_frame = tk.Frame(tarih_filter_frame, bg=self.colors['light_bg'])
        tarih_selection_frame.pack(fill='x', pady=(5, 0))
        
        start_frame = tk.Frame(tarih_selection_frame, bg=self.colors['light_bg'])
        start_frame.pack(side='left', padx=(0, 10))
        
        tk.Label(start_frame, text="BaÅŸlangÄ±Ã§:", font=('Segoe UI', 9),
                bg=self.colors['light_bg'], fg=self.colors['text']).pack(anchor='w')
        
        self.baslangic_tarih_var = tk.StringVar()
        self.baslangic_entry = DateEntry(start_frame, 
                                       textvariable=self.baslangic_tarih_var,
                                       date_pattern='dd/mm/yyyy',
                                       width=12, 
                                       font=('Segoe UI', 9),
                                       background='white',
                                       foreground='black',
                                       borderwidth=1,
                                       locale='tr_TR')
        self.baslangic_entry.pack(pady=(2, 0))
        self.baslangic_entry.delete(0, tk.END)
        
        self.takvimi_turkcelestir(self.baslangic_entry)
        
        end_frame = tk.Frame(tarih_selection_frame, bg=self.colors['light_bg'])
        end_frame.pack(side='left', padx=(10, 0))
        
        tk.Label(end_frame, text="BitiÅŸ:", font=('Segoe UI', 9),
                bg=self.colors['light_bg'], fg=self.colors['text']).pack(anchor='w')
        
        self.bitis_tarih_var = tk.StringVar()
        self.bitis_entry = DateEntry(end_frame, 
                                   textvariable=self.bitis_tarih_var,
                                   date_pattern='dd/mm/yyyy',
                                   width=12, 
                                   font=('Segoe UI', 9),
                                       background='white',
                                       foreground='black',
                                       borderwidth=1,
                                       locale='tr_TR')
        self.bitis_entry.pack(pady=(2, 0))
        self.bitis_entry.delete(0, tk.END)
        
        self.takvimi_turkcelestir(self.bitis_entry)
        
        button_frame = tk.Frame(filter_frame, bg=self.colors['light_bg'])
        button_frame.pack(side='left', padx=(15, 0))
        
        filter_btn = tk.Button(button_frame, text="Filtrele", font=('Segoe UI', 10, 'bold'),
                              bg=self.colors['accent'], fg='white', relief='raised',
                              command=self.filtrele, width=10)
        filter_btn.pack(side='left', padx=(0, 5))
        
        reset_btn = tk.Button(button_frame, text="SÄ±fÄ±rla", font=('Segoe UI', 10, 'bold'),
                             bg=self.colors['warning'], fg='white', relief='raised',
                             command=self.filtreleri_sifirla, width=10)
        reset_btn.pack(side='left')
        
        tree_frame = tk.Frame(left_frame, bg=self.colors['light_bg'])
        tree_frame.pack(fill='both', expand=True)
        

        # Tablo sÃ¼tunlarÄ±nÄ± Ä°STENEN SIRAYA gÃ¶re tanÄ±mla - TOPLAM MESAFE SÃœTUNU EKLENDÄ°
        self.tree = ttk.Treeview(tree_frame, columns=(
            'Ilce', 'HatAdi', 'MusterkDirek', 'OgDirek', 'DirekSayisi', 
            'FotoSayisi', 'BulguSayisi', 'IlkTarih', 'SonTarih', 'ToplamGun', 'ToplamMesafe'  # YENÄ°: ToplamMesafe eklendi
        ), show='headings')
        
        # SÃ¼tun baÅŸlÄ±klarÄ±nÄ± Ä°STENEN SIRAYA gÃ¶re ayarla - TOPLAM MESAFE SÃœTUNU EKLENDÄ°
        self.tree.heading('Ilce', text='Ä°lce', command=lambda: self.sutun_sirala('Ilce'))
        self.tree.heading('HatAdi', text='Hat AdÄ±', command=lambda: self.sutun_sirala('HatAdi'))
        self.tree.heading('MusterkDirek', text='MÃ¼ÅŸterek Direk', command=lambda: self.sutun_sirala('MusterkDirek'))
        self.tree.heading('OgDirek', text='OG Direk', command=lambda: self.sutun_sirala('OgDirek'))
        self.tree.heading('DirekSayisi', text='Direk SayÄ±sÄ±', command=lambda: self.sutun_sirala('DirekSayisi'))
        self.tree.heading('FotoSayisi', text='FotoÄŸraf SayÄ±sÄ±', command=lambda: self.sutun_sirala('FotoSayisi'))
        self.tree.heading('BulguSayisi', text='Bulgu', command=lambda: self.sutun_sirala('BulguSayisi'))
        self.tree.heading('IlkTarih', text='Ä°lk Ã‡ekim Tarihi', command=lambda: self.sutun_sirala('IlkTarih'))
        self.tree.heading('SonTarih', text='Son Ã‡ekim Tarihi', command=lambda: self.sutun_sirala('SonTarih'))
        self.tree.heading('ToplamGun', text='Toplam GÃ¼n', command=lambda: self.sutun_sirala('ToplamGun'))
        self.tree.heading('ToplamMesafe', text='Toplam Mesafe', command=lambda: self.sutun_sirala('ToplamMesafe'))  # YENÄ°
        
        # SÃ¼tun geniÅŸliklerini ayarla - TOPLAM MESAFE SÃœTUNU EKLENDÄ°
        self.tree.column('Ilce', width=120, anchor='center')
        self.tree.column('HatAdi', width=200, anchor='w')
        self.tree.column('MusterkDirek', width=120, anchor='center')
        self.tree.column('OgDirek', width=100, anchor='center')
        self.tree.column('DirekSayisi', width=100, anchor='center')
        self.tree.column('FotoSayisi', width=120, anchor='center')
        self.tree.column('BulguSayisi', width=80, anchor='center')
        self.tree.column('IlkTarih', width=120, anchor='center')
        self.tree.column('SonTarih', width=120, anchor='center')
        self.tree.column('ToplamGun', width=100, anchor='center')
        self.tree.column('ToplamMesafe', width=120, anchor='center')  # YENÄ°        
        
        # Ã‡ift tÄ±klama olayÄ±nÄ± baÄŸla
        self.tree.bind('<Double-1>', self.tabloya_cift_tikla)
        
        scrollbar = ttk.Scrollbar(tree_frame, orient='vertical', command=self.tree.yview)
        self.tree.configure(yscrollcommand=scrollbar.set)
        
        self.tree.pack(side='left', fill='both', expand=True)
        scrollbar.pack(side='right', fill='y')
        
        # SAÄ TARAF: GRAFÄ°KLER (EÅÄ°T BOYUTTA)
        
        # GRAFÄ°K 1: Ä°lÃ§elere gÃ¶re direk daÄŸÄ±lÄ±mÄ± (3 BÄ°RÄ°M)
        self.graf1_frame = tk.LabelFrame(right_frame, text="ğŸ™ï¸ Ä°lÃ§elere GÃ¶re Direk DaÄŸÄ±lÄ±mÄ±", 
                                       font=('Segoe UI', 12, 'bold'),
                                       fg=self.colors['text'], bg=self.colors['light_bg'],
                                       padx=10, pady=10)
        self.graf1_frame.grid(row=0, column=0, sticky='nsew', pady=(0, 5))
        
        # GRAFÄ°K 2: Aylara gÃ¶re direk sayÄ±sÄ± (3 BÄ°RÄ°M)
        self.graf2_frame = tk.LabelFrame(right_frame, text="ğŸ“… Aylara GÃ¶re Direk SayÄ±sÄ±", 
                                       font=('Segoe UI', 12, 'bold'),
                                       fg=self.colors['text'], bg=self.colors['light_bg'],
                                       padx=10, pady=10)
        self.graf2_frame.grid(row=1, column=0, sticky='nsew', pady=(5, 0))
        
        # BOÅ GRAFÄ°KLERÄ° OLUÅTUR
        self.fig1 = plt.Figure(figsize=(6, 3.5), dpi=100)
        self.ax1 = self.fig1.add_subplot(111)
        self.canvas1 = FigureCanvasTkAgg(self.fig1, self.graf1_frame)
        self.canvas1.get_tk_widget().pack(fill='both', expand=True)
        
        self.fig2 = plt.Figure(figsize=(6, 3.5), dpi=100)
        self.ax2 = self.fig2.add_subplot(111)
        self.canvas2 = FigureCanvasTkAgg(self.fig2, self.graf2_frame)
        self.canvas2.get_tk_widget().pack(fill='both', expand=True)
    
    def tabloya_cift_tikla(self, event):
        """Tablo hÃ¼cresine Ã§ift tÄ±klandÄ±ÄŸÄ±nda hangi sÃ¼tuna tÄ±klandÄ±ÄŸÄ±nÄ± tespit eder ve ilgili iÅŸlemi yapar"""
        item = self.tree.selection()[0] if self.tree.selection() else None
        if not item:
            return
        
        # TÄ±klanan sÃ¼tunu tespit et
        x = event.x
        column = self.tree.identify_column(x)
        column_index = int(column.replace('#', '')) - 1  # SÃ¼tun indeksi (0'dan baÅŸlar)

        values = self.tree.item(item, 'values')
        if not values:
            return
        
        ilce = values[0]
        hat_adi = values[1]
        direk_no = values[3]  # Direk No sÃ¼tunu (4. sÃ¼tun, indeks 3)

        # DÄ°REK NO SÃœTUNUNA TIKLANDIÄINDA TESPÄ°T EXCEL'Ä°NÄ° FÄ°LTRELÄ° AÃ‡ - YENÄ° EKLENDÄ°
        if column_index == 3:  # Direk No sÃ¼tunu (4. sÃ¼tun, indeks 3)
            self.direk_no_icin_tespit_excelini_ac(ilce, hat_adi, direk_no)
        
        # BULGU SÃœTUNUNA TIKLANDIÄINDA EXCEL DOSYASINI AÃ‡
        elif column_index == 6:  # Bulgu sÃ¼tunu (7. sÃ¼tun, indeks 6)
            bulgu_sayisi = values[6]
            if bulgu_sayisi != '0' and bulgu_sayisi != '':
                self.hat_excel_dosyasini_ac(ilce, hat_adi)
            else:
                messagebox.showinfo("Bilgi", "Bu hat iÃ§in bulgu bulunmuyor")
        
        # Tarih sÃ¼tunlarÄ±na tÄ±klandÄ±ÄŸÄ±nda EXIF dÃ¼zenleyiciyi aÃ§
        elif column_index == 7:  # Ä°lk Tarih sÃ¼tunu (8. sÃ¼tun, indeks 7)
            tarih_degeri = values[7]
            if tarih_degeri != 'Tarih yok' and tarih_degeri != 'Belirsiz' and tarih_degeri != 'Tarihi Yok':
                self.tarih_klasorunu_ac(ilce, hat_adi, tarih_degeri, "ilk")
            else:
                messagebox.showinfo("Bilgi", "Ä°lk tarih bilgisi bulunmuyor")
            
        elif column_index == 8:  # Son Tarih sÃ¼tunu (9. sÃ¼tun, indeks 8)
            tarih_degeri = values[8]
            if tarih_degeri != 'Tarih yok' and tarih_degeri != 'Belirsiz' and tarih_degeri != 'Tarihi Yok':
                self.tarih_klasorunu_ac(ilce, hat_adi, tarih_degeri, "son")
            else:
                messagebox.showinfo("Bilgi", "Son tarih bilgisi bulunmuyor")
        
        # TOPLAM GÃœN sÃ¼tununa tÄ±klandÄ±ÄŸÄ±nda DÄ°REKT EXIF dÃ¼zenleyiciyi aÃ§ (soru sormadan)
        elif column_index == 9:  # Toplam GÃ¼n sÃ¼tunu (10. sÃ¼tun, indeks 9)
            toplam_gun = values[9]
            if toplam_gun != '0 gÃ¼n' and toplam_gun != 'Belirsiz':
                # DÄ°REKT EXIF dÃ¼zenleyiciyi aÃ§ - TÃœM fotoÄŸraflar seÃ§ili olarak
                self.tum_hat_fotograflarini_ac(ilce, hat_adi)
            else:
                messagebox.showinfo("Bilgi", "Bu hat iÃ§in tarih bilgisi bulunmuyor")
        
        # HAT ADI sÃ¼tununa tÄ±klandÄ±ÄŸÄ±nda klasÃ¶rÃ¼ aÃ§
        elif column_index == 1:  # Hat AdÄ± sÃ¼tunu (2. sÃ¼tun, indeks 1)
            self.hat_klasoru_ac(ilce, hat_adi)
        
        else:
            # DiÄŸer sÃ¼tunlara tÄ±klandÄ±ÄŸÄ±nda hiÃ§bir ÅŸey yapma
            return

    def hat_excel_dosyasini_ac(self, ilce, hat_adi):
        """Rapor Excel'ini BULGULAR FÄ°LTRELÄ° aÃ§ar ve HAT TESPÄ°T Excel'ini de aÃ§ar - DÄ°REK ID TEMÄ°ZLÄ°"""
        try:
            # Rapor dosyasÄ±nÄ± bulmak iÃ§in farklÄ± yollar deneyelim
            rapor_dosyasi = None
            
            # 1. Ã–nce AnaUygulama'daki kaydetme_yeri'ni kontrol et
            if hasattr(self, 'parent') and hasattr(self.parent, 'kaydetme_yeri'):
                ana_rapor = self.parent.kaydetme_yeri.get()
                if ana_rapor and os.path.exists(ana_rapor):
                    rapor_dosyasi = ana_rapor
                    self.log(f"ğŸ“ Ana uygulamadan rapor bulundu: {os.path.basename(rapor_dosyasi)}")
            
            # 2. RaporEkrani oluÅŸturulurken verilen excel_dosyasi'ni kontrol et
            if not rapor_dosyasi and hasattr(self, 'excel_dosyasi'):
                if self.excel_dosyasi and os.path.exists(self.excel_dosyasi):
                    rapor_dosyasi = self.excel_dosyasi
                    self.log(f"ğŸ“ RaporEkrani'nden rapor bulundu: {os.path.basename(rapor_dosyasi)}")
            
            # 3. Son Ã§are: kullanÄ±cÄ±ya sor
            if not rapor_dosyasi:
                rapor_dosyasi = filedialog.askopenfilename(
                    title="Rapor Excel DosyasÄ±nÄ± SeÃ§in",
                    filetypes=[("Excel files", "*.xlsx"), ("All files", "*.*")]
                )
                if not rapor_dosyasi:
                    return
            
            if not os.path.exists(rapor_dosyasi):
                messagebox.showerror("Hata", f"Rapor dosyasÄ± bulunamadÄ±: {rapor_dosyasi}")
                return
            
            self.log(f"ğŸ” Rapor analiz ediliyor: {os.path.basename(rapor_dosyasi)}")
            
            # Rapor Excel'ini oku
            df_rapor = pd.read_excel(rapor_dosyasi, sheet_name='FotoÄŸraf KlasÃ¶rleri')
            
            # SÃ¼tunlarÄ± logla
            self.log(f"ğŸ“Š Excel sÃ¼tunlarÄ±: {df_rapor.columns.tolist()}")
            
            # 1. Ä°lÃ§e ve hat adÄ±na gÃ¶re filtrele
            if 'Aob' not in df_rapor.columns or 'Hat adÄ±' not in df_rapor.columns:
                messagebox.showerror("Hata", "Excel'de 'Aob' veya 'Hat adÄ±' sÃ¼tunu bulunamadÄ±!")
                return
            
            filtre_ilce_hat = (df_rapor['Aob'] == ilce) & (df_rapor['Hat adÄ±'] == hat_adi)
            hat_satirlari = df_rapor[filtre_ilce_hat]
            
            self.log(f"ğŸ” {ilce}-{hat_adi} iÃ§in {len(hat_satirlari)} satÄ±r bulundu")
            
            if hat_satirlari.empty:
                messagebox.showinfo("Bilgi", f"{ilce} - {hat_adi} iÃ§in kayÄ±t bulunamadÄ±!")
                
                # Mevcut ilÃ§e ve hatlarÄ± gÃ¶ster
                ilceler = df_rapor['Aob'].dropna().unique()
                hatlar = df_rapor['Hat adÄ±'].dropna().unique()
                self.log(f"ğŸ“‹ Mevcut ilÃ§eler: {ilceler}")
                self.log(f"ğŸ“‹ Mevcut hatlar: {hatlar}")
                return
            
            # 2. Tespit Notu olan satÄ±rlarÄ± bul (BULGULAR)
            tespit_sutunu = 'Tespit Notu'
            if tespit_sutunu not in hat_satirlari.columns:
                messagebox.showwarning("UyarÄ±", f"'{tespit_sutunu}' sÃ¼tunu bulunamadÄ±!")
                self.log(f"ğŸ“‹ Mevcut sÃ¼tunlar: {hat_satirlari.columns.tolist()}")
                return
            
            # Tespit Notu dolu olan satÄ±rlarÄ± filtrele
            filtre_tespit = (hat_satirlari[tespit_sutunu].notna()) & (hat_satirlari[tespit_sutunu] != '')
            bulgu_satirlari = hat_satirlari[filtre_tespit]
            
            self.log(f"ğŸ¯ {ilce}-{hat_adi} iÃ§in {len(bulgu_satirlari)} bulgu satÄ±rÄ± bulundu")
            
            if bulgu_satirlari.empty:
                messagebox.showinfo("Bilgi", f"{ilce} - {hat_adi} iÃ§in bulgu bulunamadÄ±!")
                # Bulgu yoksa sadece hat Excel'ini aÃ§
                self.hat_tespit_excelini_ac_temizli(ilce, hat_adi)
                return
            
            # Sadece HAT TESPÄ°T Excel'ini aÃ§ - DÄ°REK ID TEMÄ°ZLÄ°
            self.hat_tespit_excelini_ac_temizli(ilce, hat_adi)
            
        except Exception as e:
            messagebox.showerror("Hata", f"Excel aÃ§Ä±lÄ±rken hata: {str(e)}")
            import traceback
            self.log(f"ğŸ” Hata detayÄ±: {traceback.format_exc()}")

    def direk_id_isle_excel(self, direk_id_serisi):
        """Excel iÃ§in Direk ID temizleme - pandas Series uyumlu"""
        try:
            def temizle_deger(deger):
                if pd.isna(deger) or deger == '' or deger is None:
                    return ''
                
                deger_str = str(deger).strip()
                deger_str = deger_str.replace('-', '')  # TÃ¼m - iÅŸaretlerini kaldÄ±r
                
                if not deger_str:
                    return ''
                
                if deger_str.isdigit():
                    try:
                        return int(deger_str)
                    except:
                        return deger_str
                else:
                    return deger_str
            
            return direk_id_serisi.apply(temizle_deger)
            
        except Exception as e:
            self.log(f"âš ï¸ Excel Direk ID temizleme hatasÄ±: {str(e)}")
            return direk_id_serisi

    def hat_tespit_excelini_ac_temizli(self, ilce, hat_adi):
        """Orjinal Excel'i aÃ§, temizle, hizala, filtre ekle ve kaydet - SESSÄ°Z AÃ‡MA"""
        try:
            # 1. Ä°lgili hat iÃ§in klasÃ¶r yollarÄ±nÄ± bul
            klasor_yollari = self.hat_klasor_yollari_bul(ilce, hat_adi)
            
            if not klasor_yollari:
                self.log(f"âš ï¸ {ilce}-{hat_adi} iÃ§in klasÃ¶r bulunamadÄ±!")
                return
            
            # 2. Hat klasÃ¶rÃ¼nÃ¼ bul
            ilk_klasor = klasor_yollari[0]
            hat_klasoru = os.path.dirname(ilk_klasor)
            
            if not os.path.exists(hat_klasoru):
                self.log(f"âš ï¸ Hat klasÃ¶rÃ¼ bulunamadÄ±: {hat_klasoru}")
                return
            
            # 3. Excel dosyalarÄ±nÄ± ara
            excel_dosyalari = []
            for dosya in os.listdir(hat_klasoru):
                if dosya.lower().endswith(('.xlsx', '.xls')):
                    excel_dosyalari.append(os.path.join(hat_klasoru, dosya))
            
            if not excel_dosyalari:
                self.log(f"âš ï¸ {hat_klasoru} klasÃ¶rÃ¼nde Excel dosyasÄ± bulunamadÄ±!")
                return
            
            # 4. ORÄ°JÄ°NAL Excel dosyasÄ±nÄ± seÃ§
            orijinal_excel = excel_dosyalari[0]
            
            self.log(f"ğŸ“‚ Orjinal Excel: {os.path.basename(orijinal_excel)}")
            self.log(f"ğŸ“ KlasÃ¶r: {hat_klasoru}")
            
            # 5. Excel dosyasÄ± aÃ§Ä±k mÄ± kontrol et
            try:
                # DosyayÄ± okuma modunda aÃ§maya Ã§alÄ±ÅŸ
                with open(orijinal_excel, 'rb'):
                    pass
            except PermissionError:
                self.log("âš ï¸ Excel dosyasÄ± aÃ§Ä±k! LÃ¼tfen Excel'i kapatÄ±p tekrar deneyin.")
                messagebox.showwarning("Excel AÃ§Ä±k", 
                                     f"{os.path.basename(orijinal_excel)} dosyasÄ± aÃ§Ä±k!\n\n"
                                     f"LÃ¼tfen Excel'i kapatÄ±p tekrar deneyin.")
                return
            
            # 6. Excel'i AÃ‡ ve Ä°ÅLE
            workbook = load_workbook(orijinal_excel)
            
            # Ä°lk worksheet'i al
            worksheet = workbook.active
            
            self.log(f"ğŸ“Š Sayfa: {worksheet.title}, SatÄ±r: {worksheet.max_row}, SÃ¼tun: {worksheet.max_column}")
            
            # 7. Direk ID sÃ¼tununu bul ve temizle
            direk_id_col_index = None
            for col in range(1, worksheet.max_column + 1):
                cell = worksheet.cell(row=1, column=col)
                if cell.value and isinstance(cell.value, str):
                    if "direk" in cell.value.lower() and "id" in cell.value.lower():
                        direk_id_col_index = col
                        self.log(f"âœ… Direk ID sÃ¼tunu bulundu: {col}. sÃ¼tun")
                        break
            
            # 8. Direk ID'leri temizle
            if direk_id_col_index:
                for row in range(2, worksheet.max_row + 1):
                    cell = worksheet.cell(row=row, column=direk_id_col_index)
                    if cell.value:
                        # Direk ID'yi temizle
                        temiz_deger = self.direk_id_degerini_temizle_yerel(str(cell.value))
                        cell.value = temiz_deger
                self.log(f"âœ… {worksheet.max_row - 1} Direk ID temizlendi")
            
            # 9. TÃœM HÃœCRELERÄ° SOLA HÄ°ZALA
            for row in worksheet.iter_rows(min_row=1, max_row=worksheet.max_row, 
                                          min_col=1, max_col=worksheet.max_column):
                for cell in row:
                    cell.alignment = Alignment(horizontal='left', vertical='center')
            
            self.log("âœ… TÃ¼m hÃ¼creler sola hizalandÄ±")
            
            # 10. BAÅLIK SATIRINI BÄ°Ã‡Ä°MLENDÄ°R (mavi arkaplan, beyaz yazÄ±)
            header_fill = PatternFill(start_color="4472C4", end_color="4472C4", fill_type="solid")
            header_font = Font(bold=True, color="FFFFFF")
            
            for col in range(1, worksheet.max_column + 1):
                header_cell = worksheet.cell(row=1, column=col)
                header_cell.fill = header_fill
                header_cell.font = header_font
                header_cell.alignment = Alignment(horizontal='center', vertical='center')
            
            self.log("âœ… BaÅŸlÄ±k satÄ±rÄ± biÃ§imlendirildi")
            
            # 11. FÄ°LTRE EKLE
            if worksheet.max_row > 1:
                filter_range = f"A1:{get_column_letter(worksheet.max_column)}{worksheet.max_row}"
                worksheet.auto_filter.ref = filter_range
                self.log(f"âœ… Filtre eklendi: {filter_range}")
            
            # 12. ORÄ°JÄ°NAL DOSYAYI KAYDET
            try:
                workbook.save(orijinal_excel)
                self.log(f"ğŸ’¾ Orjinal dosya kaydedildi: {os.path.basename(orijinal_excel)}")
                
                # Workbook'u kapat
                workbook.close()
                
            except PermissionError as e:
                self.log(f"âŒ Dosya kaydedilemedi: {e}")
                messagebox.showerror("KayÄ±t HatasÄ±", 
                                   f"Dosya kaydedilemedi:\n\n{str(e)}\n\n"
                                   "Excel dosyasÄ± aÃ§Ä±k olabilir. LÃ¼tfen kapatÄ±p tekrar deneyin.")
                return
            
            # 13. EXCEL DOSYASINI SESSÄ°ZCE AÃ‡ (etkileÅŸim kutusu olmadan)
            self.log(f"ğŸš€ Excel sessizce aÃ§Ä±lÄ±yor...")
            
            try:
                # Windows iÃ§in sessiz aÃ§ma
                if sys.platform == "win32":
                    # Method 1: os.startfile (genellikle sorunsuz Ã§alÄ±ÅŸÄ±r)
                    os.startfile(orijinal_excel)
                    
                    # Alternatif method 2: subprocess ile sessiz aÃ§ma
                    # subprocess.Popen([orijinal_excel], shell=True)
                    
                elif sys.platform == "darwin":
                    subprocess.run(["open", orijinal_excel])
                else:
                    subprocess.run(["xdg-open", orijinal_excel])
                    
                self.log(f"âœ… {ilce}-{hat_adi} TESPÄ°T Excel'i baÅŸarÄ±yla aÃ§Ä±ldÄ±!")
                
            except Exception as e:
                self.log(f"âš ï¸ Excel aÃ§Ä±lÄ±rken uyarÄ±: {e}")
                # Son Ã§are: kullanÄ±cÄ±ya dosya yolunu gÃ¶ster
                messagebox.showinfo("Excel AÃ§Ä±ldÄ±", 
                                  f"Excel dosyasÄ± iÅŸlendi ve kaydedildi.\n\n"
                                  f"Dosya: {orijinal_excel}\n\n"
                                  f"DosyayÄ± manuel olarak aÃ§abilirsiniz.")
            
            self.log("=" * 50)
            self.log("ğŸ¯ Ä°ÅLEMLER TAMAMLANDI:")
            self.log("   1. Direk ID'ler temizlendi (- iÅŸaretleri kaldÄ±rÄ±ldÄ±)")
            self.log("   2. TÃ¼m hÃ¼creler sola hizalandÄ±")
            self.log("   3. BaÅŸlÄ±k satÄ±rÄ± biÃ§imlendirildi")
            self.log("   4. Filtre eklendi")
            self.log("   5. Orjinal dosya kaydedildi")
            self.log("=" * 50)
            
        except Exception as e:
            self.log(f"âŒ HATA: {str(e)}")
            import traceback
            self.log(f"ğŸ” Traceback: {traceback.format_exc()[:500]}")  # Ä°lk 500 karakter

    
    def direk_id_degerini_temizle_yerel(self, direk_id):
        """Yerel versiyon - AnaUygulama'daki metodun aynÄ±sÄ±"""
        if not direk_id or direk_id.lower() == 'nan' or direk_id == 'None':
            return ''
        
        # String'e Ã§evir
        direk_str = str(direk_id).strip()
        
        # "-" iÅŸaretlerini kaldÄ±r (sondaki ve baÅŸtaki)
        direk_str = direk_str.rstrip('-').lstrip('-')
        
        if not direk_str:
            return ''
        
        # Rakam mÄ± kontrol et
        if direk_str[0].isdigit():
            try:
                # Nokta veya virgÃ¼l iÃ§eriyor mu kontrol et
                if '.' in direk_str or ',' in direk_str:
                    # Float'a Ã§evir, sonra integer'a Ã§evirmeye Ã§alÄ±ÅŸ
                    float_deger = float(direk_str.replace(',', '.'))
                    # EÄŸer tam sayÄ± ise integer'a Ã§evir
                    if float_deger.is_integer():
                        return int(float_deger)
                    else:
                        return float_deger
                else:
                    # DoÄŸrudan integer'a Ã§evir
                    return int(direk_str)
            except (ValueError, TypeError):
                # SayÄ±ya Ã§evrilemezse orijinal string deÄŸeri kullan
                return direk_str
        else:
            # Metin ile baÅŸlÄ±yorsa string olarak sakla
            return direk_str
            



    def log(self, message):
        """Log mesajÄ± iÃ§in basit metod"""
        # EÄŸer log_text varsa kullan, yoksa konsola yaz
        if hasattr(self, 'txt_sonuc') and self.txt_sonuc:
            self.txt_sonuc.insert(tk.END, f"{message}\n")
            self.txt_sonuc.see(tk.END)
        else:
            print(f"[Rapor] {message}")

        
    def hat_klasoru_ac(self, ilce, hat_adi):
        """Hat klasÃ¶rÃ¼nÃ¼ Windows Explorer'da aÃ§ar"""
        try:
            # Ä°lgili hat iÃ§in TÃœM klasÃ¶r yollarÄ±nÄ± bul
            klasor_yollari = self.hat_klasor_yollari_bul(ilce, hat_adi)
            
            if not klasor_yollari:
                messagebox.showwarning("UyarÄ±", f"{ilce} - {hat_adi} iÃ§in klasÃ¶r bulunamadÄ±!")
                return
            
            # Ä°lk klasÃ¶rÃ¼n BÄ°R ÃœST KLASÃ–RÃœNÃœ al (hat klasÃ¶rÃ¼nÃ¼ bul)
            ilk_klasor = klasor_yollari[0]
            hat_klasoru = os.path.dirname(ilk_klasor)  # Bir Ã¼st klasÃ¶r (hat klasÃ¶rÃ¼)
            
            if os.path.exists(hat_klasoru):
                # Windows Explorer'da HAT klasÃ¶rÃ¼nÃ¼ aÃ§
                if sys.platform == "win32":
                    os.startfile(hat_klasoru)
                elif sys.platform == "darwin":
                    subprocess.run(["open", hat_klasoru])
                else:
                    subprocess.run(["xdg-open", hat_klasoru])
                
                print(f"ğŸ“ Hat klasÃ¶rÃ¼ aÃ§Ä±ldÄ±: {hat_klasoru}")
            else:
                messagebox.showwarning("UyarÄ±", f"Hat klasÃ¶rÃ¼ bulunamadÄ±: {hat_klasoru}")
                
        except Exception as e:
            messagebox.showerror("Hata", f"KlasÃ¶r aÃ§Ä±lÄ±rken hata: {str(e)}")

    def tarih_klasorunu_ac(self, ilce, hat_adi, tarih_degeri, tarih_tipi):
        """Belirli bir tarihe ait klasÃ¶rÃ¼ bul ve EXIF dÃ¼zenleyiciyi aÃ§"""
        try:
            # Ä°lgili hat iÃ§in TÃœM klasÃ¶r yollarÄ±nÄ± bul
            klasor_yollari = self.hat_klasor_yollari_bul(ilce, hat_adi)
        
            if not klasor_yollari:
                messagebox.showwarning("UyarÄ±", f"{ilce} - {hat_adi} iÃ§in klasÃ¶r bulunamadÄ±!")
                return
        
            # Tarihi datetime objesine Ã§evir
            if ' ' in tarih_degeri:  # Tarih ve saat birlikte
                tarih_obj = datetime.datetime.strptime(tarih_degeri, '%d/%m/%Y %H:%M:%S')
            else:  # Sadece tarih
                tarih_obj = datetime.datetime.strptime(tarih_degeri, '%d/%m/%Y')
        
            # Bu tarihe ait klasÃ¶rÃ¼ bul
            hedef_klasor = self.tarihe_ait_klasoru_bul(klasor_yollari, tarih_obj, tarih_tipi)
        
            if hedef_klasor:
                # EXIF dÃ¼zenleyiciyi aÃ§ - TÃœM fotoÄŸraflar iÃ§in
                exif_editor = ExifDateEditor(self, hedef_klasor)
                exif_editor.log(f"ğŸ•’ {tarih_tipi.upper()} TARÄ°H KLASÃ–RÃœ: {os.path.basename(hedef_klasor)}")
                exif_editor.log(f"ğŸ“… Hedef Tarih: {tarih_degeri}")
                exif_editor.log(f"ğŸ“ Konum: {ilce} - {hat_adi}")
            else:
                messagebox.showinfo("Bilgi", 
                                  f"{ilce} - {hat_adi} iÃ§in {tarih_degeri} tarihine ait klasÃ¶r bulunamadÄ±.\n\n"
                                  f"TÃ¼m klasÃ¶rleri kontrol etmek iÃ§in hat adÄ±na Ã§ift tÄ±klayÄ±n.")
            
        except ValueError as e:
            messagebox.showerror("Hata", f"Tarih formatÄ± hatasÄ±: {tarih_degeri}\n{e}")
    
    def tarihe_ait_klasoru_bul(self, klasor_yollari, hedef_tarih, tarih_tipi):
        """Belirli bir tarihe ait klasÃ¶rÃ¼ bulur"""
        for klasor_yolu in klasor_yollari:
            # KlasÃ¶rdeki tÃ¼m fotoÄŸraflarÄ± kontrol et
            foto_tarihleri = self.klasor_fotograf_tarihlerini_bul(klasor_yolu)
            
            if not foto_tarihleri:
                continue
                
            if tarih_tipi == "ilk":
                # Ä°lk tarih iÃ§in: en eski fotoÄŸrafÄ±n tarihini kontrol et
                klasor_ilk_tarih = min(foto_tarihleri)
                if self.tarihler_esit_mi(klasor_ilk_tarih, hedef_tarih):
                    return klasor_yolu
            else:  # "son"
                # Son tarih iÃ§in: en yeni fotoÄŸrafÄ±n tarihini kontrol et
                klasor_son_tarih = max(foto_tarihleri)
                if self.tarihler_esit_mi(klasor_son_tarih, hedef_tarih):
                    return klasor_yolu
        
        return None
    
    def tarihler_esit_mi(self, tarih1, tarih2):
        """Ä°ki tarihin aynÄ± gÃ¼n olup olmadÄ±ÄŸÄ±nÄ± kontrol et (saat farkÄ±nÄ± gÃ¶zardÄ± et)"""
        return (tarih1.year == tarih2.year and 
                tarih1.month == tarih2.month and 
                tarih1.day == tarih2.day)
    
    def hat_klasorunu_ac(self, ilce, hat_adi, klasor_yollari):
        """TÃ¼m hat klasÃ¶rlerini EXIF dÃ¼zenleyicide aÃ§"""
        if klasor_yollari:
            # Ä°lk klasÃ¶rÃ¼ kullan
            secilen_klasor = klasor_yollari[0]
            
            # EXIF dÃ¼zenleyiciyi aÃ§ - TÃœM fotoÄŸraflar iÃ§in
            exif_editor = ExifDateEditor(self, secilen_klasor)
            exif_editor.log(f"ğŸ“ TÃ¼m hat klasÃ¶rleri: {ilce} - {hat_adi}")
            exif_editor.log(f"ğŸ“ SeÃ§ilen klasÃ¶r: {os.path.basename(secilen_klasor)}")
            if len(klasor_yollari) > 1:
                exif_editor.log(f"ğŸ“‚ Toplam {len(klasor_yollari)} klasÃ¶r bulundu")
        else:
            messagebox.showwarning("UyarÄ±", f"{ilce} - {hat_adi} iÃ§in klasÃ¶r bulunamadÄ±!")
    
    def hat_klasor_yollari_bul(self, ilce, hat_adi):
        """Ä°lÃ§e ve hat adÄ±na gÃ¶re TÃœM klasÃ¶r yollarÄ±nÄ± bulur"""
        try:
            df = pd.read_excel(self.excel_dosyasi, sheet_name='FotoÄŸraf KlasÃ¶rleri')
            
            # Ä°lÃ§e ve hat adÄ±na gÃ¶re filtrele
            filtrelenmis = df[(df['Aob'] == ilce) & (df['Hat adÄ±'] == hat_adi)]
            
            klasor_yollari = []
            
            for index, row in filtrelenmis.iterrows():
                klasor_yolu = row['KlasÃ¶r Yolu']
                if isinstance(klasor_yolu, str) and os.path.exists(klasor_yolu):
                    klasor_yollari.append(klasor_yolu)
                else:
                    # KlasÃ¶r yolunu bulamazsa, Excel'deki diÄŸer bilgileri kullanarak yol oluÅŸturmayÄ± dene
                    alternatif_yol = self.alternatif_klasor_yolu_olustur(row, ilce, hat_adi)
                    if alternatif_yol and os.path.exists(alternatif_yol):
                        klasor_yollari.append(alternatif_yol)
            
            return list(set(klasor_yollari))  # Tekilleri dÃ¶ndÃ¼r
            
        except Exception as e:
            print(f"KlasÃ¶r yolu bulma hatasÄ±: {e}")
            return []

    def alternatif_klasor_yolu_olustur(self, row, ilce, hat_adi):
        """Alternatif klasÃ¶r yolu oluÅŸturur"""
        try:
            # Ana klasÃ¶r yolunu Excel dosyasÄ±nÄ±n olduÄŸu dizinden tahmin et
            excel_dizin = os.path.dirname(self.excel_dosyasi)
            
            # OlasÄ± klasÃ¶r yapÄ±larÄ±nÄ± dene
            olasÄ±_yollar = [
                os.path.join(excel_dizin, ilce, hat_adi, str(row['Direk No'])),
                os.path.join(excel_dizin, "FotoÄŸraflar", ilce, hat_adi, str(row['Direk No'])),
                os.path.join(excel_dizin, "Images", ilce, hat_adi, str(row['Direk No'])),
                os.path.join(os.path.expanduser("~"), "Desktop", ilce, hat_adi, str(row['Direk No'])),
            ]
            
            for yol in olasÄ±_yollar:
                if os.path.exists(yol):
                    return yol
            
            return None
            
        except Exception as e:
            print(f"Alternatif yol oluÅŸturma hatasÄ±: {e}")
            return None
    
    def klasor_fotograf_tarihlerini_bul(self, klasor_yolu):
        """Bir klasÃ¶rdeki tÃ¼m fotoÄŸraflarÄ±n EXIF tarihlerini bulur"""
        tarihler = []
        foto_uzantilari = ('.jpg', '.jpeg', '.png', '.tiff', '.tif', '.bmp')
        
        try:
            for root, dirs, files in os.walk(klasor_yolu):
                for dosya in files:
                    if any(dosya.lower().endswith(ext) for ext in foto_uzantilari):
                        full_path = os.path.join(root, dosya)
                        tarih = self.fotograf_tarihini_al(full_path)
                        if tarih:
                            tarihler.append(tarih)
        except Exception as e:
            print(f"KlasÃ¶r tarama hatasÄ± {klasor_yolu}: {e}")
        
        return tarihler
    
    def fotograf_tarihini_al(self, dosya_yolu):
        """FotoÄŸrafÄ±n EXIF tarihini alÄ±r - GÃœNCELLENMÄ°Å"""
        try:
            with Image.open(dosya_yolu) as img:
                exif_data = img.getexif()
                if exif_data:
                    # Ã–ncelikle Ã§ekilme tarihini ara
                    datetime_original = exif_data.get(36867)  # DateTimeOriginal
                    if not datetime_original:
                        datetime_original = exif_data.get(306)  # DateTime
                    
                    if datetime_original:
                        try:
                            return datetime.datetime.strptime(datetime_original, '%Y:%m:%d %H:%M:%S')
                        except ValueError:
                            try:
                                return datetime.datetime.strptime(datetime_original, '%Y-%m:%d %H:%M:%S')
                            except:
                                return None
                
                # Piexif ile de dene
                try:
                    exif_dict = piexif.load(dosya_yolu)
                    if piexif.ExifIFD.DateTimeOriginal in exif_dict['Exif']:
                        tarih_bytes = exif_dict['Exif'][piexif.ExifIFD.DateTimeOriginal]
                        tarih_str = tarih_bytes.decode('utf-8')
                        return datetime.datetime.strptime(tarih_str, '%Y:%m:%d %H:%M:%S')
                except:
                    pass
                
                return None
                
        except Exception as e:
            print(f"EXIF okuma hatasÄ± {dosya_yolu}: {e}")
            return None

    def takvimi_turkcelestir(self, date_entry):
        try:
            calendar = date_entry._top_cal
            if calendar:
                for i, month in enumerate(self.turkce_aylar):
                    calendar._month_names[i] = month
                
                for i, day in enumerate(self.turkce_gunler):
                    calendar._week_days[i] = day
        except Exception:
            # Hata olursa hiÃ§bir ÅŸey yapma, sessizce devam et
            pass
    
    def sutun_sirala(self, sutun):
        if not self.mevcut_filtreli_veri:
            return
        
        if sutun not in self.siralama_durumu:
            self.siralama_durumu[sutun] = False
        
        ters = self.siralama_durumu[sutun]
        
        if sutun == 'Ilce':
            self.mevcut_filtreli_veri.sort(key=lambda x: x['ilce'], reverse=ters)
        elif sutun == 'HatAdi':
            self.mevcut_filtreli_veri.sort(key=lambda x: x['hat_adi'], reverse=ters)
        elif sutun == 'MusterkDirek':
            self.mevcut_filtreli_veri.sort(key=lambda x: x['musterk_direk'], reverse=ters)
        elif sutun == 'OgDirek':
            self.mevcut_filtreli_veri.sort(key=lambda x: x['og_direk'], reverse=ters)
        elif sutun == 'DirekSayisi':
            self.mevcut_filtreli_veri.sort(key=lambda x: x['direk_sayisi'], reverse=ters)
        elif sutun == 'FotoSayisi':
            self.mevcut_filtreli_veri.sort(key=lambda x: x['foto_sayisi'], reverse=ters)
        elif sutun == 'BulguSayisi':
            self.mevcut_filtreli_veri.sort(key=lambda x: x['bulgu_sayisi'], reverse=ters)
        elif sutun == 'IlkTarih':
            self.mevcut_filtreli_veri.sort(key=lambda x: x['ilk_tarih_datetime'] or datetime.datetime.min, reverse=ters)
        elif sutun == 'SonTarih':
            self.mevcut_filtreli_veri.sort(key=lambda x: x['son_tarih_datetime'] or datetime.datetime.min, reverse=ters)
        elif sutun == 'ToplamGun':
            self.mevcut_filtreli_veri.sort(key=lambda x: x['toplam_gun'], reverse=ters)
        elif sutun == 'ToplamMesafe':  # YENÄ°: Toplam Mesafe sÄ±ralama
            self.mevcut_filtreli_veri.sort(key=lambda x: x['toplam_mesafe'], reverse=ters)
        
        self.tabloyu_guncelle(self.mevcut_filtreli_veri)
        self.sutun_basliklarini_guncelle(sutun, ters)
        self.siralama_durumu[sutun] = not ters
    
    def sutun_basliklarini_guncelle(self, aktif_sutun, ters):
        sutun_bilgileri = {
            'Ilce': 'Ä°lce',
            'HatAdi': 'Hat AdÄ±', 
            'MusterkDirek': 'MÃ¼ÅŸterek Direk',
            'OgDirek': 'OG Direk',
            'DirekSayisi': 'Direk SayÄ±sÄ±',
            'FotoSayisi': 'FotoÄŸraf SayÄ±sÄ±',
            'BulguSayisi': 'Bulgu',  # YENÄ°: Bulgu sÃ¼tunu
            'IlkTarih': 'Ä°lk Ã‡ekim Tarihi',
            'SonTarih': 'Son Ã‡ekim Tarihi',
            'ToplamGun': 'Toplam GÃ¼n'
        }
        
        for sutun, orijinal_text in sutun_bilgileri.items():
            if sutun == aktif_sutun:
                if ters:
                    self.tree.heading(sutun, text=orijinal_text + ' â–¼')
                else:
                    self.tree.heading(sutun, text=orijinal_text + ' â–²')
            else:
                self.tree.heading(sutun, text=orijinal_text)
    
    def mevcut_filtreli_veriyi_al(self):
        if not self.rapor_verileri:
            return []
            
        secili_ilce = self.ilce_filter_var.get()
        baslangic_tarih = self.tarih_metninden_al(self.baslangic_tarih_var.get())
        bitis_tarih = self.tarih_metninden_al(self.bitis_tarih_var.get())
        
        filtrelenmis_veri = self.rapor_verileri['hat_detay']
        
        if secili_ilce != 'TÃœMÃœ':
            filtrelenmis_veri = [hat for hat in filtrelenmis_veri if hat['ilce'] == secili_ilce]
        
        if baslangic_tarih or bitis_tarih:
            yeni_filtre = []
            for hat in filtrelenmis_veri:
                if hat['son_tarih_datetime']:
                    hat_tarihi = hat['son_tarih_datetime']
                    hat_tarihi_date = hat_tarihi.date()
                    
                    baslangic_kosul = True
                    bitis_kosul = True
                    
                    if baslangic_tarih:
                        baslangic_kosul = hat_tarihi_date >= baslangic_tarih
                    if bitis_tarih:
                        bitis_kosul = hat_tarihi_date <= bitis_tarih
                    
                    if baslangic_kosul and bitis_kosul:
                        yeni_filtre.append(hat)
                else:
                    yeni_filtre.append(hat)
            
            filtrelenmis_veri = yeni_filtre
        
        return filtrelenmis_veri

    def filtrele(self):
        """Filtreleme yapar ve filtreli verilere gÃ¶re istatistikleri gÃ¼nceller"""
        # Mevcut filtreli veriyi al
        self.mevcut_filtreli_veri = self.mevcut_filtreli_veriyi_al()
        self.mevcut_filtreli_veri.sort(key=lambda x: x['direk_sayisi'], reverse=True)
        self.siralama_durumu = {}
        self.sutun_basliklarini_guncelle(None, False)
        self.tabloyu_guncelle(self.mevcut_filtreli_veri)
        
        # FÄ°LTRELÄ° VERÄ°YE GÃ–RE Ä°STATÄ°STÄ°KLERÄ° YENÄ°DEN HESAPLA
        self.filtreli_istatistikleri_guncelle()

    def filtreli_istatistikleri_guncelle(self):
        """Filtreli verilere gÃ¶re istatistikleri gÃ¼nceller"""
        if not self.mevcut_filtreli_veri:
            return
        
        # Filtreli verilere gÃ¶re yeni istatistikleri hesapla
        filtrelenmis_istatistikler = self.filtreli_istatistikleri_hesapla(self.mevcut_filtreli_veri)
        
        # Ä°statistik kartlarÄ±nÄ± gÃ¼ncelle
        self.istatistik_kartlari_guncelle(filtrelenmis_istatistikler)
        
        # Grafikleri gÃ¼ncelle
        self.grafikleri_guncelle_filtreli(self.mevcut_filtreli_veri, filtrelenmis_istatistikler)
        
    def filtreli_istatistikleri_hesapla(self, filtreli_veri):
        """Filtreli verilere gÃ¶re istatistikleri hesaplar"""
        try:
            if not filtreli_veri:
                return {}
            
            # Toplam istatistikleri hesapla
            toplam_ilce = len(set(hat['ilce'] for hat in filtreli_veri))
            toplam_hat = len(filtreli_veri)  # FiltrelenmiÅŸ hat sayÄ±sÄ±
            toplam_direk = sum(hat['direk_sayisi'] for hat in filtreli_veri)
            toplam_foto = sum(hat['foto_sayisi'] for hat in filtreli_veri)
            toplam_bulgu = sum(hat['bulgu_sayisi'] for hat in filtreli_veri)
            toplam_mesafe = sum(hat.get('toplam_mesafe', 0) for hat in filtreli_veri)
            
            # Ay daÄŸÄ±lÄ±mÄ± (orijinal Excel'den alÄ±nan veriler kullanÄ±lamaz, bu yÃ¼zden boÅŸ bÄ±rakÄ±yoruz)
            # EÄŸer ay verilerini de filtrelemek isterseniz, self.hat_ay_detaylari sÃ¶zlÃ¼ÄŸÃ¼nÃ¼ kullanmalÄ±sÄ±nÄ±z
            ay_detay = {}
            
            return {
                'toplam_ilce': toplam_ilce,
                'toplam_hat': toplam_hat,
                'toplam_direk': toplam_direk,
                'toplam_foto': toplam_foto,
                'toplam_bulgu': toplam_bulgu,
                'toplam_mesafe': toplam_mesafe,
                'ay_detay': ay_detay,
                'hat_detay': filtreli_veri
            }
            
        except Exception as e:
            print(f"Filtreli istatistik hesaplama hatasÄ±: {e}")
            return {}

    def filtreli_istatistikleri_hesapla(self, filtreli_veri):
        """Filtreli verilere gÃ¶re istatistikleri hesaplar"""
        try:
            if not filtreli_veri:
                return {}
            
            # Toplam istatistikleri hesapla
            toplam_ilce = len(set(hat['ilce'] for hat in filtreli_veri))
            toplam_hat = len(set((hat['ilce'], hat['hat_adi']) for hat in filtreli_veri))
            toplam_direk = sum(hat['direk_sayisi'] for hat in filtreli_veri)
            toplam_foto = sum(hat['foto_sayisi'] for hat in filtreli_veri)
            toplam_bulgu = sum(hat['bulgu_sayisi'] for hat in filtreli_veri)
            toplam_mesafe = sum(hat.get('toplam_mesafe', 0) for hat in filtreli_veri)
            
            # Aylara gÃ¶re daÄŸÄ±lÄ±mÄ± hesapla (orijinal Excel'den alÄ±namÄ±yor, bu nedenle mevcut verilerden yola Ã§Ä±kÄ±yoruz)
            # EÄŸer Excel'den ay bilgisi almak isterseniz, bu kÄ±smÄ± deÄŸiÅŸtirmeniz gerekir
            ay_detay = {}
            
            # FiltrelenmiÅŸ istatistikleri dÃ¶ndÃ¼r
            return {
                'toplam_ilce': toplam_ilce,
                'toplam_hat': toplam_hat,
                'toplam_direk': toplam_direk,
                'toplam_foto': toplam_foto,
                'toplam_bulgu': toplam_bulgu,
                'toplam_mesafe': toplam_mesafe,
                'ay_detay': ay_detay,
                'hat_detay': filtreli_veri
            }
            
        except Exception as e:
            print(f"Filtreli istatistik hesaplama hatasÄ±: {e}")
            return {}
            
    def istatistik_kartlari_guncelle(self, filtrelenmis_istatistikler):
        """Ä°statistik kartlarÄ±nÄ± filtreli verilere gÃ¶re gÃ¼nceller"""
        for widget in self.kartlar_frame.winfo_children():
            widget.destroy()
        
        # Kart verilerini filtreli istatistiklerden al
        toplam_mesafe_km = filtrelenmis_istatistikler.get('toplam_mesafe', 0) / 1000 if filtrelenmis_istatistikler.get('toplam_mesafe', 0) > 0 else 0
        
        kart_verileri = [
            {"baslik": "Toplam Ä°lÃ§e", "deger": filtrelenmis_istatistikler.get('toplam_ilce', 0), "birim": "adet", "renk": "#27ae60", "icon": "ğŸ™ï¸"},
            {"baslik": "Toplam Hat", "deger": filtrelenmis_istatistikler.get('toplam_hat', 0), "birim": "adet", "renk": "#e74c3c", "icon": "ğŸ›£ï¸"},
            {"baslik": "Toplam Direk", "deger": filtrelenmis_istatistikler.get('toplam_direk', 0), "birim": "adet", "renk": "#3498db", "icon": "ğŸ—ï¸"},
            {"baslik": "Toplam FotoÄŸraf", "deger": filtrelenmis_istatistikler.get('toplam_foto', 0), "birim": "adet", "renk": "#f39c12", "icon": "ğŸ“·"},
            {"baslik": "Toplam Bulgu", "deger": filtrelenmis_istatistikler.get('toplam_bulgu', 0), "birim": "adet", "renk": "#9b59b6", "icon": "ğŸ”"},
            {"baslik": "Toplam Mesafe", "deger": f"{toplam_mesafe_km:.2f}", "birim": "km", "renk": "#1abc9c", "icon": "ğŸ“"},
        ]
        
        # Grid layout iÃ§in satÄ±r ve sÃ¼tun ayarÄ±
        rows = 1
        cols = len(kart_verileri)
        
        for i, kart in enumerate(kart_verileri):
            kart_frame = tk.Frame(self.kartlar_frame, bg=kart['renk'], relief='raised', bd=2)
            kart_frame.grid(row=0, column=i, sticky='nsew', padx=3, pady=2)
            
            # Grid hÃ¼crelerinin eÅŸit geniÅŸlemesi iÃ§in
            self.kartlar_frame.grid_columnconfigure(i, weight=1)
            self.kartlar_frame.grid_rowconfigure(0, weight=1)
            
            # Kart frame'inin iÃ§eriÄŸi iÃ§in grid
            kart_frame.grid_columnconfigure(0, weight=1)
            kart_frame.grid_rowconfigure(0, weight=1)
            kart_frame.grid_rowconfigure(1, weight=1)
            
            # Ä°kon ve baÅŸlÄ±k - ÃœST SATIR
            top_frame = tk.Frame(kart_frame, bg=kart['renk'])
            top_frame.grid(row=0, column=0, sticky='ew', padx=8, pady=(8, 2))
            
            icon_label = tk.Label(top_frame, text=kart['icon'], font=('Segoe UI', 16),
                                bg=kart['renk'], fg='white')
            icon_label.pack(side='left', padx=(0, 8))
            
            baslik_label = tk.Label(top_frame, text=kart['baslik'], font=('Segoe UI', 11, 'bold'),
                                  bg=kart['renk'], fg='white', wraplength=80, justify='left')
            baslik_label.pack(side='left', fill='x', expand=True)
            
            # DeÄŸer ve birim - ALT SATIR
            bottom_frame = tk.Frame(kart_frame, bg=kart['renk'])
            bottom_frame.grid(row=1, column=0, sticky='ew', padx=8, pady=(2, 8))
            
            deger_text = kart['deger']
            
            # SayÄ±sal deÄŸerleri formatla
            if isinstance(deger_text, (int, float)):
                if kart['baslik'] == "Toplam Mesafe":
                    deger_text = f"{deger_text:.2f}"
                else:
                    deger_text = f"{deger_text:,}"
            
            deger_label = tk.Label(bottom_frame, text=deger_text, font=('Segoe UI', 18, 'bold'),
                                 bg=kart['renk'], fg='white')
            deger_label.pack(side='left', padx=(0, 8))
            
            birim_label = tk.Label(bottom_frame, text=kart['birim'], font=('Segoe UI', 12, 'bold'),
                                 bg=kart['renk'], fg='white')
            birim_label.pack(side='left')
            
    

        
    
    def tarih_metninden_al(self, tarih_metni):
        if not tarih_metni:
            return None
        
        try:
            return datetime.datetime.strptime(tarih_metni, '%d/%m/%Y').date()
        except:
            return None
    
    def filtreleri_sifirla(self):
        """Filtreleri sÄ±fÄ±rlar ve orijinal verilere dÃ¶ner"""
        self.ilce_filter_var.set("TÃœMÃœ")
        self.baslangic_tarih_var.set("")
        self.bitis_tarih_var.set("")
        self.baslangic_entry.delete(0, tk.END)
        self.bitis_entry.delete(0, tk.END)
        self.siralama_durumu = {}
        self.sutun_basliklarini_guncelle(None, False)
        
        # Orijinal verilere dÃ¶n
        self.mevcut_filtreli_veri = sorted(self.rapor_verileri['hat_detay'], 
                                         key=lambda x: x['direk_sayisi'], reverse=True)
        self.tabloyu_guncelle(self.mevcut_filtreli_veri)
        
        # Orijinal istatistikleri geri yÃ¼kle
        self.istatistik_kartlari_olustur()
        self.grafikleri_ciz()

    def grafikleri_ciz(self):
        """Grafikleri Ã§izer - TÃœM veriler iÃ§in (filtreleme olmadan)"""
        # Grafik 1: Ä°lÃ§elere gÃ¶re direk daÄŸÄ±lÄ±mÄ± - HARF SIRASINA GÃ–RE
        self.ax1.clear()
        
        ilce_verileri = {}
        for detay in self.rapor_verileri['hat_detay']:
            ilce = detay['ilce']
            if ilce not in ilce_verileri:
                ilce_verileri[ilce] = 0
            ilce_verileri[ilce] += detay['direk_sayisi']
        
        # Ä°lÃ§eleri harf sÄ±rasÄ±na gÃ¶re sÄ±rala
        ilce_adlari = sorted(ilce_verileri.keys())
        direk_sayilari = [ilce_verileri[ilce] for ilce in ilce_adlari]
        
        colors = ['#3498db', '#27ae60', '#e74c3c', '#f39c12', '#9b59b6', '#1abc9c', '#34495e', '#d35400']
        
        if ilce_adlari and direk_sayilari:
            bars = self.ax1.bar(ilce_adlari, direk_sayilari, color=colors[:len(ilce_adlari)])
            self.ax1.set_ylabel('Direk SayÄ±sÄ±', fontweight='bold')
            self.ax1.set_title('Ä°lÃ§elere GÃ¶re Direk DaÄŸÄ±lÄ±mÄ± (TÃ¼m Veriler)', fontsize=12, fontweight='bold')
            
            for bar in bars:
                height = bar.get_height()
                self.ax1.text(bar.get_x() + bar.get_width()/2., height,
                             f'{int(height):,}', ha='center', va='bottom', fontweight='bold')
            
            self.ax1.tick_params(axis='x', rotation=45)
            self.fig1.subplots_adjust(top=0.90, bottom=0.20, left=0.12, right=0.95)
        else:
            self.ax1.text(0.5, 0.5, 'Ä°lÃ§e verisi bulunamadÄ±', 
                         ha='center', va='center', transform=self.ax1.transAxes,
                         fontsize=12, color='gray')
            self.fig1.subplots_adjust(top=0.90, bottom=0.20, left=0.12, right=0.95)
        
        self.canvas1.draw()
        
        # Grafik 2: Aylara gÃ¶re direk sayÄ±sÄ± - TÃœM veriler iÃ§in
        self.ax2.clear()
        
        aylar = list(self.rapor_verileri['ay_detay'].keys())
        ay_direkleri = list(self.rapor_verileri['ay_detay'].values())
        
        if aylar and ay_direkleri:
            ay_sirasi = ['01', '02', '03', '04', '05', '06', '07', '08', '09', '10', '11', '12']
            sirali_aylar = [ay for ay in ay_sirasi if ay in aylar]
            sirali_degerler = [self.rapor_verileri['ay_detay'][ay] for ay in sirali_aylar]
            
            if sirali_aylar and sirali_degerler:
                ay_isimleri = ['Oca', 'Åub', 'Mar', 'Nis', 'May', 'Haz', 'Tem', 'AÄŸu', 'Eyl', 'Eki', 'Kas', 'Ara']
                ay_etiketi = []
                for ay in sirali_aylar:
                    try:
                        ay_index = int(ay) - 1
                        if 0 <= ay_index < len(ay_isimleri):
                            ay_etiketi.append(ay_isimleri[ay_index])
                        else:
                            ay_etiketi.append(ay)
                    except:
                        ay_etiketi.append(ay)
                
                bars = self.ax2.bar(ay_etiketi, sirali_degerler, color='#e74c3c', alpha=0.7)
                self.ax2.set_ylabel('Direk SayÄ±sÄ±', fontweight='bold')
                self.ax2.set_title('Aylara GÃ¶re Direk SayÄ±sÄ± (TÃ¼m Veriler)', fontsize=12, fontweight='bold')
                
                for i, v in enumerate(sirali_degerler):
                    self.ax2.text(i, v + 0.1, f'{v:,}', ha='center', va='bottom', fontweight='bold')
                
                self.ax2.set_xticks(range(len(ay_etiketi)))
                self.ax2.set_xticklabels(ay_etiketi)
                self.fig2.subplots_adjust(top=0.90, bottom=0.20, left=0.12, right=0.95)
            else:
                self.ax2.text(0.5, 0.5, 'SÄ±ralanmÄ±ÅŸ ay verisi bulunamadÄ±', 
                             ha='center', va='center', transform=self.ax2.transAxes,
                             fontsize=12, color='gray')
                self.fig2.subplots_adjust(top=0.90, bottom=0.20, left=0.12, right=0.95)
        else:
            self.ax2.text(0.5, 0.5, 'Ay verisi bulunamadÄ±', 
                         ha='center', va='center', transform=self.ax2.transAxes,
                         fontsize=12, color='gray')
            self.fig2.subplots_adjust(top=0.90, bottom=0.20, left=0.12, right=0.95)
        
        self.canvas2.draw()

    def grafikleri_guncelle_filtreli(self, filtreli_veri, istatistikler):
        """Grafikleri filtreli verilere gÃ¶re gÃ¼nceller"""
        # Grafik 1: FiltrelenmiÅŸ ilÃ§elere gÃ¶re direk daÄŸÄ±lÄ±mÄ±
        self.ax1.clear()
        
        ilce_verileri = {}
        for hat in filtreli_veri:
            ilce = hat['ilce']
            if ilce not in ilce_verileri:
                ilce_verileri[ilce] = 0
            ilce_verileri[ilce] += hat['direk_sayisi']
        
        # Ä°lÃ§eleri harf sÄ±rasÄ±na gÃ¶re sÄ±rala
        ilce_adlari = sorted(ilce_verileri.keys())
        direk_sayilari = [ilce_verileri[ilce] for ilce in ilce_adlari]
        
        colors = ['#3498db', '#27ae60', '#e74c3c', '#f39c12', '#9b59b6', '#1abc9c', '#34495e', '#d35400']
        
        if ilce_adlari and direk_sayilari:
            bars = self.ax1.bar(ilce_adlari, direk_sayilari, color=colors[:len(ilce_adlari)])
            self.ax1.set_ylabel('Direk SayÄ±sÄ±', fontweight='bold')
            self.ax1.set_title('Ä°lÃ§elere GÃ¶re Direk DaÄŸÄ±lÄ±mÄ± (FiltrelenmiÅŸ)', fontsize=12, fontweight='bold')
            
            for bar in bars:
                height = bar.get_height()
                self.ax1.text(bar.get_x() + bar.get_width()/2., height,
                             f'{int(height):,}', ha='center', va='bottom', fontweight='bold')
            
            self.ax1.tick_params(axis='x', rotation=45)
            self.fig1.subplots_adjust(top=0.90, bottom=0.20, left=0.12, right=0.95)
        else:
            self.ax1.text(0.5, 0.5, 'FiltrelenmiÅŸ ilÃ§e verisi bulunamadÄ±', 
                         ha='center', va='center', transform=self.ax1.transAxes,
                         fontsize=12, color='gray')
            self.fig1.subplots_adjust(top=0.90, bottom=0.20, left=0.12, right=0.95)
        
        self.canvas1.draw()
        
        # Grafik 2: FiltrelenmiÅŸ hatlarÄ±n ay daÄŸÄ±lÄ±mÄ±
        self.ax2.clear()
        
        # FiltrelenmiÅŸ hatlarÄ±n ay daÄŸÄ±lÄ±mÄ±nÄ± hesapla
        filtrelenmis_ay_detay = {}
        
        for hat in filtreli_veri:
            hat_anahtari = (hat['ilce'], hat['hat_adi'])
            
            # Bu hat iÃ§in ay verilerini al
            if hasattr(self, 'hat_ay_detaylari') and hat_anahtari in self.hat_ay_detaylari:
                for ay, sayi in self.hat_ay_detaylari[hat_anahtari].items():
                    if ay not in filtrelenmis_ay_detay:
                        filtrelenmis_ay_detay[ay] = 0
                    filtrelenmis_ay_detay[ay] += sayi
        
        # EÄŸer filtreli ay verisi yoksa, mesaj gÃ¶ster
        if not filtrelenmis_ay_detay:
            self.ax2.text(0.5, 0.5, 'FiltrelenmiÅŸ veriler iÃ§in\nay bilgisi bulunamadÄ±', 
                         ha='center', va='center', transform=self.ax2.transAxes,
                         fontsize=12, color='gray')
            self.fig2.subplots_adjust(top=0.90, bottom=0.20, left=0.12, right=0.95)
            self.canvas2.draw()
            return
        
        # Ay sÄ±ralamasÄ±
        ay_sirasi = ['01', '02', '03', '04', '05', '06', '07', '08', '09', '10', '11', '12']
        sirali_aylar = [ay for ay in ay_sirasi if ay in filtrelenmis_ay_detay]
        sirali_degerler = [filtrelenmis_ay_detay[ay] for ay in sirali_aylar]
        
        if sirali_aylar and sirali_degerler:
            # Ay isimleri (TÃ¼rkÃ§e kÄ±saltma)
            ay_isimleri = ['Oca', 'Åub', 'Mar', 'Nis', 'May', 'Haz', 'Tem', 'AÄŸu', 'Eyl', 'Eki', 'Kas', 'Ara']
            
            # Ay numaralarÄ±nÄ± isimlere Ã§evir
            ay_etiketi = []
            for ay in sirali_aylar:
                try:
                    ay_index = int(ay) - 1
                    if 0 <= ay_index < len(ay_isimleri):
                        ay_etiketi.append(ay_isimleri[ay_index])
                    else:
                        ay_etiketi.append(ay)
                except:
                    ay_etiketi.append(ay)
            
            # GrafiÄŸi Ã§iz
            bars = self.ax2.bar(ay_etiketi, sirali_degerler, color='#e74c3c', alpha=0.7)
            self.ax2.set_ylabel('Direk SayÄ±sÄ±', fontweight='bold')
            self.ax2.set_title('Aylara GÃ¶re Direk SayÄ±sÄ± (FiltrelenmiÅŸ)', fontsize=12, fontweight='bold')
            
            # DeÄŸerleri Ã¼ste yaz
            for i, v in enumerate(sirali_degerler):
                self.ax2.text(i, v + 0.1, f'{v:,}', ha='center', va='bottom', fontweight='bold')
            
            self.ax2.set_xticks(range(len(ay_etiketi)))
            self.ax2.set_xticklabels(ay_etiketi)
            self.fig2.subplots_adjust(top=0.90, bottom=0.20, left=0.12, right=0.95)
        else:
            self.ax2.text(0.5, 0.5, 'FiltrelenmiÅŸ ay verisi bulunamadÄ±', 
                         ha='center', va='center', transform=self.ax2.transAxes,
                         fontsize=12, color='gray')
            self.fig2.subplots_adjust(top=0.90, bottom=0.20, left=0.12, right=0.95)
        
        self.canvas2.draw()


    

    


    def harita_verileri_yukle(self):
        """Harita iÃ§in verileri yÃ¼kler"""
        try:
            # FotoÄŸraf KlasÃ¶rleri sayfasÄ±nÄ± oku
            self.harita_df_veri = pd.read_excel(self.excel_dosyasi, sheet_name='FotoÄŸraf KlasÃ¶rleri')
            
            # SÃ¼tunlarÄ± kontrol et
            required_cols = ['LAT', 'LON', 'Aob', 'Hat adÄ±', 'Direk No', 'Ã–ncelik', 'Tespit Notu']
            for col in required_cols:
                if col not in self.harita_df_veri.columns:
                    self.harita_bilgi_var.set(f"âŒ Eksik sÃ¼tun: {col}")
                    return
            
            # KoordinatlarÄ± temizle
            self.harita_df_veri['LAT'] = pd.to_numeric(self.harita_df_veri['LAT'], errors='coerce')
            self.harita_df_veri['LON'] = pd.to_numeric(self.harita_df_veri['LON'], errors='coerce')
            
            # FiltrelenmiÅŸ veriyi baÅŸlangÄ±Ã§ta tÃ¼m veri olarak ayarla
            self.harita_df_filtreli = self.harita_df_veri.copy()
            
            # Listeleri doldur
            self.harita_listeleri_doldur()
            
            # Ä°statistikleri gÃ¼ncelle
            self.harita_istatistikleri_guncelle()
            
            self.harita_bilgi_var.set("âœ… Veriler baÅŸarÄ±yla yÃ¼klendi")
            
        except Exception as e:
            self.harita_bilgi_var.set(f"âŒ Veri yÃ¼kleme hatasÄ±: {str(e)}")

    def harita_listeleri_doldur(self):
        """Harita filtresi listelerini doldurur"""
        try:
            # Ä°lÃ§e listesi
            if 'Aob' in self.harita_df_veri.columns:
                ilce_list = ['TÃœMÃœ'] + sorted(self.harita_df_veri['Aob'].dropna().unique().tolist())
                self.harita_ilce_combo['values'] = ilce_list
            
            # Hat listesi
            if 'Hat adÄ±' in self.harita_df_veri.columns:
                hat_list = ['TÃœMÃœ'] + sorted(self.harita_df_veri['Hat adÄ±'].dropna().unique().tolist())
                self.harita_hat_combo['values'] = hat_list
                
        except Exception as e:
            print(f"Harita liste doldurma hatasÄ±: {e}")

    def harita_istatistikleri_guncelle(self):
        """Harita istatistiklerini gÃ¼nceller"""
        try:
            if self.harita_df_filtreli is not None:
                # Toplam kayÄ±t
                total_points = len(self.harita_df_filtreli)
                self.harita_toplam_kayit_var.set(f"{total_points}")
                
                # GeÃ§erli koordinat
                valid_points = len(self.harita_df_filtreli[self.harita_df_filtreli['LAT'].notna() & self.harita_df_filtreli['LON'].notna()])
                self.harita_gecerli_koordinat_var.set(f"{valid_points}")
                
                # Haritadaki nokta
                self.harita_nokta_var.set(f"{valid_points}")
                
                # Ã–ncelik daÄŸÄ±lÄ±mÄ±
                if 'Ã–ncelik' in self.harita_df_filtreli.columns:
                    # Ã‡ok acil
                    cok_acil_count = self.harita_df_filtreli['Ã–ncelik'].astype(str).str.lower().str.contains('Ã§ok acil|cok acil', na=False).sum()
                    self.harita_cok_acil_var.set(f"{cok_acil_count}")
                    
                    # Acil
                    acil_count = self.harita_df_filtreli['Ã–ncelik'].astype(str).str.lower().str.contains('acil', na=False).sum()
                    self.harita_acil_var.set(f"{acil_count}")
                    
                    # Normal
                    normal_count = self.harita_df_filtreli['Ã–ncelik'].astype(str).str.lower().str.contains('normal', na=False).sum()
                    self.harita_normal_var.set(f"{normal_count}")
                    
                    # Bekleyebilir
                    bekleyebilir_count = self.harita_df_filtreli['Ã–ncelik'].astype(str).str.lower().str.contains('bekleyebilir', na=False).sum()
                    self.harita_bekleyebilir_var.set(f"{bekleyebilir_count}")
                
                self.harita_bilgi_var.set(f"ğŸ“Š Toplam {total_points} kayÄ±t, {valid_points} geÃ§erli koordinat")
                
        except Exception as e:
            print(f"Harita istatistik gÃ¼ncelleme hatasÄ±: {e}")

    def harita_filtrele(self):
        """Harita filtrelerini uygular"""
        try:
            if self.harita_df_veri is None:
                self.harita_bilgi_var.set("âŒ Veriler yÃ¼klenmemiÅŸ")
                return
            
            self.harita_bilgi_var.set("ğŸ” Filtreleme yapÄ±lÄ±yor...")
            
            # Filtrelemeyi uygula
            filtered_df = self.harita_df_veri.copy()
            
            # 1. Ä°lÃ§e filtresi
            secili_ilce = self.harita_ilce_var.get()
            if secili_ilce != "TÃœMÃœ" and secili_ilce:
                filtered_df = filtered_df[filtered_df['Aob'] == secili_ilce]
            
            # 2. Hat filtresi
            secili_hat = self.harita_hat_var.get()
            if secili_hat != "TÃœMÃœ" and secili_hat:
                filtered_df = filtered_df[filtered_df['Hat adÄ±'] == secili_hat]
            
            # FiltrelenmiÅŸ veriyi kaydet
            self.harita_df_filtreli = filtered_df
            
            # Ä°statistikleri gÃ¼ncelle
            self.harita_istatistikleri_guncelle()
            
            # HaritayÄ± oluÅŸtur ve gÃ¶ster
            self.harita_olustur_ve_goster()
            
            self.harita_bilgi_var.set(f"âœ… {len(filtered_df)} kayÄ±t filtrelendi")
            
        except Exception as e:
            self.harita_bilgi_var.set(f"âŒ Filtreleme hatasÄ±: {str(e)}")

    def harita_filtreleri_sifirla(self):
        """Harita filtresini sÄ±fÄ±rlar"""
        try:
            self.harita_ilce_var.set("TÃœMÃœ")
            self.harita_hat_var.set("TÃœMÃœ")
            
            # Veriyi sÄ±fÄ±rla
            self.harita_df_filtreli = self.harita_df_veri.copy()
            self.harita_istatistikleri_guncelle()
            self.harita_olustur_ve_goster()
            
            self.harita_bilgi_var.set("âœ… Filtreler sÄ±fÄ±rlandÄ±")
            
        except Exception as e:
            self.harita_bilgi_var.set(f"âŒ Filtre sÄ±fÄ±rlama hatasÄ±: {str(e)}")

    def harita_olustur_ve_goster(self):
        """Harita oluÅŸturur ve embed olarak gÃ¶sterir - MASAÃœSTÃœ/RAFOR/RaporHarita.html dosyasÄ±na kaydeder"""
        try:
            if not hasattr(self, 'harita_df_filtreli') or self.harita_df_filtreli is None or self.harita_df_filtreli.empty:
                self.harita_bilgi_var.set("âŒ Harita iÃ§in veri bulunamadÄ±!")
                return
            
            self.harita_bilgi_var.set("ğŸ”„ Harita oluÅŸturuluyor...")
            self.update()
            
            # Bilgi label'Ä±nÄ± gizle
            if hasattr(self, 'harita_baslangic_label'):
                self.harita_baslangic_label.pack_forget()
            
            # Koordinat geÃ§erliliÄŸi kontrolÃ¼
            valid = self.harita_df_filtreli['LAT'].notna() & self.harita_df_filtreli['LON'].notna()
            df_map = self.harita_df_filtreli[valid].copy()
            
            if df_map.empty:
                self.harita_bilgi_var.set("âŒ GeÃ§erli koordinatlÄ± veri bulunamadÄ±!")
                return
            
            # Merkez hesapla
            try:
                center_lat = df_map['LAT'].astype(float).mean()
                center_lon = df_map['LON'].astype(float).mean()
            except:
                # VarsayÄ±lan merkez (TÃ¼rkiye)
                center_lat = 39.9334
                center_lon = 32.8597
            
            # Folium harita oluÅŸtur
            harita = folium.Map(location=[center_lat, center_lon], 
                              zoom_start=12, 
                              control_scale=True,
                              tiles=None)  # HiÃ§ tile ekleme
            
            # TÃœM TILE LAYER'LARI EKLE
            # 1. Normal Harita (OpenStreetMap)
            folium.TileLayer(
                tiles='https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
                name='ğŸ—ºï¸ Normal Harita',
                attr='Â© OpenStreetMap contributors',
                max_zoom=19,
                control=True
            ).add_to(harita)
            
            # 2. Uydu + Etiketler (Google Hybrid)
            folium.TileLayer(
                tiles='https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}',
                attr='Google Hybrid',
                name='ğŸ›°ï¸ğŸ”¤ Uydu + Etiketler',
                max_zoom=22,
                control=True
            ).add_to(harita)
            
            # Marker'larÄ± ekle
            eklenen = 0
            
            for idx, row in df_map.iterrows():
                try:
                    lat = float(row['LAT'])
                    lon = float(row['LON'])
                except:
                    continue
                
                # Ã–ncelik rengini belirle
                oncelik = str(row.get('Ã–ncelik', '')).lower()
                renk = 'gray'
                if 'Ã§ok acil' in oncelik or 'cok acil' in oncelik:
                    renk = 'red'
                elif 'acil' in oncelik:
                    renk = 'orange'
                elif 'normal' in oncelik:
                    renk = 'blue'
                elif 'bekleyebilir' in oncelik:
                    renk = 'green'
                
                # Popup iÃ§eriÄŸi
                popup_html = f"""
                <div style='font-family: Arial; width: 260px;'>
                    <h4 style='color: {renk}; margin:0 0 6px 0'>{row.get('Ã–ncelik', 'Belirsiz')}</h4>
                    <b>Ä°lÃ§e:</b> {row.get('Aob', '')}<br>
                    <b>Hat:</b> {row.get('Hat adÄ±', '')}<br>
                    <b>Direk No:</b> {row.get('Direk No', '')}<br>
                    <b>Tespit:</b> {str(row.get('Tespit Notu', ''))[:150]}<br>
                    <b>Koordinat:</b> {lat:.6f}, {lon:.6f}
                </div>
                """
                
                marker = folium.Marker(
                    location=[lat, lon],
                    popup=folium.Popup(popup_html, max_width=320),
                    tooltip=f"{row.get('Hat adÄ±','')} - {row.get('Direk No','')}",
                    icon=folium.Icon(color=renk, icon='info-sign')
                ).add_to(harita)
                eklenen += 1
            
            # Layer kontrol ekle
            folium.LayerControl(collapsed=False, position='topright').add_to(harita)
            
            # HARÄ°TAYI GEÃ‡Ä°CÄ° DOSYAYA KAYDET
            import tempfile
            temp_file = tempfile.NamedTemporaryFile(mode='w', suffix='.html', delete=False, encoding='utf-8')
            harita.save(temp_file.name)
            temp_file.close()
            
            self.map_temp_html = temp_file.name
            
            # Ä°statistikleri gÃ¼ncelle
            self.harita_nokta_var.set(f"{eklenen}")
            self.harita_gecerli_koordinat_var.set(f"{eklenen}")
            
            # Bilgi gÃ¼ncelle
            self.harita_bilgi_var.set(f"âœ… Harita hazÄ±r: {eklenen} nokta")
            
            # HaritayÄ± gÃ¶mÃ¼lÃ¼ olarak gÃ¶ster
            self.harita_goster_embed(self.map_temp_html)
            
        except Exception as e:
            self.harita_bilgi_var.set(f"âŒ Harita oluÅŸturma hatasÄ±: {str(e)}")
            import traceback
            traceback.print_exc()

    def harita_html_goster(self, html_string):
        """HTML haritayÄ± gÃ¶mÃ¼lÃ¼ olarak gÃ¶sterir"""
        try:
            # Ã–nceki iÃ§eriÄŸi temizle
            if hasattr(self, 'harita_map_frame'):
                for widget in self.harita_map_frame.winfo_children():
                    widget.destroy()
            
            # Basit bir WebView oluÅŸturmak iÃ§in tkinter Text widget'Ä±nÄ± kullan
            html_viewer = tk.Text(self.harita_map_frame, wrap='none')
            html_viewer.insert('1.0', html_string)
            html_viewer.config(state='disabled', bg='white')
            
            scrollbar_y = ttk.Scrollbar(self.harita_map_frame, orient='vertical', command=html_viewer.yview)
            scrollbar_x = ttk.Scrollbar(self.harita_map_frame, orient='horizontal', command=html_viewer.xview)
            html_viewer.configure(yscrollcommand=scrollbar_y.set, xscrollcommand=scrollbar_x.set)
            
            html_viewer.pack(side='left', fill='both', expand=True)
            scrollbar_y.pack(side='right', fill='y')
            scrollbar_x.pack(side='bottom', fill='x')
            
            # Alternatif olarak, web tarayÄ±cÄ±da aÃ§ma seÃ§eneÄŸi ekleyelim
            button_frame = tk.Frame(self.harita_map_frame, bg='white')
            button_frame.pack(side='bottom', fill='x')
            
            tk.Button(button_frame, text="ğŸŒ HaritayÄ± TarayÄ±cÄ±da AÃ§", 
                     command=self.harita_tarayiciya_ac,
                     bg="#3498db", fg='white', font=('Segoe UI', 9)).pack(pady=5)
            
        except Exception as e:
            # Hata durumunda basit mesaj
            error_label = tk.Label(self.harita_map_frame,
                                 text=f"Harita gÃ¶sterilemedi: {str(e)}\n\n"
                                      "HaritayÄ± tarayÄ±cÄ±da aÃ§mak iÃ§in butona tÄ±klayÄ±n.",
                                 font=('Segoe UI', 11),
                                 bg="black", fg="red",
                                 justify='center')
            error_label.pack(expand=True)
            
            button_frame = tk.Frame(self.harita_map_frame, bg='black')
            button_frame.pack(side='bottom', fill='x')
            
            tk.Button(button_frame, text="ğŸŒ HaritayÄ± TarayÄ±cÄ±da AÃ§", 
                     command=self.harita_tarayiciya_ac,
                     bg="#3498db", fg='white', font=('Segoe UI', 9)).pack(pady=5)

    def harita_tarayiciya_ac(self):
        """HaritayÄ± tarayÄ±cÄ±da aÃ§ar"""
        try:
            if not hasattr(self, 'harita_df_filtreli') or self.harita_df_filtreli is None:
                messagebox.showwarning("UyarÄ±", "Ã–nce harita verilerini yÃ¼kleyin!")
                return
            
            # GeÃ§ici HTML dosyasÄ± oluÅŸtur
            import tempfile
            import webbrowser
            
            temp_file = tempfile.NamedTemporaryFile(mode='w', suffix='.html', delete=False, encoding='utf-8')
            
            # Koordinat geÃ§erliliÄŸi kontrolÃ¼
            valid = self.harita_df_filtreli['LAT'].notna() & self.harita_df_filtreli['LON'].notna()
            df_map = self.harita_df_filtreli[valid].copy()
            
            if df_map.empty:
                messagebox.showwarning("UyarÄ±", "GeÃ§erli koordinatlÄ± veri bulunamadÄ±!")
                return
            
            # Merkez hesapla
            try:
                center_lat = df_map['LAT'].astype(float).mean()
                center_lon = df_map['LON'].astype(float).mean()
            except:
                center_lat = 39.9334
                center_lon = 32.8597
            
            # Folium harita oluÅŸtur
            harita = folium.Map(location=[center_lat, center_lon], 
                              zoom_start=12, 
                              control_scale=True)
            
            # Marker'larÄ± ekle
            for idx, row in df_map.iterrows():
                try:
                    lat = float(row['LAT'])
                    lon = float(row['LON'])
                except:
                    continue
                
                # Ã–ncelik rengini belirle
                oncelik = str(row.get('Ã–ncelik', '')).lower()
                renk = 'gray'
                if 'Ã§ok acil' in oncelik or 'cok acil' in oncelik:
                    renk = 'red'
                elif 'acil' in oncelik:
                    renk = 'orange'
                elif 'normal' in oncelik:
                    renk = 'blue'
                elif 'bekleyebilir' in oncelik:
                    renk = 'green'
                
                # Popup iÃ§eriÄŸi
                popup_html = f"""
                <div style='font-family: Arial; width: 260px;'>
                    <h4 style='color: {renk}; margin:0 0 6px 0'>{row.get('Ã–ncelik', 'Belirsiz')}</h4>
                    <b>Ä°lÃ§e:</b> {row.get('Aob', '')}<br>
                    <b>Hat:</b> {row.get('Hat adÄ±', '')}<br>
                    <b>Direk No:</b> {row.get('Direk No', '')}<br>
                    <b>Tespit:</b> {str(row.get('Tespit Notu', ''))[:150]}<br>
                    <b>Koordinat:</b> {lat:.6f}, {lon:.6f}
                </div>
                """
                
                marker = folium.Marker(
                    location=[lat, lon],
                    popup=folium.Popup(popup_html, max_width=320),
                    tooltip=f"{row.get('Hat adÄ±','')} - {row.get('Direk No','')}",
                    icon=folium.Icon(color=renk, icon='info-sign')
                ).add_to(harita)
            
            harita.save(temp_file.name)
            temp_file.close()
            
            # TarayÄ±cÄ±da aÃ§
            webbrowser.open(f'file://{os.path.abspath(temp_file.name)}')
            self.harita_bilgi_var.set(f"âœ… Harita tarayÄ±cÄ±da aÃ§Ä±ldÄ±: {len(df_map)} nokta")
            
        except Exception as e:
            messagebox.showerror("Hata", f"Harita aÃ§Ä±lÄ±rken hata: {str(e)}")
        

    def harita_listeleri_doldur(self):
        """Harita sekmesindeki combo box'larÄ± doldurur"""
        try:
            if os.path.exists(self.excel_dosyasi):
                df = pd.read_excel(self.excel_dosyasi, sheet_name='FotoÄŸraf KlasÃ¶rleri')
                
                # Ä°lÃ§e listesi
                ilce_list = ['TÃœMÃœ'] + sorted(df['Aob'].dropna().unique().tolist())
                self.harita_ilce_combo['values'] = ilce_list
                
                # Hat listesi
                hat_list = ['TÃœMÃœ'] + sorted(df['Hat adÄ±'].dropna().unique().tolist())
                self.harita_hat_combo['values'] = hat_list
                
        except Exception as e:
            print(f"Harita listeleri doldurma hatasÄ±: {e}")
    
    

    def embed_harita_ekrani(self, harita_ekrani, sol_frame, sag_frame):
        """HaritaAnalizEkrani'nÄ±n iÃ§eriÄŸini mevcut frame'lere gÃ¶m"""
        try:
            # HaritaAnalizEkrani'nÄ±n tÃ¼m child'larÄ±nÄ± bul
            harita_children = harita_ekrani.winfo_children()
            
            # Her child'Ä± kontrol et ve uygun frame'e yerleÅŸtir
            for child in harita_children:
                child_type = str(type(child))
                
                # Sol frame'e yerleÅŸtirilecekler (filtreler, istatistikler)
                if 'Frame' in child_type:
                    # Ä°Ã§indeki widget'lara gÃ¶re karar ver
                    child_children = child.winfo_children()
                    for subchild in child_children:
                        subchild_type = str(type(subchild))
                        
                        # Filtreler frame'ini bul
                        if 'LabelFrame' in subchild_type and 'Filtreler' in subchild.cget('text'):
                            # Bu frame'i sol_frame'e taÅŸÄ±
                            subchild.pack_forget()
                            subchild.pack(in_=sol_frame, fill='both', expand=True, padx=10, pady=10)
                        
                        # Ä°statistikler frame'ini bul
                        elif 'LabelFrame' in subchild_type and ('Ä°statistikler' in subchild.cget('text') or 
                                                               'Ã–ncelik DaÄŸÄ±lÄ±mÄ±' in subchild.cget('text')):
                            subchild.pack_forget()
                            subchild.pack(in_=sol_frame, fill='both', expand=True, padx=10, pady=10)
                
                # SaÄŸ frame'e yerleÅŸtirilecekler (harita)
                elif 'LabelFrame' in child_type and 'HARÄ°TA GÃ–RÃœNÃœMÃœ' in child.cget('text'):
                    child.pack_forget()
                    child.pack(in_=sag_frame, fill='both', expand=True)
            
            # HaritaAnalizEkrani penceresini gizle (artÄ±k gerek yok)
            harita_ekrani.withdraw()
            
        except Exception as e:
            print(f"Harita gÃ¶mme hatasÄ±: {e}")

    def apply_harita_filters(self, harita_ekrani):
        """Harita filtresini uygula"""
        try:
            secili_ilce = self.harita_ilce_var.get()
            secili_hat = self.harita_hat_var.get()
            sadece_oncelikli = self.harita_oncelik_var.get()
            kumelenme = self.harita_kumelenme_var.get()
            
            # Filtreleri uygula
            if hasattr(harita_ekrani, 'ilce_var'):
                harita_ekrani.ilce_var.set(secili_ilce)
            
            if hasattr(harita_ekrani, 'hat_var'):
                harita_ekrani.hat_var.set(secili_hat)
            
            if hasattr(harita_ekrani, 'oncelik_dagilimi_var'):
                harita_ekrani.oncelik_dagilimi_var.set(sadece_oncelikli)
            
            if hasattr(harita_ekrani, 'kumelenme_var'):
                harita_ekrani.kumelenme_var.set(kumelenme)
            
            # Filtreleme yap
            if hasattr(harita_ekrani, 'filtrele'):
                harita_ekrani.filtrele()
                
        except Exception as e:
            print(f"Filtre uygulama hatasÄ±: {e}")
    
    def harita_istatistikleri_guncelle(self):
        """Harita istatistiklerini gÃ¼nceller"""
        try:
            if hasattr(self, 'harita_ekrani') and self.harita_ekrani:
                if hasattr(self.harita_ekrani, 'df_filtreli'):
                    df = self.harita_ekrani.df_filtreli
                    if df is not None:
                        toplam = len(df)
                        gecerli = len(df[df['LAT'].notna() & df['LON'].notna()])
                        
                        # Ã–ncelikli sayÄ±sÄ±
                        oncelikli = 0
                        if 'Ã–ncelik' in df.columns:
                            oncelikli = df['Ã–ncelik'].astype(str).str.lower().str.contains(
                                'Ã§ok acil|cok acil|acil', na=False).sum()
                        
                        self.harita_toplam_var.set(f"Toplam: {toplam}")
                        self.harita_gecerli_var.set(f"KoordinatlÄ±: {gecerli}")
                        self.harita_oncelikli_var.set(f"Ã–ncelikli: {oncelikli}")
        except Exception as e:
            print(f"Ä°statistik gÃ¼ncelleme hatasÄ±: {e}")
    
    def harita_filtreleri_sifirla(self):
        """Harita filtresini sÄ±fÄ±rlar"""
        self.harita_ilce_var.set("TÃœMÃœ")
        self.harita_hat_var.set("TÃœMÃœ")
        self.harita_oncelik_var.set(False)
        self.harita_kumelenme_var.set(True)        

class AnaUygulama:
    def __init__(self, root):
        self.root = root
        self.root.title("Halil Ä°brahim BaÅŸkaya")
        self.root.geometry("1200x1000")
        self.root.minsize(900, 850)
        self.root.resizable(True, True)
        self.root.configure(bg="#2c3e50")
        
        # Program seÃ§imi
        self.secili_program = tk.StringVar(value="fotograf")
        
        # DiÄŸer deÄŸiÅŸkenler
        self.calisma_devam_ediyor = False
        self.eklenen_klasor_sayisi = tk.IntVar(value=0)
        self.atlanan_klasor_sayisi = tk.IntVar(value=0)
        self.toplam_klasor_sayisi = tk.IntVar(value=0)
        self.ana_klasor = tk.StringVar()
        self.kaydetme_yeri = tk.StringVar()
        self.ilerleme_yuzde = tk.StringVar(value="%0")
        
        # Threading iÃ§in
        self.thread_lock = threading.Lock()
        self._sehir_oncesi = {}  # Ã–nbellek
        self._last_update = 0    # UI gÃ¼ncelleme kontrolÃ¼
        
        # Drone iÃ§in deÄŸiÅŸkenler
        self.toplam_foto_sayisi = tk.IntVar(value=0)

        
        # Excel dosya yollarÄ±
        self.direk_musterek_yolu = None
        self.direk_og_yolu = None
        
        # Stil ayarlarÄ±
        self.style = ttk.Style()
        self.style.theme_use('clam')
        
        self.colors = {
            'dark_bg': '#2c3e50', 'light_bg': '#34495e', 'accent': '#3498db',
            'success': '#27ae60', 'danger': '#e74c3c', 'warning': '#f39c12',
            'text': '#ecf0f1', 'border': '#7f8c8d', 'info_bg': '#2c3e50',
            'selected': '#1e8449', 'frame_bg': '#3d566e', 'frame_border': '#1a252f'
        }
        
        self.sehirler = ['DEMRE', 'ELMALI', 'FÄ°NÄ°KE', 'KALKAN', 'KAÅ', 'KEMER', 'KORKUTELÄ°', 'KUMLUCA']
        
        self.configure_styles()
        self.arayuz_olustur()
        
    def configure_styles(self):
        self.style.configure('Dark.TFrame', background=self.colors['dark_bg'])
        self.style.configure('Light.TFrame', background=self.colors['light_bg'])
        self.style.configure('Info.TFrame', background=self.colors['info_bg'])
        self.style.configure('Frame.TFrame', background=self.colors['frame_bg'])
        
        self.style.configure('Title.TLabel', 
                            font=('Segoe UI', 18, 'bold'),
                            foreground=self.colors['text'],
                            background=self.colors['dark_bg'])
        
        self.style.configure('Subtitle.TLabel', 
                            font=('Segoe UI', 11, 'bold'),
                            foreground=self.colors['accent'],
                            background=self.colors['dark_bg'])
        
        self.style.configure('Light.TLabel', 
                            font=('Segoe UI', 10),
                            foreground=self.colors['text'],
                            background=self.colors['light_bg'])
        
        self.style.configure('Stats.TLabel', 
                            font=('Segoe UI', 11, 'bold'),
                            foreground=self.colors['text'],
                            background=self.colors['info_bg'])
        
        self.style.configure('StatsValue.TLabel', 
                            font=('Segoe UI', 12, 'bold'),
                            foreground=self.colors['accent'],
                            background=self.colors['info_bg'])
        
        self.style.configure('Accent.TButton', 
                            font=('Segoe UI', 10, 'bold'),
                            foreground='white',
                            background=self.colors['accent'],
                            borderwidth=1,
                            focusthickness=3,
                            focuscolor=self.colors['accent'])
        
        self.style.map('Accent.TButton', background=[('active', '#2980b9')])
        
        self.style.configure('Success.TButton', 
                            font=('Segoe UI', 10, 'bold'),
                            foreground='white',
                            background=self.colors['success'],
                            borderwidth=1,
                            focusthickness=3,
                            focuscolor=self.colors['success'])
        
        self.style.map('Success.TButton', background=[('active', '#219a52')])
        
        self.style.configure('Danger.TButton', 
                            font=('Segoe UI', 10, 'bold'),
                            foreground='white',
                            background=self.colors['danger'],
                            borderwidth=1,
                            focusthickness=3,
                            focuscolor=self.colors['danger'])
        
        self.style.map('Danger.TButton', background=[('active', '#c0392b')])
        
        self.style.configure('Custom.TEntry',
                            fieldbackground=self.colors['light_bg'],
                            foreground=self.colors['text'],
                            borderwidth=1,
                            focusthickness=3,
                            focuscolor=self.colors['accent'])
        
        self.style.configure('Custom.Horizontal.TProgressbar',
                            thickness=20,
                            troughcolor=self.colors['light_bg'],
                            background=self.colors['accent'],
                            lightcolor=self.colors['accent'],
                            darkcolor=self.colors['accent'])
        
        self.style.configure('Light.TCheckbutton',
                            background=self.colors['light_bg'],
                            foreground=self.colors['text'],
                            font=('Segoe UI', 10))
        
    def create_3d_frame(self, parent, **kwargs):
        frame = tk.Frame(parent, 
                        bg=self.colors['frame_bg'],
                        relief='ridge', 
                        bd=2,
                        highlightbackground=self.colors['frame_border'],
                        highlightthickness=1,
                        **kwargs)
        return frame
        
    def create_input_frame(self, parent, text, variable, browse_command=None, width=50):
        frame = self.create_3d_frame(parent)
        
        label = tk.Label(frame, text=text, font=('Segoe UI', 10, 'bold'),
                        bg=self.colors['frame_bg'], fg=self.colors['text'],
                        width=15, anchor='w')
        label.pack(side='left', padx=8, pady=6)
        
        entry = ttk.Entry(frame, textvariable=variable, 
                         style='Custom.TEntry', width=width, 
                         font=('Segoe UI', 10))
        entry.pack(side='left', padx=5, fill='x', expand=True)
        
        if browse_command:
            btn = ttk.Button(frame, text="GÃ¶zat", 
                           command=browse_command, 
                           style='Accent.TButton', width=10)
            btn.pack(side='left', padx=5)
            
        return frame
        
    def create_progress_frame(self, parent, text):
        frame = self.create_3d_frame(parent)
        
        label = tk.Label(frame, text=text, font=('Segoe UI', 10, 'bold'),
                        bg=self.colors['frame_bg'], fg=self.colors['text'],
                        width=15, anchor='w')
        label.pack(side='left', padx=8, pady=8)
        
        progress = ttk.Progressbar(frame, style='Custom.Horizontal.TProgressbar', 
                                 mode='determinate', length=300)
        progress.pack(side='left', padx=(0, 10), fill='x', expand=True)
        
        percent_label = tk.Label(frame, textvariable=self.ilerleme_yuzde,
                               font=('Segoe UI', 10, 'bold'),
                               bg=self.colors['frame_bg'], fg=self.colors['accent'],
                               width=5)
        percent_label.pack(side='left', padx=(0, 5))
        
        return frame, progress
        
    def arayuz_olustur(self):
        main_container = ttk.Frame(self.root, style='Dark.TFrame', padding=15)
        main_container.pack(fill='both', expand=True)
        
        title_frame = ttk.Frame(main_container, style='Dark.TFrame')
        title_frame.pack(fill='x', pady=(0, 10))
        
        title_label = ttk.Label(title_frame, 
                               text="RAPOR", 
                               style='Title.TLabel')
        title_label.pack()
        
        program_frame = ttk.Frame(title_frame, style='Dark.TFrame')
        program_frame.pack(pady=8)
        


        
        
        self.lbl_aciklama = ttk.Label(title_frame, style='Subtitle.TLabel')
        self.lbl_aciklama.pack(pady=(3, 0))
        
        stats_frame = self.create_3d_frame(main_container)
        stats_frame.pack(fill='x', pady=(0, 10), padx=5)
        
        stats_grid = ttk.Frame(stats_frame, style='Dark.TFrame')
        stats_grid.pack(pady=8, padx=10)
        
        ttk.Label(stats_grid, text="Eklenen Direk SayÄ±sÄ±:", style='Stats.TLabel').grid(row=0, column=0, padx=15)
        ttk.Label(stats_grid, textvariable=self.eklenen_klasor_sayisi, style='StatsValue.TLabel').grid(row=0, column=1, padx=15)
        
        ttk.Label(stats_grid, text="Atlanan Direk SeyÄ±sÄ±:", style='Stats.TLabel').grid(row=0, column=2, padx=15)
        ttk.Label(stats_grid, textvariable=self.atlanan_klasor_sayisi, style='StatsValue.TLabel').grid(row=0, column=3, padx=15)
        
        ttk.Label(stats_grid, text="Toplam Direk SayÄ±sÄ±:", style='Stats.TLabel').grid(row=0, column=4, padx=15)
        ttk.Label(stats_grid, textvariable=self.toplam_klasor_sayisi, style='StatsValue.TLabel').grid(row=0, column=5, padx=15)

        
        
        
        self.content_frame = ttk.Frame(main_container, style='Light.TFrame')
        self.content_frame.pack(fill='both', expand=True, padx=8, pady=3)
        
        self.guncelle_icerik_alani()
        
        self.lbl_durum = tk.Label(main_container, text="HazÄ±r", font=('Segoe UI', 12, 'bold'), 
                                 fg=self.colors['success'], bg=self.colors['dark_bg'])
        self.lbl_durum.pack(pady=3)
        
        result_frame = self.create_3d_frame(main_container)
        result_frame.pack(fill='both', expand=True, padx=5, pady=3)
        
        lbl_sonuc = tk.Label(result_frame, text="Ä°ÅŸlem SonuÃ§larÄ±:", 
                           font=('Segoe UI', 11, 'bold'),
                           bg=self.colors['frame_bg'], fg=self.colors['text'])
        lbl_sonuc.pack(anchor='w', pady=(8, 4), padx=10)
        
        text_frame = ttk.Frame(result_frame, style='Light.TFrame')
        text_frame.pack(fill='both', expand=True, padx=8, pady=(0, 8))
        
        self.txt_sonuc = tk.Text(text_frame, height=5, width=80,
                                bg=self.colors['light_bg'], fg=self.colors['text'],
                                font=('Consolas', 10), relief='sunken', 
                                borderwidth=2, highlightthickness=1,
                                highlightcolor=self.colors['accent'],
                                highlightbackground=self.colors['border'])
        
        scrollbar = ttk.Scrollbar(text_frame, orient='vertical', command=self.txt_sonuc.yview)
        self.txt_sonuc.configure(yscrollcommand=scrollbar.set)
        
        self.txt_sonuc.pack(side='left', fill='both', expand=True)
        scrollbar.pack(side='right', fill='y')
        
        self.program_degisti()
        
    def program_degisti(self):
        try:
            self.istatistikleri_sifirla()
        except Exception as e:
            # Hata durumunda sadece log yaz, uygulamayÄ± Ã§Ã¶kertme
            print(f"Program deÄŸiÅŸimi sÄ±rasÄ±nda hata: {e}")
            self.txt_sonuc.insert(tk.END, f"âš ï¸ Program deÄŸiÅŸimi sÄ±rasÄ±nda hata: {e}\n")
        
        # Program deÄŸiÅŸimi iÅŸlemlerine devam et...
        if self.secili_program.get() == "fotograf":
            self.lbl_aciklama.config(text="KlasÃ¶rlerinizdeki fotoÄŸraflarÄ± profesyonel ÅŸekilde listeleyin")


        elif self.secili_program.get() == "drone":
            self.lbl_aciklama.config(text="Drone GPS verilerinizi Excel'e aktarÄ±n")
            self.foto_radio.config(fg=self.colors['text'])

        elif self.secili_program.get() == "boyutlandirici":
            self.lbl_aciklama.config(text="FotoÄŸraflarÄ±nÄ±zÄ± toplu olarak boyutlandÄ±rÄ±n")
            self.foto_radio.config(fg=self.colors['text'])

        elif self.secili_program.get() == "excel_merge":
            self.lbl_aciklama.config(text="Excel dosyalarÄ±nÄ±zÄ± birleÅŸtirin ve filtreleyin")
            self.foto_radio.config(fg=self.colors['text'])

        else:
            self.lbl_aciklama.config(text="FarklÄ± klasÃ¶rlerdeki fotoÄŸraflarÄ± birleÅŸtirin")
            self.foto_radio.config(fg=self.colors['text'])

        
        self.guncelle_icerik_alani()
        
    def guncelle_icerik_alani(self):
        for widget in self.content_frame.winfo_children():
            widget.destroy()
            
        if self.secili_program.get() == "fotograf":
            self.Klasor_Listele_arayuz_olustur()

    
    def Klasor_Listele_arayuz_olustur(self):
        frame_ana_klasor = self.create_input_frame(
            self.content_frame, 
            "Ana KlasÃ¶r:", 
            self.ana_klasor, 
            self.ana_klasor_sec
        )
        frame_ana_klasor.pack(fill='x', padx=15, pady=8)
        
        frame_kaydetme = self.create_input_frame(
            self.content_frame,
            "Kaydetme Yeri:",
            self.kaydetme_yeri,
            self.kaydetme_yeri_sec
        )
        frame_kaydetme.pack(fill='x', padx=15, pady=8)
        
        # YENÄ°: Tarihsiz kontrol seÃ§eneÄŸi - "Orijinalleri TaÅŸÄ±" gibi tasarÄ±m
        tarihsiz_frame = self.create_3d_frame(self.content_frame)
        tarihsiz_frame.pack(fill='x', padx=15, pady=8)
        
        self.tarihsiz_kontrol_var = tk.BooleanVar(value=False)
        
        # "Orijinalleri TaÅŸÄ±" tasarÄ±mÄ±na uygun checkbox
        self.tarihsiz_check = tk.Checkbutton(tarihsiz_frame, 
                                           text="ğŸ“Š Tarihsiz FotoÄŸraflarÄ± Rapora Ekle",
                                           variable=self.tarihsiz_kontrol_var,
                                           font=('Segoe UI', 10, 'bold'),
                                           bg=self.colors['frame_bg'],
                                           fg=self.colors['text'],
                                           selectcolor='white',
                                           activebackground=self.colors['frame_bg'],
                                           activeforeground='black',
                                           command=self.tarihsiz_kontrol_degisti)
        self.tarihsiz_check.pack(side='left', padx=15, pady=8)
        
        frame_ilerleme, self.ilerleme = self.create_progress_frame(
            self.content_frame,
            "Ä°lerleme Durumu:"
        )
        frame_ilerleme.pack(fill='x', padx=15, pady=12)
        
        frame_butonlar = self.create_3d_frame(self.content_frame)
        frame_butonlar.pack(pady=15, padx=15)
        
        ttk.Button(frame_butonlar, text="Ä°ÅŸlemi BaÅŸlat", 
                  command=self.fotograf_klasorleri_listele, 
                  style='Success.TButton', width=15).pack(side='left', padx=12, pady=10)
        
        ttk.Button(frame_butonlar, text="Rapor GÃ¶ster", 
                  command=self.rapor_goster, 
                  style='Accent.TButton', width=15).pack(side='left', padx=12, pady=10)
        
        ttk.Button(frame_butonlar, text="Ã‡Ä±kÄ±ÅŸ", 
                  command=self.root.destroy, 
                  style='Danger.TButton', width=15).pack(side='left', padx=12, pady=10)
    


    def tarihsiz_kontrol_degisti(self):
        """Tarihsiz kontrol checkbox'Ä± deÄŸiÅŸtiÄŸinde renk ve stil gÃ¼ncellemesi"""
        if self.tarihsiz_kontrol_var.get():
            self.tarihsiz_check.config(fg='black')  # SeÃ§iliyse siyah renk
            self.txt_sonuc.insert(tk.END, "â„¹ï¸ Tarihsiz fotoÄŸraf kontrolÃ¼ AKTÄ°F (YavaÅŸ mod)\n")
        else:
            self.tarihsiz_check.config(fg=self.colors['text'])  # SeÃ§ili deÄŸilse normal renk
            self.txt_sonuc.insert(tk.END, "â„¹ï¸ Tarihsiz fotoÄŸraf kontrolÃ¼ PASÄ°F (HÄ±zlÄ± mod)\n")
        self.txt_sonuc.see(tk.END)


    
    def excel_secim_ve_islem_baslat(self):
        """Excel dosyalarÄ±nÄ± seÃ§mek iÃ§in dialog aÃ§ ve iÅŸlemi baÅŸlat"""
        if not self.ana_klasor.get():
            messagebox.showerror("Hata", "LÃ¼tfen bir ana klasÃ¶r seÃ§in!")
            return
            
        if not self.kaydetme_yeri.get():
            messagebox.showerror("Hata", "LÃ¼tfen kaydetme yeri seÃ§in!")
            return
        
        # Excel seÃ§im dialogunu aÃ§
        excel_dialog = ExcelSecimDialog(self.root)
        self.root.wait_window(excel_dialog)
        
        # SeÃ§ilen dosya yollarÄ±nÄ± al
        self.direk_musterek_yolu = excel_dialog.direk_musterek_yolu
        self.direk_og_yolu = excel_dialog.direk_og_yolu
        
        # EÄŸer hiÃ§ dosya seÃ§ilmediyse uyarÄ± ver
        if not self.direk_musterek_yolu and not self.direk_og_yolu:
            messagebox.showwarning("UyarÄ±", "HiÃ§ Excel dosyasÄ± seÃ§ilmedi! Direk tipi bilgisi eklenmeyecek.")
        
        # Ä°ÅŸlemi baÅŸlat
        self.fotograf_klasorleri_listele()
    

    
    def alt_klasor_check_degisti(self):
        if self.alt_klasor_dahil.get():
            self.alt_klasor_check.config(fg='black')
        else:
            self.alt_klasor_check.config(fg=self.colors['text'])
    
    def boyut_check_degisti(self):
        if self.boyutlandir_birlesik.get():
            self.boyut_check.config(fg='black')
            self.entry_boyut.config(state='normal')
        else:
            self.boyut_check.config(fg=self.colors['text'])
            self.entry_boyut.config(state='disabled')
    
    def orijinal_check_degisti(self):
        if self.orijinalleri_tasi.get():
            self.orijinal_check.config(fg='black')
        else:
            self.orijinal_check.config(fg=self.colors['text'])
    
    def boyutlandir_birlesik_toggle(self):
        if self.boyutlandir_birlesik.get():
            self.entry_boyut.config(state='normal')
        else:
            self.entry_boyut.config(state='disabled')
    
    def kaynak_klasor_temizle(self):
        self.kaynak_klasorler.clear()
        self.kaynak_listbox.delete(0, tk.END)

    
    def istatistikleri_sifirla(self):
        self.eklenen_klasor_sayisi.set(0)
        self.atlanan_klasor_sayisi.set(0)
        self.toplam_klasor_sayisi.set(0)
        self.toplam_foto_sayisi.set(0)

        
        # Ä°lerleme Ã§ubuÄŸunu gÃ¼venli ÅŸekilde sÄ±fÄ±rla
        try:
            if hasattr(self, 'ilerleme') and self.ilerleme:
                self.ilerleme['value'] = 0
        except tk.TclError:
            # Ä°lerleme Ã§ubuÄŸu mevcut deÄŸilse, hata verme
            pass
        
        try:
            if hasattr(self, 'excel_ilerleme') and self.excel_ilerleme:
                self.excel_ilerleme['value'] = 0
        except tk.TclError:
            # Excel ilerleme Ã§ubuÄŸu mevcut deÄŸilse, hata verme
            pass
        
        self.ilerleme_yuzde.set("%0")
        self.txt_sonuc.delete(1.0, tk.END)
        self.lbl_durum.config(text="HazÄ±r", fg=self.colors['success'])
        self._sehir_oncesi.clear()

        
    def log_mesaj_ekle(self, mesaj):
        """Ä°ÅŸlem sonuÃ§larÄ±na zaman damgalÄ± mesaj ekler"""
        timestamp = datetime.datetime.now().strftime("[%H:%M:%S]")
        log_mesaj = f"{timestamp} {mesaj}\n"
        self.txt_sonuc.insert(tk.END, log_mesaj)
        self.txt_sonuc.see(tk.END)
        self.root.update()  # self.update() yerine self.root.update()


    
    def ana_klasor_sec(self):
        klasor = filedialog.askdirectory(title="Ana KlasÃ¶rÃ¼ SeÃ§in")
        if klasor:
            self.ana_klasor.set(klasor)
            
    def klasor_sec(self, degisken):
        klasor = filedialog.askdirectory(title="KlasÃ¶r SeÃ§in")
        if klasor:
            degisken.set(klasor)
            
    def kaydetme_yeri_sec(self):
        baslangic_yolu = os.path.join(os.path.expanduser("~"), "Documents")
        if not os.path.exists(baslangic_yolu):
            baslangic_yolu = os.path.expanduser("~")
            
        dosya = filedialog.asksaveasfilename(
            initialdir=baslangic_yolu,
            title="Excel DosyasÄ±nÄ± Kaydet",
            defaultextension=".xlsx",
            filetypes=[("Excel dosyalarÄ±", "*.xlsx"), ("TÃ¼m dosyalar", "*.*")]
        )
        if dosya:
            self.kaydetme_yeri.set(dosya)

    
    def kaynak_klasor_sil(self):
        secili_indeksler = self.kaynak_listbox.curselection()
        for indeks in reversed(secili_indeksler):
            self.kaynak_klasorler.pop(indeks)
            self.kaynak_listbox.delete(indeks)

    


    def fotograf_klasorleri_listele(self):
        if not self.ana_klasor.get():
            messagebox.showerror("Hata", "LÃ¼tfen bir ana klasÃ¶r seÃ§in!")
            return
            
        if not self.kaydetme_yeri.get():
            messagebox.showerror("Hata", "LÃ¼tfen kaydetme yeri seÃ§in!")
            return
        
        # 1. Ã–NCE MASADÃœSTÃœNDEKÄ° DRONE KLASÃ–RÃœNDEN EXCEL DOSYALARINI OTOMATÄ°K BUL
        desktop_path = os.path.join(os.path.expanduser("~"), "Desktop")
        drone_klasoru = os.path.join(desktop_path, "Drone")
        
        # Excel dosya adlarÄ±nÄ± tanÄ±mla
        musterek_dosya_adlari = ["direk_musterek.xlsx", "direk_musterek.xls", "musterek_direk.xlsx", "musterek_direk.xls"]
        og_dosya_adlari = ["direk_og.xlsx", "direk_og.xls", "og_direk.xlsx", "og_direk.xls"]
        
        # DosyalarÄ± bul
        self.direk_musterek_yolu = None
        self.direk_og_yolu = None
        
        if os.path.exists(drone_klasoru):
            self.log_mesaj_ekle(f"ğŸ” MasaÃ¼stÃ¼ Drone klasÃ¶rÃ¼ taranÄ±yor: {drone_klasoru}")
            
            # MÃ¼ÅŸterek direk Excel'ini ara
            for dosya_adi in musterek_dosya_adlari:
                potansiyel_yol = os.path.join(drone_klasoru, dosya_adi)
                if os.path.exists(potansiyel_yol):
                    self.direk_musterek_yolu = potansiyel_yol
                    self.log_mesaj_ekle(f"âœ… MÃ¼ÅŸterek direk Excel'i bulundu: {dosya_adi}")
                    break
            
            # OG direk Excel'ini ara
            for dosya_adi in og_dosya_adlari:
                potansiyel_yol = os.path.join(drone_klasoru, dosya_adi)
                if os.path.exists(potansiyel_yol):
                    self.direk_og_yolu = potansiyel_yol
                    self.log_mesaj_ekle(f"âœ… OG direk Excel'i bulundu: {dosya_adi}")
                    break
            
            # EÄŸer dosyalar bulunamadÄ±ysa, klasÃ¶rdeki tÃ¼m Excel dosyalarÄ±nÄ± ara
            if not self.direk_musterek_yolu or not self.direk_og_yolu:
                self.log_mesaj_ekle("ğŸ“‚ KlasÃ¶rdeki tÃ¼m Excel dosyalarÄ± taranÄ±yor...")
                for dosya in os.listdir(drone_klasoru):
                    if dosya.lower().endswith(('.xlsx', '.xls')):
                        dosya_yolu = os.path.join(drone_klasoru, dosya)
                        
                        # Dosya adÄ±na gÃ¶re tÃ¼rÃ¼nÃ¼ belirle
                        dosya_adi_lower = dosya.lower()
                        
                        if not self.direk_musterek_yolu and any(keyword in dosya_adi_lower for keyword in ['musterek', 'mÃ¼ÅŸterek']):
                            self.direk_musterek_yolu = dosya_yolu
                            self.log_mesaj_ekle(f"âœ… MÃ¼ÅŸterek direk Excel'i bulundu: {dosya}")
                        
                        if not self.direk_og_yolu and any(keyword in dosya_adi_lower for keyword in ['og', 'og_direk', 'ogdirek', 'TRAFO DÄ°REÄÄ°']):
                            self.direk_og_yolu = dosya_yolu
                            self.log_mesaj_ekle(f"âœ… OG direk Excel'i bulundu: {dosya}")
        
        # 2. EÄER OTOMATÄ°K BULUNAMADIYSA, KULLANICIYA SOR
        if not self.direk_musterek_yolu and not self.direk_og_yolu:
            self.log_mesaj_ekle("âš ï¸ Excel dosyalarÄ± otomatik bulunamadÄ±, manuel seÃ§ime geÃ§iliyor...")
            
            # Excel seÃ§im dialogunu aÃ§
            excel_dialog = ExcelSecimDialog(self.root)
            self.root.wait_window(excel_dialog)
            
            # SeÃ§ilen dosya yollarÄ±nÄ± al
            self.direk_musterek_yolu = excel_dialog.direk_musterek_yolu
            self.direk_og_yolu = excel_dialog.direk_og_yolu
            
            # EÄŸer hiÃ§ dosya seÃ§ilmediyse uyarÄ± ver
            if not self.direk_musterek_yolu and not self.direk_og_yolu:
                messagebox.showwarning("UyarÄ±", "HiÃ§ Excel dosyasÄ± seÃ§ilmedi! Direk tipi bilgisi eklenmeyecek.")
        else:
            # OTOMATÄ°K BULUNDU, KULLANICIYA BÄ°LGÄ° VER
            bulunan_dosyalar = []
            if self.direk_musterek_yolu:
                bulunan_dosyalar.append(f"MÃ¼ÅŸterek: {os.path.basename(self.direk_musterek_yolu)}")
            if self.direk_og_yolu:
                bulunan_dosyalar.append(f"OG: {os.path.basename(self.direk_og_yolu)}")
            
            self.log_mesaj_ekle(f"âœ… Excel dosyalarÄ± otomatik bulundu: {', '.join(bulunan_dosyalar)}")

        
        # 3. RAPOR Ä°ÅLEMÄ°NÄ° BAÅLAT
        self.calisma_devam_ediyor = True
        self.lbl_durum.config(text="Rapor oluÅŸturma iÅŸlemi baÅŸlatÄ±lÄ±yor...", fg=self.colors['accent'])
        self.txt_sonuc.delete(1.0, tk.END)
        self.txt_sonuc.insert(tk.END, "Rapor oluÅŸturma iÅŸlemi baÅŸlatÄ±lÄ±yor...\n")
        self.ilerleme['value'] = 0
        self.ilerleme_yuzde.set("%0")
        self.root.update()
        
        # Direkt rapor iÅŸlemini baÅŸlat
        threading.Thread(target=self.fotograf_klasorleri_listele_thread_optimized, daemon=True).start()

    
    def tum_yol_ayiricilari_duzelt(self, yol):
        if yol:
            yol = yol.replace('/', '\\')
            yol = os.path.normpath(yol)
        return yol
    
    def fotograf_klasorleri_listele_thread_optimized(self):
        try:
            # EXCEL DOSYA DURUMUNU LOGLA - BURAYA EKLÄ°YORUZ
            self.log_mesaj_ekle("ğŸ“Š Excel dosya durumu kontrol ediliyor...")
            
            if hasattr(self, 'direk_musterek_yolu') and self.direk_musterek_yolu:
                self.log_mesaj_ekle(f"âœ… MÃ¼ÅŸterek Excel: {os.path.basename(self.direk_musterek_yolu)}")
            else:
                self.log_mesaj_ekle("âš ï¸ MÃ¼ÅŸterek Excel dosyasÄ± bulunamadÄ± - Direk tipi bilgisi eklenmeyecek")
                
            if hasattr(self, 'direk_og_yolu') and self.direk_og_yolu:
                self.log_mesaj_ekle(f"âœ… OG Excel: {os.path.basename(self.direk_og_yolu)}")
            else:
                self.log_mesaj_ekle("âš ï¸ OG Excel dosyasÄ± bulunamadÄ± - Direk tipi bilgisi eklenmeyecek")
            
            start_time = time.time()
            self.log_mesaj_ekle("ğŸ”„ HÄ±zlÄ± tarama baÅŸlatÄ±ldÄ±...")
            self.throttled_update()
            
            # KULLANICI SEÃ‡ENEÄÄ° - YENÄ° EKLENDÄ°
            tarihsiz_tara = self.tarihsiz_kontrol_var.get()
            
            # 1. AÅAMA: KlasÃ¶r tarama
            self.log_mesaj_ekle("ğŸ“ KlasÃ¶rler taranÄ±yor...")
            self.throttled_update()
            tum_klasorler = self.hizli_klasor_tarama(self.ana_klasor.get())
            tarama_suresi = time.time() - start_time
            
            self.log_mesaj_ekle(f"âœ… {len(tum_klasorler)} klasÃ¶r {tarama_suresi:.2f}s'de bulundu")
            self.throttled_update()
            
            if not tum_klasorler:
                self.log_mesaj_ekle("âŒ HiÃ§ fotoÄŸraf klasÃ¶rÃ¼ bulunamadÄ±!")
                return
            
            # 2. AÅAMA: KlasÃ¶r iÅŸleme
            self.log_mesaj_ekle("ğŸ” KlasÃ¶r bilgileri iÅŸleniyor...")
            
            if tarihsiz_tara:
                self.log_mesaj_ekle("âš¡ TÃ¼m fotoÄŸraflar tarih kontrolÃ¼ yapÄ±lacak (YavaÅŸ mod)")
            else:
                self.log_mesaj_ekle("âš¡ Sadece Ã§ekim tarihleri alÄ±nacak (HÄ±zlÄ± mod)")
            
            self.log_mesaj_ekle(f"âš¡ {self.optimal_thread_sayisi()} thread ile paralel iÅŸlem")
            self.throttled_update()
            
            foto_klasorleri = []
            atlanan_klasorler = []
            hat_tarihleri = {}
            
            max_workers = self.optimal_thread_sayisi()
            
            with concurrent.futures.ThreadPoolExecutor(max_workers=max_workers) as executor:
                future_to_klasor = {
                    executor.submit(self.klasor_isle, klasor, tarihsiz_tara): klasor 
                    for klasor in tum_klasorler
                }
                
                completed = 0
                for future in concurrent.futures.as_completed(future_to_klasor):
                    completed += 1
                    try:
                        result = future.result(timeout=15)
                        if result:
                            klasor_veri, atlama_veri = result
                            if klasor_veri:
                                foto_klasorleri.append(klasor_veri)
                                
                                # Hat bazlÄ± tarih analizi
                                hat_anahtari = (klasor_veri['Aob'], klasor_veri['Hat adÄ±'])
                                if hat_anahtari not in hat_tarihleri:
                                    hat_tarihleri[hat_anahtari] = {
                                        'ilk_tarih': None,
                                        'son_tarih': None,
                                        'tarihler': []
                                    }
                                
                                # Tarih bilgisini datetime'a Ã§evir
                                try:
                                    tarih_str = klasor_veri['En Yeni FotoÄŸraf Tarihi']
                                    if tarih_str != 'Tarih alÄ±namadÄ±' and tarih_str != 'Tarihi Yok':
                                        tarih_obj = datetime.datetime.strptime(tarih_str, '%d/%m/%Y %H:%M:%S')
                                        hat_tarihleri[hat_anahtari]['tarihler'].append(tarih_obj)
                                except:
                                    pass
                                
                                with self.thread_lock:
                                    self.eklenen_klasor_sayisi.set(len(foto_klasorleri))
                                    
                            elif atlama_veri:
                                atlanan_klasorler.append(atlama_veri)
                                with self.thread_lock:
                                    self.atlanan_klasor_sayisi.set(len(atlanan_klasorler))
                    
                    except concurrent.futures.TimeoutError:
                        klasor_yolu = future_to_klasor[future]
                        self.log_mesaj_ekle(f"â° Timeout: {os.path.basename(klasor_yolu)}")
                    except Exception as e:
                        klasor_yolu = future_to_klasor[future]
                        self.log_mesaj_ekle(f"âš ï¸ Hata: {os.path.basename(klasor_yolu)} - {str(e)}")
                    
                    ilerleme = (completed / len(tum_klasorler)) * 100
                    with self.thread_lock:
                        self.ilerleme['value'] = ilerleme
                        self.ilerleme_yuzde.set(f"%{int(ilerleme)}")
                        self.toplam_klasor_sayisi.set(completed)
                    
                    if completed % 25 == 0:
                        self.throttled_update()
            
            # YENÄ°: KLASÃ–RLERÄ° SIRALA - Hat bazÄ±nda ve sÄ±ra numarasÄ±na gÃ¶re
            self.log_mesaj_ekle("ğŸ”¢ KlasÃ¶rler sÄ±ralanÄ±yor...")
            self.throttled_update()
            foto_klasorleri = self.klasorleri_sirala(foto_klasorleri)
            
            # 3. AÅAMA: Hat sÃ¼relerini hesaplama
            self.log_mesaj_ekle("ğŸ“… Hat sÃ¼releri hesaplanÄ±yor...")
            self.throttled_update()
            hat_sureleri = self.hat_surelerini_hesapla(hat_tarihleri)
            
            # 4. AÅAMA: Direk tipi bilgilerini alma
            self.log_mesaj_ekle("ğŸ·ï¸ Direk tipi bilgileri alÄ±nÄ±yor...")
            self.throttled_update()
            direk_tipleri = self.direk_tipi_bilgilerini_al(foto_klasorleri)
            
            # 5. AÅAMA: Tarihsiz istatistikleri hesaplama (SADECE SEÃ‡Ä°LÄ°RSE)
            hat_tarihsiz_istatistikleri = {}
            if tarihsiz_tara:
                self.log_mesaj_ekle("ğŸ“Š Tarihsiz fotoÄŸraf istatistikleri hesaplanÄ±yor...")
                self.throttled_update()
                hat_tarihsiz_istatistikleri = self.hat_bazi_tarihsiz_hesapla(foto_klasorleri)
            else:
                self.log_mesaj_ekle("â© Tarihsiz kontrol atlanÄ±yor (hÄ±zlÄ± mod)")
                self.throttled_update()
                # BoÅŸ istatistik gÃ¶nder
                hat_tarihsiz_istatistikleri = {}
            
            self.throttled_update()
            
            # 6. AÅAMA: Excel oluÅŸturma
            self.log_mesaj_ekle("ğŸ“Š Excel dosyasÄ± oluÅŸturuluyor...")
            self.throttled_update()
            # Tarihsiz istatistiklerini parametre olarak gÃ¶nderiyoruz
            self.excel_islemi_tamamla(foto_klasorleri, atlanan_klasorler, hat_sureleri, hat_tarihsiz_istatistikleri)
            
        except Exception as e:
            self.lbl_durum.config(text="Hata oluÅŸtu", fg=self.colors['danger'])
            self.log_mesaj_ekle(f"âŒ Beklenmeyen hata: {str(e)}")
            import traceback
            self.log_mesaj_ekle(f"ğŸ” Hata detayÄ±: {traceback.format_exc()}")



    def klasorleri_sirala(self, foto_klasorleri):
        """KlasÃ¶rleri hat bazÄ±nda ve sÄ±ra numarasÄ±na gÃ¶re sÄ±ralar"""
        try:
            # Ã–nce hat bazÄ±nda grupla
            hat_gruplari = {}
            
            for klasor in foto_klasorleri:
                hat_anahtari = (klasor['Aob'], klasor['Hat adÄ±'])
                
                if hat_anahtari not in hat_gruplari:
                    hat_gruplari[hat_anahtari] = []
                
                hat_gruplari[hat_anahtari].append(klasor)
            
            # Her hat grubunu sÄ±ra numarasÄ±na gÃ¶re sÄ±rala
            sirali_klasorler = []
            
            for hat_anahtari, klasor_listesi in hat_gruplari.items():
                # SÄ±ra numarasÄ±na gÃ¶re sÄ±rala
                sirali_hat_klasorleri = sorted(klasor_listesi, 
                                             key=lambda x: self.sira_no_ile_sirala(x['Orijinal KlasÃ¶r AdÄ±']))
                sirali_klasorler.extend(sirali_hat_klasorleri)
                
                # Debug info
                self.log_mesaj_ekle(f"ğŸ”¢ {hat_anahtari[0]} - {hat_anahtari[1]}: {len(sirali_hat_klasorleri)} klasÃ¶r sÄ±ralandÄ±")
            
            self.log_mesaj_ekle(f"âœ… Toplam {len(sirali_klasorler)} klasÃ¶r sÄ±ralandÄ±")
            return sirali_klasorler
            
        except Exception as e:
            self.log_mesaj_ekle(f"âš ï¸ SÄ±ralama hatasÄ±: {str(e)}")
            # Hata durumunda orijinal listeyi dÃ¶ndÃ¼r
            return foto_klasorleri

    def sira_no_ile_sirala(self, orijinal_klasor_adi):
        """SÄ±ralama iÃ§in sÄ±ra numarasÄ±nÄ± Ã§Ä±karÄ±r (sayÄ±sal karÅŸÄ±laÅŸtÄ±rma iÃ§in)"""
        try:
            sira_no_str = self.sira_no_ayikla(orijinal_klasor_adi)
            if sira_no_str and sira_no_str.isdigit():
                return int(sira_no_str)
            else:
                # SÄ±ra numarasÄ± yoksa veya geÃ§ersizse, Ã§ok bÃ¼yÃ¼k bir sayÄ± dÃ¶ndÃ¼rerek sona at
                return 999999
        except:
            return 999999


    def hat_surelerini_hesapla(self, hat_tarihleri):
        """Hat bazÄ±nda sadece Ã§ekim yapÄ±lan gÃ¼nleri hesaplar"""
        hat_sureleri = {}
        
        for hat_anahtari, tarih_bilgileri in hat_tarihleri.items():
            if tarih_bilgileri['tarihler']:
                # TÃ¼m tarihleri al ve sadece tarih kÄ±smÄ±nÄ± (gÃ¼n bazÄ±nda) al
                tum_tarihler = tarih_bilgileri['tarihler']
                
                # Benzersiz Ã§ekim gÃ¼nlerini bul (sadece tarih, saat yok)
                cekim_gunleri = set()
                for tarih in tum_tarihler:
                    gun_bazinda = tarih.date()  # Sadece tarih kÄ±smÄ±nÄ± al, saati at
                    cekim_gunleri.add(gun_bazinda)
                
                # Benzersiz Ã§ekim gÃ¼nlerini sÄ±rala
                sirali_gunler = sorted(cekim_gunleri)
                
                if sirali_gunler:
                    ilk_gun = sirali_gunler[0]
                    son_gun = sirali_gunler[-1]
                    
                    # TOPLAM Ä°Å GÃœNÃœ = Benzersiz Ã§ekim gÃ¼nÃ¼ sayÄ±sÄ±
                    toplam_is_gunu = len(cekim_gunleri)
                    
                    hat_sureleri[hat_anahtari] = {
                        'ilk_tarih': ilk_gun.strftime('%d/%m/%Y'),
                        'son_tarih': son_gun.strftime('%d/%m/%Y'),
                        'toplam_gun': toplam_is_gunu,
                        'benzersiz_cekim_gunleri': len(cekim_gunleri),
                        'tum_tarih_araligi': f"{ilk_gun.strftime('%d/%m/%Y')} - {son_gun.strftime('%d/%m/%Y')}",
                        'tarih_araligi_gun_sayisi': (son_gun - ilk_gun).days + 1
                    }
                else:
                    hat_sureleri[hat_anahtari] = {
                        'ilk_tarih': 'Tarihi Yok',
                        'son_tarih': 'Tarihi Yok', 
                        'toplam_gun': 0,
                        'benzersiz_cekim_gunleri': 0,
                        'tarih_araligi': 'Tarihi Yok'
                    }
            else:
                hat_sureleri[hat_anahtari] = {
                    'ilk_tarih': 'Tarihi Yok',
                    'son_tarih': 'Tarihi Yok', 
                    'toplam_gun': 0,
                    'benzersiz_cekim_gunleri': 0,
                    'tarih_araligi': 'Tarihi Yok'
                }
        
        return hat_sureleri
    
    def hizli_klasor_tarama(self, ana_klasor):
        foto_uzantilari = ('.jpg', '.jpeg', '.png', '.gif', '.bmp', '.tiff', '.webp')
        foto_klasorleri = []
        
        for root, dirs, files in os.walk(ana_klasor):
            for dosya in files:
                if any(dosya.lower().endswith(ext) for ext in foto_uzantilari):
                    foto_klasorleri.append(root)
                    break
        
        return foto_klasorleri
    
    def optimal_thread_sayisi(self):
        try:
            cpu_sayisi = os.cpu_count() or 1
            return min(cpu_sayisi, 4)
        except:
            return 2
    
    def throttled_update(self):
        current_time = time.time()
        if current_time - self._last_update > 0.1:
            self.root.update()  # Burada da self.root.update() kullan
            self._last_update = current_time
            # Text widget'Ä±nÄ± her gÃ¼ncellemede en sona kaydÄ±r
            self.txt_sonuc.see(tk.END)
    
    def exif_tarihini_al(self, dosya_yolu):
        try:
            with Image.open(dosya_yolu) as img:
                exif_data = img.getexif()
                if exif_data:
                    # Ã–ncelikle Ã§ekilme tarihini ara (EXIF tag 36867 veya 306)
                    datetime_original = exif_data.get(36867)  # DateTimeOriginal
                    if not datetime_original:
                        datetime_original = exif_data.get(306)  # DateTime
                    
                    if datetime_original:
                        # EXIF tarih formatÄ±: '2025:07:20 12:30:45'
                        try:
                            return datetime.datetime.strptime(datetime_original, '%Y:%m:%d %H:%M:%S')
                        except ValueError:
                            # BazÄ± format farklÄ±lÄ±klarÄ± olabilir
                            try:
                                return datetime.datetime.strptime(datetime_original, '%Y-%m-%d %H:%M:%S')
                            except:
                                pass
                
                # EXIF yoksa veya okunamazsa None dÃ¶ndÃ¼r
                return None
                
        except Exception as e:
            print(f"EXIF okuma hatasÄ± {dosya_yolu}: {e}")
            return None

    def klasor_isle(self, klasor_yolu, tarihsiz_tara=False):
        klasor_adi = os.path.basename(klasor_yolu)
        foto_uzantilari = ('.jpg', '.jpeg', '.png', '.gif', '.bmp', '.tiff', '.webp')
        
        try:
            try:
                dosyalar = os.listdir(klasor_yolu)
            except (PermissionError, OSError) as e:
                return None, {
                    'KlasÃ¶r Yolu': self.tum_yol_ayiricilari_duzelt(klasor_yolu),
                    'Direk No': klasor_adi,
                    'Sebep': f'EriÅŸim hatasÄ±: {str(e)}'
                }
            
            rakam_kismi = self.klasor_adi_kontrol(klasor_adi)
            
            if rakam_kismi is None or rakam_kismi == "0":
                return None, {
                    'KlasÃ¶r Yolu': self.tum_yol_ayiricilari_duzelt(klasor_yolu),
                    'Direk No': klasor_adi,
                    'Sebep': 'Uygun format deÄŸil' if rakam_kismi is None else 'Direk No 0 olamaz'
                }
            
            foto_sayisi = 0
            son_foto_tarihi = None
            
            # KlasÃ¶rdeki fotoÄŸraflarÄ± sÄ±rala ve son fotoÄŸrafÄ± bul
            foto_dosyalari = []
            for dosya in dosyalar:
                if any(dosya.lower().endswith(ext) for ext in foto_uzantilari):
                    foto_sayisi += 1
                    foto_dosyalari.append(dosya)
            
            # FotoÄŸraflarÄ± sÄ±rala (alfabetik olarak sonuncuyu al)
            if foto_dosyalari:
                foto_dosyalari.sort()
                son_foto = foto_dosyalari[-1]  # En son sÄ±radaki fotoÄŸraf
                dosya_yolu = os.path.join(klasor_yolu, son_foto)
                
                # Ã–nce EXIF'ten Ã§ekilme tarihini al
                son_foto_tarihi = self.exif_tarihini_al(dosya_yolu)
                
                # EÄŸer EXIF tarihi yoksa, "Tarihi Yok" olarak iÅŸaretle
                if son_foto_tarihi is None:
                    son_foto_tarihi = None  # "Tarihi Yok" olarak iÅŸaretle
            
            # Tarih bilgisini iÅŸle
            if son_foto_tarihi is not None:
                tarih_bilgileri = self.tarihi_ayristir(son_foto_tarihi)
            else:
                # Tarih yoksa "Tarihi Yok" olarak iÅŸaretle
                tarih_bilgileri = {
                    'tam_tarih': 'Tarihi Yok',
                    'yil': 'Tarihi Yok',
                    'ay': 'Tarihi Yok', 
                    'gun': 'Tarihi Yok'
                }
            
            aob_adi = self.aob_adi_bul(klasor_yolu)
            hat_adi = self.bir_ust_klasor_adi_al(klasor_yolu)
            
            try:
                klasor_adi_sayi = int(rakam_kismi)
            except ValueError:
                klasor_adi_sayi = rakam_kismi
            
            mesaj = f"âœ“ {aob_adi} -> {hat_adi} -> {klasor_adi_sayi} ({foto_sayisi} fotoÄŸraf, Tarih: {tarih_bilgileri['tam_tarih']})"
            with self.thread_lock:
                self.log_mesaj_ekle(mesaj)
            
            return {
                'KlasÃ¶r Yolu': self.tum_yol_ayiricilari_duzelt(klasor_yolu),
                'Aob': aob_adi,
                'Hat adÄ±': hat_adi,
                'Direk No': klasor_adi_sayi,
                'FotoÄŸraf SayÄ±sÄ±': foto_sayisi,
                'Orijinal KlasÃ¶r AdÄ±': klasor_adi,
                'GÃ¼n': tarih_bilgileri['gun'],
                'Ay': tarih_bilgileri['ay'],
                'YÄ±l': tarih_bilgileri['yil'],
                'En Yeni FotoÄŸraf Tarihi': tarih_bilgileri['tam_tarih']
            }, None
            
        except Exception as e:
            return None, {
                'KlasÃ¶r Yolu': self.tum_yol_ayiricilari_duzelt(klasor_yolu),
                'Direk No': klasor_adi,
                'Sebep': f'Ä°ÅŸlem hatasÄ±: {str(e)}'
            }
    
    def tarihi_ayristir(self, tarih_objesi):
        if tarih_objesi is None:
            return {
                'tam_tarih': 'Tarihi Yok',
                'yil': 'Tarihi Yok',
                'ay': 'Tarihi Yok', 
                'gun': 'Tarihi Yok'
            }
        
        try:
            return {
                'tam_tarih': tarih_objesi.strftime('%d/%m/%Y %H:%M:%S'),
                'yil': str(tarih_objesi.year),
                'ay': str(tarih_objesi.month).zfill(2),
                'gun': str(tarih_objesi.day).zfill(2)
            }
        except Exception as e:
            return {
                'tam_tarih': 'Tarihi Yok',
                'yil': 'Tarihi Yok',
                'ay': 'Tarihi Yok',
                'gun': 'Tarihi Yok'
            }
    
    def aob_adi_bul(self, klasor_yolu):
        if klasor_yolu in self._sehir_oncesi:
            return self._sehir_oncesi[klasor_yolu]
            
        parts = klasor_yolu.split(os.sep)
        for part in parts:
            temiz_part = part.strip().upper()
            for sehir in self.sehirler:
                if sehir in temiz_part:
                    self._sehir_oncesi[klasor_yolu] = sehir
                    return sehir
        
        result = parts[-1] if parts else "Bilinmiyor"
        self._sehir_oncesi[klasor_yolu] = result
        return result
    
    def bir_ust_klasor_adi_al(self, klasor_yolu):
        if klasor_yolu:
            ust_klasor_yolu = os.path.dirname(klasor_yolu)
            return os.path.basename(ust_klasor_yolu)
        return ""
    
    def klasor_adi_kontrol(self, klasor_adi):
        """
        Revize edilmiÅŸ klasÃ¶r adÄ± kontrol fonksiyonu
        Yeni format: "74 - a123456" â†’ "123456" desteÄŸi eklendi
        """
        
        # Ã–NCE YENÄ° FORMAT: "74 - a123456", "74 - b123457" (SADECE TEK HARF)
        try:
            if ' - ' in klasor_adi:
                parts = klasor_adi.split(' - ', 1)
                if len(parts) == 2:
                    sÄ±ra_kÄ±smÄ± = parts[0].strip()      # "74"
                    direk_kÄ±smÄ± = parts[1].strip()     # "a123456", "b123457", vb.
                    
                    # SÄ±ra kÄ±smÄ± sayÄ± mÄ± kontrol et
                    if sÄ±ra_kÄ±smÄ± and sÄ±ra_kÄ±smÄ±.isdigit():
                        # Direk kÄ±smÄ±: TAM OLARAK 1 HARF + RAKAMLAR olmalÄ±
                        if (len(direk_kÄ±smÄ±) >= 2 and 
                            direk_kÄ±smÄ±[0].isalpha() and 
                            len(direk_kÄ±smÄ±[0]) == 1 and  # SADECE 1 HARF
                            direk_kÄ±smÄ±[1:].isdigit()):   # GERÄ° KALANI SADECE RAKAM
                            
                            rakam_kismi = direk_kÄ±smÄ±[1:]  # "123456"
                            # BaÅŸtaki sÄ±fÄ±rlarÄ± temizle, "0" deÄŸerini koru
                            rakam_kismi = rakam_kismi.lstrip('0') or '0'
                            if rakam_kismi != "0":
                                return rakam_kismi
        except:
            pass
        
        # SONRA ORÄ°JÄ°NAL FORMATLARI KONTROL ET
        if klasor_adi.count('-') >= 2:
            parts = klasor_adi.split('-', 2)
            if len(parts) == 3:
                rakam_kismi = parts[1].strip()
                rakam_kismi = ''.join(filter(str.isdigit, rakam_kismi))
                if rakam_kismi and rakam_kismi != "0":
                    return rakam_kismi
        
        elif ' - ' in klasor_adi:
            parts = klasor_adi.split(' - ', 1)
            if len(parts) == 2:
                rakam_kismi = parts[1].strip()
                if not rakam_kismi or not rakam_kismi[0].isdigit():
                    return None
                rakamlar = []
                for char in rakam_kismi:
                    if char.isdigit():
                        rakamlar.append(char)
                    elif rakamlar:
                        break
                rakam_kismi = ''.join(rakamlar)
                if rakam_kismi and rakam_kismi != "0":
                    return rakam_kismi
        
        elif '-' in klasor_adi:
            parts = klasor_adi.split('-', 1)
            if len(parts) == 2:
                rakam_kismi = parts[1].strip()
                if not rakam_kismi or not rakam_kismi[0].isdigit():
                    return None
                rakamlar = []
                for char in rakam_kismi:
                    if char.isdigit():
                        rakamlar.append(char)
                    elif rakamlar:
                        break
                rakam_kismi = ''.join(rakamlar)
                if rakam_kismi and rakam_kismi != "0":
                    return rakam_kismi
        
        return None
    

    def excel_islemi_tamamla(self, foto_klasorleri, atlanan_klasorler, hat_sureleri=None, hat_tarihsiz_istatistikleri=None):
        start_time = time.time()
        self.log_mesaj_ekle("ğŸ’¾ Excel dosyasÄ± oluÅŸturuluyor...")
        self.throttled_update()
        
        try:
            # 1. AÅAMA: Workbook oluÅŸturma
            self.log_mesaj_ekle("ğŸ“— Workbook oluÅŸturuluyor...")
            workbook = Workbook()
            workbook.remove(workbook.active)
            
            # 2. AÅAMA: Koordinat bilgilerini al
            self.log_mesaj_ekle("ğŸ“ Koordinat bilgileri alÄ±nÄ±yor...")
            koordinat_bilgileri = self.koordinat_bilgilerini_al(foto_klasorleri)
            
            # 3. AÅAMA: TESPÄ°T BÄ°LGÄ°LERÄ°NÄ° BÄ°RLEÅTÄ°R (ÃœÃ‡LÃœ ANAHTAR Ä°LE) - YAPILDI MI? BÄ°LGÄ°SÄ° DE ALINACAK
            self.log_mesaj_ekle("ğŸ” Tespit bilgileri birleÅŸtiriliyor...")
            tespit_verileri = self.tespit_bilgilerini_birlestir(foto_klasorleri)
            
            # 4. AÅAMA: Mesafe bilgilerini hesapla (YENÄ°: hat uzunluklarÄ±nÄ± da al)
            self.log_mesaj_ekle("ğŸ“ Mesafe hesaplamalarÄ± yapÄ±lÄ±yor...")
            mesafe_sonuclari_dict = self.mesafe_hesapla(foto_klasorleri, koordinat_bilgileri)
            mesafe_sonuclari = mesafe_sonuclari_dict.get('mesafe_sonuclari', {})
            hat_uzunluklari = mesafe_sonuclari_dict.get('hat_uzunluklari', {})  # YENÄ°: Hat uzunluklarÄ±nÄ± al
            
            # 5. AÅAMA: DiÄŸer bilgileri al (TESPÄ°T VERÄ°LERÄ°NÄ° PARAMETRE OLARAK GÃ–NDER)
            self.log_mesaj_ekle("ğŸ·ï¸ Direk tipi ve tespit bilgileri alÄ±nÄ±yor...")
            bilgiler = self.direk_tipi_bilgilerini_al(foto_klasorleri, tespit_verileri)
            direk_tipleri = bilgiler.get('direk_tipleri', {})
            trafo_direkleri = bilgiler.get('trafo_direkleri', {})
            tespit_bilgileri = bilgiler.get('tespit_bilgileri', {})
            
            # YENÄ°: TESPÄ°T VERÄ°LERÄ°NÄ° SÃ–ZLÃœÄE DÃ–NÃœÅTÃœR (ÃœÃ‡LÃœ ANAHTAR Ä°LE)
            tespit_dict = {}
            for tespit in tespit_verileri:
                # Ä°lÃ§e bilgisini al (hem Ä°lÃ§e hem Aob iÃ§in)
                ilce = tespit.get('Ä°lÃ§e', tespit.get('Aob', '')).strip()
                
                # Hat adÄ± bilgisini al (tÃ¼m olasÄ± sÃ¼tun adlarÄ±)
                hat_adi = tespit.get('Hat AdÄ±', 
                           tespit.get('Hat adÄ±', 
                           tespit.get('Hat AdÄ±', 
                           tespit.get('Hat', '')))).strip()
                
                # Direk numarasÄ±nÄ± al (hem Direk No hem Direk ID iÃ§in)
                direk_no = tespit.get('Direk No', tespit.get('Direk ID', ''))
                temiz_direk_no = self.direk_no_temizle(direk_no)
                
                if ilce and hat_adi and temiz_direk_no:
                    # ÃœÃ‡LÃœ ANAHTAR: (Ä°lÃ§e, Hat AdÄ±, Direk No)
                    anahtar = (ilce, hat_adi, temiz_direk_no)
                    
                    tespit_dict[anahtar] = {
                        'oncelik': tespit.get('Ã–ncelik', ''),
                        'tespit_notu': tespit.get('Tespit Notu', ''),
                        'yapildi_mi': tespit.get('YapÄ±ldÄ± mÄ±?', tespit.get('YapÄ±ldÄ± mÄ±', ''))
                    }
                        
            if foto_klasorleri:
                # 6. AÅAMA: FotoÄŸraf KlasÃ¶rleri sayfasÄ±
                self.log_mesaj_ekle("ğŸ“Š FotoÄŸraf KlasÃ¶rleri sayfasÄ± hazÄ±rlanÄ±yor...")
                ws_veri = workbook.create_sheet('FotoÄŸraf KlasÃ¶rleri')
                
                basliklar = [
                    'SÄ±ra No', 'KlasÃ¶r Yolu', 'Aob', 'Hat adÄ±', 'Direk No', 'FotoÄŸraf SayÄ±sÄ±',
                    'Orijinal KlasÃ¶r AdÄ±', 'GÃ¼n', 'Ay', 'YÄ±l', 'En Yeni FotoÄŸraf Tarihi',
                    'Toplam GÃ¼n', 'Direk Tipi', 'Trafo DireÄŸi', 'LAT', 'LON', 'Mesafe (m)', 
                    'Ã–ncelik', 'Tespit Notu', 'YapÄ±ldÄ± mÄ±?'  # YAPILDI MI? SÃœTUNU
                ]
                
                for col_num, column_title in enumerate(basliklar, 1):
                    cell = ws_veri.cell(row=1, column=col_num)
                    cell.value = column_title
                    cell.font = Font(bold=True, color="FFFFFF")
                    cell.fill = PatternFill(start_color="4472C4", end_color="4472C4", fill_type="solid")
                    cell.border = Border(left=Side(style='thin'), right=Side(style='thin'),
                                       top=Side(style='thin'), bottom=Side(style='thin'))
                    cell.alignment = Alignment(horizontal='center', vertical='center')
                
                # 7. AÅAMA: Veri satÄ±rlarÄ±nÄ± ekleme (ÃœÃ‡LÃœ ANAHTAR Ä°LE TESPÄ°T VERÄ°SÄ° EÅLEÅTÄ°RME)
                self.log_mesaj_ekle(f"ğŸ“ {len(foto_klasorleri)} satÄ±r veri ekleniyor...")

                for row_num, row_data in enumerate(foto_klasorleri, 2):
                    # Temel bilgileri al - FotoÄŸraf KlasÃ¶rleri sayfasÄ±ndan
                    aob = row_data.get('Aob', row_data.get('Ä°lÃ§e', '')).strip()
                    hat_adi = row_data.get('Hat adÄ±', row_data.get('Hat AdÄ±', '')).strip()
                    
                    # Direk numarasÄ±nÄ± al ve temizle
                    klasor_adi = str(row_data.get('Direk No', row_data.get('Direk ID', '')))
                    temiz_direk_no = self.direk_no_temizle(klasor_adi)
                    
                    # SÄ±ra No bilgisini al - BU SATIR DAHA ERKEN OLMALI!
                    orijinal_klasor_adi = row_data.get('Orijinal KlasÃ¶r AdÄ±', '')
                    sira_no = self.sira_no_ayikla(orijinal_klasor_adi)  # BU SATIRI ERKEN TANIMLA!
                    
                    hat_anahtari = (aob, hat_adi)
                    hat_sure = hat_sureleri.get(hat_anahtari, {}) if hat_sureleri else {}
                    
                    # ÃœÃ‡LÃœ ANAHTAR Ä°LE TESPÄ°T BÄ°LGÄ°LERÄ°NÄ° ARA
                    uc_anahtar_1 = (aob, hat_adi, temiz_direk_no)
                    uc_anahtar_2 = (aob.upper() if aob else '', hat_adi.upper() if hat_adi else '', temiz_direk_no)
                    uc_anahtar_3 = (aob.lower() if aob else '', hat_adi.lower() if hat_adi else '', temiz_direk_no)
                    
                    # Tespit bilgilerini al
                    oncelik = ""
                    tespit_notu = ""
                    yapildi_mi = ""
                    
                    if uc_anahtar_1 in tespit_dict:
                        tespit_info = tespit_dict[uc_anahtar_1]
                    elif uc_anahtar_2 in tespit_dict:
                        tespit_info = tespit_dict[uc_anahtar_2]
                    elif uc_anahtar_3 in tespit_dict:
                        tespit_info = tespit_dict[uc_anahtar_3]
                    else:
                        tespit_info = None
                    
                    if tespit_info:
                        oncelik = tespit_info.get('oncelik', '')
                        tespit_notu = tespit_info.get('tespit_notu', '')
                        yapildi_mi = tespit_info.get('yapildi_mi', '')
                    
                    # Direk tipi bilgisini al
                    direk_tipi = direk_tipleri.get(temiz_direk_no, '') if temiz_direk_no in direk_tipleri else ''
                    
                    # Trafo direÄŸi bilgisini al
                    trafo_diregi = trafo_direkleri.get(temiz_direk_no, '') if temiz_direk_no in trafo_direkleri else ''
                    
                    # Koordinat bilgilerini al
                    koordinat_info = koordinat_bilgileri.get(temiz_direk_no, {})
                    lat = koordinat_info.get('lat', '')
                    lon = koordinat_info.get('lon', '')
                    
                    # Mesafe bilgisini al
                    uc_mesafe_anahtar = (aob, hat_adi, sira_no, temiz_direk_no)
                    mesafe = mesafe_sonuclari.get(uc_mesafe_anahtar, '')
                    
                    # HÃœCRE DEÄERLERÄ° - FOTOÄRAF KLASÃ–RLERÄ° SAYFASI
                    cell_values = [
                        sira_no,  # ÅÄ°MDÄ° TANIMLI!
                        row_data.get('KlasÃ¶r Yolu', ''),
                        aob,
                        hat_adi,
                        row_data.get('Direk No', row_data.get('Direk ID', '')),
                        row_data.get('FotoÄŸraf SayÄ±sÄ±', ''),
                        orijinal_klasor_adi,
                        row_data.get('GÃ¼n', ''),
                        row_data.get('Ay', ''),
                        row_data.get('YÄ±l', ''),
                        row_data.get('En Yeni FotoÄŸraf Tarihi', ''),    
                        hat_sure.get('toplam_gun', ''),
                        direk_tipi,
                        trafo_diregi,
                        lat,
                        lon,
                        mesafe,
                        oncelik,
                        tespit_notu,
                        yapildi_mi
                    ]
                    
                    for col_num, cell_value in enumerate(cell_values, 1):
                        cell = ws_veri.cell(row=row_num, column=col_num)
                        cell.value = cell_value
                        
                        # Mesafe sÃ¼tunu iÃ§in Ã¶zel sayÄ± formatÄ±
                        if col_num == 17:
                            if isinstance(cell_value, (int, float)):
                                cell.number_format = '#,##0.0'
                        
                        cell.border = Border(left=Side(style='thin'), right=Side(style='thin'),
                                           top=Side(style='thin'), bottom=Side(style='thin'))
                        cell.alignment = Alignment(horizontal='left', vertical='center')
                
                # 8. AÅAMA: SÃ¼tun geniÅŸliklerini ayarla
                self.log_mesaj_ekle("ğŸ“ SÃ¼tun geniÅŸlikleri ayarlanÄ±yor...")
                self.auto_adjust_column_widths(ws_veri)
                ws_veri.auto_filter.ref = ws_veri.dimensions
                
                # 9. AÅAMA: Hat Ã–zeti sayfasÄ± (YENÄ°: Hat UzunluÄŸu sÃ¼tunu eklendi)
                if hat_sureleri:
                    self.log_mesaj_ekle("ğŸ“ˆ Hat Ã–zeti sayfasÄ± oluÅŸturuluyor...")
                    ws_hat_ozet = workbook.create_sheet('Hat Ã–zeti')
                    
                    # YENÄ°: 'Hat UzunluÄŸu (km)' sÃ¼tunu eklendi (Toplam GÃ¼n'den sonra)
                    hat_basliklar = [
                        'Ä°lÃ§e', 'Hat AdÄ±', 'MÃ¼ÅŸterek Direk', 'OG Direk', 
                        'Direk SayÄ±sÄ±', 'FotoÄŸraf SayÄ±sÄ±', 'Ä°lk Ã‡ekim Tarihi', 
                        'Son Ã‡ekim Tarihi', 'Toplam GÃ¼n', 'Hat UzunluÄŸu (km)'  # YENÄ° SÃœTUN
                    ]
                    
                    for col_num, column_title in enumerate(hat_basliklar, 1):
                        cell = ws_hat_ozet.cell(row=1, column=col_num)
                        cell.value = column_title
                        cell.font = Font(bold=True, color="FFFFFF")
                        cell.fill = PatternFill(start_color="27ae60", end_color="27ae60", fill_type="solid")
                        cell.border = Border(left=Side(style='thin'), right=Side(style='thin'),
                                           top=Side(style='thin'), bottom=Side(style='thin'))
                        cell.alignment = Alignment(horizontal='center', vertical='center')
                    
                    # Hat detaylarÄ±nÄ± topla
                    hat_detaylari = {}
                    for row_data in foto_klasorleri:
                        aob = row_data.get('Aob', '')
                        hat_adi = row_data.get('Hat adÄ±', '')
                        hat_anahtari = (aob, hat_adi)
                        
                        if hat_anahtari not in hat_detaylari:
                            hat_detaylari[hat_anahtari] = {
                                'ilce': aob,
                                'hat_adi': hat_adi,
                                'musterk_direk': 0,
                                'og_direk': 0,
                                'direk_sayisi': 0,
                                'foto_sayisi': 0
                            }
                        
                        klasor_adi = str(row_data.get('Direk No', ''))
                        temiz_direk_no = self.direk_no_temizle(klasor_adi)
                        direk_tipi = direk_tipleri.get(temiz_direk_no, '') if temiz_direk_no in direk_tipleri else ''
                        
                        if direk_tipi == 'MÃ¼ÅŸterek Direk':
                            hat_detaylari[hat_anahtari]['musterk_direk'] += 1
                        elif direk_tipi == 'Og Direk':
                            hat_detaylari[hat_anahtari]['og_direk'] += 1
                        
                        hat_detaylari[hat_anahtari]['direk_sayisi'] += 1
                        hat_detaylari[hat_anahtari]['foto_sayisi'] += row_data.get('FotoÄŸraf SayÄ±sÄ±', 0)
                    
                    # Hat sÃ¼re bilgilerini ekle
                    for hat_anahtari, detay in hat_detaylari.items():
                        if hat_anahtari in hat_sureleri:
                            detay['ilk_tarih'] = hat_sureleri[hat_anahtari]['ilk_tarih']
                            detay['son_tarih'] = hat_sureleri[hat_anahtari]['son_tarih']
                            detay['toplam_gun'] = hat_sureleri[hat_anahtari]['toplam_gun']
                        
                        # YENÄ°: Hat uzunluÄŸunu ekle (km cinsinden)
                        if hat_anahtari in hat_uzunluklari:
                            hat_uzunluk_km = hat_uzunluklari[hat_anahtari] / 1000.0
                            detay['hat_uzunlugu'] = round(hat_uzunluk_km, 3)  # 3 ondalÄ±k basamak
                        else:
                            detay['hat_uzunlugu'] = 0.0
                    
                    # HatlarÄ± sÄ±rala ve ekle
                    sirali_hatlar = sorted(hat_detaylari.values(), 
                                         key=lambda x: x['direk_sayisi'], 
                                         reverse=True)
                    
                    for row_num, hat_detay in enumerate(sirali_hatlar, 2):
                        cell_values = [
                            hat_detay['ilce'],
                            hat_detay['hat_adi'],
                            hat_detay['musterk_direk'],
                            hat_detay['og_direk'],
                            hat_detay['direk_sayisi'],
                            hat_detay['foto_sayisi'],
                            hat_detay['ilk_tarih'],
                            hat_detay['son_tarih'],
                            hat_detay['toplam_gun'],
                            hat_detay['hat_uzunlugu']  # YENÄ°: Hat uzunluÄŸu
                        ]
                        
                        for col_num, cell_value in enumerate(cell_values, 1):
                            cell = ws_hat_ozet.cell(row=row_num, column=col_num)
                            cell.value = cell_value
                            
                            # YENÄ°: Hat uzunluÄŸu sÃ¼tunu iÃ§in Ã¶zel format (km cinsinden, 3 ondalÄ±k)
                            if col_num == 10 and isinstance(cell_value, (int, float)):
                                cell.number_format = '#,##0.000'
                            
                            cell.border = Border(left=Side(style='thin'), right=Side(style='thin'),
                                               top=Side(style='thin'), bottom=Side(style='thin'))
                            cell.alignment = Alignment(horizontal='left', vertical='center')
                    
                    self.auto_adjust_column_widths(ws_hat_ozet)
                    ws_hat_ozet.auto_filter.ref = ws_hat_ozet.dimensions
            
            # 10. AÅAMA: BÄ°RLEÅTÄ°RÄ°LMÄ°Å_TESPÄ°T sayfasÄ±nÄ± oluÅŸtur - TAMAMEN YENÄ° FORMAT
            if tespit_verileri:
                self.log_mesaj_ekle("ğŸ“Š BirleÅŸtirilmiÅŸ_Tespit sayfasÄ± oluÅŸturuluyor...")
                ws_tespit = workbook.create_sheet('BirleÅŸtirilmiÅŸ_Tespit')
                
                # DEÄÄ°ÅTÄ°RÄ°LDÄ°: 'Direk ID' yerine 'Direk No'
                tespit_basliklar = [
                    'Ä°lÃ§e', 'Hat AdÄ±', 'Direk No', 'Tespit Notu', 'Tespit Kategorisi', 
                    'Ã–ncelik', 'FotoÄŸraf Yolu', 'Enlem', 'Boylam', 'Birim', 'YapÄ±ldÄ± mÄ±?'
                ]
                
                # BAÅLIK SATIRI FORMATLAMA - MAVÄ° ARKA PLAN, KALIN BEYAZ YAZI
                for col_num, column_title in enumerate(tespit_basliklar, 1):
                    cell = ws_tespit.cell(row=1, column=col_num)
                    cell.value = column_title
                    cell.font = Font(bold=True, color="FFFFFF")  # KalÄ±n beyaz yazÄ±
                    cell.fill = PatternFill(start_color="4472C4", end_color="4472C4", fill_type="solid")  # Mavi arkaplan
                    cell.border = Border(left=Side(style='thin'), right=Side(style='thin'),
                                       top=Side(style='thin'), bottom=Side(style='thin'))
                    cell.alignment = Alignment(horizontal='center', vertical='center')
                
                # VERÄ° SATIRLARINI EKLE - TÃœM SATIRLARI SOLA HÄ°ZALI
                for row_num, tespit_data in enumerate(tespit_verileri, 2):
                    # DEÄÄ°ÅTÄ°RÄ°LDÄ°: 'Direk ID' yerine 'Direk No'
                    direk_no = tespit_data.get('Direk No', '')
                    direk_no_temiz = self.direk_no_temizle(direk_no)
                    
                    # Direk No'yu sayÄ±ya Ã§evirmeye Ã§alÄ±ÅŸ
                    try:
                        if direk_no_temiz and direk_no_temiz != '':
                            if '.' in direk_no_temiz or ',' in direk_no_temiz:
                                direk_no_temiz = float(direk_no_temiz.replace(',', '.'))
                            else:
                                direk_no_temiz = int(direk_no_temiz)
                    except (ValueError, TypeError):
                        # SayÄ±ya Ã§evrilemezse string olarak bÄ±rak
                        pass
                    
                    # FotoÄŸraf Yolu iÃ§in Ã¶zel iÅŸlem - KÃ–PRÃœ OLUÅTUR
                    foto_yolu = tespit_data.get('FotoÄŸraf Yolu', '')
                    
                    # TÃ¼m sÃ¼tunlarÄ± ekle - FotoÄŸraf Yolu iÃ§in hyperlink
                    for col_num, sutun_adi in enumerate(tespit_basliklar, 1):
                        cell = ws_tespit.cell(row=row_num, column=col_num)
                        
                        if sutun_adi == 'FotoÄŸraf Yolu' and foto_yolu:
                            # FotoÄŸraf yolunu kontrol et
                            if os.path.exists(foto_yolu):
                                # TAM YOL VAR VE GEÃ‡ERLÄ° - KÃ–PRÃœ OLUÅTUR
                                cell.value = os.path.basename(foto_yolu)  # GÃ¶rÃ¼nen metin (sadece dosya adÄ±)
                                cell.hyperlink = foto_yolu  # KÃ¶prÃ¼ linki (tam yol)
                                cell.font = Font(color="0000FF", underline="single")  # Mavi ve altÄ± Ã§izili
                            else:
                                # Yol geÃ§erli deÄŸilse sadece metin gÃ¶ster
                                cell.value = foto_yolu if foto_yolu else ""
                                cell.font = Font(color="000000")  # Siyah
                            
                            cell.alignment = Alignment(horizontal='left', vertical='center')
                        elif sutun_adi == 'Direk No':
                            cell.value = direk_no_temiz
                            cell.alignment = Alignment(horizontal='left', vertical='center')
                        else:
                            cell.value = tespit_data.get(sutun_adi, '')
                            cell.alignment = Alignment(horizontal='left', vertical='center')
                    
                    # HÃ¼cre sÄ±nÄ±rlarÄ±nÄ± ekle
                    for col_num in range(1, len(tespit_basliklar) + 1):
                        cell = ws_tespit.cell(row=row_num, column=col_num)
                        cell.border = Border(left=Side(style='thin'), right=Side(style='thin'),
                                           top=Side(style='thin'), bottom=Side(style='thin'))
                
                # SÃœTUN GENÄ°ÅLÄ°KLERÄ°NÄ° OTOMATÄ°K AYARLA
                for column in ws_tespit.columns:
                    max_length = 0
                    column_letter = get_column_letter(column[0].column)
                    
                    for cell in column:
                        try:
                            if cell.value:
                                cell_length = len(str(cell.value))
                                if cell_length > max_length:
                                    max_length = cell_length
                        except:
                            pass
                    
                    adjusted_width = min(max_length + 2, 50)
                    ws_tespit.column_dimensions[column_letter].width = adjusted_width
                
                # FÄ°LTRE EKLE
                if ws_tespit.max_row > 1:
                    filter_range = f"A1:{get_column_letter(ws_tespit.max_column)}{ws_tespit.max_row}"
                    ws_tespit.auto_filter.ref = filter_range
                    self.log_mesaj_ekle(f"âœ… Tespit sayfasÄ±na filtre eklendi: {filter_range}")
                
                self.log_mesaj_ekle(f"âœ… {len(tespit_verileri)} tespit verisi BirleÅŸtirilmiÅŸ_Tespit sayfasÄ±na eklendi (FotoÄŸraf Yolu kÃ¶prÃ¼lÃ¼)")
            
            # 11. AÅAMA: Atlanan klasÃ¶rler sayfasÄ±
            if atlanan_klasorler:
                self.log_mesaj_ekle("ğŸ“ Atlanan klasÃ¶rler sayfasÄ± oluÅŸturuluyor...")
                ws_atlanan = workbook.create_sheet('KlasÃ¶r Uyumsuz')
                
                basliklar = ['KlasÃ¶r Yolu', 'Direk No', 'Sebep']
                for col_num, column_title in enumerate(basliklar, 1):
                    cell = ws_atlanan.cell(row=1, column=col_num)
                    cell.value = column_title
                    cell.font = Font(bold=True, color="FFFFFF")
                    cell.fill = PatternFill(start_color="e74c3c", end_color="e74c3c", fill_type="solid")
                    cell.border = Border(left=Side(style='thin'), right=Side(style='thin'),
                                       top=Side(style='thin'), bottom=Side(style='thin'))
                    cell.alignment = Alignment(horizontal='center', vertical='center')
                
                for row_num, atlama_veri in enumerate(atlanan_klasorler, 2):
                    ws_atlanan.cell(row=row_num, column=1, value=atlama_veri.get('KlasÃ¶r Yolu', ''))
                    ws_atlanan.cell(row=row_num, column=2, value=atlama_veri.get('Direk No', ''))
                    ws_atlanan.cell(row=row_num, column=3, value=atlama_veri.get('Sebep', ''))
                
                self.auto_adjust_column_widths(ws_atlanan)
                ws_atlanan.auto_filter.ref = ws_atlanan.dimensions
            
            # 12. AÅAMA: DosyayÄ± kaydet
            self.log_mesaj_ekle("ğŸ’¾ Excel dosyasÄ± kaydediliyor...")
            workbook.save(self.kaydetme_yeri.get())
            
            # 13. AÅAMA: SonuÃ§larÄ± gÃ¶ster
            toplam_sure = time.time() - start_time
            self.lbl_durum.config(text="Ä°ÅŸlem tamamlandÄ± âœ“", fg=self.colors['success'])
            self.log_mesaj_ekle(f"\nğŸ‰ Ä°ÅLEM TAMAMLANDI!")
            self.log_mesaj_ekle(f"â±ï¸ Toplam sÃ¼re: {toplam_sure:.2f}s")
            self.log_mesaj_ekle(f"ğŸ“ Excel dosyasÄ±: {self.kaydetme_yeri.get()}")
            self.log_mesaj_ekle(f"âœ… {len(foto_klasorleri)} klasÃ¶r eklendi")
            self.log_mesaj_ekle(f"âŒ {len(atlanan_klasorler)} klasÃ¶r atlandÄ±")
            self.log_mesaj_ekle(f"ğŸ” {len(tespit_verileri)} tespit verisi eklendi")
            
            # Rapor ekranÄ±nÄ± aÃ§
            self.rapor_ekrani_ac(self.kaydetme_yeri.get(), hat_tarihsiz_istatistikleri)
            
        except Exception as e:
            self.lbl_durum.config(text="Excel oluÅŸturma hatasÄ±", fg=self.colors['danger'])
            self.log_mesaj_ekle(f"âŒ Excel oluÅŸturma hatasÄ±: {str(e)}")
            import traceback
            self.log_mesaj_ekle(f"ğŸ” Hata detayÄ±: {traceback.format_exc()}")





    def tespit_bilgilerini_birlestir(self, foto_klasorleri):
        """Tespit Excel dosyalarÄ±nÄ± birleÅŸtirir ve dÃ¶ndÃ¼rÃ¼r (Ä°lÃ§e bilgisi ve TAM FOTOÄRAF YOLU eklenmiÅŸ ÅŸekilde)"""
        tespit_verileri = []
        
        try:
            # Ã–NCE: FotoÄŸraf klasÃ¶rleri verisini kullanarak direk-fotoÄŸraf eÅŸleÅŸtirmesi oluÅŸtur
            direk_foto_eslestirme = {}
            
            for klasor_veri in foto_klasorleri:
                klasor_yolu = klasor_veri.get('KlasÃ¶r Yolu', '')
                direk_no = klasor_veri.get('Direk No', '')
                temiz_direk_no = self.direk_no_temizle(str(direk_no))
                aob = klasor_veri.get('Aob', '')
                hat_adi = klasor_veri.get('Hat adÄ±', '')
                
                if temiz_direk_no and klasor_yolu:
                    # Anahtar: (Ä°lÃ§e, Hat AdÄ±, Direk No)
                    anahtar = (aob, hat_adi, temiz_direk_no)
                    
                    # Bu klasÃ¶rdeki fotoÄŸraflarÄ± bul
                    foto_dosyalari = []
                    try:
                        for dosya in os.listdir(klasor_yolu):
                            if dosya.lower().endswith(('.jpg', '.jpeg', '.png', '.tiff', '.tif', '.bmp')):
                                tam_yol = os.path.join(klasor_yolu, dosya)
                                foto_dosyalari.append((dosya, tam_yol))
                    except:
                        foto_dosyalari = []
                    
                    direk_foto_eslestirme[anahtar] = foto_dosyalari
            
            self.log_mesaj_ekle(f"ğŸ“ {len(direk_foto_eslestirme)} direk iÃ§in fotoÄŸraf bilgisi hazÄ±rlandÄ±")
            
            # Ana klasÃ¶rdeki tÃ¼m Excel dosyalarÄ±nÄ± bul
            excel_dosyalari = []
            for root, dirs, files in os.walk(self.ana_klasor.get()):
                for dosya in files:
                    if dosya.lower().endswith(('.xlsx', '.xls')):
                        tam_yol = os.path.join(root, dosya)
                        excel_dosyalari.append(tam_yol)
            
            if not excel_dosyalari:
                self.log_mesaj_ekle("â„¹ï¸ Tespit Excel dosyasÄ± bulunamadÄ±")
                return tespit_verileri
            
            self.log_mesaj_ekle(f"ğŸ” {len(excel_dosyalari)} Excel dosyasÄ± taranÄ±yor...")
            
            # Hem 'Direk No' hem de 'Direk ID' iÃ§in arama yap
            istenen_sutunlar = [
                'Ä°lÃ§e', 'Hat AdÄ±', 'Tespit Notu', 'Tespit Kategorisi', 
                'Ã–ncelik', 'FotoÄŸraf Yolu', 'Enlem', 'Boylam', 'Birim', 'YapÄ±ldÄ± mÄ±?'
            ]
            
            # DEÄÄ°ÅKENLER: Direk No ve Direk ID - "SÄ±ra No" hariÃ§
            direk_no_degiskenleri = ['Direk No', 'Direk No.', 'Direk_No', 'DirekNo', 'Direk no', 'direk no']
            direk_id_degiskenleri = ['Direk ID', 'Direk Id', 'Direk_ID', 'DirekID', 'Direk', 'No']
            
            for dosya in excel_dosyalari:
                try:
                    # Ä°lÃ§eyi klasÃ¶r yolundan bul
                    dosya_klasoru = os.path.dirname(dosya)
                    ilce_adi = self.aob_adi_bul(dosya_klasoru)
                    
                    self.log_mesaj_ekle(f"ğŸ” {os.path.basename(dosya)} - KlasÃ¶r: {dosya_klasoru}")
                    self.log_mesaj_ekle(f"   ğŸ™ï¸ Ä°lÃ§e: {ilce_adi}")
                    
                    df = pd.read_excel(dosya, header=None)
                    
                    # GerÃ§ek baÅŸlÄ±k satÄ±rÄ±nÄ± bul
                    baslik_satiri_idx = None
                    for idx in range(min(10, len(df))):
                        satir = df.iloc[idx]
                        satir_metin = ' '.join(str(x).strip() for x in satir.values if pd.notna(x) and str(x).strip())
                        
                        # "Ä°lÃ§e", "Hat AdÄ±" ve "YapÄ±ldÄ± mÄ±?" hariÃ§ diÄŸer sÃ¼tunlarÄ± kontrol et
                        kontrol_sutunlari = [s for s in istenen_sutunlar if s not in ['Ä°lÃ§e', 'Hat AdÄ±', 'YapÄ±ldÄ± mÄ±?']]
                        
                        # 'Direk No' veya 'Direk ID' kontrolÃ¼ - SADECE bu deÄŸiÅŸkenlerle
                        direk_kontrol = False
                        for direk_degisken in direk_no_degiskenleri + direk_id_degiskenleri:
                            if any(direk_degisken.lower() in str(x).lower() for x in satir.values if pd.notna(x)):
                                direk_kontrol = True
                                break
                        
                        # DiÄŸer sÃ¼tunlarÄ±n kontrolÃ¼
                        diger_kontrol = all(any(sutun_adi.lower() in str(x).lower() for x in satir.values if pd.notna(x)) 
                                           for sutun_adi in kontrol_sutunlari if sutun_adi not in ['Direk No', 'Direk ID'])
                        
                        if direk_kontrol and diger_kontrol:
                            baslik_satiri_idx = idx
                            self.log_mesaj_ekle(f"   âœ“ BaÅŸlÄ±k satÄ±rÄ± {idx+1}. satÄ±rda bulundu")
                            break
                    
                    if baslik_satiri_idx is not None:
                        df = pd.read_excel(dosya, header=baslik_satiri_idx)
                    else:
                        df = pd.read_excel(dosya, header=0)
                        self.log_mesaj_ekle(f"â„¹ï¸ {os.path.basename(dosya)} - Ä°lk satÄ±r baÅŸlÄ±k olarak kullanÄ±ldÄ±")
                    
                    # SÃ¼tun eÅŸleÅŸtirme - Ã–NCE 'Direk No', SONRA 'Direk ID' ara
                    mevcut_sutunlar = df.columns.tolist()
                    sutun_eslesmeleri = {}
                    
                    # 'Direk No' veya 'Direk ID' sÃ¼tununu bul - "SÄ±ra No" HARÄ°Ã‡
                    direk_sutunu = None
                    for mevcut_sutun in mevcut_sutunlar:
                        mevcut_sutun_clean = str(mevcut_sutun).strip().lower()
                        
                        # Ã–NCE 'Direk No' arasÄ±n - "SÄ±ra No" kontrolÃ¼ YOK
                        for direk_no_degisken in direk_no_degiskenleri:
                            if direk_no_degisken.lower() == mevcut_sutun_clean:
                                direk_sutunu = mevcut_sutun
                                sutun_eslesmeleri[mevcut_sutun] = 'Direk No'
                                self.log_mesaj_ekle(f"   âœ“ 'Direk No' sÃ¼tunu bulundu: {mevcut_sutun}")
                                break
                        
                        if direk_sutunu:
                            break
                    
                    # EÄŸer 'Direk No' bulunamadÄ±ysa, 'Direk ID' arasÄ±n - "SÄ±ra No" HARÄ°Ã‡
                    if not direk_sutunu:
                        for mevcut_sutun in mevcut_sutunlar:
                            mevcut_sutun_clean = str(mevcut_sutun).strip().lower()
                            
                            for direk_id_degisken in direk_id_degiskenleri:
                                # SADECE tam eÅŸleÅŸme veya kÄ±smi eÅŸleÅŸme, "SÄ±ra No" DEÄÄ°L
                                if direk_id_degisken.lower() == mevcut_sutun_clean or \
                                   (direk_id_degisken.lower() in mevcut_sutun_clean and 'sÄ±ra' not in mevcut_sutun_clean):
                                    direk_sutunu = mevcut_sutun
                                    sutun_eslesmeleri[mevcut_sutun] = 'Direk ID'
                                    self.log_mesaj_ekle(f"   âœ“ 'Direk ID' sÃ¼tunu bulundu: {mevcut_sutun}")
                                    break
                            
                            if direk_sutunu:
                                break
                    
                    # DiÄŸer sÃ¼tunlarÄ± bul
                    for istenen_sutun in istenen_sutunlar:
                        if istenen_sutun in ['Ä°lÃ§e', 'Hat AdÄ±', 'Direk No', 'Direk ID']:
                            continue
                            
                        eslesen_sutun = None
                        for mevcut_sutun in mevcut_sutunlar:
                            mevcut_sutun_clean = str(mevcut_sutun).strip().lower()
                            istenen_sutun_clean = str(istenen_sutun).strip().lower()
                            
                            if (mevcut_sutun_clean == istenen_sutun_clean or 
                                istenen_sutun_clean in mevcut_sutun_clean):
                                eslesen_sutun = mevcut_sutun
                                sutun_eslesmeleri[mevcut_sutun] = istenen_sutun
                                break
                        
                        if eslesen_sutun:
                            self.log_mesaj_ekle(f"   âœ“ '{istenen_sutun}' sÃ¼tunu bulundu: {eslesen_sutun}")
                    
                    # Verileri iÅŸle
                    dosya_klasor_baslik = os.path.basename(os.path.dirname(dosya))
                    dosya_veri_sayisi = 0
                    
                    for index, row in df.iterrows():
                        try:
                            tespit_data = {
                                'Ä°lÃ§e': ilce_adi,
                                'Hat AdÄ±': dosya_klasor_baslik
                            }
                            
                            # Direk No/ID bilgisini al
                            direk_degeri = ""
                            if direk_sutunu and direk_sutunu in row:
                                direk_degeri = str(row[direk_sutunu]) if pd.notna(row[direk_sutunu]) else ""
                                if direk_degeri:
                                    temiz_direk_no = self.direk_no_temizle(direk_degeri)
                                    tespit_data['Direk No'] = temiz_direk_no
                                    
                                    # DEBUG: Direk No deÄŸerini logla
                                    if dosya_veri_sayisi < 3:  # Ä°lk 3 kayÄ±t iÃ§in
                                        self.log_mesaj_ekle(f"   ğŸ” Ã–rnek Direk No: '{direk_degeri}' -> '{temiz_direk_no}'")
                                else:
                                    tespit_data['Direk No'] = ""
                            else:
                                tespit_data['Direk No'] = ""
                            
                            # DiÄŸer sÃ¼tunlarÄ± al
                            for istenen_sutun in istenen_sutunlar:
                                if istenen_sutun in ['Ä°lÃ§e', 'Hat AdÄ±', 'Direk No', 'Direk ID', 'FotoÄŸraf Yolu']:
                                    continue
                                    
                                eslesen_mevcut_sutun = None
                                for mevcut_sutun, standart_sutun in sutun_eslesmeleri.items():
                                    if standart_sutun == istenen_sutun:
                                        eslesen_mevcut_sutun = mevcut_sutun
                                        break
                                
                                if eslesen_mevcut_sutun and eslesen_mevcut_sutun in row:
                                    deger = row[eslesen_mevcut_sutun]
                                    tespit_data[istenen_sutun] = deger if pd.notna(deger) else ""
                                else:
                                    tespit_data[istenen_sutun] = ""
                            
                            # "FotoÄŸraf Yolu" iÃ§in Ã¶zel iÅŸlem - TAM YOLU BUL
                            foto_yolu_degeri = ""
                            if 'FotoÄŸraf Yolu' in sutun_eslesmeleri.values():
                                # EÅŸleÅŸen sÃ¼tunu bul
                                foto_sutunu = None
                                for mevcut_sutun, standart_sutun in sutun_eslesmeleri.items():
                                    if standart_sutun == 'FotoÄŸraf Yolu':
                                        foto_sutunu = mevcut_sutun
                                        break
                                
                                if foto_sutunu and foto_sutunu in row:
                                    foto_yolu_degeri = str(row[foto_sutunu]) if pd.notna(row[foto_sutunu]) else ""
                            
                            # ÅÄ°MDÄ° FOTOÄRAFIN TAM YOLUNU BUL
                            tam_foto_yolu = ""
                            
                            if tespit_data['Direk No'] and ilce_adi and dosya_klasor_baslik:
                                # Anahtar: (Ä°lÃ§e, Hat AdÄ±, Direk No)
                                anahtar = (ilce_adi, dosya_klasor_baslik, tespit_data['Direk No'])
                                
                                if anahtar in direk_foto_eslestirme:
                                    foto_listesi = direk_foto_eslestirme[anahtar]
                                    
                                    if foto_yolu_degeri:
                                        # Tespit dosyasÄ±nda belirtilen fotoÄŸraf adÄ±nÄ± ara
                                        for foto_adi, foto_tam_yol in foto_listesi:
                                            if foto_adi == foto_yolu_degeri or foto_yolu_degeri in foto_adi:
                                                tam_foto_yolu = foto_tam_yol
                                                break
                                    
                                    # EÄŸer tam yol bulunamadÄ±ysa, ilk fotoÄŸrafÄ± kullan
                                    if not tam_foto_yolu and foto_listesi:
                                        tam_foto_yolu = foto_listesi[0][1]  # Ä°lk fotoÄŸrafÄ±n tam yolu
                            
                            # FotoÄŸraf yolunu kaydet (tam yol veya orijinal deÄŸer)
                            tespit_data['FotoÄŸraf Yolu'] = tam_foto_yolu if tam_foto_yolu else foto_yolu_degeri
                            
                            # "YapÄ±ldÄ± mÄ±?" sÃ¼tunu iÃ§in Ã¶zel kontrol
                            if 'YapÄ±ldÄ± mÄ±?' not in tespit_data:
                                tespit_data['YapÄ±ldÄ± mÄ±?'] = ""
                            
                            # Birim filtresi
                            if tespit_data.get('Birim', ''):
                                birim_str = str(tespit_data['Birim']).strip().lower()
                                if birim_str in ['aob', ''] or pd.isna(tespit_data['Birim']):
                                    tespit_verileri.append(tespit_data)
                                    dosya_veri_sayisi += 1
                        
                        except Exception as e:
                            continue
                    
                    self.log_mesaj_ekle(f"âœ… {os.path.basename(dosya)} - {dosya_veri_sayisi} tespit verisi eklendi (Ä°lÃ§e: {ilce_adi})")
                    
                except Exception as e:
                    self.log_mesaj_ekle(f"âš ï¸ {os.path.basename(dosya)} - Hata: {str(e)}")
            
            # Ä°lÃ§e bazÄ±nda istatistik
            ilce_bazli_sayilar = {}
            for veri in tespit_verileri:
                ilce = veri.get('Ä°lÃ§e', 'Bilinmeyen')
                if ilce not in ilce_bazli_sayilar:
                    ilce_bazli_sayilar[ilce] = 0
                ilce_bazli_sayilar[ilce] += 1
            
            self.log_mesaj_ekle(f"ğŸ“Š Toplam {len(tespit_verileri)} tespit verisi birleÅŸtirildi")
            for ilce, sayi in ilce_bazli_sayilar.items():
                self.log_mesaj_ekle(f"   ğŸ“ {ilce}: {sayi} tespit")
            
            # DEBUG: Ä°lk 5 tespit verisini gÃ¶ster
            if tespit_verileri:
                self.log_mesaj_ekle("ğŸ” Ä°lk 5 tespit verisi Ã¶rneÄŸi:")
                for i, tespit in enumerate(tespit_verileri[:5]):
                    self.log_mesaj_ekle(f"   {i+1}. Ä°lÃ§e: {tespit.get('Ä°lÃ§e', '')}, "
                                       f"Direk No: {tespit.get('Direk No', '')}, "
                                       f"FotoÄŸraf Yolu: {os.path.basename(tespit.get('FotoÄŸraf Yolu', '')) if tespit.get('FotoÄŸraf Yolu') else 'Yok'}")
            
        except Exception as e:
            self.log_mesaj_ekle(f"âŒ Tespit birleÅŸtirme hatasÄ±: {str(e)}")
        
        return tespit_verileri


            

    def mesafe_hesapla(self, foto_klasorleri, koordinat_bilgileri):
        """Her direk iÃ§in bir Ã¶nceki direkle arasÄ±ndaki mesafeyi METRE cinsinden hesaplar ve toplam hat uzunluklarÄ±nÄ± hesaplar"""
        mesafe_sonuclari = {}
        hat_uzunluklari = {}  # YENÄ°: Hat bazÄ±nda toplam uzunluklar
        
        try:
            mesafe_sonuclari.clear()
            hat_uzunluklari.clear()  # YENÄ°: Hat uzunluklarÄ±nÄ± temizle
            self.log_mesaj_ekle("ğŸ”„ Mesafe hesaplamalarÄ± yapÄ±lÄ±yor (TRAFO DÄ°REÄÄ° Ã¶zel durumu ve 750m limiti ile)...")
            
            # Trafo direklerini al
            bilgiler = self.direk_tipi_bilgilerini_al(foto_klasorleri)
            trafo_direkleri = bilgiler.get('trafo_direkleri', {})
            
            hat_gruplari = {}
            
            for klasor in foto_klasorleri:
                hat_anahtari = (klasor['Aob'], klasor['Hat adÄ±'])
                if hat_anahtari not in hat_gruplari:
                    hat_gruplari[hat_anahtari] = []
                    hat_uzunluklari[hat_anahtari] = 0.0  # YENÄ°: Her hat iÃ§in uzunluk sÄ±fÄ±rla
                hat_gruplari[hat_anahtari].append(klasor)
            
            for hat_anahtari, klasor_listesi in hat_gruplari.items():
                aob, hat_adi = hat_anahtari
                sirali_klasorler = sorted(klasor_listesi, 
                                        key=lambda x: self.sira_no_ile_sirala(x['Orijinal KlasÃ¶r AdÄ±']))
                
                onceki_lat = None
                onceki_lon = None
                onceki_direk_no = None
                onceki_sira_no = None
                
                # Geriye doÄŸru arama iÃ§in tÃ¼m direkleri kaydedelim
                hat_direkleri = []
                
                for i, klasor in enumerate(sirali_klasorler):
                    klasor_adi = str(klasor.get('Direk No', ''))
                    temiz_direk_no = self.direk_no_temizle(klasor_adi)
                    sira_no = self.sira_no_ayikla(klasor.get('Orijinal KlasÃ¶r AdÄ±', ''))
                    
                    # ÃœÃ‡LÃœ ANAHTAR: (Aob, Hat-AdÄ±, SÄ±raNo, DirekNo)
                    uc_anahtar = (aob, hat_adi, sira_no, temiz_direk_no)
                    
                    # Hat direklerini kaydet (geriye doÄŸru arama iÃ§in)
                    hat_direkleri.append({
                        'index': i,
                        'anahtar': uc_anahtar,
                        'direk_no': temiz_direk_no,
                        'sira_no': sira_no,
                        'lat': koordinat_bilgileri.get(temiz_direk_no, {}).get('lat'),
                        'lon': koordinat_bilgileri.get(temiz_direk_no, {}).get('lon'),
                        'trafo_mu': temiz_direk_no in trafo_direkleri
                    })
                
                for i, klasor in enumerate(sirali_klasorler):
                    klasor_adi = str(klasor.get('Direk No', ''))
                    temiz_direk_no = self.direk_no_temizle(klasor_adi)
                    sira_no = self.sira_no_ayikla(klasor.get('Orijinal KlasÃ¶r AdÄ±', ''))
                    
                    # ÃœÃ‡LÃœ ANAHTAR: (Aob, Hat-AdÄ±, SÄ±raNo, DirekNo)
                    uc_anahtar = (aob, hat_adi, sira_no, temiz_direk_no)
                    
                    # Bu direk trafo mu?
                    simdiki_trafo_mu = temiz_direk_no in trafo_direkleri
                    
                    koordinat_info = koordinat_bilgileri.get(temiz_direk_no, {})
                    simdiki_lat = koordinat_info.get('lat')
                    simdiki_lon = koordinat_info.get('lon')
                    
                    if i == 0:
                        # Ä°lk direk iÃ§in mesafe yok
                        mesafe_deger = ""
                        self.log_mesaj_ekle(f"ğŸ“ {aob}-{hat_adi}-{sira_no}-{temiz_direk_no}: Ä°lk direk (mesafe yok)")
                    
                    elif simdiki_trafo_mu:
                        # BU DÄ°REK TRAFO Ä°SE: Ã–nceki direkle arasÄ±ndaki mesafeyi TRAFO satÄ±rÄ±na yaz
                        if (onceki_lat is not None and onceki_lon is not None and 
                            simdiki_lat is not None and simdiki_lon is not None):
                            try:
                                mesafe_metre = self.koordinat_mesafe_hesapla(onceki_lat, onceki_lon, simdiki_lat, simdiki_lon)
                                # 750m KONTROLÃœ
                                if mesafe_metre > 750:
                                    mesafe_deger = ""
                                    self.log_mesaj_ekle(f"ğŸ­ {aob}-{hat_adi}-{sira_no}-{temiz_direk_no}: TRAFO DÄ°REÄÄ° - {mesafe_metre:.2f} m (750m Ã¼zeri - boÅŸ)")
                                else:
                                    mesafe_deger = float(mesafe_metre)
                                    # YENÄ°: Trafo direÄŸi mesafesini hat uzunluÄŸuna ekle
                                    if mesafe_deger > 0:
                                        hat_uzunluklari[hat_anahtari] += mesafe_deger
                                    self.log_mesaj_ekle(f"ğŸ­ {aob}-{hat_adi}-{sira_no}-{temiz_direk_no}: TRAFO DÄ°REÄÄ° - {mesafe_deger:.2f} m (Ã¶nceki direkten)")
                            except Exception as e:
                                mesafe_deger = "HesaplanamadÄ±"
                                self.log_mesaj_ekle(f"âš ï¸ Trafo mesafe hesaplama hatasÄ± {uc_anahtar}: {str(e)}")
                        else:
                            mesafe_deger = "Koordinat yok"
                            self.log_mesaj_ekle(f"âš ï¸ {uc_anahtar} (TRAFO): Koordinat eksik")
                    
                    elif onceki_direk_no and onceki_direk_no in trafo_direkleri:
                        # Ã–NCEKÄ° DÄ°REK TRAFO Ä°SE: Yeni kriterlere gÃ¶re iÅŸlem yap
                        if (onceki_lat is not None and onceki_lon is not None and 
                            simdiki_lat is not None and simdiki_lon is not None):
                            try:
                                # A- Ã–nceki trafo ile mevcut direk arasÄ±ndaki mesafeyi hesapla
                                mesafe_trafo_ile = self.koordinat_mesafe_hesapla(onceki_lat, onceki_lon, simdiki_lat, simdiki_lon)
                                
                                if mesafe_trafo_ile <= 100:
                                    # A-1: Mesafe 100m altÄ±nda ise, trafo ile arasÄ±ndaki mesafeyi yaz
                                    # 750m KONTROLÃœ
                                    if mesafe_trafo_ile > 750:
                                        mesafe_deger = ""
                                        self.log_mesaj_ekle(f"ğŸ“ {aob}-{hat_adi}-{sira_no}-{temiz_direk_no}: Trafo ile {mesafe_trafo_ile:.2f} m (100m altÄ± ama 750m Ã¼zeri - boÅŸ)")
                                    else:
                                        mesafe_deger = float(mesafe_trafo_ile)
                                        # YENÄ°: Mesafeyi hat uzunluÄŸuna ekle
                                        if mesafe_deger > 0:
                                            hat_uzunluklari[hat_anahtari] += mesafe_deger
                                        self.log_mesaj_ekle(f"ğŸ“ {aob}-{hat_adi}-{sira_no}-{temiz_direk_no}: Trafo ile {mesafe_deger:.2f} m (100m altÄ±)")
                                else:
                                    # B- Mesafe 100m Ã¼zeri ise, geriye doÄŸru en yakÄ±n direÄŸi bul
                                    en_yakin_direk = None
                                    en_yakin_mesafe = float('inf')
                                    
                                    # Geriye doÄŸru ara (i-2, i-3, ...)
                                    for j in range(i-2, -1, -1):
                                        geri_direk = hat_direkleri[j]
                                        geri_lat = geri_direk['lat']
                                        geri_lon = geri_direk['lon']
                                        geri_trafo_mu = geri_direk['trafo_mu']
                                        
                                        # Trafo olmayan direk ara
                                        if not geri_trafo_mu and geri_lat is not None and geri_lon is not None:
                                            # Gerideki direk ile mevcut direk arasÄ±ndaki mesafeyi hesapla
                                            mesafe_geri = self.koordinat_mesafe_hesapla(geri_lat, geri_lon, simdiki_lat, simdiki_lon)
                                            
                                            if mesafe_geri < en_yakin_mesafe:
                                                en_yakin_mesafe = mesafe_geri
                                                en_yakin_direk = geri_direk
                                    
                                    if en_yakin_direk is not None:
                                        # En yakÄ±n direk bulundu, o direk ile mesafeyi yaz
                                        # 750m KONTROLÃœ
                                        if en_yakin_mesafe > 750:
                                            mesafe_deger = ""
                                            self.log_mesaj_ekle(f"ğŸ” {aob}-{hat_adi}-{sira_no}-{temiz_direk_no}: {en_yakin_direk['direk_no']} ile {en_yakin_mesafe:.2f} m (100m Ã¼zeri, 750m Ã¼zeri - boÅŸ)")
                                        else:
                                            mesafe_deger = float(en_yakin_mesafe)
                                            # YENÄ°: Mesafeyi hat uzunluÄŸuna ekle
                                            if mesafe_deger > 0:
                                                hat_uzunluklari[hat_anahtari] += mesafe_deger
                                            self.log_mesaj_ekle(f"ğŸ” {aob}-{hat_adi}-{sira_no}-{temiz_direk_no}: {en_yakin_direk['direk_no']} ile {mesafe_deger:.2f} m (100m Ã¼zeri, geriye arama)")
                                    else:
                                        # Geriye doÄŸtrafo olmayan direk bulunamadÄ±
                                        mesafe_deger = ""
                                        self.log_mesaj_ekle(f"â­ï¸ {aob}-{hat_adi}-{sira_no}-{temiz_direk_no}: Trafo ile 100m Ã¼zeri ({mesafe_trafo_ile:.2f}m) ve geriye doÄŸru direk bulunamadÄ±")
                            
                            except Exception as e:
                                mesafe_deger = "HesaplanamadÄ±"
                                self.log_mesaj_ekle(f"âš ï¸ Mesafe hesaplama hatasÄ± {uc_anahtar}: {str(e)}")
                        else:
                            mesafe_deger = "Koordinat yok"
                            self.log_mesaj_ekle(f"âš ï¸ {uc_anahtar}: Koordinat eksik")
                    
                    elif (onceki_lat is not None and onceki_lon is not None and 
                          simdiki_lat is not None and simdiki_lon is not None):
                        # NORMAL DURUM: Ã–nceki direkle arasÄ±ndaki mesafeyi hesapla
                        try:
                            mesafe_metre = self.koordinat_mesafe_hesapla(onceki_lat, onceki_lon, simdiki_lat, simdiki_lon)
                            # 750m KONTROLÃœ
                            if mesafe_metre > 750:
                                mesafe_deger = ""
                                self.log_mesaj_ekle(f"ğŸ“ {aob}-{hat_adi}-{sira_no}-{temiz_direk_no}: {mesafe_metre:.2f} m (750m Ã¼zeri - boÅŸ)")
                            else:
                                mesafe_deger = float(mesafe_metre)
                                # YENÄ°: Mesafeyi hat uzunluÄŸuna ekle
                                if mesafe_deger > 0:
                                    hat_uzunluklari[hat_anahtari] += mesafe_deger
                                self.log_mesaj_ekle(f"ğŸ“ {aob}-{hat_adi}-{sira_no}-{temiz_direk_no}: {mesafe_deger:.2f} m")
                        except Exception as e:
                            mesafe_deger = "HesaplanamadÄ±"
                            self.log_mesaj_ekle(f"âš ï¸ Mesafe hesaplama hatasÄ± {uc_anahtar}: {str(e)}")
                    else:
                        mesafe_deger = "Koordinat yok"
                        self.log_mesaj_ekle(f"âš ï¸ {uc_anahtar}: Koordinat eksik")
                    
                    # ÃœÃ‡LÃœ ANAHTAR ile kaydet
                    mesafe_sonuclari[uc_anahtar] = mesafe_deger
                    
                    # Bir sonraki iterasyon iÃ§in deÄŸerleri gÃ¼ncelle
                    onceki_lat = simdiki_lat
                    onceki_lon = simdiki_lon
                    onceki_direk_no = temiz_direk_no
                    onceki_sira_no = sira_no
                
                # YENÄ°: Hat uzunluÄŸunu km'ye Ã§evir ve logla
                hat_uzunluk_km = hat_uzunluklari[hat_anahtari] / 1000.0
                self.log_mesaj_ekle(f"ğŸ“ {hat_anahtari} toplam uzunluk: {hat_uzunluk_km:.3f} km")
                self.log_mesaj_ekle(f"âœ… {hat_anahtari} iÃ§in {len([v for v in mesafe_sonuclari.values() if v and v != 'Koordinat yok' and v != 'HesaplanamadÄ±'])} mesafe hesaplandÄ±")
                
            # Ä°statistikler
            toplam_trafo = len(trafo_direkleri)
            trafo_mesafe_sayisi = sum(1 for k, v in mesafe_sonuclari.items() 
                                    if v and v != "Koordinat yok" and v != "HesaplanamadÄ±" and 
                                    k[3] in trafo_direkleri)
            
            # YENÄ°: Toplam hat uzunluklarÄ± istatistiÄŸi
            toplam_hat_uzunluk_km = sum(hat_uzunluklari.values()) / 1000.0
            self.log_mesaj_ekle(f"ğŸ“Š Toplam {len(hat_uzunluklari)} hat iÃ§in uzunluk hesaplandÄ±")
            self.log_mesaj_ekle(f"ğŸ“ Toplam hat uzunluÄŸu: {toplam_hat_uzunluk_km:.2f} km")
            
            # YENÄ°: Hat uzunluklarÄ±nÄ± dÃ¶ndÃ¼r
            sonuc = {
                'mesafe_sonuclari': mesafe_sonuclari,
                'hat_uzunluklari': hat_uzunluklari  # YENÄ°: Hat uzunluklarÄ±nÄ± da dÃ¶ndÃ¼r
            }
            
            return sonuc
            
        except Exception as e:
            self.log_mesaj_ekle(f"âŒ Mesafe hesaplama hatasÄ±: {str(e)}")
        
        return {'mesafe_sonuclari': {}, 'hat_uzunluklari': {}}
    



    def koordinat_mesafe_hesapla(self, lat1, lon1, lat2, lon2):
        """DOÄRU HAVERSINE FORMÃœLÃœ - Metre cinsinden"""
        try:
            # KoordinatlarÄ± float'a Ã§evir
            lat1 = float(lat1)
            lon1 = float(lon1)
            lat2 = float(lat2)
            lon2 = float(lon2)
            
            # DÃ¼nya yarÄ±Ã§apÄ± (metre cinsinden)
            R = 6371000  # 6371 km * 1000 = 6371000 metre
            
            # Dereceleri radyana Ã§evir
            lat1_rad = math.radians(lat1)
            lon1_rad = math.radians(lon1)
            lat2_rad = math.radians(lat2)
            lon2_rad = math.radians(lon2)
            
            # Koordinat farklarÄ±
            dlat = lat2_rad - lat1_rad
            dlon = lon2_rad - lon1_rad
            
            # Haversine formÃ¼lÃ¼
            a = math.sin(dlat/2)**2 + math.cos(lat1_rad) * math.cos(lat2_rad) * math.sin(dlon/2)**2
            c = 2 * math.atan2(math.sqrt(a), math.sqrt(1-a))
            
            # Mesafe (metre cinsinden)
            distance = R * c
            
            return distance  # metre cinsinden dÃ¶ndÃ¼r
            
        except Exception as e:
            self.log_mesaj_ekle(f"âŒ Mesafe hesaplama hatasÄ±: {str(e)}")
            return 0.0

    


    def sira_no_ayikla(self, orijinal_klasor_adi):
        """Orijinal KlasÃ¶r AdÄ±'ndan sÄ±ra numarasÄ±nÄ± ayÄ±klar"""
        if not orijinal_klasor_adi:
            return ""
        
        try:
            # String'e Ã§evir
            klasor_adi = str(orijinal_klasor_adi).strip()
            
            # " - " veya "-" iÅŸaretlerini kontrol et
            if " - " in klasor_adi:
                parts = klasor_adi.split(" - ", 1)
            elif "-" in klasor_adi:
                parts = klasor_adi.split("-", 1)
            else:
                return ""  # AyÄ±rÄ±cÄ± yoksa boÅŸ dÃ¶ndÃ¼r
            
            if len(parts) >= 1:
                # Ä°lk kÄ±smÄ± al ve sadece rakamlarÄ± Ã§Ä±kar
                ilk_kisim = parts[0].strip()
                rakamlar = []
                
                for char in ilk_kisim:
                    if char.isdigit():
                        rakamlar.append(char)
                    elif rakamlar:  # Rakam baÅŸladÄ±ktan sonra rakam dÄ±ÅŸÄ± karakter gelirse dur
                        break
                
                if rakamlar:
                    return ''.join(rakamlar)
            
            return ""
            
        except Exception as e:
            print(f"SÄ±ra no ayÄ±klama hatasÄ±: {e}")
            return ""

    
    def koordinat_bilgilerini_al(self, veri):
        """Direk numaralarÄ±na gÃ¶re koordinat bilgilerini alÄ±r"""
        koordinat_bilgileri = {}
        
        try:
            # 1. Ana veriden direk numaralarÄ±nÄ± hazÄ±rla
            ana_direk_set = set()
            for row_data in veri:
                direk_no = str(row_data.get('Direk No', ''))
                temiz_no = self.direk_no_temizle(direk_no)
                if temiz_no and temiz_no != 'nan':
                    ana_direk_set.add(temiz_no)

            self.txt_sonuc.insert(tk.END, f"ğŸ“ {len(ana_direk_set)} direk iÃ§in koordinat bilgisi aranÄ±yor\n")
            
            if not ana_direk_set:
                return {}

            # 2. MÃ¼ÅŸterek direk Excel'inden koordinatlarÄ± al
            if self.direk_musterek_yolu and os.path.exists(self.direk_musterek_yolu):
                try:
                    df_musterek = pd.read_excel(self.direk_musterek_yolu)
                    
                    # SÃ¼tun isimlerini bul
                    direkno_col = None
                    lat_col = None
                    lon_col = None
                    
                    for col in df_musterek.columns:
                        col_upper = col.upper()
                        if 'DIREK' in col_upper and ('NO' in col_upper or 'NUMARA' in col_upper):
                            direkno_col = col
                        elif 'LAT' in col_upper or 'ENLEM' in col_upper:
                            lat_col = col
                        elif 'LON' in col_upper or 'BOYLAM' in col_upper:
                            lon_col = col
                    
                    if direkno_col and lat_col and lon_col:
                        for index, row in df_musterek.iterrows():
                            direk_no = str(row[direkno_col])
                            temiz_no = self.direk_no_temizle(direk_no)
                            
                            if temiz_no and temiz_no in ana_direk_set:
                                lat = row[lat_col]
                                lon = row[lon_col]
                                
                                # Koordinat deÄŸerlerini kontrol et
                                if pd.notna(lat) and pd.notna(lon):
                                    koordinat_bilgileri[temiz_no] = {
                                        'lat': lat,
                                        'lon': lon
                                    }
                        
                        self.txt_sonuc.insert(tk.END, f"âœ“ MÃ¼ÅŸterek Excel'inden {len(koordinat_bilgileri)} koordinat bulundu\n")
                        
                except Exception as e:
                    self.txt_sonuc.insert(tk.END, f"âš ï¸ MÃ¼ÅŸterek Excel koordinat okuma hatasÄ±: {str(e)}\n")

            # 3. OG direk Excel'inden koordinatlarÄ± al (mÃ¼ÅŸterekte bulunmayanlar iÃ§in)
            if self.direk_og_yolu and os.path.exists(self.direk_og_yolu):
                try:
                    df_og = pd.read_excel(self.direk_og_yolu)
                    
                    # SÃ¼tun isimlerini bul
                    direkno_col = None
                    lat_col = None
                    lon_col = None
                    
                    for col in df_og.columns:
                        col_upper = col.upper()
                        if 'DIREK' in col_upper and ('NO' in col_upper or 'NUMARA' in col_upper):
                            direkno_col = col
                        elif 'LAT' in col_upper or 'ENLEM' in col_upper:
                            lat_col = col
                        elif 'LON' in col_upper or 'BOYLAM' in col_upper:
                            lon_col = col
                    
                    if direkno_col and lat_col and lon_col:
                        og_koordinat_sayisi = 0
                        for index, row in df_og.iterrows():
                            direk_no = str(row[direkno_col])
                            temiz_no = self.direk_no_temizle(direk_no)
                            
                            # Sadece mÃ¼ÅŸterekte bulunmayan direkler iÃ§in
                            if temiz_no and temiz_no in ana_direk_set and temiz_no not in koordinat_bilgileri:
                                lat = row[lat_col]
                                lon = row[lon_col]
                                
                                # Koordinat deÄŸerlerini kontrol et
                                if pd.notna(lat) and pd.notna(lon):
                                    koordinat_bilgileri[temiz_no] = {
                                        'lat': lat,
                                        'lon': lon
                                    }
                                    og_koordinat_sayisi += 1
                        
                        if og_koordinat_sayisi > 0:
                            self.txt_sonuc.insert(tk.END, f"âœ“ OG Excel'inden {og_koordinat_sayisi} koordinat bulundu\n")
                        
                except Exception as e:
                    self.txt_sonuc.insert(tk.END, f"âš ï¸ OG Excel koordinat okuma hatasÄ±: {str(e)}\n")

            # Ä°statistikler
            toplam_koordinat = len(koordinat_bilgileri)
            koordinatsiz = len(ana_direk_set) - toplam_koordinat
            
            self.txt_sonuc.insert(tk.END, f"ğŸ“ Toplam {toplam_koordinat} direk iÃ§in koordinat bulundu\n")
            if koordinatsiz > 0:
                self.txt_sonuc.insert(tk.END, f"ğŸ“ {koordinatsiz} direk iÃ§in koordinat bulunamadÄ±\n")
                
        except Exception as e:
            self.txt_sonuc.insert(tk.END, f"âš ï¸ Koordinat bilgisi alma hatasÄ±: {str(e)}\n")
        
        return koordinat_bilgileri



    def rapor_ekrani_ac(self, excel_dosyasi, hat_tarihsiz_istatistikleri=None):
        try:
            # Mevcut rapor ekranÄ±nÄ± kapat
            if hasattr(self, 'rapor_ekrani'):
                try:
                    self.rapor_ekrani.destroy()
                    time.sleep(0.5)  # KapanmasÄ± iÃ§in bekle
                except:
                    pass
            
            # Yeni rapor ekranÄ± oluÅŸtur - main thread'de
            def create_report():
                try:
                    self.rapor_ekrani = RaporEkrani(self.root, excel_dosyasi, hat_tarihsiz_istatistikleri)
                except Exception as e:
                    messagebox.showerror("Hata", f"Rapor ekranÄ± oluÅŸturulamadÄ±: {str(e)}")
            
            # 1 saniye bekle ve oluÅŸtur
            self.root.after(1000, create_report)
            
        except Exception as e:
            messagebox.showwarning("UyarÄ±", f"Rapor ekranÄ± aÃ§Ä±lamadÄ±: {str(e)}")
    
    def rapor_goster(self):
        if not self.kaydetme_yeri.get() or not os.path.exists(self.kaydetme_yeri.get()):
            messagebox.showerror("Hata", "Ã–nce bir Excel dosyasÄ± oluÅŸturun!")
            return
        
        # Excel dosyasÄ±ndan hat istatistiklerini oku
        try:
            df_hat_ozet = pd.read_excel(self.kaydetme_yeri.get(), sheet_name='Hat Ã–zeti')
            hat_tarihsiz_istatistikleri = {}
            
            for index, row in df_hat_ozet.iterrows():
                hat_anahtari = (row['Ä°lÃ§e'], row['Hat AdÄ±'])
                # Excel'de tarihsiz yÃ¼zde sÃ¼tunu yoksa 0 olarak kabul et
                hat_tarihsiz_istatistikleri[hat_anahtari] = 0
                
        except:
            hat_tarihsiz_istatistikleri = {}
        
        self.rapor_ekrani_ac(self.kaydetme_yeri.get(), hat_tarihsiz_istatistikleri)
    
    def auto_adjust_column_widths(self, worksheet):
        for column in worksheet.columns:
            max_length = 0
            column_letter = get_column_letter(column[0].column)
            
            for cell in column:
                try:
                    if cell.value:
                        cell_length = len(str(cell.value))
                        if cell_length > max_length:
                            max_length = cell_length
                except:
                    pass
            
            header_cell = worksheet[f"{column_letter}1"]
            if header_cell.value:
                header_length = len(str(header_cell.value))
                if header_length > max_length:
                    max_length = header_length
            
            adjusted_width = min(max_length + 3, 100)
            adjusted_width = max(adjusted_width, 12)
            
            worksheet.column_dimensions[column_letter].width = adjusted_width
    
    def direk_tipi_bilgilerini_al(self, veri, tespit_verileri=None):
        """Ã‡OK HIZLI versiyon - pandas merge kullan ve tespit bilgilerini de al"""
        try:
            # 1. Ana veriden direk numaralarÄ±nÄ± hazÄ±rla - SET kullan
            ana_direk_set = set()
            for row_data in veri:
                direk_no = str(row_data.get('Direk No', ''))
                temiz_no = self.direk_no_temizle(direk_no)
                if temiz_no and temiz_no != 'nan':
                    ana_direk_set.add(temiz_no)

            self.txt_sonuc.insert(tk.END, f"ğŸ“Š Ana Excel'de {len(ana_direk_set)} direk numarasÄ± bulundu\n")
            
            if not ana_direk_set:
                return {}

            direk_tipleri = {}
            trafo_direkleri = {}
            tespit_bilgileri = {}
            
            # DEÄÄ°ÅTÄ°R: 'Direk ID' yerine 'Direk No'
            if tespit_verileri:
                for tespit_data in tespit_verileri:
                    # ÃœÃ‡ BÄ°LGÄ°YÄ° AL
                    ilce = tespit_data.get('Ä°lÃ§e', '').strip()
                    kaynak_klasor = tespit_data.get('Hat AdÄ±', '').strip()
                    direk_no = tespit_data.get('Direk No', '')  # DEÄÄ°ÅTÄ°RÄ°LDÄ°: Direk ID -> Direk No
                    temiz_no = self.direk_no_temizle(direk_no)
                    
                    if ilce and kaynak_klasor and temiz_no:
                        # ÃœÃ‡LÃœ ANAHTAR OLUÅTUR: (Ä°lÃ§e, Hat AdÄ±, Direk No)
                        anahtar = (ilce, kaynak_klasor, temiz_no)
                        tespit_bilgileri[anahtar] = {
                            'oncelik': tespit_data.get('Ã–ncelik', ''),
                            'tespit_notu': tespit_data.get('Tespit Notu', ''),
                            'yapildi_mi': tespit_data.get('YapÄ±ldÄ± mÄ±?', '')
                        }

            # 3. OG direk Excel'inden TRAFO DÄ°REÄÄ° bilgilerini al
            if self.direk_og_yolu and os.path.exists(self.direk_og_yolu):
                try:
                    df_og = pd.read_excel(self.direk_og_yolu)
                    
                    # SÃ¼tun isimlerini bul
                    direkno_col = None
                    tip_col = None
                    
                    for col in df_og.columns:
                        col_upper = col.upper()
                        if 'DIREK' in col_upper and ('NO' in col_upper or 'NUMARA' in col_upper):
                            direkno_col = col
                        elif 'TIP' in col_upper or 'TÄ°P' in col_upper or 'TYPE' in col_upper:
                            tip_col = col
                    
                    if direkno_col and tip_col:
                        for index, row in df_og.iterrows():
                            direk_no = str(row[direkno_col])
                            temiz_no = self.direk_no_temizle(direk_no.strip())
                            tip_deger = str(row[tip_col]).strip().upper() if pd.notna(row[tip_col]) else ""
                            
                            if temiz_no and temiz_no in ana_direk_set:
                                # "TRAFO DIREGI" kontrolÃ¼ (bÃ¼yÃ¼k/kÃ¼Ã§Ã¼k harf duyarsÄ±z)
                                if "TRAFO" in tip_deger or "TRAFO DÄ°REÄÄ°" in tip_deger.upper():
                                    trafo_direkleri[temiz_no] = "TRAFO DÄ°REÄÄ°"
                            
                        self.txt_sonuc.insert(tk.END, f"âœ“ OG Excel'inden {len(trafo_direkleri)} trafo direÄŸi bulundu\n")
                        
                except Exception as e:
                    self.txt_sonuc.insert(tk.END, f"âš ï¸ OG Excel trafo bilgisi okuma hatasÄ±: {str(e)}\n")

            # 4. MÃ¼ÅŸterek direkleri HIZLI ÅŸekilde bul
            if self.direk_musterek_yolu and os.path.exists(self.direk_musterek_yolu):
                try:
                    df_musterek = pd.read_excel(self.direk_musterek_yolu)
                    direkno_col = next((col for col in df_musterek.columns 
                                      if 'DIREKNO' in col.upper() or 'NO' in col.upper()), None)
                    
                    if direkno_col:
                        musterek_direkler = set()
                        for direk_no in df_musterek[direkno_col].dropna().astype(str):
                            temiz_no = self.direk_no_temizle(direk_no.strip())
                            if temiz_no:
                                musterek_direkler.add(temiz_no)
                        
                        eslesenler = ana_direk_set.intersection(musterek_direkler)
                        for direk_no in eslesenler:
                            direk_tipleri[direk_no] = 'MÃ¼ÅŸterek Direk'
                        
                        self.txt_sonuc.insert(tk.END, f"âœ“ MÃ¼ÅŸterek direk Excel'inde eÅŸleÅŸen: {len(eslesenler)} direk\n")
                        
                except Exception as e:
                    self.txt_sonuc.insert(tk.END, f"âš ï¸ MÃ¼ÅŸterek Excel okuma hatasÄ±: {str(e)}\n")

            # 5. OG direkleri HIZLI ÅŸekilde bul (trafo olmayanlar)
            if self.direk_og_yolu and os.path.exists(self.direk_og_yolu):
                try:
                    df_og = pd.read_excel(self.direk_og_yolu)
                    direkno_col = next((col for col in df_og.columns 
                                      if 'DIREKNO' in col.upper() or 'NO' in col.upper()), None)
                    
                    if direkno_col:
                        og_direkler = set()
                        for direk_no in df_og[direkno_col].dropna().astype(str):
                            temiz_no = self.direk_no_temizle(direk_no.strip())
                            if temiz_no:
                                og_direkler.add(temiz_no)
                        
                        # Trafo direklerini Ã§Ä±kararak OG direkleri bul
                        eslesenler = ana_direk_set.intersection(og_direkler) - set(direk_tipleri.keys()) - set(trafo_direkleri.keys())
                        for direk_no in eslesenler:
                            direk_tipleri[direk_no] = 'Og Direk'
                        
                        self.txt_sonuc.insert(tk.END, f"âœ“ OG direk Excel'inde eÅŸleÅŸen: {len(eslesenler)} direk\n")
                        
                except Exception as e:
                    self.txt_sonuc.insert(tk.END, f"âš ï¸ OG Excel okuma hatasÄ±: {str(e)}\n")

            # Ä°statistikler
            eslesmeyenler = ana_direk_set - set(direk_tipleri.keys()) - set(trafo_direkleri.keys())
            self.txt_sonuc.insert(tk.END, f"ğŸ“Š Toplam {len(direk_tipleri)} direk tipi bilgisi bulundu\n")
            self.txt_sonuc.insert(tk.END, f"ğŸ“Š {len(trafo_direkleri)} trafo direÄŸi bulundu\n")
            self.txt_sonuc.insert(tk.END, f"ğŸ“Š Tespit bilgisi bulunan: {len(tespit_bilgileri)} direk\n")
            
            # Direk tipi, trafo bilgisi ve tespit bilgilerini birleÅŸtir
            sonuc = {
                'direk_tipleri': direk_tipleri,
                'trafo_direkleri': trafo_direkleri,
                'tespit_bilgileri': tespit_bilgileri
            }
            
            return sonuc
            
        except Exception as e:
            self.txt_sonuc.insert(tk.END, f"âš ï¸ Direk tipi hesaplama hatasÄ±: {str(e)}\n")
            return {'direk_tipleri': {}, 'trafo_direkleri': {}, 'tespit_bilgileri': {}}


    
    def tespit_excelini_oku(self):
        """Rapor Excel'indeki BirleÅŸtirilmiÅŸ_Tespit sayfasÄ±nÄ± okur (Ä°lÃ§e bilgisi ile)"""
        tespit_verileri = {}
        
        try:
            # Rapor Excel dosyasÄ±nÄ±n yolunu bul
            rapor_dosya_yolu = self.kaydetme_yeri.get()
            
            if not rapor_dosya_yolu or not os.path.exists(rapor_dosya_yolu):
                self.txt_sonuc.insert(tk.END, "âš ï¸ Rapor Excel dosyasÄ± bulunamadÄ±\n")
                return tespit_verileri
            
            # BirleÅŸtirilmiÅŸ_Tespit sayfasÄ±nÄ± oku
            try:
                df_tespit = pd.read_excel(rapor_dosya_yolu, sheet_name='BirleÅŸtirilmiÅŸ_Tespit')
            except:
                self.txt_sonuc.insert(tk.END, "âš ï¸ BirleÅŸtirilmiÅŸ_Tespit sayfasÄ± bulunamadÄ±\n")
                return tespit_verileri
            
            # DEÄÄ°ÅTÄ°RÄ°LDÄ°: 'Direk ID' yerine 'Direk No'
            gerekli_sutunlar = ['Ä°lÃ§e', 'Direk No', 'Ã–ncelik', 'Tespit Notu', 'YapÄ±ldÄ± mÄ±?']  # DEÄÄ°ÅTÄ°RÄ°LDÄ°
            mevcut_sutunlar = df_tespit.columns.tolist()
            
            # SÃ¼tun eÅŸleÅŸtirme
            sutun_eslesmeleri = {}
            for gerekli_sutun in gerekli_sutunlar:
                for mevcut_sutun in mevcut_sutunlar:
                    if gerekli_sutun.lower() in mevcut_sutun.lower():
                        sutun_eslesmeleri[gerekli_sutun] = mevcut_sutun
                        break
            
            # Tespit verilerini iÅŸle
            for index, row in df_tespit.iterrows():
                try:
                    # DEÄÄ°ÅTÄ°RÄ°LDÄ°: 'Direk ID' yerine 'Direk No'
                    direk_no_sutunu = sutun_eslesmeleri.get('Direk No')  # DEÄÄ°ÅTÄ°RÄ°LDÄ°
                    if not direk_no_sutunu:
                        continue
                        
                    direk_no = str(row[direk_no_sutunu])
                    temiz_no = self.direk_no_temizle(direk_no)
                    
                    if not temiz_no or temiz_no == 'nan':
                        continue
                    
                    # Ä°lÃ§e bilgisini al
                    ilce_sutunu = sutun_eslesmeleri.get('Ä°lÃ§e')
                    ilce = ""
                    if ilce_sutunu and pd.notna(row[ilce_sutunu]):
                        ilce = str(row[ilce_sutunu])
                    
                    # Ã–ncelik, Tespit Notu ve YapÄ±ldÄ± mÄ±?'yÄ± al
                    oncelik = ""
                    tespit_notu = ""
                    yapildi_mi = ""
                    
                    oncelik_sutunu = sutun_eslesmeleri.get('Ã–ncelik')
                    if oncelik_sutunu and pd.notna(row[oncelik_sutunu]):
                        oncelik = str(row[oncelik_sutunu])
                    
                    tespit_notu_sutunu = sutun_eslesmeleri.get('Tespit Notu')
                    if tespit_notu_sutunu and pd.notna(row[tespit_notu_sutunu]):
                        tespit_notu = str(row[tespit_notu_sutunu])
                    
                    yapildi_mi_sutunu = sutun_eslesmeleri.get('YapÄ±ldÄ± mÄ±?')
                    if yapildi_mi_sutunu and pd.notna(row[yapildi_mi_sutunu]):
                        yapildi_mi = str(row[yapildi_mi_sutunu])
                    
                    # Tespit bilgilerini kaydet (ilÃ§e bilgisi ile birlikte)
                    tespit_verileri[temiz_no] = {
                        'ilce': ilce,
                        'oncelik': oncelik,
                        'tespit_notu': tespit_notu,
                        'yapildi_mi': yapildi_mi
                    }
                    
                except Exception as e:
                    continue
            
            self.txt_sonuc.insert(tk.END, f"âœ… BirleÅŸtirilmiÅŸ_Tespit sayfasÄ±ndan {len(tespit_verileri)} direk iÃ§in bilgi alÄ±ndÄ±\n")
            
        except Exception as e:
            self.txt_sonuc.insert(tk.END, f"âš ï¸ Tespit Excel okuma hatasÄ±: {str(e)}\n")
        
        return tespit_verileri



    
    def direk_no_temizle(self, direk_no):
        """Direk numarasÄ±nÄ± temizleyerek standart formata getirir"""
        if not direk_no or str(direk_no).lower() in ['nan', 'none', 'null', '']:
            return ""  # TÃœM boÅŸ deÄŸerler iÃ§in "" dÃ¶ndÃ¼r
        
        # String'e Ã§evir ve temizle
        direk_no = str(direk_no).strip()
        
        # EÄŸer boÅŸ string ise None dÃ¶ndÃ¼r
        if not direk_no:
            return None
        
        # Ã–zel durum: "0" veya "0000" gibi deÄŸerleri kontrol et
        if direk_no.replace('0', '') == '':
            return '0'
        
        # SayÄ±sal deÄŸerleri kontrol et (Ã¶rn: 123.0 -> 123)
        try:
            # Float ise integer'a Ã§evir, baÅŸtaki sÄ±fÄ±rlarÄ± kaldÄ±r
            if '.' in direk_no:
                cleaned = str(int(float(direk_no)))
            else:
                # DoÄŸrudan integer'a Ã§evirmeye Ã§alÄ±ÅŸ
                cleaned = str(int(direk_no))
            
            # BaÅŸtaki sÄ±fÄ±rlarÄ± kaldÄ±r, ama "0" deÄŸerini koru
            cleaned = cleaned.lstrip('0') or '0'
            return cleaned
            
        except (ValueError, TypeError):
            # SayÄ±ya Ã§evrilemezse, sadece rakamlarÄ± al
            sadece_rakamlar = ''.join(filter(str.isdigit, direk_no))
            if sadece_rakamlar:
                # BaÅŸtaki sÄ±fÄ±rlarÄ± kaldÄ±r, ama "0" deÄŸerini koru
                sadece_rakamlar = sadece_rakamlar.lstrip('0') or '0'
                return sadece_rakamlar
            
            # HiÃ§ rakam yoksa orijinal deÄŸeri dÃ¶ndÃ¼r (temizlenmiÅŸ)
            return direk_no

    
    
    def excel_ac(self, dosya_yolu):
        try:
            if sys.platform == "win32":
                os.startfile(dosya_yolu)
            elif sys.platform == "darwin":
                subprocess.run(["open", dosya_yolu])
            else:
                subprocess.run(["xdg-open", dosya_yolu])
            return True
        except Exception as e:
            print(f"Excel aÃ§Ä±lÄ±rken hata: {e}")
            return False


    
    

    

    def isim_sablonu_olustur(self, foto_info, sira_no, dosya_sayaclari):
        orijinal_adi = os.path.splitext(foto_info['orijinal_adi'])[0]
        uzanti = os.path.splitext(foto_info['orijinal_adi'])[1]
        klasor_adi = foto_info['klasor_adi']
        kaynak_klasor_adi = os.path.basename(foto_info['kaynak_klasor'])
    
        # Ä°sim ÅŸablonunu al
        sablon = self.isim_sablonu.get().strip()
    
        # EÄŸer ÅŸablon sadece "DJI" ise, DJI_1'den baÅŸlayacak ÅŸekilde deÄŸiÅŸtir
        if sablon == "DJI":
            sablon = "DJI_{sira_no}"
    
        # Åablonu iÅŸle
        yeni_isim = sablon
        yeni_isim = yeni_isim.replace('{orijinal_adi}', orijinal_adi)
        yeni_isim = yeni_isim.replace('{klasor_adi}', klasor_adi)
        yeni_isim = yeni_isim.replace('{kaynak_klasr}', kaynak_klasor_adi)
        yeni_isim = yeni_isim.replace('{sira_no}', str(sira_no))
    
        # GeÃ§ersiz karakterleri temizle
        yeni_isim = re.sub(r'[<>:"/\\|?*]', '_', yeni_isim)
    
        return yeni_isim + uzanti.lower()


    def hat_bazi_tarihsiz_hesapla(self, veri):
        """Her hat iÃ§in tarihsiz fotoÄŸraf yÃ¼zdesini hesaplar"""
        hat_istatistikleri = {}
        
        # 1. Ã–nce hatlarÄ± grupla ve doÄŸrudan sayÄ±m yap
        for row_data in veri:
            aob = row_data.get('Aob', '')
            hat_adi = row_data.get('Hat adÄ±', '')
            hat_anahtari = (aob, hat_adi)
            
            if hat_anahtari not in hat_istatistikleri:
                hat_istatistikleri[hat_anahtari] = {
                    'toplam_foto': 0,
                    'tarihsiz_foto': 0
                }
            
            # DoÄŸrudan bu klasÃ¶rÃ¼n istatistiklerini hesapla ve ekle
            klasor_yolu = row_data.get('KlasÃ¶r Yolu', '')
            if klasor_yolu and os.path.exists(klasor_yolu):
                klasor_istatistik = self.klasor_tarihsiz_say(klasor_yolu)
                hat_istatistikleri[hat_anahtari]['toplam_foto'] += klasor_istatistik['toplam']
                hat_istatistikleri[hat_anahtari]['tarihsiz_foto'] += klasor_istatistik['tarihsiz']
        
        # 2. Her hat iÃ§in tarihsiz fotoÄŸraf yÃ¼zdesini hesapla
        hat_tarihsiz_oranlari = {}
        for hat_anahtari, istatistik in hat_istatistikleri.items():
            toplam_foto = istatistik['toplam_foto']
            tarihsiz_foto = istatistik['tarihsiz_foto']
            
            # YÃ¼zde hesapla
            if toplam_foto > 0:
                tarihsiz_yuzde = (tarihsiz_foto / toplam_foto) * 100
            else:
                tarihsiz_yuzde = 0
                
            hat_tarihsiz_oranlari[hat_anahtari] = round(tarihsiz_yuzde, 1)
            
            # Debug info
            print(f"ğŸ” {hat_anahtari}: {toplam_foto} fotoÄŸraf, {tarihsiz_foto} tarihsiz (%{tarihsiz_yuzde:.1f})")
        
        return hat_tarihsiz_oranlari

    def klasor_tarihsiz_say(self, klasor_yolu):
        """Bir klasÃ¶rdeki tarihsiz fotoÄŸraflarÄ± sayar - HIZLI versiyon"""
        foto_uzantilari = ('.jpg', '.jpeg', '.png', '.tiff', '.tif', '.bmp')
        toplam = 0
        tarihsiz = 0
        
        try:
            for root, dirs, files in os.walk(klasor_yolu):
                for dosya in files:
                    if any(dosya.lower().endswith(ext) for ext in foto_uzantilari):
                        toplam += 1
                        dosya_yolu = os.path.join(root, dosya)
                        if not self.exif_tarihi_var_mi_hizli(dosya_yolu):
                            tarihsiz += 1
        except Exception as e:
            print(f"KlasÃ¶r tarama hatasÄ± {klasor_yolu}: {e}")
        
        return {'toplam': toplam, 'tarihsiz': tarihsiz}

    def exif_tarihi_var_mi_hizli(self, dosya_yolu):
        """EXIF tarihi kontrolÃ¼ - HIZLI versiyon"""
        try:
            with Image.open(dosya_yolu) as img:
                exif_data = img.getexif()
                if exif_data:
                    datetime_original = exif_data.get(36867)  # DateTimeOriginal
                    datetime_digitized = exif_data.get(36868)  # DateTimeDigitized  
                    datetime_normal = exif_data.get(306)       # DateTime
                    
                    if datetime_original or datetime_digitized or datetime_normal:
                        return True
                return False
        except:
            return False



    def excel_klasor_sec(self):
        """KlasÃ¶r seÃ§me dialogunu aÃ§ar"""
        try:
            klasor = filedialog.askdirectory(
                title="Excel DosyalarÄ±nÄ±n BulunduÄŸu KlasÃ¶rÃ¼ SeÃ§in"
            )
            if klasor:
                self.excel_birlestirme_klasor = klasor
                
                # SADECE klasÃ¶r seÃ§imi alanÄ±nÄ± gÃ¼ncelle, kaydetme yerini deÄŸil
                for widget in self.content_frame.winfo_children():
                    if isinstance(widget, tk.Frame) and hasattr(widget, 'winfo_children'):
                        # Ä°lk frame'i bul (klasÃ¶r seÃ§imi frame'i)
                        frame_children = widget.winfo_children()
                        if len(frame_children) >= 2:  # Label ve Entry var
                            entry_widget = frame_children[1]  # Entry widget'Ä±
                            if isinstance(entry_widget, tk.Entry):
                                # Sadece klasÃ¶r seÃ§imi entry'sini gÃ¼ncelle
                                if "KlasÃ¶r SeÃ§:" in str(frame_children[0].cget('text')):
                                    entry_widget.config(state='normal')
                                    entry_widget.delete(0, tk.END)
                                    entry_widget.insert(0, klasor)
                                    entry_widget.config(state='readonly')
                                    break
                
                self.log_mesaj_ekle(f"âœ… KlasÃ¶r seÃ§ildi: {klasor}")
                # KlasÃ¶rÃ¼ otomatik tara
                self.excel_klasoru_tara()
                
        except Exception as e:
            messagebox.showerror("Hata", f"KlasÃ¶r seÃ§ilirken hata oluÅŸtu: {str(e)}")

    def excel_klasoru_tara(self):
        """SeÃ§ili klasÃ¶rdeki Excel dosyalarÄ±nÄ± tarar"""
        if not hasattr(self, 'excel_birlestirme_klasor') or not self.excel_birlestirme_klasor:
            messagebox.showwarning("UyarÄ±", "LÃ¼tfen Ã¶nce bir klasÃ¶r seÃ§in!")
            return
        
        try:
            self.excel_birlestirme_dosyalari = []
            
            if self.alt_klasor_tara_var.get():
                # Alt klasÃ¶rler dahil
                for root, dirs, files in os.walk(self.excel_birlestirme_klasor):
                    for dosya in files:
                        if dosya.lower().endswith(('.xlsx', '.xls')):
                            tam_yol = os.path.join(root, dosya)
                            self.excel_birlestirme_dosyalari.append(tam_yol)
            else:
                # Sadece seÃ§ili klasÃ¶r
                for dosya in os.listdir(self.excel_birlestirme_klasor):
                    if dosya.lower().endswith(('.xlsx', '.xls')):
                        tam_yol = os.path.join(self.excel_birlestirme_klasor, dosya)
                        self.excel_birlestirme_dosyalari.append(tam_yol)
            
            self.excel_birlestirme_toplam_dosya.set(len(self.excel_birlestirme_dosyalari))
            self.excel_birlestirme_islenen_dosya.set(0)
            
            self.log_mesaj_ekle(f"âœ… {len(self.excel_birlestirme_dosyalari)} Excel dosyasÄ± bulundu")
            
            if self.excel_birlestirme_dosyalari:
                self.log_mesaj_ekle("ğŸ“‹ Bulunan dosyalar:")
                for dosya in self.excel_birlestirme_dosyalari[:10]:  # Ä°lk 10'u gÃ¶ster
                    goreli_yol = os.path.relpath(dosya, self.excel_birlestirme_klasor)
                    self.log_mesaj_ekle(f"   ğŸ“„ {goreli_yol}")
                
                if len(self.excel_birlestirme_dosyalari) > 10:
                    self.log_mesaj_ekle(f"   ... ve {len(self.excel_birlestirme_dosyalari) - 10} dosya daha")
            
        except Exception as e:
            self.log_mesaj_ekle(f"âŒ KlasÃ¶r taranÄ±rken hata: {str(e)}")

    def excel_kaydetme_yeri_sec(self):
        """Kaydetme yeri seÃ§me dialogunu aÃ§ar"""
        try:
            baslangic_dizin = os.path.expanduser("~")
            if hasattr(self, 'excel_birlestirme_klasor') and self.excel_birlestirme_klasor:
                baslangic_dizin = self.excel_birlestirme_klasor
                
            dosya = filedialog.asksaveasfilename(
                title="BirleÅŸtirilmiÅŸ Excel DosyasÄ±nÄ± Kaydet",
                initialdir=baslangic_dizin,
                defaultextension=".xlsx",
                filetypes=[("Excel files", "*.xlsx"), ("All files", "*.*")]
            )
            if dosya:
                self.excel_birlestirme_kaydetme_yeri.set(dosya)
                self.log_mesaj_ekle(f"ğŸ’¾ Kaydetme yeri: {dosya}")
        except Exception as e:
            messagebox.showerror("Hata", f"Kaydetme yeri seÃ§ilirken hata oluÅŸtu: {str(e)}")

    def excel_birlestirmeyi_baslat(self):
        """Excel birleÅŸtirme iÅŸlemini baÅŸlatÄ±r"""
        if not hasattr(self, 'excel_birlestirme_klasor') or not self.excel_birlestirme_klasor:
            messagebox.showerror("Hata", "LÃ¼tfen Ã¶nce bir klasÃ¶r seÃ§in!")
            return
            
        if not self.excel_birlestirme_dosyalari:
            messagebox.showwarning("UyarÄ±", "SeÃ§ilen klasÃ¶rde Excel dosyasÄ± bulunamadÄ±!")
            return
            
        if not self.excel_birlestirme_kaydetme_yeri.get():
            messagebox.showerror("Hata", "LÃ¼tfen kaydetme yerini seÃ§in!")
            return
        
        self.calisma_devam_ediyor = True
        self.lbl_durum.config(text="Excel dosyalarÄ± birleÅŸtiriliyor...", fg=self.colors['accent'])
        self.txt_sonuc.delete(1.0, tk.END)
        self.txt_sonuc.insert(tk.END, "Excel dosyalarÄ± birleÅŸtiriliyor...\n")
        self.excel_ilerleme['value'] = 0
        self.ilerleme_yuzde.set("%0")
        self.root.update()
        
        threading.Thread(target=self.excel_birlestir_thread, daemon=True).start()

    def excel_birlestir_thread(self):
        """Excel dosyalarÄ±nÄ± birleÅŸtirme iÅŸlemini thread'de Ã§alÄ±ÅŸtÄ±rÄ±r - Hat AdÄ± BÄ°LGÄ°LÄ° VERSÄ°YON"""
        try:
            tum_veriler = []
            basarili_dosyalar = 0
            hatali_dosyalar = 0
            
            # Ä°STATÄ°STÄ°K DEÄÄ°ÅKENLERÄ°
            toplam_satir = 0
            toplam_cbs_satir = 0
            toplam_aob_satir = 0
            toplam_bos_satir = 0
            toplam_eklenen_satir = 0
            toplam_eklenmeyen_satir = 0
            
            # Ä°STENEN SÃœTUN LÄ°STESÄ° - "SIRA NO" KALDIRILDI, Hat AdÄ± SÃœTUNU EKLENDÄ°
            istenen_sutunlar = [
                'Hat AdÄ±', 'Direk No', 'Tespit Notu', 'Tespit Kategorisi', 
                'Ã–ncelik', 'FotoÄŸraf Yolu', 'Enlem', 'Boylam', 'Birim'
            ]
            
            self.excel_ilerleme['maximum'] = len(self.excel_birlestirme_dosyalari)
            self.excel_ilerleme['value'] = 0
            
            for i, dosya in enumerate(self.excel_birlestirme_dosyalari):
                try:
                    self.lbl_durum.config(text=f"Ä°ÅŸleniyor: {os.path.basename(dosya)}")
                    
                    # Excel dosyasÄ±nÄ± header=None ile oku (baÅŸlÄ±k satÄ±rÄ± olmadan)
                    df = pd.read_excel(dosya, header=None)
                    
                    # GERÃ‡EK BAÅLIK SATIRINI BUL
                    baslik_satiri_idx = None
                    for idx in range(min(15, len(df))):  # Ä°lk 15 satÄ±rÄ± kontrol et
                        satir = df.iloc[idx]
                        satir_metin = ' '.join(str(x).strip() for x in satir.values if pd.notna(x) and str(x).strip())
                        
                        # Ä°stenen sÃ¼tun isimlerini ara (bÃ¼yÃ¼k/kÃ¼Ã§Ã¼k harf duyarsÄ±z)
                        if all(any(sutun_adi.lower() in str(x).lower() for x in satir.values if pd.notna(x)) 
                               for sutun_adi in istenen_sutunlar if sutun_adi and sutun_adi != 'Hat AdÄ±'):
                            baslik_satiri_idx = idx
                            break
                    
                    if baslik_satiri_idx is not None:
                        # BaÅŸlÄ±k satÄ±rÄ±nÄ± bulduk, onu kullanarak tekrar oku
                        df = pd.read_excel(dosya, header=baslik_satiri_idx)
                        self.log_mesaj_ekle(f"â„¹ï¸ {os.path.basename(dosya)} - BaÅŸlÄ±k {baslik_satiri_idx + 1}. satÄ±rda bulundu")
                    else:
                        # BaÅŸlÄ±k bulunamazsa, ilk satÄ±rÄ± baÅŸlÄ±k olarak kullan
                        df = pd.read_excel(dosya, header=0)
                        self.log_mesaj_ekle(f"â„¹ï¸ {os.path.basename(dosya)} - Ä°lk satÄ±r baÅŸlÄ±k olarak kullanÄ±ldÄ±")
                    
                    # SADECE Ä°STENEN 9 SÃœTUNU SEÃ‡ - "SIRA NO" KALDIRILDI, Hat AdÄ± EKLENDÄ°
                    mevcut_sutunlar = df.columns.tolist()
                    secilecek_sutunlar = []
                    sutun_eslesmeleri = {}
                    
                    # Ä°stenen sÃ¼tunlarÄ± bul (bÃ¼yÃ¼k/kÃ¼Ã§Ã¼k harf duyarsÄ±z ve kÄ±smi eÅŸleÅŸme)
                    for istenen_sutun in istenen_sutunlar:
                        # "Hat AdÄ±" sÃ¼tunu Ã¶zel iÅŸlem - mevcut Excel'de yok, biz ekleyeceÄŸiz
                        if istenen_sutun == 'Hat AdÄ±':
                            continue
                            
                        eslesen_sutun = None
                        for mevcut_sutun in mevcut_sutunlar:
                            mevcut_sutun_clean = str(mevcut_sutun).strip().lower()
                            istenen_sutun_clean = str(istenen_sutun).strip().lower()
                            
                            # Tam eÅŸleÅŸme
                            if mevcut_sutun_clean == istenen_sutun_clean:
                                eslesen_sutun = mevcut_sutun
                                break
                            # KÄ±smi eÅŸleÅŸme
                            elif istenen_sutun_clean in mevcut_sutun_clean:
                                eslesen_sutun = mevcut_sutun
                                break
                        
                        if eslesen_sutun:
                            secilecek_sutunlar.append(eslesen_sutun)
                            sutun_eslesmeleri[eslesen_sutun] = istenen_sutun
                        else:
                            # EÅŸleÅŸen sÃ¼tun yoksa, boÅŸ sÃ¼tun ekleyeceÄŸiz
                            pass
                    
                    # SADECE BULUNAN SÃœTUNLARI SEÃ‡ - DÄ°ÄERLERÄ°NÄ° TAMAMEN SÄ°L
                    df_filtreli = pd.DataFrame()
                    
                    # Ã–NCE TÃœM VERÄ° SATIRLARI Ä°Ã‡Ä°N Hat AdÄ± BÄ°LGÄ°SÄ°NÄ° HAZIRLA
                    # DosyanÄ±n bulunduÄŸu klasÃ¶r adÄ±nÄ± al
                    dosya_klasoru = os.path.basename(os.path.dirname(dosya))
                    
                    for istenen_sutun in istenen_sutunlar:
                        # "Hat AdÄ±" sÃ¼tunu Ã¶zel iÅŸlem - TÃœM SATIRLARA AYNI DEÄERÄ° VER
                        if istenen_sutun == 'Hat AdÄ±':
                            continue
                            
                        # Bu sÃ¼tun iÃ§in eÅŸleÅŸme var mÄ± kontrol et
                        eslesen_mevcut_sutun = None
                        for mevcut_sutun, standart_sutun in sutun_eslesmeleri.items():
                            if standart_sutun == istenen_sutun:
                                eslesen_mevcut_sutun = mevcut_sutun
                                break
                        
                        if eslesen_mevcut_sutun and eslesen_mevcut_sutun in df.columns:
                            # DÄ°REK ID SÃœTUNU Ã–ZEL Ä°ÅLEM
                            if istenen_sutun == 'Direk ID':
                                # Direk ID sÃ¼tununu Ã¶zel iÅŸle
                                df_filtreli[istenen_sutun] = self.direk_id_isle(df[eslesen_mevcut_sutun])
                            else:
                                df_filtreli[istenen_sutun] = df[eslesen_mevcut_sutun]
                        else:
                            # SÃ¼tun bulunamadÄ±, boÅŸ sÃ¼tun oluÅŸtur
                            df_filtreli[istenen_sutun] = [""] * len(df)
                    
                    # ÅÄ°MDÄ° Hat AdÄ± SÃœTUNUNU EKLE - TÃœM SATIRLARA AYNI DEÄER
                    if not df_filtreli.empty:
                        df_filtreli['Hat AdÄ±'] = dosya_klasoru
                        # SÃ¼tun sÄ±rasÄ±nÄ± dÃ¼zelt: Hat AdÄ± ilk sÃ¼tun olmalÄ±
                        sutun_sirasi = ['Hat AdÄ±'] + [sutun for sutun in istenen_sutunlar if sutun != 'Hat AdÄ±']
                        df_filtreli = df_filtreli[sutun_sirasi]
                    
                    # Ä°STATÄ°STÄ°K: Toplam satÄ±r sayÄ±sÄ± (FÄ°LTRE Ã–NCESÄ°)
                    dosya_toplam_satir = len(df_filtreli)
                    toplam_satir += dosya_toplam_satir
                    
                    # BÄ°RÄ°M SÃœTUNU Ä°STATÄ°STÄ°KLERÄ° (FÄ°LTRE Ã–NCESÄ°)
                    if 'Birim' in df_filtreli.columns:
                        # "Birim" sÃ¼tununu temizle
                        birim_serisi = df_filtreli['Birim'].astype(str).str.strip()
                        
                        # Ä°STATÄ°STÄ°K: Filtreleme Ã¶ncesi birim daÄŸÄ±lÄ±mÄ±
                        dosya_cbs_satir = birim_serisi.str.lower().str.contains('cbs', na=False).sum()
                        dosya_aob_satir = (birim_serisi.str.lower() == 'aob').sum()
                        dosya_bos_satir = ((birim_serisi == '') | (birim_serisi == 'nan') | 
                                         (birim_serisi == 'None') | df_filtreli['Birim'].isna()).sum()
                        
                        toplam_cbs_satir += dosya_cbs_satir
                        toplam_aob_satir += dosya_aob_satir
                        toplam_bos_satir += dosya_bos_satir
                        
                        # FÄ°LTRELEME: Sadece "Aob" varyasyonlarÄ± ve boÅŸ hÃ¼creler
                        def is_valid_birim(birim_deger):
                            if pd.isna(birim_deger) or birim_deger in ['', 'nan', 'None']:
                                return True
                            birim_str = str(birim_deger).strip().lower()
                            return birim_str == 'aob'
                        
                        birim_mask = birim_serisi.apply(is_valid_birim)
                        birim_mask.index = df_filtreli.index
                        
                        # Filtreyi uygula
                        df_filtreli = df_filtreli[birim_mask]
                        
                        # Ä°STATÄ°STÄ°K: Eklenen ve eklenmeyen satÄ±rlar
                        dosya_eklenen_satir = len(df_filtreli)
                        dosya_eklenmeyen_satir = dosya_toplam_satir - dosya_eklenen_satir
                        
                        toplam_eklenen_satir += dosya_eklenen_satir
                        toplam_eklenmeyen_satir += dosya_eklenmeyen_satir
                        
                        # Filtreleme istatistikleri
                        self.log_mesaj_ekle(f"ğŸ” {os.path.basename(dosya)} - Birim filtresi:")
                        self.log_mesaj_ekle(f"   ğŸ“Š Toplam: {dosya_toplam_satir} satÄ±r")
                        self.log_mesaj_ekle(f"   âœ… Eklenecek: {dosya_eklenen_satir} satÄ±r")
                        self.log_mesaj_ekle(f"   âŒ Eklenmeyecek: {dosya_eklenmeyen_satir} satÄ±r")
                        self.log_mesaj_ekle(f"   ğŸ“‹ Birim daÄŸÄ±lÄ±mÄ± - CBS: {dosya_cbs_satir}, AOB: {dosya_aob_satir}, BoÅŸ: {dosya_bos_satir}")
                    
                    # BAÅLIK SATIRLARINI VE BOÅ SATIRLARI FÄ°LTRELE
                    if not df_filtreli.empty:
                        mask = pd.Series([True] * len(df_filtreli), index=df_filtreli.index)
                        
                        for sutun in df_filtreli.columns:
                            if df_filtreli[sutun].dtype == 'object' and sutun != 'Hat AdÄ±':
                                # BaÅŸlÄ±k benzeri metinler iÃ§eren satÄ±rlarÄ± bul
                                try:
                                    baslik_mask = ~df_filtreli[sutun].astype(str).str.contains(
                                        '|'.join([s for s in istenen_sutunlar if s != 'Hat AdÄ±'] + ['Direk NumarasÄ±', 'YAPILACAK MI', 'K2']), 
                                        case=False, na=False
                                    )
                                    # Mask'Ä± hizala
                                    baslik_mask.index = df_filtreli.index
                                    mask = mask & baslik_mask
                                except Exception as e:
                                    self.log_mesaj_ekle(f"âš ï¸ BaÅŸlÄ±k filtresi hatasÄ±: {str(e)}")
                                    continue
                        
                        # Filtreyi uygula - mask'Ä± DataFrame index'i ile hizala
                        mask.index = df_filtreli.index
                        df_filtreli = df_filtreli[mask]
                        
                        # TÃ¼mÃ¼ boÅŸ satÄ±rlarÄ± sil (Hat AdÄ± hariÃ§)
                        bos_sutunlar = [col for col in df_filtreli.columns if col != 'Hat AdÄ±']
                        df_filtreli = df_filtreli.dropna(subset=bos_sutunlar, how='all')
                        
                        # Hat AdÄ± SÃœTUNUNU KONTROL ET VE GÃœNCELLE
                        if not df_filtreli.empty:
                            # Filtreleme sonrasÄ± kalan satÄ±r sayÄ±sÄ±na gÃ¶re Hat AdÄ± sÃ¼tununu gÃ¼ncelle
                            df_filtreli['Hat AdÄ±'] = dosya_klasoru
                    
                    if not df_filtreli.empty:
                        tum_veriler.append(df_filtreli)
                        basarili_dosyalar += 1
                        
                        goreli_yol = os.path.relpath(dosya, self.excel_birlestirme_klasor)
                        self.log_mesaj_ekle(f"âœ… {goreli_yol} - {len(df_filtreli)} satÄ±r eklendi (Kaynak: {dosya_klasoru})")
                        
                    else:
                        hatali_dosyalar += 1
                        goreli_yol = os.path.relpath(dosya, self.excel_birlestirme_klasor)
                        self.log_mesaj_ekle(f"âš ï¸ {goreli_yol} - Filtreleme sonrasÄ± veri kalmadÄ±")
                    
                except Exception as e:
                    hatali_dosyalar += 1
                    goreli_yol = os.path.relpath(dosya, self.excel_birlestirme_klasor)
                    self.log_mesaj_ekle(f"âŒ {goreli_yol} - Hata: {str(e)}")
                    import traceback
                    self.log_mesaj_ekle(f"ğŸ” Hata detayÄ±: {traceback.format_exc()}")
                
                # Ä°lerlemeyi gÃ¼ncelle
                self.excel_birlestirme_islenen_dosya.set(i + 1)
                self.excel_ilerleme['value'] = i + 1
                ilerleme = ((i + 1) / len(self.excel_birlestirme_dosyalari)) * 100
                self.ilerleme_yuzde.set(f"%{int(ilerleme)}")
                self.root.update()
            
            # TÃ¼m verileri birleÅŸtir
            if tum_veriler:
                self.lbl_durum.config(text="Veriler birleÅŸtiriliyor...")
                self.log_mesaj_ekle("ğŸ“Š Veriler birleÅŸtiriliyor...")
                
                birlesik_df = pd.concat(tum_veriler, ignore_index=True)
                
                # SON KONTROL: BAÅLIK SATIRLARINI TEKRAR FÄ°LTRELE
                if not birlesik_df.empty:
                    mask = pd.Series([True] * len(birlesik_df), index=birlesik_df.index)
                    
                    for sutun in birlesik_df.columns:
                        if birlesik_df[sutun].dtype == 'object' and sutun != 'Hat AdÄ±':
                            try:
                                baslik_mask = ~birlesik_df[sutun].astype(str).str.contains(
                                    '|'.join([s for s in istenen_sutunlar if s != 'Hat AdÄ±'] + ['Direk NumarasÄ±', 'YAPILACAK MI', 'K2']), 
                                    case=False, na=False
                                )
                                baslik_mask.index = birlesik_df.index
                                mask = mask & baslik_mask
                            except Exception as e:
                                self.log_mesaj_ekle(f"âš ï¸ Son baÅŸlÄ±k filtresi hatasÄ±: {str(e)}")
                                continue
                    
                    # Filtreyi uygula
                    mask.index = birlesik_df.index
                    birlesik_df = birlesik_df[mask]
                
                # KESÄ°NLÄ°KLE SADECE 9 SÃœTUN OLMALI (Hat AdÄ± dahil, SÄ±ra No yok)
                birlesik_df = birlesik_df[istenen_sutunlar]
                
                # GERÃ‡EK SONUÃ‡LARI HESAPLA (BÄ°RLEÅTÄ°RME SONRASI)
                gercek_toplam_satir = len(birlesik_df)
                if 'Birim' in birlesik_df.columns:
                    birim_serisi = birlesik_df['Birim'].astype(str).str.strip()
                    gercek_aob_satir = (birim_serisi.str.lower() == 'aob').sum()
                    gercek_bos_satir = ((birim_serisi == '') | (birim_serisi == 'nan') | 
                                      (birim_serisi == 'None') | birlesik_df['Birim'].isna()).sum()
                else:
                    gercek_aob_satir = 0
                    gercek_bos_satir = gercek_toplam_satir
                
                # Excel'e kaydet
                self.lbl_durum.config(text="Excel dosyasÄ± kaydediliyor...")
                self.log_mesaj_ekle("ğŸ’¾ Excel dosyasÄ± kaydediliyor...")
                
                with pd.ExcelWriter(self.excel_birlestirme_kaydetme_yeri.get(), engine='openpyxl') as writer:
                    birlesik_df.to_excel(writer, index=False, sheet_name='BirleÅŸtirilmiÅŸ_Veri')
                    
                    # Excel formatÄ±nÄ± Ã¶zelleÅŸtir
                    workbook = writer.book
                    worksheet = writer.sheets['BirleÅŸtirilmiÅŸ_Veri']
                    
                    # BaÅŸlÄ±k satÄ±rÄ±nÄ± biÃ§imlendir
                    from openpyxl.styles import Font, PatternFill, Alignment
                    header_font = Font(bold=True, color="FFFFFF")
                    header_fill = PatternFill(start_color="4472C4", end_color="4472C4", fill_type="solid")
                    
                    for col_num, value in enumerate(istenen_sutunlar, 1):
                        cell = worksheet.cell(row=1, column=col_num)
                        cell.value = value
                        cell.font = header_font
                        cell.fill = header_fill
                        cell.alignment = Alignment(horizontal='left', vertical='center')  # BaÅŸlÄ±k sola hizalÄ±
                    
                    # YENÄ°: TÃœM HÃœCRELERÄ° SOLA HÄ°ZALA
                    for row in worksheet.iter_rows(min_row=2, max_row=worksheet.max_row, 
                                                 min_col=1, max_col=len(istenen_sutunlar)):
                        for cell in row:
                            cell.alignment = Alignment(horizontal='left', vertical='center')
                    
                    # SÃ¼tun geniÅŸliklerini otomatik ayarla
                    for column in worksheet.columns:
                        max_length = 0
                        column_letter = column[0].column_letter
                        for cell in column:
                            try:
                                if len(str(cell.value)) > max_length:
                                    max_length = len(str(cell.value))
                            except:
                                pass
                        adjusted_width = min(max_length + 2, 50)
                        worksheet.column_dimensions[column_letter].width = adjusted_width
                
                # DETAYLI Ä°STATÄ°STÄ°KLERÄ° GÃ–STER
                self.lbl_durum.config(text="BirleÅŸtirme tamamlandÄ± âœ“", fg=self.colors['success'])
                self.log_mesaj_ekle(f"\nğŸ‰ BÄ°RLEÅTÄ°RME TAMAMLANDI!")
                self.log_mesaj_ekle("=" * 50)
                self.log_mesaj_ekle("ğŸ“ˆ DETAYLI Ä°STATÄ°STÄ°KLER")
                self.log_mesaj_ekle("=" * 50)
                self.log_mesaj_ekle(f"ğŸ“ Dosya Ä°statistikleri:")
                self.log_mesaj_ekle(f"   âœ… BaÅŸarÄ±lÄ±: {basarili_dosyalar} dosya")
                self.log_mesaj_ekle(f"   âŒ HatalÄ±: {hatali_dosyalar} dosya")
                self.log_mesaj_ekle(f"   ğŸ“Š Toplam: {len(self.excel_birlestirme_dosyalari)} dosya")
                self.log_mesaj_ekle("=" * 50)
                self.log_mesaj_ekle(f"\nğŸ“Š TÃœM DOSYALARIN TOPLAM Ä°STATÄ°STÄ°KLERÄ°:")
                self.log_mesaj_ekle(f"   ğŸ“‹ Toplam Ä°ÅŸlenen SatÄ±r: {toplam_satir:,}")
                
                self.log_mesaj_ekle(f"   ğŸ”µ Toplam CBS SatÄ±r: {toplam_cbs_satir:,}")
                self.log_mesaj_ekle(f"   ğŸŸ¢ Aob SatÄ±rlarÄ±: {gercek_aob_satir:,}")
                self.log_mesaj_ekle(f"   âšª BoÅŸ SatÄ±rlar: {gercek_bos_satir:,}")
                self.log_mesaj_ekle("=" * 50)
                self.log_mesaj_ekle(f"   ğŸ“„ SonuÃ§taki Toplam SatÄ±r: {gercek_toplam_satir:,}")

                # Excel dosyasÄ±nÄ± aÃ§
                self.excel_ac(self.excel_birlestirme_kaydetme_yeri.get())
                
            else:
                self.lbl_durum.config(text="HiÃ§ veri bulunamadÄ±", fg=self.colors['warning'])
                self.log_mesaj_ekle("âŒ HiÃ§ veri bulunamadÄ±!")
                
        except Exception as e:
            self.lbl_durum.config(text="Hata oluÅŸtu", fg=self.colors['danger'])
            self.log_mesaj_ekle(f"âŒ Beklenmeyen hata: {str(e)}")
            import traceback
            self.log_mesaj_ekle(f"ğŸ” Hata detayÄ±: {traceback.format_exc()}")
        finally:
            self.calisma_devam_ediyor = False

    def direk_id_isle(self, direk_id_serisi):
        """Direk ID sÃ¼tunundaki deÄŸerleri uygun tipe dÃ¶nÃ¼ÅŸtÃ¼rÃ¼r ve '-' iÅŸaretlerini temizler"""
        try:
            islenmis_degerler = []
            
            for deger in direk_id_serisi:
                # NaN veya boÅŸ deÄŸer kontrolÃ¼
                if pd.isna(deger) or deger == '' or deger is None:
                    islenmis_degerler.append('')
                    continue
                
                # String'e Ã§evir
                deger_str = str(deger).strip()
                
                # EÄŸer boÅŸ string ise
                if not deger_str:
                    islenmis_degerler.append('')
                    continue
                
                # YENÄ°: "-" iÅŸaretini temizle (sondaki ve baÅŸtaki)
                deger_str = deger_str.rstrip('-').lstrip('-')
                
                # EÄŸer temizleme sonrasÄ± boÅŸ string oluÅŸtuysa
                if not deger_str:
                    islenmis_degerler.append('')
                    continue
                
                # Rakam ile baÅŸlÄ±yorsa sayÄ±ya Ã§evirmeye Ã§alÄ±ÅŸ
                if deger_str[0].isdigit():
                    try:
                        # Nokta veya virgÃ¼l iÃ§eriyor mu kontrol et (float olabilir)
                        if '.' in deger_str or ',' in deger_str:
                            # Float'a Ã§evir, sonra integer'a Ã§evirmeye Ã§alÄ±ÅŸ
                            float_deger = float(deger_str.replace(',', '.'))
                            # EÄŸer tam sayÄ± ise integer'a Ã§evir
                            if float_deger.is_integer():
                                islenmis_degerler.append(int(float_deger))
                            else:
                                islenmis_degerler.append(float_deger)
                        else:
                            # DoÄŸrudan integer'a Ã§evir
                            islenmis_degerler.append(int(deger_str))
                    except (ValueError, TypeError):
                        # SayÄ±ya Ã§evrilemezse orijinal string deÄŸeri kullan (temizlenmiÅŸ hali)
                        islenmis_degerler.append(deger_str)
                else:
                    # Metin ile baÅŸlÄ±yorsa string olarak sakla (temizlenmiÅŸ hali)
                    islenmis_degerler.append(deger_str)
            
            return islenmis_degerler
            
        except Exception as e:
            self.log_mesaj_ekle(f"âš ï¸ Direk ID iÅŸleme hatasÄ±: {str(e)}")
            # Hata durumunda orijinal seriyi dÃ¶ndÃ¼r
            return direk_id_serisi

            
if __name__ == "__main__":
    root = tk.Tk()
    app = AnaUygulama(root)
    root.mainloop()
