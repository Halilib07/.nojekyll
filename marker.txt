import sys
import os
import time
import shutil
from math import radians, sin, cos, sqrt, atan2
from pathlib import Path
from urllib.parse import urlparse, unquote  # â­ EKLEDÄ°K

import piexif
from PIL import Image, ImageQt

from openpyxl import load_workbook, Workbook

from PyQt6.QtCore import Qt, QPoint, QPointF, QUrl
from PyQt6.QtGui import QIcon, QPixmap, QPainter, QPen, QColor, QImage, QFont, QCursor
from PyQt6.QtWidgets import (
    QApplication, QMainWindow, QWidget, QVBoxLayout, QHBoxLayout,
    QPushButton, QFileDialog, QLabel, QGroupBox, QInputDialog,
    QMessageBox, QScrollArea, QProgressBar, QSpinBox, QDialog, QColorDialog,
    QLineEdit, QComboBox, QListWidget
)
from PyQt6.QtWebEngineWidgets import QWebEngineView
from PyQt6.QtWebEngineCore import QWebEngineSettings
from PIL.ExifTags import TAGS
from PyQt6.QtWidgets import QButtonGroup, QRadioButton, QFrame, QLabel

# EXIF'ten GPS alma
def dms_to_deg(dms, ref):
    deg = dms[0][0] / dms[0][1]
    minute = dms[1][0] / dms[1][1]
    second = dms[2][0] / dms[2][1]
    result = deg + (minute / 60.0) + (second / 3600.0)
    if ref in ['S', 'W']:
        result *= -1
    return result

def exif_tarih_al(exif):
    if not exif:
        return None
    for tag_id, value in exif.items():
        tag = TAGS.get(tag_id, tag_id)
        if tag == 'DateTimeOriginal':
            return value
    return None

def get_gps_from_image(image_path):
    try:
        exif_data = piexif.load(image_path)
        gps_data = exif_data.get("GPS", {})
        if 2 in gps_data and 4 in gps_data:
            lat = dms_to_deg(gps_data[2], gps_data[1].decode())
            lon = dms_to_deg(gps_data[4], gps_data[3].decode())
            return lat, lon
    except Exception as e:
        print(f"EXIF HatasÄ± ({image_path}): {e}")
    return None

class DroneHarita(QMainWindow):
    def __init__(self):
        super().__init__()
        self.setWindowTitle("Drone Tespit Ä°ÅŸleme ProgramÄ±")
        self.resize(1200, 700)

        self.photo_info = []  # ğŸ“· FotoÄŸraflar listesi
        self.direkler = []    # ğŸ—ï¸ Direkler listesi

        # Sabit harita yolu
        user_dir = os.path.expanduser("~")
        self.drone_dir = os.path.join(user_dir, "Desktop", "Drone")
        self.map_path = os.path.join(self.drone_dir, "map.html")
        
        # Ä°kon yolunu belirle
        icon_yolu = os.path.join(self.drone_dir, "icons", "icon.png")
        self.setWindowIcon(QIcon(icon_yolu))

        # Direk verilerini oku
        self.direk_data = oku_direkler(os.path.join(self.drone_dir, "direk_og.xlsx"))
        self.direk_data += oku_direkler_musterek(os.path.join(self.drone_dir, "direk_musterek.xlsx"))

        # WebView oluÅŸtur ve direklerle birlikte haritayÄ± yÃ¼kle
        self.view = QWebEngineView()
        self.view.settings().setAttribute(QWebEngineSettings.WebAttribute.LocalContentCanAccessRemoteUrls, True)
        self.view.settings().setAttribute(QWebEngineSettings.WebAttribute.LocalContentCanAccessFileUrls, True)
        self.view.settings().setAttribute(QWebEngineSettings.WebAttribute.JavascriptEnabled, True)
        self.view.settings().setAttribute(QWebEngineSettings.WebAttribute.LocalStorageEnabled, True)
        self.view.settings().setAttribute(QWebEngineSettings.WebAttribute.AllowRunningInsecureContent, True)
        self.view.settings().setAttribute(QWebEngineSettings.WebAttribute.Accelerated2dCanvasEnabled, True)
        self.view.settings().setAttribute(QWebEngineSettings.WebAttribute.WebGLEnabled, True)
        self.view.settings().setAttribute(QWebEngineSettings.WebAttribute.JavascriptCanAccessClipboard, True)
        self.view.settings().setAttribute(QWebEngineSettings.WebAttribute.PluginsEnabled, False)

        # Ã–nbellek aktif
        self.view.page().profile().setHttpCacheType(self.view.page().profile().HttpCacheType.DiskHttpCache)
        self.view.page().profile().setPersistentStoragePath(os.path.join(self.drone_dir, "webcache"))

        # Direklerle harita oluÅŸtur (fotoÄŸraf olmadan)
        self.direklerle_harita_olustur()
        
        # Sol panel (buton ve label'lar)
        sol_panel = QWidget()
        sol_layout = QVBoxLayout(sol_panel)
        sol_panel.setFixedWidth(200)

        # âœˆï¸ DRONE GRUBU
        drone_group = QGroupBox("âœˆï¸ Drone")
        drone_layout = QVBoxLayout(drone_group)
        self.drone_kayit_klasoru = ""

        # ğŸ“‚ FotoÄŸraflarÄ± YÃ¼kle
        self.yukle_buton = QPushButton("ğŸ“‚ FotoÄŸraflarÄ± YÃ¼kle")
        self.yukle_buton.clicked.connect(self.fotograflari_yukle)
        drone_layout.addWidget(self.yukle_buton)

        # ğŸ“‚ FotoÄŸraf KlasÃ¶rlerini BirleÅŸtir
        self.birlestir_buton = QPushButton("ğŸ”— KlasÃ¶rleri BirleÅŸtir")
        self.birlestir_buton.clicked.connect(self.fotograf_klasorlerini_birlestir)
        drone_layout.addWidget(self.birlestir_buton)

        # â• Direk Ekle
        self.direk_ekle_buton = QPushButton("â• Direk Ekle")
        self.direk_ekle_buton.clicked.connect(self.direk_ekleme_modunu_aktif_et)
        drone_layout.addWidget(self.direk_ekle_buton)

        # ğŸ¨ Foto Editor
        self.foto_editor_buton = QPushButton("ğŸ¨ Foto Editor")
        self.foto_editor_buton.clicked.connect(self.foto_editoru_ac)
        drone_layout.addWidget(self.foto_editor_buton)

        self.en_yakina_isle_buton = QPushButton("ğŸ“ En YakÄ±na Ä°ÅŸle")
        self.en_yakina_isle_buton.clicked.connect(self.en_yakina_isle)
        self.en_yakina_isle_buton.setEnabled(False)  # ğŸš« BaÅŸlangÄ±Ã§ta kapalÄ±
        drone_layout.addWidget(self.en_yakina_isle_buton)

        # ğŸ“ KayÄ±t DosyasÄ±nÄ± SeÃ§
        self.kayit_klasoru_buton = QPushButton("ğŸ“ KayÄ±t DosyasÄ±nÄ± SeÃ§")
        self.kayit_klasoru_buton.clicked.connect(self.drone_kayit_klasoru_sec)
        drone_layout.addWidget(self.kayit_klasoru_buton)

        # ğŸ”„ Harita YÃ¼kleniyor BarÄ±
        self.harita_yukleme_bar = QProgressBar()
        self.harita_yukleme_bar.setVisible(False)
        self.harita_yukleme_bar.setMaximum(0)  # Belirsiz ilerleme modu
        self.harita_yukleme_bar.setMinimum(0)
        drone_layout.addWidget(self.harita_yukleme_bar)

        # ğŸ“ SeÃ§ilen KayÄ±t KlasÃ¶rÃ¼ Label
        self.kayit_label = QLabel("ğŸ“ SeÃ§ilen kayÄ±t klasÃ¶rÃ¼: HenÃ¼z seÃ§ilmedi")
        self.kayit_label.setWordWrap(True)
        drone_layout.addWidget(self.kayit_label)

        # ğŸ’¾ Kaydet
        self.kaydet_buton = QPushButton("ğŸ’¾ Kaydet")
        self.kaydet_buton.clicked.connect(self.kaydet)
        drone_layout.addWidget(self.kaydet_buton)

        # ğŸ”’ BaÅŸlangÄ±Ã§ta bazÄ± butonlarÄ± pasif yap
        # Sadece foto editor ve en yakÄ±na iÅŸle butonlarÄ± pasif, diÄŸerleri aktif
        self.foto_editor_buton.setEnabled(False)
        self.en_yakina_isle_buton.setEnabled(False)
        # Direk ekleme ve kayÄ±t butonlarÄ± aktif (Ã§Ã¼nkÃ¼ direkler yÃ¼klendi)
        self.direk_ekle_buton.setEnabled(True)
        self.kayit_klasoru_buton.setEnabled(True)
        self.kaydet_buton.setEnabled(True)

        # âœˆï¸ Grubu genel sol panele ekle
        sol_layout.addWidget(drone_group)

        # --- RESÄ°M KÃœÃ‡ÃœLTME PANELÄ° ---
        resim_kucultme_grup = QGroupBox("ğŸ–¼ï¸ FotoÄŸraf KÃ¼Ã§Ã¼ltme")
        resim_kucultme_layout = QVBoxLayout(resim_kucultme_grup)

        self.foto_klasor = ""
        self.kayit_klasor = ""

        btn_foto_klasor = QPushButton("ğŸ“‚ FotoÄŸraf KlasÃ¶rÃ¼ SeÃ§")
        btn_foto_klasor.clicked.connect(self.fotograf_klasoru_sec)
        resim_kucultme_layout.addWidget(btn_foto_klasor)

        self.foto_klasor_label = QLabel("ğŸ“ SeÃ§ilmedi")
        self.foto_klasor_label.setWordWrap(True)
        resim_kucultme_layout.addWidget(self.foto_klasor_label)

        btn_kayit_klasor = QPushButton("ğŸ’¾ KayÄ±t KlasÃ¶rÃ¼ SeÃ§")
        btn_kayit_klasor.clicked.connect(self.foto_kayit_klasoru_sec)
        resim_kucultme_layout.addWidget(btn_kayit_klasor)

        self.kayit_klasor_label = QLabel("ğŸ“ SeÃ§ilmedi")
        self.kayit_klasor_label.setWordWrap(True)
        resim_kucultme_layout.addWidget(self.kayit_klasor_label)
        
        self.kucultme_bar = QProgressBar()
        self.kucultme_bar.setVisible(False)               # BaÅŸta gizli
        self.kucultme_bar.setMaximum(100)                 # GeÃ§eri deÄŸer
        self.kucultme_bar.setValue(0)
        self.kucultme_bar.setFormat("%p%")
        resim_kucultme_layout.addWidget(self.kucultme_bar)

        self.btn_kucult = QPushButton("â–¶ï¸ KÃ¼Ã§Ã¼ltmeye BaÅŸla")
        self.btn_kucult.clicked.connect(self.kucultmeyi_baslat)
        resim_kucultme_layout.addWidget(self.btn_kucult)

        sol_layout.addWidget(resim_kucultme_grup)

        # Ana dÃ¼zen
        merkez_widget = QWidget()
        genel_layout = QHBoxLayout(merkez_widget)
        genel_layout.addWidget(sol_panel)
        genel_layout.addWidget(self.view)
        self.setCentralWidget(merkez_widget)
        
    def direklerle_harita_olustur(self):
        """Sadece direklerle harita oluÅŸtur (fotoÄŸraf olmadan)"""
        if not self.direk_data:
            # EÄŸer direk verisi yoksa, boÅŸ harita oluÅŸtur
            with open(self.map_path, "w", encoding="utf-8") as f:
                f.write("""
                <html>
                <head>
                    <title>Drone HaritasÄ±</title>
                    <style>
                        body { margin: 0; padding: 0; }
                        #map { height: 100vh; }
                    </style>
                </head>
                <body>
                    <div id="map"></div>
                    <script>
                        var map = L.map('map').setView([41.0082, 28.9784], 13);
                        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                            maxZoom: 19,
                            attribution: '&copy; OpenStreetMap contributors'
                        }).addTo(map);
                    </script>
                </body>
                </html>
                """)
            self.view.load(QUrl.fromLocalFile(os.path.abspath(self.map_path)))
            return
        
        # Direklerle harita oluÅŸtur - parametre olmadan (varsayÄ±lan sabit koordinatlar kullanÄ±lacak)
        create_map([], self.direk_data, self.map_path)
        self.view.load(QUrl.fromLocalFile(os.path.abspath(self.map_path)))
        
        # Direkleri kaydet
        self.direkler = self.direk_data.copy()

    def tum_fotolari_disari_al(self):
        """TÃ¼m direklerden tÃ¼m fotoÄŸraflarÄ± dÄ±ÅŸarÄ± Ã§Ä±karÄ±r"""
        from PyQt6.QtWidgets import QMessageBox
        
        msg = QMessageBox(self)
        msg.setWindowTitle("Toplu Ã‡Ä±karma")
        msg.setText("TÃ¼m direklerden TÃœM fotoÄŸraflarÄ± dÄ±ÅŸarÄ± Ã§Ä±karmak istediÄŸinize emin misiniz?")
        msg.setIcon(QMessageBox.Icon.Question)
        msg.setStandardButtons(QMessageBox.StandardButton.Yes | QMessageBox.StandardButton.No)
        msg.setDefaultButton(QMessageBox.StandardButton.No)
        
        if msg.exec() == QMessageBox.StandardButton.No:
            return
        
        js_kod = """
        (function() {
            // TÃ¼m direklerden fotoÄŸraflarÄ± topla
            const tumFotograflar = [];
            direkler.forEach(direk => {
                if (direk.photos && direk.photos.length > 0) {
                    direk.photos.forEach(foto => {
                        tumFotograflar.push({
                            path: foto.path,
                            direk_id: direk.id,
                            note: foto.note || ""
                        });
                    });
                    // DireÄŸi temizle
                    direk.photos = [];
                    if (direk.numara) {
                        direk.numara = null;
                    }
                }
            });
            
            // Her fotoÄŸrafÄ± eski yerine geri dÃ¶ndÃ¼r
            tumFotograflar.forEach(foto => {
                const dosyaAdi = foto.path.split('/').pop().split('\\\\').pop().toLowerCase();
                const photoInfoObj = photoInfo.find(p => {
                    const pFile = p.path.split('/').pop().split('\\\\').pop().toLowerCase();
                    return pFile === dosyaAdi;
                });
                
                if (photoInfoObj) {
                    const lat = photoInfoObj.originalLat !== undefined ? photoInfoObj.originalLat : photoInfoObj.lat;
                    const lon = photoInfoObj.originalLon !== undefined ? photoInfoObj.originalLon : photoInfoObj.lon;
                    
                    // FotoÄŸrafÄ± haritaya geri ekle
                    var markerClass = "photo-marker " + (photoInfoObj.note ? "photo-turkuaz" : "photo-mavi");

                    var marker = L.marker([lat, lon], {
                        draggable: true,
                        icon: L.divIcon({
                            className: markerClass,
                            iconSize: [13, 13]
                        })
                    }).bindPopup(getPhotoPopupHTML(photoInfoObj.path, photoInfoObj.note), {
                        maxWidth: 420,
                        minWidth: 400,
                        autoPan: true,
                        className: 'custom-popup'
                    });

                    // Ã‡ift tÄ±k event'i ekle
                    marker.on("dblclick", function(e) {
                        e.originalEvent.preventDefault();
                        e.originalEvent.stopPropagation();
                        
                        var pos = e.target.getLatLng();
                        var hedefDirek = null;
                        var enKisaMesafe = Infinity;

                        direkler.forEach(function(d) {
                            var mesafe = map.distance(pos, L.latLng(d.lat, d.lon));
                            if (mesafe < 40 && mesafe < enKisaMesafe) {
                                hedefDirek = d;
                                enKisaMesafe = mesafe;
                            }
                        });

                        if (hedefDirek) {
                            var zatenVar = hedefDirek.photos.some(p => p.path === photoInfoObj.path);
                            if (zatenVar) {
                                L.popup()
                                    .setLatLng(pos)
                                    .setContent("â›” AynÄ± fotoÄŸraf zaten bu direÄŸe eklenmiÅŸ")
                                    .openOn(map);
                                return;
                            }

                            const notDegeri = photoInfoObj.note || "";
                            const kategori = photoInfoObj.kategori || "";
                            const oncelik = photoInfoObj.oncelik || "Bekleyebilir";
                            const birim = photoInfoObj.birim || "Aob";

                            hedefDirek.photos.push({
                                path: photoInfoObj.path,
                                note: notDegeri,
                                kategori: kategori,
                                oncelik: oncelik,
                                birim: birim
                            });

                            if (typeof hedefDirek.numara === 'undefined' || hedefDirek.numara === null) {
                                const kullanÄ±lanNumaralar = direkler
                                    .filter(d => typeof d.numara === 'number')
                                    .map(d => d.numara);
                                let yeniNumara = 1;
                                while (kullanÄ±lanNumaralar.includes(yeniNumara)) {
                                    yeniNumara++;
                                }
                                hedefDirek.numara = yeniNumara;
                            }

                            guncellePopup(hedefDirek);
                            map.removeLayer(marker);
                            
                            var successPopup = L.popup()
                                .setLatLng(pos)
                                .setContent("âœ… En yakÄ±n direÄŸe eklendi: " + hedefDirek.id)
                                .openOn(map);

                            setTimeout(function() {{
                                map.closePopup(successPopup);
                            }}, 750);
                                
                        } else {
                            L.popup()
                                .setLatLng(pos)
                                .setContent("âš ï¸ 40 metre iÃ§inde direk bulunamadÄ±")
                                .openOn(map);
                        }
                    });

                    marker.on("popupopen", function() {
                        bindNoteInput(photoInfoObj.path);
                    });

                    marker.on("dragend", function(e) {
                        var pos = e.target.getLatLng();
                        var hedefDirek = null;
                        var enKisaMesafe = Infinity;

                        direkler.forEach(function(d) {
                            var mesafe = map.distance(pos, L.latLng(d.lat, d.lon));
                            if (mesafe < 8 && !d.photos.find(p => p.path === photoInfoObj.path) && mesafe < enKisaMesafe) {
                                hedefDirek = d;
                                enKisaMesafe = mesafe;
                            }
                        });

                        if (hedefDirek) {
                            const notDegeri = photoInfoObj.note || "";
                            hedefDirek.photos.push({ path: photoInfoObj.path, note: notDegeri });

                            if (typeof hedefDirek.numara === 'undefined' || hedefDirek.numara === null) {
                                const kullanÄ±lanNumaralar = direkler
                                    .filter(d => typeof d.numara === 'number')
                                    .map(d => d.numara);
                                let yeniNumara = 1;
                                while (kullanÄ±lanNumaralar.includes(yeniNumara)) {
                                    yeniNumara++;
                                }
                                hedefDirek.numara = yeniNumara;
                            }

                            guncellePopup(hedefDirek);
                            map.removeLayer(marker);
                        }
                    });

                    photoInfoObj.marker = marker;
                    map.addLayer(marker);
                }
            });
            
            // Direk popuplarÄ±nÄ± gÃ¼ncelle
            direkler.forEach(d => guncellePopup(d));
            
            return tumFotograflar.length;
        })();
        """
        
        def js_sonucu(islenen_sayi):
            if islenen_sayi > 0:
                QMessageBox.information(self, "Ä°ÅŸlem Tamam", 
                    f"âœ… {islenen_sayi} fotoÄŸraf baÅŸarÄ±yla tÃ¼m direklerden Ã§Ä±karÄ±ldÄ± ve haritaya geri eklendi.")
            else:
                QMessageBox.information(self, "FotoÄŸraf Yok", 
                    "âš ï¸ HiÃ§ fotoÄŸraf baÄŸlÄ± deÄŸil.")
        
        self.view.page().runJavaScript(js_kod, js_sonucu)

    def mesafe_hesapla(self, lat1, lon1, lat2, lon2):
        R = 6371000  # DÃ¼nya yarÄ±Ã§apÄ± (metre)
        phi1 = radians(lat1)
        phi2 = radians(lat2)
        dphi = radians(lat2 - lat1)
        dlambda = radians(lon2 - lon1)

        a = sin(dphi/2)**2 + cos(phi1)*cos(phi2)*sin(dlambda/2)**2
        c = 2 * atan2(sqrt(a), sqrt(1-a))

        return R * c  # sonucu metre cinsinden verir

    def en_yakina_isle(self):
        js_kod = """
            (function() {
                return {
                    photoInfo: photoInfo.map(p => {
                        let pos = (p.marker && p.marker.getLatLng) ? p.marker.getLatLng() : { lat: p.lat, lng: p.lon };
                        return [p.path, pos.lat, pos.lng, p.note || ""];
                    }),
                    direkler: direkler.map(d => ({
                        id: d.id,
                        lat: d.lat,
                        lon: d.lon,
                        tip: d.tip,
                        numara: d.numara || null,
                        photos: d.photos || []
                    }))
                };
            })();
        """
        self.view.page().runJavaScript(js_kod, self.en_yakina_isle_guncelle)

    def en_yakina_isle_guncelle(self, veri):
        from PyQt6.QtWidgets import QMessageBox
        import os
        from pathlib import Path

        self.direkler = veri["direkler"]
        updated_photo_info = veri["photoInfo"]
        self.photo_info = updated_photo_info

        if not updated_photo_info or not self.direkler:
            QMessageBox.warning(self, "Veri Eksik", "âš ï¸ FotoÄŸraf veya direk verisi eksik!")
            return

        otomatik_iliskilenen = 0
        manuel_gereken = 0
        kontrol_edilecek = []

        for foto_path, foto_lat, foto_lon, note in updated_photo_info:
            if foto_lat is None or foto_lon is None:
                print(f"âš ï¸ AtlanÄ±yor (konum yok): {foto_path}")
                continue

            yakin_direkler = []
            for direk in self.direkler:
                lat = direk.get("lat")
                lon = direk.get("lon")
                if lat is None or lon is None:
                    continue

                mesafe = self.mesafe_hesapla(foto_lat, foto_lon, lat, lon)
                if mesafe <= 10:
                    yakin_direkler.append((mesafe, direk))

            yakin_direkler.sort(key=lambda x: x[0])

            if len(yakin_direkler) == 1:
                secilen_direk = yakin_direkler[0][1]
                kontrol_edilecek.append((foto_path, secilen_direk))
            elif len(yakin_direkler) > 1:
                manuel_gereken += 1

        def devam_et_kontrol(kalanlar, index=0):
            if index >= len(kalanlar):
                js_say = """
                    (function() {
                        return photoInfo.filter(p => p.marker && map.hasLayer(p.marker)).length;
                    })();
                """
                def goster_sayiyi(toplam_kalan):
                    QMessageBox.information(self, "Ä°ÅŸlem Tamam",
                        f"âœ… {otomatik_iliskilenen} fotoÄŸraf otomatik iliÅŸtirildi.\n"
                        f"âš ï¸ {manuel_gereken} fotoÄŸraf manuel iliÅŸtirilmeli.\n"
                        f"ğŸ—‚ï¸ Toplam iliÅŸtirilmemiÅŸ kalan: {toplam_kalan}")
                self.view.page().runJavaScript(js_say, goster_sayiyi)

                self.view.page().runJavaScript("guncellePopuplar();")
                return
    
            foto_path, direk = kalanlar[index]
            foto_filename = os.path.basename(foto_path)
            path_url = Path(foto_path).as_uri()

            js_kontrol = f"""
                (function() {{
                    const d = direkler.find(dd => dd.id === "{direk['id']}");
                    const file = "{foto_filename}".toLowerCase();
                    if (!d || !d.photos) return false;
                    return !d.photos.some(p => p.path.split('/').pop().split('\\\\').pop().toLowerCase() === file);
                }})();
            """

            def handle_kontrol(result):
                nonlocal otomatik_iliskilenen
                if result:
                    if "photos" not in direk:
                        direk["photos"] = []

                    tarih = None
                    for p in self.photo_info:
                        if len(p) >= 4 and p[0] == foto_path:
                            tarih = p[3]
                            break

                    direk["photos"].append({"path": foto_path, "note": note, "tarih": tarih})
                    otomatik_iliskilenen += 1

                    self.view.page().runJavaScript(f"""
                        (function() {{
                            const filename = "{foto_filename}";
                            const p = photoInfo.find(p => p.path.split('/').pop().split('\\\\').pop().toLowerCase() === filename.toLowerCase());
                            if (p) {{
                                if (p.marker && map.hasLayer(p.marker)) {{
                                    map.removeLayer(p.marker);
                                }}
                                if (p.originalLat !== undefined && p.originalLon !== undefined) {{
                                    p.lat = p.originalLat;
                                    p.lon = p.originalLon;
                                }}
                                p.marker = null;
                            }}
                        }})();
                    """)
                    self.view.page().runJavaScript(f'addPhotoToDirek("{direk["id"]}", "{path_url}")')

                devam_et_kontrol(kalanlar, index + 1)

            self.view.page().runJavaScript(js_kontrol, handle_kontrol)

        devam_et_kontrol(kontrol_edilecek)
    
    def fotograf_klasorlerini_birlestir(self):
        klasor_listesi = []

        # ğŸ“œ KÃ¼Ã§Ã¼k pencere (QDialog) oluÅŸtur
        dialog = QDialog(self)
        dialog.setWindowTitle("SeÃ§ilen KlasÃ¶rler")
        layout = QVBoxLayout(dialog)
        klasor_list_widget = QListWidget()
        layout.addWidget(klasor_list_widget)
        bilgi_label = QPushButton("Devam etmek iÃ§in baÅŸka klasÃ¶r seÃ§in veya pencereyi kapatÄ±n.")
        bilgi_label.setEnabled(False)
        layout.addWidget(bilgi_label)
        dialog.resize(500, 300)
        dialog.show()

        while True:
            klasor = QFileDialog.getExistingDirectory(self, "FotoÄŸraf KlasÃ¶rÃ¼ SeÃ§in")
            if klasor:
                klasor_listesi.append(klasor)
                klasor_list_widget.addItem(klasor)

                # Devam etmek istiyor musun? (Evet/HayÄ±r sorusu)
                msg = QMessageBox(self)
                msg.setWindowTitle("Devam?")
                msg.setText("BaÅŸka klasÃ¶r eklemek ister misiniz?")
                evet_buton = msg.addButton("Evet", QMessageBox.ButtonRole.YesRole)
                hayir_buton = msg.addButton("HayÄ±r", QMessageBox.ButtonRole.NoRole)
                msg.exec()

                if msg.clickedButton() == hayir_buton:
                    break
            else:
                break

        dialog.close()

        if not klasor_listesi:
            QMessageBox.warning(self, "Ä°ÅŸlem Ä°ptal", "âš ï¸ HiÃ§ klasÃ¶r seÃ§ilmedi.")
            return

        # FotoÄŸraflarÄ± topla
        foto_liste = []
        uzantilar = (".jpg", ".jpeg", ".png", ".bmp", ".webp", ".tif", ".tiff")

        for klasor in klasor_listesi:
            for root, _, files in os.walk(klasor):
                for file in files:
                    if file.lower().endswith(uzantilar):
                        tam_yol = os.path.join(root, file)

                        try:
                            exif = piexif.load(tam_yol)
                            tarih = exif['Exif'][piexif.ExifIFD.DateTimeOriginal].decode()
                        except Exception:
                            tarih = time.ctime(os.path.getctime(tam_yol))

                        foto_liste.append((tam_yol, tarih))

        if not foto_liste:
            QMessageBox.warning(self, "FotoÄŸraf Yok", "âš ï¸ SeÃ§ilen klasÃ¶rlerde uygun fotoÄŸraf bulunamadÄ±.")
            return

        # Tarihe gÃ¶re sÄ±rala
        foto_liste.sort(key=lambda x: x[1])

        # KullanÄ±cÄ±dan yeni klasÃ¶r seÃ§
        hedef_klasor = QFileDialog.getExistingDirectory(self, "BirleÅŸen FotoÄŸraflarÄ±n KaydedileceÄŸi KlasÃ¶rÃ¼ SeÃ§in")
        if not hedef_klasor:
            QMessageBox.warning(self, "Ä°ÅŸlem Ä°ptal", "âš ï¸ KlasÃ¶r seÃ§ilmedi.")
            return

        # KullanÄ±cÄ±dan isim kÃ¶kÃ¼ al
        isim_koku, ok = QInputDialog.getText(self, "Proje", "Tarama YapÄ±lan Projenin Ä°smini Girin:")
        if not ok or not isim_koku.strip():
            QMessageBox.warning(self, "Ä°ÅŸlem Ä°ptal", "âš ï¸ FotoÄŸraf ismi girilmedi.")
            return
        isim_koku = isim_koku.strip()

        # Åimdi kopyala ve sÄ±rala
        for i, (kaynak_yol, _) in enumerate(foto_liste, start=1):
            uzanti = os.path.splitext(kaynak_yol)[1]  # .jpg, .png gibi
            hedef_yol = os.path.join(hedef_klasor, f"{isim_koku}_{i}{uzanti}")
            try:
                shutil.copy2(kaynak_yol, hedef_yol)
                print(f"âœ… {kaynak_yol} â†’ {hedef_yol}")
            except Exception as e:
                print(f"âŒ Hata: {kaynak_yol} â†’ {e}")

        QMessageBox.information(self, "Ä°ÅŸlem Tamam", f"âœ… {len(foto_liste)} fotoÄŸraf baÅŸarÄ±yla birleÅŸtirildi.")

        # Åimdi sor: Haritaya iÅŸlemek ister misin?
        msg2 = QMessageBox(self)
        msg2.setWindowTitle("Harita YÃ¼kleme")
        msg2.setText("ğŸ“ BirleÅŸen fotoÄŸraflarÄ± haritaya yÃ¼klemek ister misiniz?")
        evet_buton2 = msg2.addButton("Evet", QMessageBox.ButtonRole.YesRole)
        hayir_buton2 = msg2.addButton("HayÄ±r", QMessageBox.ButtonRole.NoRole)
        msg2.exec()

        if msg2.clickedButton() == evet_buton2:
            self.birlestirilen_fotograflari_yukle(hedef_klasor)

    def birlestirilen_fotograflari_yukle(self, klasor):
        uzantilar = (".jpg", ".jpeg", ".png", ".bmp", ".webp", ".tif", ".tiff")
        photo_data = []

        dosyalar = os.listdir(klasor)
        for dosya in dosyalar:
            if dosya.lower().endswith(uzantilar):
                tam_yol = os.path.join(klasor, dosya)
                gps = get_gps_from_image(tam_yol)
                tarih = None
                try:
                    img = Image.open(tam_yol)
                    exif = img._getexif()
                    tarih = exif_tarih_al(exif)
                except:
                    pass

                if gps:
                    photo_data.append((tam_yol, gps[0], gps[1], tarih))
                else:
                    print(f"âš ï¸ GPS yok: {tam_yol}")

        if not photo_data:
            QMessageBox.warning(self, "GPS Yok", "âš ï¸ GPS verisi bulunamadÄ±.")
            return

        create_map(photo_data, self.direk_data, self.map_path)
        self.view.load(QUrl.fromLocalFile(os.path.abspath(self.map_path)))
        # âœ… Map yÃ¼klenince butonlar aktif olsun
        self.direk_ekle_buton.setEnabled(True)
        self.foto_editor_buton.setEnabled(True)
        self.kayit_klasoru_buton.setEnabled(True)
        self.kaydet_buton.setEnabled(True)
        self.en_yakina_isle_buton.setEnabled(True)

        self.photo_info = photo_data
        self.direkler = self.direk_data.copy()
    
        QMessageBox.information(self, "Harita YÃ¼klendi", "âœ… BirleÅŸen fotoÄŸraflar haritaya iÅŸlendi.")
        
    def foto_editoru_ac(self):
        if not hasattr(self, 'view') or not self.view:
            QMessageBox.warning(self, "Harita Yok", "ğŸ“ Ã–nce fotoÄŸraflarÄ± yÃ¼klemelisiniz!")
            return

        # FotoÄŸraf verilerini path + note + tarih + kategori + oncelik olarak al
        js_kod = """
        (function() {
            return photoInfo.map(p => ({
                path: p.path,
                note: p.note || "",
                tarih: p.tarih || "",
                kategori: p.kategori || "",
                oncelik: p.oncelik || "Bekleyebilir"
            }));
        })();
        """
        self.view.page().runJavaScript(js_kod, self.foto_editor_penceresini_ac)

    def foto_editor_penceresini_ac(self, foto_verileri):
        if not foto_verileri:
            QMessageBox.warning(self, "FotoÄŸraf Yok", "âš ï¸ HenÃ¼z YÃ¼klenmiÅŸ fotoÄŸraf yok!")
            return

        # ğŸ•’ Tarihe gÃ¶re sÄ±rala (eskiden yeniye)
        foto_verileri.sort(key=lambda x: x["tarih"])

        # ArtÄ±k kategori ve oncelik zaten geldiÄŸi iÃ§in ek bir ÅŸey yapmana gerek yok
        FotoEditorViewer(foto_verileri, view=self.view, parent=self).show()

    def direk_ekleme_modunu_aktif_et(self):
        id_metni, ok = QInputDialog.getText(self, "Yeni Direk ID", "Yeni konulacak direÄŸin ID'sini yazÄ±nÄ±z:")
        
        if ok and id_metni.strip():
            temiz_id = id_metni.strip().replace("'", "").replace('"', '')

            js_kontrol = f"""
                (function(){{
                    return direkler.some(d => d.id === '{temiz_id}');
                }})();
            """

            def js_kontrol_sonucu(var_mi):
                if var_mi:
                    QMessageBox.warning(self, "ID Mevcut", f"âš ï¸ '{temiz_id}' ID'li direk zaten mevcut! BaÅŸka bir ID giriniz.")
                else:
                    js = f"""
                    setTimeout(function() {{
                        if (typeof map !== 'undefined') {{
                            map.once('click', function(e) {{
                                var yeniID = '{temiz_id}';
                                var popupHTML = `
                                    <b>Direk ID: ${{yeniID}}</b><br>
                                    <b>Tip:</b> (yeni)<br><br>
                                    <button onclick="kaldirDirek('${{yeniID}}')">ğŸ—‘ï¸ DireÄŸi KaldÄ±r</button>
                                `;

                                var marker = L.circleMarker(e.latlng, {{
                                    radius: 7,
                                    color: "#ff0000",
                                    weight: 1,
                                    fillColor: "#ff6666",
                                    fillOpacity: 0.9
                                }}).addTo(map);

                                var popup = L.popup().setContent(popupHTML);
                                marker.bindPopup(popup);

                                var yeniDirek = {{
                                    id: yeniID,
                                    tip: "(yeni)",
                                    lat: e.latlng.lat,
                                    lon: e.latlng.lng,
                                    marker: marker,
                                    popup: popup,
                                    photos: [],
                                    ozel: true,
                                    silinecek_mi: false,
                                    koordinat_degisecek_mi: false,
                                    konum_degistirme_modu: false
                                }};

                                direkler.push(yeniDirek);

                                if (!window.kaldirDirek) {{
                                    window.kaldirDirek = function(id) {{
                                        var index = direkler.findIndex(d => d.id === id);
                                        if (index !== -1) {{
                                            var d = direkler[index];
                                            map.removeLayer(d.marker);
                                            direkler.splice(index, 1);
                                            console.log("ğŸ—‘ï¸ Direk silindi:", id);
                                        }}
                                    }};
                                }}

                                console.log("âœ… Yeni direk eklendi ve belleÄŸe alÄ±ndÄ±:", yeniID);
                            }});
                        }} else {{
                            console.warn("âŒ Harita hazÄ±r deÄŸil");
                        }}
                    }}, 500);
                    """
                    self.view.page().runJavaScript(js)

            self.view.page().runJavaScript(js_kontrol, js_kontrol_sonucu)
        elif not ok:
            return  # âŒ Cancel'a basÄ±ldÄ±ysa sessizce Ã§Ä±k
        else:
            QMessageBox.warning(self, "GeÃ§ersiz ID", "âš ï¸ LÃ¼tfen geÃ§erli bir direk ID'si giriniz!")

    def fotograflari_yukle(self):
        klasor = QFileDialog.getExistingDirectory(self, "FotoÄŸraf KlasÃ¶rÃ¼ SeÃ§")
        if not klasor:
            return

        # ğŸ”¥ BaÅŸlangÄ±Ã§ zamanÄ± kaydet
        baslangic_zamani = time.perf_counter()

        # Loading bar gÃ¶ster
        self.harita_yukleme_bar.setVisible(True)
        QApplication.processEvents()

        # Desteklenen formatlar
        uzantilar = (".jpg", ".jpeg", ".png", ".tif", ".tiff", ".heic", ".bmp", ".webp")
        photo_data = []

        dosyalar = os.listdir(klasor)
        toplam = len(dosyalar)
        self.harita_yukleme_bar.setMaximum(toplam)
        self.harita_yukleme_bar.setValue(0)

        for i, dosya in enumerate(dosyalar):
            if dosya.lower().endswith(uzantilar):
                tam_yol = os.path.join(klasor, dosya)
                gps = get_gps_from_image(tam_yol)
                if gps:
                    tarih = None
                    try:
                        img = Image.open(tam_yol)
                        exif = img._getexif()
                        tarih = exif_tarih_al(exif)
                        print(f"ğŸ“¸ {dosya} â†’ {gps} ğŸ•’ {tarih}")
                    except Exception as e:
                        print(f"âŒ EXIF tarih alÄ±namadÄ±: {dosya} â†’ {e}")

                    photo_data.append((tam_yol, gps[0], gps[1], tarih))
                else:
                    print(f"âš ï¸ GPS yok: {dosya}")

            # BarÄ± gÃ¼ncelle
            self.harita_yukleme_bar.setValue(i + 1)
            QApplication.processEvents()

        if not photo_data:
            QMessageBox.warning(self, "GPS Verisi Yok", "âš ï¸ Uygun GPS verisine sahip fotoÄŸraf bulunamadÄ±.")
            self.harita_yukleme_bar.setVisible(False)
            return

        # ğŸ“ FotoÄŸraflarÄ±n tamamÄ±nÄ± gÃ¶sterecek ÅŸekilde harita konumunu ve zoom'u hesapla
        if photo_data:
            # TÃ¼m enlem ve boylamlarÄ± al
            lats = [float(photo[1]) for photo in photo_data]
            lons = [float(photo[2]) for photo in photo_data]
            
            # En uÃ§ noktalarÄ± bul
            min_lat = min(lats)
            max_lat = max(lats)
            min_lon = min(lons)
            max_lon = max(lons)
            
            # Merkez noktasÄ±nÄ± hesapla
            center_lat = (min_lat + max_lat) / 2
            center_lon = (min_lon + max_lon) / 2
            
            # Zoom seviyesini hesapla (basit bir yaklaÅŸÄ±m)
            lat_diff = max_lat - min_lat
            lon_diff = max_lon - min_lon
            max_diff = max(lat_diff, lon_diff)
            
            # Zoom seviyesini fark miktarÄ±na gÃ¶re belirle
            if max_diff < 0.001:
                zoom_level = 18  # 16'dan 18'e Ã§Ä±karÄ±ldÄ±
            elif max_diff < 0.005:
                zoom_level = 17  # 15'ten 17'ye Ã§Ä±karÄ±ldÄ±
            elif max_diff < 0.01:
                zoom_level = 16  # 14'ten 16'ya Ã§Ä±karÄ±ldÄ±
            elif max_diff < 0.05:
                zoom_level = 15  # 13'ten 15'e Ã§Ä±karÄ±ldÄ±
            elif max_diff < 0.1:
                zoom_level = 14  # 12'den 14'e Ã§Ä±karÄ±ldÄ±
            elif max_diff < 0.5:
                zoom_level = 13  # 11'den 13'e Ã§Ä±karÄ±ldÄ±
            else:
                zoom_level = 12  # 10'dan 12'ye Ã§Ä±karÄ±ldÄ±
                
            print(f"ğŸ“ FotoÄŸraf bazlÄ± harita ayarÄ±: Merkez={center_lat},{center_lon}, Zoom={zoom_level}")
        else:
            # FotoÄŸraf yoksa sabit koordinatlarÄ± kullan
            center_lat = 36.7300
            center_lon = 30.2000
            zoom_level = 9.8

        # HaritayÄ± Ã¼ret - fotoÄŸraf bazlÄ± koordinat ve zoom ile
        create_map(photo_data, self.direk_data, self.map_path, 
                   center_lat=center_lat, center_lon=center_lon, zoom_level=zoom_level)
        self.view.load(QUrl.fromLocalFile(os.path.abspath(self.map_path)))

        # Buraya ekle:
        self.direk_ekle_buton.setEnabled(True)
        self.foto_editor_buton.setEnabled(True)
        self.kayit_klasoru_buton.setEnabled(True)
        self.kaydet_buton.setEnabled(True)
        self.en_yakina_isle_buton.setEnabled(True)

        self.photo_info = photo_data
        self.direkler = self.direk_data.copy()

        # ğŸ”¥ BitiÅŸ zamanÄ± kaydet
        bitis_zamani = time.perf_counter()
        gecen_sure = bitis_zamani - baslangic_zamani

        # BarÄ± gizle ve kullanÄ±cÄ±ya bildir
        self.harita_yukleme_bar.setVisible(False)
        QMessageBox.information(self, "YÃ¼kleme TamamlandÄ±", 
            f"âœ… FotoÄŸraflar haritaya yÃ¼klendi!\n\nâ±ï¸ GeÃ§en SÃ¼re: {gecen_sure:.2f} saniye\nğŸ“ Harita konumu: fotoÄŸraflarÄ±n tamamÄ± gÃ¶rÃ¼necek ÅŸekilde ayarlandÄ±")

    def kaydet(self):
        try:
            if not self.drone_kayit_klasoru:
                QMessageBox.warning(self, "KlasÃ¶r SeÃ§ilmedi", "âš ï¸ LÃ¼tfen Ã¶nce drone kayÄ±t klasÃ¶rÃ¼nÃ¼ seÃ§iniz!")
                return

            # ğŸ†• KÃ¼Ã§Ã¼ltme seÃ§eneÄŸi diyalogu
            msg = QMessageBox(self)
            msg.setWindowTitle("KayÄ±t SeÃ§eneÄŸi")
            msg.setText("ğŸ“¸ FotoÄŸraflarÄ± nasÄ±l kaydetmek istiyorsunuz?")
            msg.setIcon(QMessageBox.Icon.Question)
            
            kucult_btn = msg.addButton("KÃ¼Ã§Ã¼lterek Kaydet", QMessageBox.ButtonRole.YesRole)
            orijinal_btn = msg.addButton("Orijinal Boyutta Kaydet", QMessageBox.ButtonRole.NoRole)
            iptal_btn = msg.addButton("Ä°ptal", QMessageBox.ButtonRole.RejectRole)
            
            msg.exec()
            
            if msg.clickedButton() == iptal_btn:
                print("ğŸš« KullanÄ±cÄ± iptal etti")
                return
            
            kuculterek_kaydet = msg.clickedButton() == kucult_btn
            print(f"ğŸ“ KayÄ±t seÃ§eneÄŸi: {'KÃ¼Ã§Ã¼lterek' if kuculterek_kaydet else 'Orijinal'}")

            js_kod = """
                (function(){
                    return {
                        direkFotoData: direkler.filter(d => d.photos.length > 0 || d.silinecek_mi).map(d => ({
                            id: d.id,
                            lat: d.lat,
                            lon: d.lon,
                            photos: d.photos.map(p => {
                                const fotoBilgisi = photoInfo.find(pi => {
                                    const piFile = pi.path.split('/').pop().split('\\\\').pop().toLowerCase();
                                    const pFile = p.path.split('/').pop().split('\\\\').pop().toLowerCase();
                                    return piFile === pFile;
                                });
                                const kategori = fotoBilgisi ? (fotoBilgisi.kategori || "") : "";
                                const oncelik  = fotoBilgisi ? (fotoBilgisi.oncelik || "Bekleyebilir") : "Bekleyebilir";
                                const birim    = fotoBilgisi ? (fotoBilgisi.birim || "Aob") : "Aob";
                                return {
                                    path: p.path,
                                    note: p.note || "",
                                    kategori: kategori,
                                    oncelik: oncelik,
                                    birim: birim
                                };
                            }),
                            numara: d.numara ?? null,
                            silinecek_mi: d.silinecek_mi || false
                        })),
                        iliskilenmeyenFotolari: photoInfo.filter(p => {
                            const ad = p.path.split('/').pop().split('\\\\').pop().toLowerCase();
                            return !direkler.flatMap(d => d.photos.map(p => p.path.split('/').pop().split('\\\\').pop().toLowerCase())).includes(ad);
                        }).map(p => p.path)
                    };
                })();
            """
            
            def js_sonucu_al(veri):
                try:
                    print("ğŸ“Š JavaScript'ten veri alÄ±ndÄ±")
                    direk_fotolari = veri["direkFotoData"]
                    iliskisiz_fotolar = veri["iliskilenmeyenFotolari"]
                    
                    # ğŸ”¥ YENÄ°: "KoordinatÄ± DeÄŸiÅŸecek" direklerin gÃ¼ncel koordinatlarÄ±nÄ± al
                    js_koordinat_kod = """
                    (function() {
                        return direkler.filter(d => d.koordinat_degisecek_mi).map(d => ({
                            id: d.id,
                            lat: d.lat,
                            lon: d.lon
                        }));
                    })();
                    """
                    
                    def koordinatlari_isle(guncel_koordinatlar):
                        # ğŸ”¥ Direk foto verilerini gÃ¼ncel koordinatlarla birleÅŸtir
                        for guncel in guncel_koordinatlar:
                            for direk in direk_fotolari:
                                if direk['id'] == guncel['id']:
                                    direk['lat'] = guncel['lat']
                                    direk['lon'] = guncel['lon']
                                    print(f"ğŸ“ Direk {direk['id']} koordinatlarÄ± gÃ¼ncellendi: {guncel['lat']}, {guncel['lon']}")
                        
                        # ğŸ”¥ ORÄ°JÄ°NAL KODUNUZUN DEVAMI
                        if not direk_fotolari:
                            QMessageBox.warning(self, "FotoÄŸraf Yok", "âš ï¸ HiÃ§bir direÄŸe fotoÄŸraf baÄŸlÄ± deÄŸil!")
                            return

                        def kopyalamaya_basla():
                            try:
                                print(f"ğŸ“ KayÄ±t klasÃ¶rÃ¼: {self.drone_kayit_klasoru}")
                                excel_yolu = os.path.join(self.drone_kayit_klasoru, "Tespit.xlsx")
                                print(f"ğŸ“— Excel dosyasÄ±: {excel_yolu}")
                                
                                wb = Workbook()
                                ws = wb.active
                                ws.append(["SÄ±ra No", "Direk ID", "Tespit Notu", "Tespit Kategorisi", "Ã–ncelik", "FotoÄŸraf Yolu", "Enlem", "Boylam", "Birim", "YapÄ±ldÄ± mÄ±?"])
                                
                                # Toplam fotoÄŸraf sayÄ±sÄ±nÄ± hesapla
                                total_fotos = sum(len(d.get('photos', [])) for d in direk_fotolari)
                                print(f"ğŸ“¸ Toplam fotoÄŸraf sayÄ±sÄ±: {total_fotos}")
                                
                                processed = 0
                                
                                for direk in direk_fotolari:
                                    direk_id = direk['id']
                                    lat = direk.get("lat", "")
                                    lon = direk.get("lon", "")
                                    foto_bilgileri = direk.get('photos', [])
                                    numara = direk.get("numara", "")
                                    silinecek_mi = direk.get("silinecek_mi", False)
                                    # ğŸ”¥ YENÄ°: Koordinat deÄŸiÅŸecek mi?
                                    koordinat_degisecek_mi = direk.get("koordinat_degisecek_mi", False)
                                    
                                    print(f"ğŸ—ï¸ Direk iÅŸleniyor: {direk_id}, Foto sayÄ±sÄ±: {len(foto_bilgileri)}")
                                    
                                    if foto_bilgileri:
                                        klasor_adi = f"{numara} - {direk_id}" if numara else direk_id
                                        hedef_klasor = os.path.join(self.drone_kayit_klasoru, klasor_adi)
                                        print(f"ğŸ“‚ KlasÃ¶r oluÅŸturuluyor: {hedef_klasor}")
                                        os.makedirs(hedef_klasor, exist_ok=True)
                                        
                                        for foto in foto_bilgileri:
                                            foto_yol = foto.get('path', '')
                                            if not foto_yol:
                                                print("âš ï¸ FotoÄŸraf yolu boÅŸ, atlanÄ±yor")
                                                continue
                                                
                                            foto_not = foto.get('note', '') or ""
                                            foto_birim = foto.get('birim', 'Aob') or "Aob"
                                            kategori = foto.get("kategori", "") or ""
                                            oncelik = foto.get("oncelik", "") or "Bekleyebilir"
                                            
                                            print(f"ğŸ“· FotoÄŸraf iÅŸleniyor: {os.path.basename(foto_yol)}")
                                            
                                            try:
                                                foto_yol_fs = uri_to_path(foto_yol)
                                                hedef_yol = os.path.join(hedef_klasor, os.path.basename(foto_yol_fs))
                                                
                                                if kuculterek_kaydet:
                                                    try:
                                                        print(f"ğŸ”„ KÃ¼Ã§Ã¼ltÃ¼lÃ¼yor: {foto_yol_fs}")
                                                        img = Image.open(foto_yol_fs)
                                                        exif = img.info.get("exif", None)
                                                        img.thumbnail((1600, 1600))
                                                        if exif:
                                                            img.save(hedef_yol, exif=exif)
                                                        else:
                                                            img.save(hedef_yol)
                                                        print(f"âœ… KÃ¼Ã§Ã¼ltÃ¼ldÃ¼: {hedef_yol}")
                                                    except Exception as e:
                                                        print(f"âŒ KÃ¼Ã§Ã¼ltme hatasÄ±: {e}")
                                                        shutil.copy2(foto_yol_fs, hedef_yol)
                                                else:
                                                    print(f"ğŸ“‹ Orjinal kopyalanÄ±yor: {foto_yol_fs}")
                                                    shutil.copy2(foto_yol_fs, hedef_yol)
                                                
                                                excel_klasor = os.path.dirname(excel_yolu)
                                                goreceli_yol = os.path.relpath(hedef_yol, excel_klasor)
                                                
                                            except Exception as e:
                                                print(f"âŒ Kopyalama hatasÄ±: {e}")
                                                hedef_yol = os.path.join(hedef_klasor, os.path.basename(foto_yol))
                                                goreceli_yol = hedef_yol
                                            
                                            if (not foto_not.strip()) and (not kategori.strip()):
                                                continue
                                            
                                            # ğŸ”¥ KOORDÄ°NAT DURUMU Ä°Ã‡Ä°N Ã–ZEL KONTROL - GÃœNCELLENDÄ°
                                            if foto_birim == "Koordinat" or koordinat_degisecek_mi:
                                                aciklama = "KoordinatÄ± deÄŸiÅŸecek"
                                                birim = "Cbs"
                                            elif foto_not.strip():
                                                aciklama = foto_not.strip()
                                                birim = "Aob" if foto_birim == "Aob" else "Cbs"
                                            else:
                                                aciklama = "[Kategori seÃ§ildi]"
                                                birim = "Aob" if foto_birim == "Aob" else "Cbs"
                                            
                                            if silinecek_mi:
                                                numara_yazi = f"({direk_id})"
                                                aciklama = f"{numara_yazi} numaralÄ± direk CBS'den silinecek"
                                                birim = "Cbs"
                                            
                                            hyperlink_path = goreceli_yol.replace("\\", "/")
                                            gÃ¶rÃ¼nen_ad = os.path.basename(hedef_yol)
                                            link = f'=HYPERLINK("{hyperlink_path}", "{gÃ¶rÃ¼nen_ad}")'
                                            
                                            ws.append([numara, direk_id, aciklama, kategori, oncelik, link, lat, lon, birim])
                                            
                                            processed += 1
                                            if total_fotos > 0:
                                                progress = int((processed / total_fotos) * 100)
                                                print(f"ğŸ“Š Ä°lerleme: {processed}/{total_fotos} ({progress}%)")
                                            
                                            QApplication.processEvents()
                                            
                                    elif silinecek_mi:
                                        aciklama = f"({direk_id}) numaralÄ± direk CBS'den silinecek"
                                        ws.append([numara, direk_id, aciklama, "", "", "", lat, lon, "Cbs"])
                                    elif koordinat_degisecek_mi:
                                        # ğŸ”¥ YENÄ°: Sadece koordinat deÄŸiÅŸecek ama fotoÄŸraf yok
                                        aciklama = f"({direk_id}) numaralÄ± direk koordinatÄ± deÄŸiÅŸecek"
                                        ws.append([numara, direk_id, aciklama, "", "", "", lat, lon, "Cbs"])
                                
                                print(f"ğŸ’¾ Excel kaydediliyor: {excel_yolu}")
                                wb.save(excel_yolu)
                                
                                kayit_turu = "kÃ¼Ã§Ã¼ltÃ¼lerek" if kuculterek_kaydet else "orijinal boyutta"
                                QMessageBox.information(self, "Ä°ÅŸlem TamamlandÄ±", 
                                    f"âœ… TÃ¼m fotoÄŸraflar ve notlar baÅŸarÄ±yla kaydedildi.\n\n"
                                    f"ğŸ“¸ FotoÄŸraflar {kayit_turu} kaydedildi.\n"
                                    f"ğŸ“ KlasÃ¶r: {self.drone_kayit_klasoru}\n"
                                    f"ğŸ“„ Excel dosyasÄ±: Tespit.xlsx")
                                
                            except Exception as e:
                                print(f"âŒ Kopyalama sÄ±rasÄ±nda hata: {e}")
                                import traceback
                                traceback.print_exc()
                                QMessageBox.critical(self, "Hata", f"KayÄ±t sÄ±rasÄ±nda hata oluÅŸtu:\n{str(e)}")

                        if iliskisiz_fotolar:
                            cevap = QMessageBox.question(self, "Ä°liÅŸtirilmeyen FotoÄŸraflar Var",
                                f"âš ï¸ {len(iliskisiz_fotolar)} adet iliÅŸtirilmeyen fotoÄŸraf var.\n"
                                "Yine de kaydetmek istiyor musunuz?",
                                QMessageBox.StandardButton.Yes | QMessageBox.StandardButton.No)
                            if cevap == QMessageBox.StandardButton.Yes:
                                kopyalamaya_basla()
                            else:
                                print("ğŸš« KullanÄ±cÄ± iptal etti")
                        else:
                            kopyalamaya_basla()
                    
                    # ğŸ”¥ YENÄ°: Ã–nce gÃ¼ncel koordinatlarÄ± al, sonra iÅŸleme devam et
                    self.view.page().runJavaScript(js_koordinat_kod, koordinatlari_isle)
                    
                except Exception as e:
                    print(f"âŒ JavaScript veri iÅŸleme hatasÄ±: {e}")
                    import traceback
                    traceback.print_exc()
                    QMessageBox.critical(self, "Hata", f"Veri iÅŸleme hatasÄ±:\n{str(e)}")
            
            print("ğŸ” JavaScript Ã§alÄ±ÅŸtÄ±rÄ±lÄ±yor...")
            self.view.page().runJavaScript(js_kod, js_sonucu_al)
            
        except Exception as e:
            print(f"âŒ Ana kayÄ±t fonksiyonunda hata: {e}")
            import traceback
            traceback.print_exc()
            QMessageBox.critical(self, "Hata", f"KayÄ±t iÅŸlemi baÅŸlatÄ±lamadÄ±:\n{str(e)}")
        

    def fotograf_klasoru_sec(self):
        klasor = QFileDialog.getExistingDirectory(self, "FotoÄŸraf KlasÃ¶rÃ¼nÃ¼ SeÃ§")
        if klasor:
            self.foto_klasor = klasor
            self.foto_klasor_label.setText(f"ğŸ“ {klasor}")
            
    def drone_kayit_klasoru_sec(self):
        klasor = QFileDialog.getExistingDirectory(self, "Drone KayÄ±t DosyasÄ± KlasÃ¶rÃ¼ SeÃ§")
        if klasor:
            self.drone_kayit_klasoru = klasor
            self.kayit_label.setText(f"ğŸ“ SeÃ§ilen kayÄ±t klasÃ¶rÃ¼:\n{klasor}")
            print(f"ğŸ“ Drone kayÄ±t klasÃ¶rÃ¼ seÃ§ildi: {klasor}")

    def foto_kayit_klasoru_sec(self):
        klasor = QFileDialog.getExistingDirectory(self, "FotoÄŸraf KÃ¼Ã§Ã¼ltme KayÄ±t KlasÃ¶rÃ¼ SeÃ§")
        if klasor:
            self.foto_kayit_klasor = klasor
            self.kayit_klasor_label.setText(f"ğŸ“ {klasor}")
            print(f"ğŸ“ FotoÄŸraf kÃ¼Ã§Ã¼ltme kayÄ±t klasÃ¶rÃ¼ seÃ§ildi: {klasor}")

    def kucultmeyi_baslat(self):
        if not self.foto_klasor or not self.foto_kayit_klasor:
            print("âš ï¸ Ã–nce fotoÄŸraf ve kayÄ±t klasÃ¶rlerini seÃ§melisiniz.")
            return

        yollar = []
        
        for root, _, files in os.walk(self.foto_klasor):
            for file in files:
                if file.lower().endswith((".jpg", ".jpeg", ".png", ".bmp", ".webp", ".tif", ".tiff")):
                    kaynak = os.path.join(root, file)
                    alt_yol = os.path.relpath(kaynak, self.foto_klasor)
                    hedef = os.path.join(self.foto_kayit_klasor, alt_yol)   
                    yollar.append((kaynak, hedef))

        if not yollar:
            print("âš ï¸ Uygun fotoÄŸraf bulunamadÄ±.")
            return

        self.kucultme_bar.setVisible(True)
        self.kucultme_bar.setMaximum(len(yollar))  # âœ… AsÄ±l burada doÄŸru
        self.kucultme_bar.setValue(0)
        self.kucultme_bar.setFormat("%p%")

        for i, (kaynak, hedef) in enumerate(yollar):
            try:
                os.makedirs(os.path.dirname(hedef), exist_ok=True)
                img = Image.open(kaynak)
                exif = img.info.get("exif", None)
                img.thumbnail((1600, 1600))  # ğŸ“ Ä°stediÄŸin boyut
                if exif:
                    img.save(hedef, exif=exif)
                else:
                    img.save(hedef)
                print(f"âœ… KÃ¼Ã§Ã¼ltÃ¼ldÃ¼: {hedef}")
            except Exception as e:
                print(f"âŒ Hata: {kaynak} - {e}")

            self.kucultme_bar.setValue(i + 1)
            QApplication.processEvents()  # GUI donmasÄ±n

        self.kucultme_bar.setFormat("âœ… TamamlandÄ± (%p%)")  # âœ… BittiÄŸinde yazÄ± gÃ¼ncelle
        print("ğŸ“¦ TÃ¼m fotoÄŸraflar kÃ¼Ã§Ã¼ltÃ¼ldÃ¼.")

def create_map(photo_data, direk_data, save_path, center_lat=None, center_lon=None, zoom_level=None):
    """
    Harita oluÅŸtur - Dinamik koordinat ve zoom ile
    """
    # SABÄ°T AYARLAR (varsayÄ±lan deÄŸerler)
    SABIT_LAT = 36.7300     # BatÄ± Antalya enlem
    SABIT_LON = 30.2000     # BatÄ± Antalya boylam
    SABIT_ZOOM = 9.8        # ğŸ”¥ KESÄ°RLÄ° ZOOM: 9.8
    
    # ğŸ“ EÄŸer merkez koordinat ve zoom belirtilmemiÅŸse, fotoÄŸraf verisine gÃ¶re hesapla
    if center_lat is None or center_lon is None or zoom_level is None:
        if photo_data:
            # TÃ¼m enlem ve boylamlarÄ± al
            lats = [float(photo[1]) for photo in photo_data]
            lons = [float(photo[2]) for photo in photo_data]
            
            # En uÃ§ noktalarÄ± bul
            min_lat = min(lats)
            max_lat = max(lats)
            min_lon = min(lons)
            max_lon = max(lons)
            
            # Merkez noktasÄ±nÄ± hesapla
            center_lat = (min_lat + max_lat) / 2
            center_lon = (min_lon + max_lon) / 2
            
            # Zoom seviyesini hesapla
            lat_diff = max_lat - min_lat
            lon_diff = max_lon - min_lon
            max_diff = max(lat_diff, lon_diff)
            
            # Zoom seviyesini fark miktarÄ±na gÃ¶re belirle
            if max_diff < 0.001:
                zoom_level = 18  # 16'dan 18'e Ã§Ä±karÄ±ldÄ±
            elif max_diff < 0.005:
                zoom_level = 17  # 15'ten 17'ye Ã§Ä±karÄ±ldÄ±
            elif max_diff < 0.01:
                zoom_level = 16  # 14'ten 16'ya Ã§Ä±karÄ±ldÄ±
            elif max_diff < 0.05:
                zoom_level = 15  # 13'ten 15'e Ã§Ä±karÄ±ldÄ±
            elif max_diff < 0.1:
                zoom_level = 14  # 12'den 14'e Ã§Ä±karÄ±ldÄ±
            elif max_diff < 0.5:
                zoom_level = 13  # 11'den 13'e Ã§Ä±karÄ±ldÄ±
            else:
                zoom_level = 12  # 10'dan 12'ye Ã§Ä±karÄ±ldÄ±
        else:
            # FotoÄŸraf yoksa sabit koordinatlarÄ± kullan
            center_lat = SABIT_LAT
            center_lon = SABIT_LON
            zoom_level = SABIT_ZOOM
    else:
        # Parametre olarak verilmiÅŸse, onlarÄ± kullan
        center_lat = center_lat
        center_lon = center_lon
        zoom_level = zoom_level
    
    print(f"ğŸ—ºï¸ Harita konumu: {center_lat}, {center_lon} - Zoom: {zoom_level}")
    
    # EÄŸer fotoÄŸraf ve direk yoksa basit harita oluÅŸtur
    if not photo_data and not direk_data:
        print("Haritaya eklenecek veri yok! BoÅŸ harita oluÅŸturuluyor...")
        with open(save_path, "w", encoding="utf-8") as f:
            f.write(f"""
            <html>
            <head>
                <title>Drone HaritasÄ±</title>
                <meta name="viewport" content="width=device-width, initial-scale=1.0">
                <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
                <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
                <style>
                    body {{ margin: 0; padding: 0; }}
                    #map {{ height: 100vh; }}
                </style>
            </head>
            <body>
                <div id="map"></div>
                <script>
                    // DÄ°NAMÄ°K KOORDÄ°NAT VE ZOOM
                    var map = L.map('map', {{
                        center: [{center_lat}, {center_lon}],
                        zoom: {zoom_level},
                        zoomSnap: 0.1,
                        zoomDelta: 0.5
                    }});
                    
                    L.tileLayer('https://{{s}}.tile.openstreetmap.org/{{z}}/{{x}}/{{y}}.png', {{
                        maxZoom: 19,
                        attribution: 'Â© OpenStreetMap contributors'
                    }}).addTo(map);
                    
                    console.log('ğŸ“ Harita konumu: {center_lat}, {center_lon} - Zoom: {zoom_level}');
                </script>
            </body>
            </html>
            """)
        return
    
    # DÄ°NAMÄ°K koordinatlarÄ± kullan
    start_coords = (center_lat, center_lon)
    
    if direk_data:
        print(f"ğŸ“ {len(direk_data)} direk haritaya eklenecek (konum: {start_coords[0]}, {start_coords[1]})")
    if photo_data:
        print(f"ğŸ“¸ {len(photo_data)} fotoÄŸraf haritaya eklenecek (konum: {start_coords[0]}, {start_coords[1]})")
    
    # HTML baÅŸlangÄ±cÄ±
    html_start = f"""
    <!DOCTYPE html>
    <html>
    <head>
        <meta charset="utf-8" />
        <title>Drone Harita</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
        <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

        <style>
            html, body, #map {{
                height: 100%;
                margin: 0;
                padding: 0;
            }}
            .photo-marker {{
                width: 16px;
                height: 16px;
                border-radius: 50%;
                border: 2px solid white;
                box-shadow: 0 0 4px #000;
            }}
            .photo-mavi {{
                background-color: #007BFF;
                opacity: 0.7;
            }}
            .photo-turkuaz {{
                background-color: #00CED1;
                opacity: 0.7;
            }}
            .custom-popup .leaflet-popup-content-wrapper {{
                width: 420px !important;
            }}
            /* ğŸ”„ Buton iÃ§in yeni stil */
            .leaflet-control-tum-fotolari-cikar {{
                background: white;
                border-radius: 4px;
                border: 2px solid rgba(0,0,0,0.2);
                cursor: pointer;
            }}
            .leaflet-control-tum-fotolari-cikar a {{
                display: block;
                width: 30px;
                height: 30px;
                line-height: 30px;
                text-align: center;
                text-decoration: none;
                color: #333;
                font-size: 18px;
            }}
            .leaflet-control-tum-fotolari-cikar:hover {{
                background: #f4f4f4;
            }}
            
            /* ğŸ”„ "TÃ¼mÃ¼nÃ¼ GÃ¶ster" butonu - Ä°STEMÄ°YORSAN BUNU SÄ°L */
            .leaflet-control-tumunu-goster {{
                background: white;
                border-radius: 4px;
                border: 2px solid rgba(0,0,0,0.2);
                cursor: pointer;
            }}
            .leaflet-control-tumunu-goster a {{
                display: block;
                width: 30px;
                height: 30px;
                line-height: 30px;
                text-align: center;
                text-decoration: none;
                color: #333;
                font-size: 18px;
            }}
            .leaflet-control-tumunu-goster:hover {{
                background: #f4f4f4;
            }}
            
            /* ğŸ”¢ Direk NumarasÄ± Stili */
            .direk-numara-label {{
                position: absolute;
                transform: translate(-50%, -50%);
                color: #000;
                font-weight: bold;
                font-size: 11px;
                text-shadow: 1px 1px 0 white, -1px -1px 0 white, 1px -1px 0 white, -1px 1px 0 white;
                pointer-events: none;
                z-index: 1000;
                white-space: nowrap;
                opacity: 0.95;
            }}
        </style>
    </head>
    <body>
        <div id="map"></div>
        <script>
            function encodeID(str) {{
                return btoa(unescape(encodeURIComponent(str))).replace(/[/+=]/g, '_');
            }}

            var streetLayer = L.tileLayer('https://{{s}}.tile.openstreetmap.org/{{z}}/{{x}}/{{y}}.png', {{
                maxZoom: 19,
                attribution: '&copy; OpenStreetMap contributors'
            }});

            var satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{{z}}/{{y}}/{{x}}', {{
                maxZoom: 18,
                attribution: 'Tiles Â© Esri'
            }});

            // ğŸ”¥ DÄ°NAMÄ°K KOORDÄ°NAT VE ZOOM Ä°LE HARÄ°TA
            var map = L.map('map', {{
                center: [{start_coords[0]}, {start_coords[1]}],  // DÄ°NAMÄ°K
                zoom: {zoom_level},                              // DÄ°NAMÄ°K
                zoomSnap: 0.1,
                zoomDelta: 0.5,
                layers: [streetLayer],
                doubleClickZoom: false
            }});
            
            console.log('ğŸ“ Harita konumu: {start_coords[0]}, {start_coords[1]} - Zoom: {zoom_level}');
            
            // ğŸ§¼ SaÄŸ tÄ±klama menÃ¼sÃ¼nÃ¼ devre dÄ±ÅŸÄ± bÄ±rak
            map.getContainer().addEventListener("contextmenu", function(e) {{
                e.preventDefault();
            }});

            var baseLayers = {{
                "Standart Harita": streetLayer,
                "Uydu GÃ¶rÃ¼ntÃ¼sÃ¼": satelliteLayer
            }};
            L.control.layers(baseLayers).addTo(map);

            // ğŸ”„ "TÃ¼m FotoÄŸraflarÄ± DÄ±ÅŸarÄ± Al" kontrolÃ¼
            var TumFotolariCikarControl = L.Control.extend({{
                options: {{
                    position: 'topright'
                }},
                onAdd: function(map) {{
                    var container = L.DomUtil.create('div', 'leaflet-control-tum-fotolari-cikar leaflet-bar leaflet-control');
                    var link = L.DomUtil.create('a', 'leaflet-bar-part', container);
                    link.href = '#';
                    link.innerHTML = 'ğŸ”„';
                    link.title = 'TÃ¼m fotoÄŸraflarÄ± dÄ±ÅŸarÄ± al';
                    
                    L.DomEvent.on(link, 'click', function(e) {{
                        L.DomEvent.stopPropagation(e);
                        L.DomEvent.preventDefault(e);
                        tumFotolariCikar();
                    }});
                    
                    return container;
                }}
            }});
            
            // ğŸ”„ "TÃ¼mÃ¼nÃ¼ GÃ¶ster" butonu - Ä°STEMÄ°YORSAN BU BLOÄU SÄ°L
            var TumunuGosterControl = L.Control.extend({{
                options: {{
                    position: 'topright'
                }},
                onAdd: function(map) {{
                    var container = L.DomUtil.create('div', 'leaflet-control-tumunu-goster leaflet-bar leaflet-control');
                    var link = L.DomUtil.create('a', 'leaflet-bar-part', container);
                    link.href = '#';
                    link.innerHTML = 'ğŸ—ºï¸';
                    link.title = 'Harita konumuna dÃ¶n';
                    
                    L.DomEvent.on(link, 'click', function(e) {{
                        L.DomEvent.stopPropagation(e);
                        L.DomEvent.preventDefault(e);
                        // Harita konumuna dÃ¶n
                        map.setView([{start_coords[0]}, {start_coords[1]}], {zoom_level});
                        console.log('ğŸ“ Harita konumuna dÃ¶nÃ¼ldÃ¼');
                    }});
                    
                    return container;
                }}
            }});
            
            // Kontrolleri haritaya ekle
            map.addControl(new TumFotolariCikarControl());
            map.addControl(new TumunuGosterControl());  // Ä°STEMÄ°YORSAN BU SATIRI SÄ°L

            var direkler = [];
            var photoInfo = [];

            // ğŸ”¢ Direk NumarasÄ± GÃ¶rÃ¼ntÃ¼leme Fonksiyonu
            function guncelleDirekNumaraGorunumu(direk) {{
                // Eski numara label'Ä± varsa temizle
                if (direk.numaraLabelMarker && map.hasLayer(direk.numaraLabelMarker)) {{
                    map.removeLayer(direk.numaraLabelMarker);
                    direk.numaraLabelMarker = null;
                }}
                
                // EÄŸer direkte fotoÄŸraf varsa ve numara atanmÄ±ÅŸsa, numarayÄ± gÃ¶ster
                if (direk.photos && direk.photos.length > 0 && direk.numara !== null && direk.numara !== undefined) {{
                    var latlng = direk.marker.getLatLng();
                    
                    var numaraLabel = L.divIcon({{
                        className: 'direk-numara-label',
                        html: '<div style="text-align:center; font-weight:bold;">' + direk.numara + '</div>',
                        iconSize: [20, 20],
                        iconAnchor: [10, 10]
                    }});
                    
                    var labelMarker = L.marker(latlng, {{
                        icon: numaraLabel,
                        interactive: false,
                        zIndexOffset: 1000
                    }}).addTo(map);
                    
                    direk.numaraLabelMarker = labelMarker;
                }}
            }}

            // ğŸ”„ TÃ¼m fotoÄŸraflarÄ± dÄ±ÅŸarÄ± al JavaScript fonksiyonu
            function tumFotolariCikar() {{
                if (!confirm("TÃ¼m direklerden TÃœM fotoÄŸraflarÄ± dÄ±ÅŸarÄ± Ã§Ä±karmak istediÄŸinize emin misiniz?")) {{
                    return;
                }}
                
                // TÃ¼m direklerden fotoÄŸraflarÄ± topla
                const tumFotograflar = [];
                direkler.forEach(direk => {{
                    if (direk.photos && direk.photos.length > 0) {{
                        direk.photos.forEach(foto => {{
                            tumFotograflar.push({{
                                path: foto.path,
                                direk_id: direk.id,
                                note: foto.note || ""
                            }});
                        }});
                        // DireÄŸi temizle
                        direk.photos = [];
                        if (direk.numara) {{
                            direk.numara = null;
                        }}
                        // NumarayÄ± haritadan kaldÄ±r
                        guncelleDirekNumaraGorunumu(direk);
                    }}
                }});
                
                if (tumFotograflar.length === 0) {{
                    alert("âš ï¸ HiÃ§ fotoÄŸraf baÄŸlÄ± deÄŸil.");
                    return;
                }}
                
                // Her fotoÄŸrafÄ± eski yerine geri dÃ¶ndÃ¼r
                tumFotograflar.forEach(foto => {{
                    const dosyaAdi = foto.path.split('/').pop().split('\\\\').pop().toLowerCase();
                    const photoInfoObj = photoInfo.find(p => {{
                        const pFile = p.path.split('/').pop().split('\\\\').pop().toLowerCase();
                        return pFile === dosyaAdi;
                    }});
                    
                    if (photoInfoObj) {{
                        const lat = photoInfoObj.originalLat !== undefined ? photoInfoObj.originalLat : photoInfoObj.lat;
                        const lon = photoInfoObj.originalLon !== undefined ? photoInfoObj.originalLon : photoInfoObj.lon;
                        
                        var markerClass = "photo-marker " + (photoInfoObj.note ? "photo-turkuaz" : "photo-mavi");

                        var marker = L.marker([lat, lon], {{
                            draggable: true,
                            icon: L.divIcon({{
                                className: markerClass,
                                iconSize: [13, 13]
                            }})
                        }}).bindPopup(getPhotoPopupHTML(photoInfoObj.path, photoInfoObj.note), {{
                            maxWidth: 420,
                            minWidth: 400,
                            autoPan: true,
                            className: 'custom-popup'
                        }});

                        // Ã‡ift tÄ±k event'i ekle
                        marker.on("dblclick", function(e) {{
                            e.originalEvent.preventDefault();
                            e.originalEvent.stopPropagation();
                            
                            var pos = e.target.getLatLng();
                            var hedefDirek = null;
                            var enKisaMesafe = Infinity;

                            direkler.forEach(function(d) {{
                                var mesafe = map.distance(pos, L.latLng(d.lat, d.lon));
                                if (mesafe < 20 && mesafe < enKisaMesafe) {{
                                    hedefDirek = d;
                                    enKisaMesafe = mesafe;
                                }}
                            }});

                            if (hedefDirek) {{
                                var zatenVar = hedefDirek.photos.some(p => p.path === photoInfoObj.path);
                                if (zatenVar) {{
                                    L.popup()
                                        .setLatLng(pos)
                                        .setContent("â›” AynÄ± fotoÄŸraf zaten bu direÄŸe eklenmiÅŸ")
                                        .openOn(map);
                                    return;
                                }}

                                const notDegeri = photoInfoObj.note || "";
                                const kategori = photoInfoObj.kategori || "";
                                const oncelik = photoInfoObj.oncelik || "Bekleyebilir";
                                const birim = photoInfoObj.birim || "Aob";

                                hedefDirek.photos.push({{
                                    path: photoInfoObj.path,
                                    note: notDegeri,
                                    kategori: kategori,
                                    oncelik: oncelik,
                                    birim: birim
                                }});

                                if (typeof hedefDirek.numara === 'undefined' || hedefDirek.numara === null) {{
                                    const kullanÄ±lanNumaralar = direkler
                                        .filter(d => typeof d.numara === 'number')
                                        .map(d => d.numara);
                                    let yeniNumara = 1;
                                    while (kullanÄ±lanNumaralar.includes(yeniNumara)) {{
                                        yeniNumara++;
                                    }}
                                    hedefDirek.numara = yeniNumara;
                                    // Numara atandÄ±ÄŸÄ±nda gÃ¶rÃ¼nÃ¼mÃ¼ gÃ¼ncelle
                                    guncelleDirekNumaraGorunumu(hedefDirek);
                                }}

                                guncellePopup(hedefDirek);
                                map.removeLayer(marker);
                                
                                L.popup()
                                    .setLatLng(pos)
                                    .setContent("âœ… En yakÄ±n direÄŸe eklendi: " + hedefDirek.id)
                                    .openOn(map);
                            }} else {{
                                L.popup()
                                    .setLatLng(pos)
                                    .setContent("âš ï¸ 20 metre iÃ§inde direk bulunamadÄ±")
                                    .openOn(map);
                            }}
                        }});

                        marker.on("popupopen", function() {{
                            bindNoteInput(photoInfoObj.path);
                        }});

                        marker.on("dragend", function(e) {{
                            var pos = e.target.getLatLng();
                            var hedefDirek = null;
                            var enKisaMesafe = Infinity;

                            direkler.forEach(function(d) {{
                                var mesafe = map.distance(pos, L.latLng(d.lat, d.lon));
                                if (mesafe < 8 && !d.photos.find(p => p.path === photoInfoObj.path) && mesafe < enKisaMesafe) {{
                                    hedefDirek = d;
                                    enKisaMesafe = mesafe;
                                }}
                            }});

                            if (hedefDirek) {{
                                const notDegeri = photoInfoObj.note || "";
                                hedefDirek.photos.push({{ path: photoInfoObj.path, note: notDegeri }});

                                if (typeof hedefDirek.numara === 'undefined' || hedefDirek.numara === null) {{
                                    const kullanÄ±lanNumaralar = direkler
                                        .filter(d => typeof d.numara === 'number')
                                        .map(d => d.numara);
                                    let yeniNumara = 1;
                                    while (kullanÄ±lanNumaralar.includes(yeniNumara)) {{
                                        yeniNumara++;
                                    }}
                                    hedefDirek.numara = yeniNumara;
                                    // Numara atandÄ±ÄŸÄ±nda gÃ¶rÃ¼nÃ¼mÃ¼ gÃ¼ncelle
                                    guncelleDirekNumaraGorunumu(hedefDirek);
                                }}

                                guncellePopup(hedefDirek);
                                map.removeLayer(marker);
                            }}
                        }});

                        photoInfoObj.marker = marker;
                        map.addLayer(marker);
                    }}
                }});
                
                // Direk popuplarÄ±nÄ± gÃ¼ncelle
                direkler.forEach(d => guncellePopup(d));
                
                alert("âœ… " + tumFotograflar.length + " fotoÄŸraf baÅŸarÄ±yla tÃ¼m direklerden Ã§Ä±karÄ±ldÄ± ve haritaya geri eklendi.");
            }}

            function guncellePopup(d, popupAc = false) {{
                let html = `<b>Direk ID: ${{d.id}}</b><br><b>Tip:</b> ${{d.tip}}`;

                if (typeof d.numara !== 'undefined' && d.numara !== null) {{
                    html += `<br><b>ğŸ“Œ Numara:</b> 
                            <input type="number" value="${{d.numara}}" id="numara-input-${{d.id}}" style="width:60px;"> 
                            <button onclick="kaydetNumara('${{d.id}}')" style="margin-left:5px; padding:4px 8px;">ğŸ’¾</button>
                            <button onclick="direktenTumFotolariCikar('${{d.id}}')" style="margin-left:5px; padding:4px 8px;" title="TÃ¼m fotoÄŸraflarÄ± dÄ±ÅŸarÄ± al">ğŸ”„</button>`;
                }}

                if (d.photos && d.photos.length > 0) {{
                    html += "<br><b>FotoÄŸraflar:</b><br>";
                    d.photos.forEach(p => {{
                        html += `
                            <div style='margin-bottom:6px;'>
                                <img src='${{p.path}}' width='80' style='margin:2px; border-radius:4px; cursor:pointer;' onclick="geriCagir('${{p.path}}')"><br>
                                <small>ğŸ“ Not: ${{p.note || '-'}}</small>
                            </div>
                        `;
                    }});
                }}

                if ((d.tip === "(yeni)" || d.ozel) && (!d.photos || d.photos.length === 0)) {{
                    html += `<br><button onclick="kaldirDirek('${{d.id}}')">ğŸ—‘ï¸ DireÄŸi KaldÄ±r</button>`;
                }}

                if (d.tip !== "(yeni)" && !d.ozel) {{
                    html += `<br><label><input type="checkbox" id="silinecek-checkbox-${{d.id}}" ${{d.silinecek_mi && 'checked'}} onchange="kaydetSilinecek('${{d.id}}')"> Direk Silinecek</label><br>`;
                    html += `<label><input type="checkbox" id="koordinat-degisecek-checkbox-${{d.id}}" ${{d.koordinat_degisecek_mi && 'checked'}} onchange="kaydetKoordinatDegisecek('${{d.id}}')"> KoordinatÄ± DeÄŸiÅŸecek</label>`;
                }}

                const alreadyHasPopup = !!d.marker.getPopup();
                if (!alreadyHasPopup) {{
                    d.marker.bindPopup(html);
                }} else {{
                    d.marker.setPopupContent(html);
                }}

                if (popupAc || d.marker.isPopupOpen()) {{
                    d.marker.openPopup();
                }}

                if (d.photos && d.photos.length > 0) {{
                    d.marker.setStyle({{
                        color: "#008000",
                        fillColor: "#66ff66"
                    }});
                }} else {{
                    if (d.musterek) {{
                        d.marker.setStyle({{
                            color: "#800080",
                            fillColor: "#dda0dd"
                        }});
                    }} else {{
                        d.marker.setStyle({{
                            color: "#ff0000",
                            fillColor: "#ff6666"
                        }});
                    }}
                }}
                
                // ğŸ”¢ Direk numarasÄ± gÃ¶rÃ¼nÃ¼mÃ¼nÃ¼ gÃ¼ncelle
                guncelleDirekNumaraGorunumu(d);
            }}
            
            // YENÄ°: Tek bir direkten tÃ¼m fotoÄŸraflarÄ± dÄ±ÅŸarÄ± alma fonksiyonu
            function direktenTumFotolariCikar(direkId) {{
                const direk = direkler.find(d => d.id === direkId);
                if (!direk || !direk.photos || direk.photos.length === 0) return;
                
                // TÃ¼m fotoÄŸraflarÄ± kaydet
                const fotograflar = [...direk.photos];
                
                // Her fotoÄŸrafÄ± eski yerine geri dÃ¶ndÃ¼r
                fotograflar.forEach(foto => {{
                    const dosyaAdi = foto.path.split('/').pop().split('\\\\').pop().toLowerCase();
                    const photoInfoObj = photoInfo.find(p => {{
                        const pFile = p.path.split('/').pop().split('\\\\').pop().toLowerCase();
                        return pFile === dosyaAdi;
                    }});
                    
                    if (photoInfoObj) {{
                        const lat = photoInfoObj.originalLat !== undefined ? photoInfoObj.originalLat : photoInfoObj.lat;
                        const lon = photoInfoObj.originalLon !== undefined ? photoInfoObj.originalLon : photoInfoObj.lon;
                        
                        var markerClass = "photo-marker " + (photoInfoObj.note ? "photo-turkuaz" : "photo-mavi");

                        var marker = L.marker([lat, lon], {{
                            draggable: true,
                            icon: L.divIcon({{
                                className: markerClass,
                                iconSize: [13, 13]
                            }})
                        }}).bindPopup(getPhotoPopupHTML(photoInfoObj.path, photoInfoObj.note), {{
                            maxWidth: 420,
                            minWidth: 400,
                            autoPan: true,
                            className: 'custom-popup'
                        }});

                        // Ã‡ift tÄ±k event'i ekle
                        marker.on("dblclick", function(e) {{
                            e.originalEvent.preventDefault();
                            e.originalEvent.stopPropagation();
                            
                            var pos = e.target.getLatLng();
                            var hedefDirek = null;
                            var enKisaMesafe = Infinity;

                            direkler.forEach(function(d) {{
                                var mesafe = map.distance(pos, L.latLng(d.lat, d.lon));
                                if (mesafe < 40 && mesafe < enKisaMesafe) {{
                                    hedefDirek = d;
                                    enKisaMesafe = mesafe;
                                }}
                            }});

                            if (hedefDirek) {{
                                var zatenVar = hedefDirek.photos.some(p => p.path === photoInfoObj.path);
                                if (zatenVar) {{
                                    L.popup()
                                        .setLatLng(pos)
                                        .setContent("â›” AynÄ± fotoÄŸraf zaten bu direÄŸe eklenmiÅŸ")
                                        .openOn(map);
                                    return;
                                }}

                                const notDegeri = photoInfoObj.note || "";
                                const kategori = photoInfoObj.kategori || "";
                                const oncelik = photoInfoObj.oncelik || "Bekleyebilir";
                                const birim = photoInfoObj.birim || "Aob";

                                hedefDirek.photos.push({{
                                    path: photoInfoObj.path,
                                    note: notDegeri,
                                    kategori: kategori,
                                    oncelik: oncelik,
                                    birim: birim
                                }});

                                if (typeof hedefDirek.numara === 'undefined' || hedefDirek.numara === null) {{
                                    const kullanÄ±lanNumaralar = direkler
                                        .filter(d => typeof d.numara === 'number')
                                        .map(d => d.numara);
                                    let yeniNumara = 1;
                                    while (kullanÄ±lanNumaralar.includes(yeniNumara)) {{
                                        yeniNumara++;
                                    }}
                                    hedefDirek.numara = yeniNumara;
                                    // Numara atandÄ±ÄŸÄ±nda gÃ¶rÃ¼nÃ¼mÃ¼ gÃ¼ncelle
                                    guncelleDirekNumaraGorunumu(hedefDirek);
                                }}

                                guncellePopup(hedefDirek);
                                map.removeLayer(marker);
                                
                                var successPopup = L.popup()
                                    .setLatLng(pos)
                                    .setContent("âœ… En yakÄ±n direÄŸe eklendi: " + hedefDirek.id)
                                    .openOn(map);

                                setTimeout(function() {{
                                    map.closePopup(successPopup);
                                }}, 750);
                                
                            }} else {{
                                L.popup()
                                    .setLatLng(pos)
                                    .setContent("âš ï¸ 40 metre iÃ§inde direk bulunamadÄ±")
                                    .openOn(map);
                            }}
                        }});

                        marker.on("popupopen", function() {{
                            bindNoteInput(photoInfoObj.path);
                        }});

                        marker.on("dragend", function(e) {{
                            var pos = e.target.getLatLng();
                            var hedefDirek = null;
                            var enKisaMesafe = Infinity;

                            direkler.forEach(function(d) {{
                                var mesafe = map.distance(pos, L.latLng(d.lat, d.lon));
                                if (mesafe < 8 && !d.photos.find(p => p.path === photoInfoObj.path) && mesafe < enKisaMesafe) {{
                                    hedefDirek = d;
                                    enKisaMesafe = mesafe;
                                }}
                            }});

                            if (hedefDirek) {{
                                const notDegeri = photoInfoObj.note || "";
                                hedefDirek.photos.push({{ path: photoInfoObj.path, note: notDegeri }});

                                if (typeof hedefDirek.numara === 'undefined' || hedefDirek.numara === null) {{
                                    const kullanÄ±lanNumaralar = direkler
                                        .filter(d => typeof d.numara === 'number')
                                        .map(d => d.numara);
                                    let yeniNumara = 1;
                                    while (kullanÄ±lanNumaralar.includes(yeniNumara)) {{
                                        yeniNumara++;
                                    }}
                                    hedefDirek.numara = yeniNumara;
                                    // Numara atandÄ±ÄŸÄ±nda gÃ¶rÃ¼nÃ¼mÃ¼ gÃ¼ncelle
                                    guncelleDirekNumaraGorunumu(hedefDirek);
                                }}

                                guncellePopup(hedefDirek);
                                map.removeLayer(marker);
                            }}
                        }});

                        photoInfoObj.marker = marker;
                        map.addLayer(marker);
                    }}
                }});
                
                // DireÄŸi temizle
                direk.photos = [];
                if (direk.numara) {{
                    direk.numara = null;
                }}
                
                // Numara gÃ¶rÃ¼nÃ¼mÃ¼nÃ¼ temizle
                guncelleDirekNumaraGorunumu(direk);
                
                // Popup'Ä± gÃ¼ncelle
                guncellePopup(direk, true);
                
                alert(`âœ… ${{fotograflar.length}} fotoÄŸraf "${{direkId}}" direÄŸinden Ã§Ä±karÄ±ldÄ±.`);
            }}

            function guncellePopuplar() {{
                direkler.forEach(d => {{
                    guncellePopup(d);
                }});
            }}

            function removePhotoFromMap(path) {{
                const filename = path.split('\\\\').pop().split('/').pop();
                const index = photoInfo.findIndex(p => {{
                    const pFilename = p.path.split('\\\\').pop().split('/').pop();
                    return pFilename === filename;
                }});
                if (index !== -1) {{
                    const marker = photoInfo[index].marker;
                    if (map.hasLayer(marker)) {{
                        map.removeLayer(marker);
                    }}
                    photoInfo.splice(index, 1);
                }}
            }}
            
            function addPhotoToDirek(direkId, path) {{
                const direk = direkler.find(d => d.id === direkId);
                if (direk) {{
                    if (!direk.photos) {{
                        direk.photos = [];
                    }}

                    const fileName = path.split('/').pop().split('\\\\').pop().toLowerCase();
                    const foto = photoInfo.find(p => {{
                        const pFile = p.path.split('/').pop().split('\\\\').pop().toLowerCase();
                        return pFile === fileName;
                    }});

                    const notDegeri = foto && foto.note ? foto.note : "";

                    const zatenEkli = direk.photos.some(p => {{
                        const pFile = p.path.split('/').pop().split('\\\\').pop().toLowerCase();
                        return pFile === fileName;
                    }});

                    if (zatenEkli) {{
                        console.log(`â›” FotoÄŸraf zaten ekli: ${{path}}`);
                        return;
                    }}

                    direk.photos.push({{ path: path, note: notDegeri }});
                    guncellePopup(direk);
                    
                    // ğŸ”¢ FotoÄŸraf eklendiÄŸinde numara gÃ¶rÃ¼nÃ¼mÃ¼nÃ¼ gÃ¼ncelle
                    if (direk.photos.length === 1) {{
                        // Ä°lk fotoÄŸraf eklendi, numara atanmamÄ±ÅŸsa ata
                        if (typeof direk.numara === 'undefined' || direk.numara === null) {{
                            const kullanÄ±lanNumaralar = direkler
                                .filter(d => typeof d.numara === 'number')
                                .map(d => d.numara);
                            let yeniNumara = 1;
                            while (kullanÄ±lanNumaralar.includes(yeniNumara)) {{
                                yeniNumara++;
                            }}
                            direk.numara = yeniNumara;
                        }}
                        guncelleDirekNumaraGorunumu(direk);
                    }}
                }}
            }}
            
            function kaydetNumara(id) {{
                const d = direkler.find(x => x.id === id);
                if (!d) return;

                const input = document.getElementById(`numara-input-${{id}}`);
                if (!input) return;

                const yeniNumara = parseInt(input.value);
                if (isNaN(yeniNumara)) return;

                const baskasi = direkler.find(x => x.numara === yeniNumara && x.id !== id);
                if (baskasi) {{
                    alert(`âŒ Bu numara zaten '${{baskasi.id}}' direÄŸinde kullanÄ±lÄ±yor.`);
                    input.value = d.numara ?? "";
                    return;
                }}

                d.numara = yeniNumara;
                console.log(`ğŸ”¢ '${{id}}' numarasÄ± gÃ¼ncellendi â†’ ${{yeniNumara}}`);
                guncellePopup(d, true);  // âœ… Popup'Ä± gÃ¼ncelle ve yeniden gÃ¶ster
                
                // ğŸ”¢ Numara gÃ¶rÃ¼nÃ¼mÃ¼nÃ¼ gÃ¼ncelle
                guncelleDirekNumaraGorunumu(d);
            }}

            function kaydetSilinecek(id) {{
                const d = direkler.find(x => x.id === id);
                if (!d) return;

                const checkbox = document.getElementById(`silinecek-checkbox-${{id}}`);
                if (!checkbox) return;

                d.silinecek_mi = checkbox.checked;
                guncellePopup(d, true);
                console.log(`ğŸ—‘ï¸ '${{id}}' silinecek mi? â†’`, d.silinecek_mi);
            }}

            function kaydetKoordinatDegisecek(id) {{
                const d = direkler.find(x => x.id === id);
                if (!d) return;

                const checkbox = document.getElementById(`koordinat-degisecek-checkbox-${{id}}`);
                if (!checkbox) return;

                d.koordinat_degisecek_mi = checkbox.checked;
                
                // ğŸ”¥ CRITICAL FIX: Marker'Ä±n draggable Ã¶zelliÄŸini deÄŸiÅŸtir
                if (d.koordinat_degisecek_mi) {{
                    // Draggable yap ve dragging'i etkinleÅŸtir
                    d.marker.dragging.enable();
                    d.marker.options.draggable = true;
                    
                    L.popup()
                        .setLatLng(d.marker.getLatLng())
                        .setContent("âœ… Bu direk iÃ§in konum deÄŸiÅŸtirme aktif.<br>ğŸ“ Konumu deÄŸiÅŸtirmek iÃ§in direÄŸi SOL TUÅLA sÃ¼rÃ¼kleyin.")
                        .openOn(map);
                }} else {{
                    // Draggable yapma
                    d.marker.dragging.disable();
                    d.marker.options.draggable = false;
                }}
                
                guncellePopup(d, true);
                console.log(`ğŸ“ '${{id}}' koordinatÄ± deÄŸiÅŸecek mi? â†’`, d.koordinat_degisecek_mi);
            }}

            function geriCagir(path) {{
                direkler.forEach(d => {{
                    const index = d.photos.findIndex(p => p.path === path);
                    if (index > -1) {{
                        const wasOpen = d.marker.isPopupOpen?.() ?? false;
                        d.photos.splice(index, 1);

                        if (d.photos.length === 0) {{
                            console.log(`â™»ï¸ '${{d.id}}' boÅŸ kaldÄ±, numara ${{d.numara}} boÅŸa Ã§Ä±ktÄ±.`);
                            d.numara = null;
                            // ğŸ”¢ TÃ¼m fotoÄŸraflar Ã§Ä±karÄ±ldÄ±ÄŸÄ±nda numara gÃ¶rÃ¼nÃ¼mÃ¼nÃ¼ temizle
                            guncelleDirekNumaraGorunumu(d);
                        }}

                        guncellePopup(d);
                        if (wasOpen) {{
                            setTimeout(() => d.marker.openPopup(), 0);
                        }}
                    }}
                }});

                var dosyaAdi = path.split('/').pop();
                var info = photoInfo.find(p => p.path.split('/').pop() === dosyaAdi);

                if (!info) {{
                    console.warn("âŒ Geri Ã§aÄŸrÄ±lan foto bulunamadÄ±:", decodeURIComponent(dosyaAdi));
                    return;
                }}

                var lat = info.originalLat !== undefined ? info.originalLat : info.lat;
                var lon = info.originalLon !== undefined ? info.originalLon : info.lon;

                var markerClass = "photo-marker " + (info.note ? "photo-turkuaz" : "photo-mavi");

                var marker = L.marker([lat, lon], {{
                    draggable: true,
                    icon: L.divIcon({{
                        className: markerClass,
                        iconSize: [13, 13]
                    }})
                }}).bindPopup(getPhotoPopupHTML(info.path, info.note), {{
                    maxWidth: 420,
                    minWidth: 400,
                    autoPan: true,
                    className: 'custom-popup'
                }});

                // ğŸ”¥ Ã‡Ä°FT TIK EVENT'Ä°NÄ° GERÄ° Ã‡AÄIRILAN MARKER'A DA EKLE
                marker.on("dblclick", function(e) {{
                    e.originalEvent.preventDefault();
                    e.originalEvent.stopPropagation();
                    
                    var pos = e.target.getLatLng();
                    var hedefDirek = null;
                    var enKisaMesafe = Infinity;

                    direkler.forEach(function(d) {{
                        var mesafe = map.distance(pos, L.latLng(d.lat, d.lon));
                        if (mesafe < 40 && mesafe < enKisaMesafe) {{
                            hedefDirek = d;
                            enKisaMesafe = mesafe;
                        }}
                    }});

                    if (hedefDirek) {{
                        var zatenVar = hedefDirek.photos.some(p => p.path === path);
                        if (zatenVar) {{
                            console.log("â›” AynÄ± fotoÄŸraf zaten bu direÄŸe eklenmiÅŸ.");
                            L.popup()
                                .setLatLng(pos)
                                .setContent("â›” AynÄ± fotoÄŸraf zaten bu direÄŸe eklenmiÅŸ")
                                .openOn(map);
                            return;
                        }}

                        // Not bilgisini photoInfo'dan Ã§ek
                        const dosyaAdi = path.split('/').pop().toLowerCase();
                        const foto = photoInfo.find(p => p.path.split('/').pop().toLowerCase() === dosyaAdi);
                        const notDegeri = foto?.note || "";
                        const kategori = foto?.kategori || "";
                        const oncelik = foto?.oncelik || "Bekleyebilir";
                        const birim = foto?.birim || "Aob";

                        hedefDirek.photos.push({{
                            path: path,
                            note: notDegeri,
                            kategori: kategori,
                            oncelik: oncelik,
                            birim: birim
                        }});

                        if (typeof hedefDirek.numara === 'undefined' || hedefDirek.numara === null) {{
                            const kullanÄ±lanNumaralar = direkler
                                .filter(d => typeof d.numara === 'number')
                                .map(d => d.numara);
                            let yeniNumara = 1;
                            while (kullanÄ±lanNumaralar.includes(yeniNumara)) {{
                                yeniNumara++;
                            }}
                            hedefDirek.numara = yeniNumara;
                            console.log(`Yeni numara atandÄ±: ${{yeniNumara}}`);
                            // ğŸ”¢ Numara atandÄ±ÄŸÄ±nda gÃ¶rÃ¼nÃ¼mÃ¼ gÃ¼ncelle
                            guncelleDirekNumaraGorunumu(hedefDirek);
                        }}

                        guncellePopup(hedefDirek);
                        map.removeLayer(marker);
                        
                        // KullanÄ±cÄ±ya bilgi ver
                        var successPopup = L.popup()
                            .setLatLng(pos)
                            .setContent("âœ… En yakÄ±n direÄŸe eklendi: " + hedefDirek.id)
                            .openOn(map);

                        setTimeout(function() {{
                            map.closePopup(successPopup);
                        }}, 750);

                            
                    }} else {{
                        L.popup()
                            .setLatLng(pos)
                            .setContent("âš ï¸ 40 metre iÃ§inde direk bulunamadÄ±")
                            .openOn(map);
                    }}
                }});

                marker.on("popupopen", function() {{
                    bindNoteInput(info.path);
                }});

                marker.on("dragend", function(e) {{
                    var pos = e.target.getLatLng();
                    var hedefDirek = null;
                    var enKisaMesafe = Infinity;

                    direkler.forEach(function(d) {{
                        var mesafe = map.distance(pos, L.latLng(d.lat, d.lon));
                        if (mesafe < 8 && !d.photos.find(p => p.path === path) && mesafe < enKisaMesafe) {{
                            hedefDirek = d;
                            enKisaMesafe = mesafe;
                        }}
                    }});

                    if (hedefDirek) {{
                        var note = photoInfo.find(p => p.path.split('/').pop() === dosyaAdi)?.note || "";

                        var photo = photoInfo.find(p => p.path.split('/').pop() === dosyaAdi);
                        if (photo) {{
                            // Orijinal EXIF konumu sadece ilk defa setle
                            if (photo.originalLat === undefined || photo.originalLon === undefined) {{
                                photo.originalLat = photo.lat;
                                photo.originalLon = photo.lon;
                            }}

                            // GÃ¼ncel konumu deÄŸiÅŸtir
                            photo.lat = pos.lat;
                            photo.lon = pos.lng;
                        }}

                        hedefDirek.photos.push({{ path: path, note: note }});

                        if (typeof hedefDirek.numara === 'undefined' || hedefDirek.numara === null) {{
                            const kullanÄ±lanNumaralar = direkler
                                .filter(d => typeof d.numara === 'number')
                                .map(d => d.numara);
                            let yeniNumara = 1;
                            while (kullanÄ±lanNumaralar.includes(yeniNumara)) {{
                                yeniNumara++;
                            }}
                            hedefDirek.numara = yeniNumara;
                            console.log(`ğŸ”¢ '${{hedefDirek.id}}' iÃ§in yeni numara atandÄ±: ${{yeniNumara}}`);
                            // ğŸ”¢ Numara atandÄ±ÄŸÄ±nda gÃ¶rÃ¼nÃ¼mÃ¼ gÃ¼ncelle
                            guncelleDirekNumaraGorunumu(hedefDirek);
                        }}

                        guncellePopup(hedefDirek);
                        map.removeLayer(marker);
                    }}
                }});

                info.marker = marker;
                map.addLayer(marker);
                console.log("ğŸ“ Marker EXIF konumuna geri dÃ¶ndÃ¼:", decodeURIComponent(dosyaAdi));
            }}

            function bindNoteInput(path) {{
                const fileName = path.split('/').pop().split('\\\\').pop().toLowerCase();
                const info = photoInfo.find(p => {{
                    const pFile = p.path.split('/').pop().split('\\\\').pop().toLowerCase();
                    return pFile === fileName;
                }});
                
                if (info) {{
                    const encoded = encodeID(info.path);
                    const noteInput = document.querySelector(`#note-input-${{encoded}}`);
                    const button = document.querySelector(`#note-save-${{encoded}}`);
                    const koordinatRadio = document.querySelector(`#koordinat-${{encoded}}`);
                    
                    if (noteInput && button) {{
                        button.onclick = function () {{
                            const aobRadio = document.querySelector(`#aob-${{encoded}}`);
                            const cbsRadio = document.querySelector(`#cbs-${{encoded}}`);
                            
                            let yeniNot = noteInput.value;
                            let birim = "";
                            
                            // Koordinat radio butonu seÃ§ili mi?
                            if (koordinatRadio && koordinatRadio.checked) {{
                                yeniNot = "KoordinatÄ± deÄŸiÅŸecek";
                                noteInput.value = yeniNot;
                                birim = "Cbs";
                                
                                // Cbs'yi otomatik seÃ§
                                if (cbsRadio) cbsRadio.checked = true;
                                if (aobRadio) aobRadio.checked = false;
                            }} else {{
                                // Normal birim seÃ§imi
                                if (aobRadio && aobRadio.checked) {{
                                    birim = "Aob";
                                }} else if (cbsRadio && cbsRadio.checked) {{
                                    birim = "Cbs";
                                }}
                            }}
                            
                            info.note = yeniNot;
                            info.birim = birim;
                            
                            // ğŸ‘‡ Marker rengini gÃ¼ncelle
                            if (info.marker && info.marker._icon) {{
                                info.marker._icon.classList.remove("photo-mavi");
                                info.marker._icon.classList.add("photo-turkuaz");
                            }}
                            
                            // ğŸ‘‡ Popup yeniden oluÅŸturuluyor
                            const newContent = getPhotoPopupHTML(info.path, info.note, info.birim);
                            info.marker.setPopupContent(newContent);
                            
                            // ğŸ‘‡ DireÄŸe iliÅŸtirilmiÅŸse gÃ¼ncelle
                            direkler.forEach(d => {{
                                if (d.photos) {{
                                    d.photos.forEach(f => {{
                                        const fFile = f.path.split('/').pop().split('\\\\').pop().toLowerCase();
                                        if (fFile === fileName) {{
                                            f.note = yeniNot;
                                            f.birim = birim;
                                        }}
                                    }});
                                    guncellePopup(d);
                                }}
                            }});
                            
                            console.log(`âœ… Not ve birim kaydedildi: ${{yeniNot}} - ${{birim}}`);
                            
                            // ğŸ‘‡ Not giriÅŸ kutusu yeniden baÄŸlantÄ±landÄ±rÄ±lÄ±yor
                            setTimeout(() => {{
                                bindNoteInput(info.path);
                            }}, 10);
                        }};
                    }}
                    
                    // Koordinat radio butonunu dinle
                    if (koordinatRadio) {{
                        koordinatRadio.onchange = function() {{
                            if (this.checked) {{
                                noteInput.value = "KoordinatÄ± deÄŸiÅŸecek";
                                
                                // Cbs'yi otomatik seÃ§
                                const cbsRadio = document.querySelector(`#cbs-${{encoded}}`);
                                if (cbsRadio) {{
                                    cbsRadio.checked = true;
                                }}
                            }}
                        }};
                    }}
                    
                    // Not deÄŸiÅŸtiÄŸinde Koordinat butonunu gÃ¼ncelle
                    if (noteInput) {{
                        noteInput.oninput = function() {{
                            if (koordinatRadio && this.value.includes("KoordinatÄ± deÄŸiÅŸecek")) {{
                                koordinatRadio.checked = true;
                                
                                // Cbs'yi otomatik seÃ§
                                const cbsRadio = document.querySelector(`#cbs-${{encoded}}`);
                                if (cbsRadio) {{
                                    cbsRadio.checked = true;
                                }}
                            }}
                        }};
                    }}
                }}
            }}

            function decodeID(encoded) {{
                try {{
                    // encodeID'de yapÄ±lan iÅŸlemin tersi
                    let safe = encoded.replace(/_/g, '/').replace(/-/g, '+');
                    // Base64 decode iÃ§in padding ekle
                    while (safe.length % 4) {{
                        safe += '=';
                    }}
                    return decodeURIComponent(atob(safe));
                }} catch (e) {{
                    console.error("Decode hatasÄ±:", e);
                    return encoded;
                }}
            }}

            function getPhotoPopupHTML(path, note, birim="") {{
                const encoded = encodeID(path);
                
                // ğŸ”¥ Radio buton durumlarÄ±
                const aobChecked = birim === "Cbs" ? "" : "checked";
                const cbsChecked = birim === "Cbs" ? "checked" : "";
                const koordinatChecked = note && note.includes("KoordinatÄ± deÄŸiÅŸecek") ? "checked" : "";
                
                return `
                    <div style='width: 300px; max-width: 90%; line-height: 1.2;'>
                        <b style="word-break: break-all; font-size: 12px; margin: 0; display: block;">${{path}}</b>
                        <img src='${{path}}' style='width: 100%; max-width: 280px; border-radius: 3px; box-shadow: 0 0 3px #0002; margin: 2px 0; display: block;'>
                        
                        <div style="margin: 3px 0 2px 0;">
                            <label style="font-size: 12px; font-weight: bold; margin: 0; display: block;">ğŸ“ Not:</label>
                            <textarea id="note-input-${{encoded}}" 
                                      style="width: 95%; max-width: 280px; 
                                             padding: 4px;
                                             margin-top: 2px;
                                             border: 1px solid #ccc;
                                             border-radius: 2px;
                                             font-size: 12px;
                                             line-height: 1.3;" 
                                      rows="2">${{note || ""}}</textarea>
                        </div>
                        
                        <!-- ğŸ”¥ KOORDÄ°NAT SEÃ‡ENEÄÄ° -->
                        <div style="margin: 2px 0; font-size: 12px;">
                            <input type="radio" id="koordinat-${{encoded}}" ${{koordinatChecked}} style="margin: 0 3px 0 0;">
                            <label for="koordinat-${{encoded}}" style="margin: 0;">KoordinatÄ± deÄŸiÅŸecek</label>
                        </div>
                        
                        <!-- ğŸ”¥ AOB/CBS SEÃ‡Ä°MÄ° -->
                        <div style="margin: 3px 0; font-size: 12px;">
                            <label style="font-weight: bold; margin: 0; display: block;">Birim SeÃ§:</label>
                            <div style="margin-top: 2px;">
                                <input type="radio" id="aob-${{encoded}}" name="birim-${{encoded}}" value="Aob" ${{aobChecked}} style="margin: 0 3px 0 0;">
                                <label for="aob-${{encoded}}" style="margin: 0 8px 0 0;">Aob</label>
                                
                                <input type="radio" id="cbs-${{encoded}}" name="birim-${{encoded}}" value="Cbs" ${{cbsChecked}} style="margin: 0 3px 0 0;">
                                <label for="cbs-${{encoded}}" style="margin: 0;">Cbs</label>
                            </div>
                        </div>
                        
                        <button id="note-save-${{encoded}}" 
                                style="background-color: #007bff; 
                                       color: white; 
                                       border: none; 
                                       padding: 5px 10px; 
                                       border-radius: 2px; 
                                       cursor: pointer;
                                       font-size: 12px;
                                       margin-top: 3px;
                                       display: block;">
                            ğŸ’¾ Kaydet
                        </button>
                    </div>
                `;
            }}

    """

    # âœ… GERÃ‡EK ZAMANLI KONUM TAKÄ°BÄ°
    realtime_tracking = """
            setInterval(function() {
                photoInfo.forEach(p => {
                    if (p.marker) {
                        const pos = p.marker.getLatLng();
                        p.lat = pos.lat;
                        p.lon = pos.lng;
                    }
                });
            }, 50);
    """

    # Photo marker'larÄ±nÄ± oluÅŸtur
    photo_markers = ""
    if photo_data:
        for path, lat, lon, tarih in photo_data:
            abs_path = path.replace("\\", "/")
            photo_markers += f"""
                (function() {{
                    var fotoPath = "{abs_path}";
                    var note = "";
                    var marker = L.marker([{lat}, {lon}], {{
                        draggable: true,
                        icon: L.divIcon({{
                            className: 'photo-marker photo-mavi',
                            iconSize: [13, 13]
                        }})
                    }});

                    // ğŸ”¥ CRITICAL FIX: Popup'Ä± baÄŸla (Ã¶nce boÅŸ bir popup)
                    marker.bindPopup("<div>YÃ¼kleniyor...</div>");

                    // ğŸ”¥ Ã‡Ä°FT TIK EVENT'Ä° - EN YAKIN DÄ°REÄE ATA
                    marker.on("dblclick", function(e) {{
                        e.originalEvent.preventDefault();
                        e.originalEvent.stopPropagation();
                        
                        var pos = e.target.getLatLng();
                        var hedefDirek = null;
                        var enKisaMesafe = Infinity;

                        direkler.forEach(function(d) {{
                            var mesafe = map.distance(pos, L.latLng(d.lat, d.lon));
                            if (mesafe < 40 && mesafe < enKisaMesafe) {{
                                hedefDirek = d;
                                enKisaMesafe = mesafe;
                            }}
                        }});

                        if (hedefDirek) {{
                            var zatenVar = hedefDirek.photos.some(p => p.path === fotoPath);
                            if (zatenVar) {{
                                console.log("â›” AynÄ± fotoÄŸraf zaten bu direÄŸe eklenmiÅŸ.");
                                L.popup()
                                    .setLatLng(pos)
                                    .setContent("â›” AynÄ± fotoÄŸraf zaten bu direÄŸe eklenmiÅŸ")
                                    .openOn(map);
                                return;
                            }}

                            // Not bilgisini photoInfo'dan Ã§ek
                            const dosyaAdi = fotoPath.split('/').pop().toLowerCase();
                            const foto = photoInfo.find(p => p.path.split('/').pop().toLowerCase() === dosyaAdi);
                            const notDegeri = foto?.note || "";
                            const kategori = foto?.kategori || "";
                            const oncelik = foto?.oncelik || "Bekleyebilir";
                            const birim = foto?.birim || "Aob";

                            hedefDirek.photos.push({{
                                path: fotoPath,
                                note: notDegeri,
                                kategori: kategori,
                                oncelik: oncelik,
                                birim: birim
                            }});

                            if (typeof hedefDirek.numara === 'undefined' || hedefDirek.numara === null) {{
                                const kullanÄ±lanNumaralar = direkler
                                    .filter(d => typeof d.numara === 'number')
                                    .map(d => d.numara);
                                let yeniNumara = 1;
                                while (kullanÄ±lanNumaralar.includes(yeniNumara)) {{
                                    yeniNumara++;
                                }}
                                hedefDirek.numara = yeniNumara;
                                console.log(`Yeni numara atandÄ±: ${{yeniNumara}}`);
                                // ğŸ”¢ Numara atandÄ±ÄŸÄ±nda gÃ¶rÃ¼nÃ¼mÃ¼ gÃ¼ncelle
                                guncelleDirekNumaraGorunumu(hedefDirek);
                            }}

                            guncellePopup(hedefDirek);
                            map.removeLayer(marker);
                            
                            // KullanÄ±cÄ±ya bilgi ver
                            var successPopup = L.popup()
                                .setLatLng(pos)
                                .setContent("âœ… En yakÄ±n direÄŸe eklendi: " + hedefDirek.id)
                                .openOn(map);

                            setTimeout(function() {{
                                map.closePopup(successPopup);
                            }}, 750);
                            
                        }} else {{
                            L.popup()
                                .setLatLng(pos)
                                .setContent("âš ï¸ 40 metre iÃ§inde direk bulunamadÄ±")
                                .openOn(map);
                        }}
                    }});

                    marker.on("popupopen", function() {{
                        const foto = photoInfo.find(p => {{
                            const fileName = fotoPath.split('/').pop().toLowerCase();
                            const pFile = p.path.split('/').pop().toLowerCase();
                            return pFile === fileName;
                        }});
                        const guncelNote = foto?.note || "";
                        const guncelBirim = foto?.birim || "";
                        
                        marker.setPopupContent(getPhotoPopupHTML(fotoPath, guncelNote, guncelBirim));
                        bindNoteInput(fotoPath);
                    }});

                    marker.on("dragend", function(e) {{
                        var pos = e.target.getLatLng();
                        var hedefDirek = null;
                        var enKisaMesafe = Infinity;

                        direkler.forEach(function(d) {{
                            var mesafe = map.distance(pos, L.latLng(d.lat, d.lon));
                            if (mesafe < 8 && mesafe < enKisaMesafe) {{
                                hedefDirek = d;
                                enKisaMesafe = mesafe;
                            }}
                        }});

                        if (hedefDirek) {{
                            var zatenVar = hedefDirek.photos.some(p => p.path === fotoPath);
                            if (zatenVar) {{
                                console.log("â›” AynÄ± fotoÄŸraf zaten bu direÄŸe eklenmiÅŸ.");
                                return;
                            }}

                            // âœ… NOT bilgisini photoInfo'dan Ã§ek
                            const dosyaAdi = fotoPath.split('/').pop().toLowerCase();
                            const foto = photoInfo.find(p => p.path.split('/').pop().toLowerCase() === dosyaAdi);
                            const notDegeri = foto?.note || "";

                            hedefDirek.photos.push({{ path: fotoPath, note: notDegeri }});

                            if (typeof hedefDirek.numara === 'undefined' || hedefDirek.numara === null) {{
                                const kullanÄ±lanNumaralar = direkler
                                    .filter(d => typeof d.numara === 'number')
                                    .map(d => d.numara);
                                let yeniNumara = 1;
                                while (kullanÄ±lanNumaralar.includes(yeniNumara)) {{
                                    yeniNumara++;
                                }}
                                hedefDirek.numara = yeniNumara;
                                console.log(`Yeni numara atandÄ±: ${{yeniNumara}}`);
                                // ğŸ”¢ Numara atandÄ±ÄŸÄ±nda gÃ¶rÃ¼nÃ¼mÃ¼ gÃ¼ncelle
                                guncelleDirekNumaraGorunumu(hedefDirek);
                            }}

                            guncellePopup(hedefDirek);
                            map.removeLayer(marker);
                        }}
                    }});

                    photoInfo.push({{
                        path: fotoPath,
                        lat: marker.getLatLng().lat,
                        lon: marker.getLatLng().lng,
                        originalLat: {lat},
                        originalLon: {lon},
                        note: note,
                        birim: "Aob",
                        marker: marker,
                        edited: false,
                        tarih: "{tarih or ''}",
                        kategori: "",
                        oncelik: "Bekleyebilir"
                    }});

                    map.addLayer(marker);
                }})();
            """

    # Direk marker'larÄ±nÄ± oluÅŸtur (direk_data boÅŸsa boÅŸ string)
    direk_markers = ""
    if direk_data:
        direk_markers += """
            var canvasRenderer = L.canvas({ padding: 0.5, tolerance: 10 });
            var direkLayer = L.layerGroup();

            var direk_data = [
        """

        for d in direk_data:
            direk_markers += f"""
                {{
                    id: "{d['id']}",
                    tip: "{d['tip']}",
                    lat: {d['lat']},
                    lon: {d['lon']},
                    musterek: {str(d.get('musterek', False)).lower()}
                }},
            """

        direk_markers += """
            ];

            direk_data.forEach(function(d) {
                var renk_katman = d.musterek ? "#0000ff" : "#ff0000";
                var dolgu_renk = d.musterek ? "#66ccff" : "#ff6666";

                // ğŸ”¥ DEÄÄ°ÅÄ°KLÄ°K: Draggable Ã¶zelliÄŸini koÅŸullu yap
                var marker = L.circleMarker([d.lat, d.lon], {
                    renderer: canvasRenderer,
                    radius: 7,
                    color: renk_katman,
                    weight: 1,
                    fillColor: dolgu_renk,
                    fillOpacity: 0.9,
                    draggable: false  // ğŸ”¥ BaÅŸlangÄ±Ã§ta false, koordinat deÄŸiÅŸecek seÃ§ilince true olacak
                });

                marker.on("dragstart", function(e) {
                    const direk = direkler.find(dir => dir.marker === marker);
                    if (!direk || !direk.koordinat_degisecek_mi) {
                        e.target.dragging.disable();
                    }
                });

                marker.on("dragend", function(e) {
                    const direk = direkler.find(dir => dir.marker === marker);
                    if (!direk || !direk.koordinat_degisecek_mi) return;
                    
                    const yeniPos = e.target.getLatLng();
                    direk.lat = yeniPos.lat;
                    direk.lon = yeniPos.lng;
                    
                    guncellePopup(direk, true);
                    
                    L.popup()
                        .setLatLng(yeniPos)
                        .setContent("âœ… Direk konumu gÃ¼ncellendi:<br>Enlem: " + yeniPos.lat.toFixed(6) + "<br>Boylam: " + yeniPos.lng.toFixed(6))
                        .openOn(map);
                    
                    console.log("ğŸ“ Direk " + direk.id + " konumu gÃ¼ncellendi:", yeniPos.lat, yeniPos.lng);
                });

                direkler.push({
                    id: d.id,
                    tip: d.tip,
                    lat: d.lat,
                    lon: d.lon,
                    marker: marker,
                    photos: [],
                    musterek: d.musterek,
                    numara: null,
                    numaraLabelMarker: null,
                    silinecek_mi: false,
                    koordinat_degisecek_mi: false,
                    konum_degistirme_modu: false
                });

                guncellePopup(direkler[direkler.length - 1]);
                direkLayer.addLayer(marker);
            });

            direkLayer.addTo(map);
        """

    html_end = """
        </script>
    </body>
    </html>
    """

    html_end = """
        </script>
    </body>
    </html>
    """

    # TÃ¼m HTML parÃ§alarÄ±nÄ± birleÅŸtir
    full_html = html_start + realtime_tracking + photo_markers + direk_markers + html_end

    with open(save_path, "w", encoding="utf-8") as f:
        f.write(full_html)

    print(f"âœ… Harita kaydedildi: {save_path}")

    
def uri_to_path(uri):
    if uri.startswith("file:///"):
        parsed = urlparse(uri)
        return unquote(parsed.path.lstrip("/"))
    return uri
    
def oku_direkler(excel_yolu):
    direk_listesi = []
    try:
        wb = load_workbook(excel_yolu, data_only=True)
        ws = wb.active

        for row in ws.iter_rows(min_row=2):  # BaÅŸlÄ±k satÄ±rÄ±nÄ± atla
            direk_id = str(row[1].value).strip()   # B sÃ¼tunu
            tip = str(row[2].value).strip()        # C sÃ¼tunu
            lat = row[5].value                     # F sÃ¼tunu
            lon = row[6].value                     # G sÃ¼tunu

            if lat and lon:
                direk_listesi.append({
                    "id": direk_id,
                    "tip": tip,
                    "lat": float(lat),
                    "lon": float(lon)
                })
    except Exception as e:
        print(f"âŒ Direk verisi okunamadÄ±: {e}")
    return direk_listesi

def oku_direkler_musterek(excel_yolu):
    musterek_listesi = []
    try:
        wb = load_workbook(excel_yolu, data_only=True)
        ws = wb.active

        for row in ws.iter_rows(min_row=2):  # BaÅŸlÄ±k atlanÄ±yor
            direk_id = str(row[1].value).strip()   # B sÃ¼tunu
            tip = str(row[2].value).strip()        # C sÃ¼tunu
            lat = row[5].value                     # F sÃ¼tunu
            lon = row[6].value                     # G sÃ¼tunu

            if lat and lon:
                musterek_listesi.append({
                    "id": direk_id,
                    "tip": tip,
                    "lat": float(lat),
                    "lon": float(lon),
                    "musterek": True  # ğŸ’¡ ayÄ±rt edebilmek iÃ§in iÅŸaret ekliyoruz
                })
    except Exception as e:
        print(f"âŒ MÃ¼ÅŸterek direk verisi okunamadÄ±: {e}")
    return musterek_listesi

class FotoEditorViewer(QMainWindow):
    def __init__(self, foto_yollari, view=None, parent=None):
        super().__init__(parent)
        self.editor_viewer = parent
        self.view = view
        self.setWindowTitle("ğŸ–¼ï¸ FotoÄŸraf EditÃ¶r")
        self.setMinimumSize(1000, 800)
        self.setFocusPolicy(Qt.FocusPolicy.StrongFocus)
        self.setFocus()

        # ğŸ”¥ Foto verisini path+note ÅŸeklinde tutuyoruz
        self.fotolar = foto_yollari  # ArtÄ±k not iÃ§eren dict'ler geliyor
        for foto in self.fotolar:
            foto.setdefault("oncelik", "Bekleyebilir")  # VarsayÄ±lan Ã¶nem derecesi
        self.index = 0  

        central_widget = QWidget()
        self.setCentralWidget(central_widget)
        self.layout = QVBoxLayout(central_widget)

        self.canvas_layout = QVBoxLayout()

        # ğŸ–¼ï¸ Ä°lk fotoÄŸraf
        self.canvas = FotoEditorCanvas(self.fotolar[self.index]["path"], parent=self)
        self.canvas_layout.addWidget(self.canvas)

        # SaÄŸ alt kÃ¶ÅŸeye transparan Ã¶ncelik widget'Ä± oluÅŸtur
        self.oncelik_widget = QFrame(self)
        self.oncelik_widget.setFixedSize(160, 140)
        self.oncelik_widget.setStyleSheet("""
            background-color: rgba(255, 255, 255, 180);
            border-radius: 8px;
            border: 1px solid rgba(0,0,0,50);
        """)

        # BaÅŸlÄ±k label
        baslik_label = QLabel("Ã–ncelik:", self.oncelik_widget)
        baslik_label.move(10, 10)
        baslik_label.setStyleSheet("font-weight: bold; font-size:13px; color:black;")

        # Radio butonlar oluÅŸtur
        self.oncelik_grup = QButtonGroup(self.oncelik_widget)
        self.oncelik_secenekleri = ["Bekleyebilir", "Normal", "Acil", "Ã‡ok Acil"]

        for i, secenek in enumerate(self.oncelik_secenekleri):
            rb = QRadioButton(secenek, self.oncelik_widget)
            rb.move(10, 35 + i*22)
            rb.setStyleSheet("color:black;")
            self.oncelik_grup.addButton(rb, id=i)
            rb.toggled.connect(self.onceligi_kaydet)
        self.oncelik_widget.show()

        # ğŸ“Œ Ä°ÅŸte istediÄŸin kÄ±sÄ±m (Elle ayarlanabilir alt mesafe):
        alt_mesafe = 80  # âš ï¸ Bunu istediÄŸin gibi artÄ±rÄ±p azaltabilirsin.

        def oncelik_widget_yerlestir():
            margin_x = 15  # SaÄŸdan boÅŸluk
            x = self.width() - self.oncelik_widget.width() - margin_x
            y = self.height() - self.oncelik_widget.height() - alt_mesafe
            self.oncelik_widget.move(x, y)

        # Ä°lk yerleÅŸimi yap
        oncelik_widget_yerlestir()

        # Resize olduÄŸunda yeniden yerleÅŸsin
        self.resizeEvent = lambda event: oncelik_widget_yerlestir()

        # Toolbar (Butonlar)
        self.toolbar_layout = QHBoxLayout()
        self.toolbar_layout.addWidget(self._btn("â¬…ï¸", self.onceki_foto))
        self.toolbar_layout.addWidget(self._btn("â¡ï¸", self.sonraki_foto))
        self.toolbar_layout.addWidget(self._btn("âœï¸ Ã‡iz", lambda: self.canvas.set_tool("draw")))
        self.toolbar_layout.addWidget(self._btn("ğŸ“ YazÄ±", lambda: self.canvas.set_tool("text")))
        self.toolbar_layout.addWidget(self._btn("ğŸ–ï¸ TaÅŸÄ±", lambda: self.canvas.set_tool("pan")))
        self.toolbar_layout.addWidget(self._btn("â†©ï¸ Geri Al", self.canvas.undo))
        self.toolbar_layout.addWidget(self._btn("ğŸ’¾ Kaydet", self.canvas.kaydet))

        # âœï¸ KalÄ±nlÄ±k input
        self.thickness_input = QSpinBox()
        self.thickness_input.setRange(1, 100)
        self.thickness_input.setValue(15)
        self.thickness_input.valueChanged.connect(lambda val: setattr(self.canvas, 'pen_thickness', val))
        self.toolbar_layout.addWidget(QLabel("KalÄ±nlÄ±k:"))
        self.toolbar_layout.addWidget(self.thickness_input)

        # ğŸ”  YazÄ± boyutu input
        self.yazi_boyutu_input = QSpinBox()
        self.yazi_boyutu_input.setRange(8, 200)
        self.yazi_boyutu_input.setValue(120)
        self.yazi_boyutu_input.valueChanged.connect(lambda val: setattr(self.canvas, 'yazi_boyutu', val))
        self.canvas.yazi_boyutu = self.yazi_boyutu_input.value()
        self.toolbar_layout.addWidget(QLabel("YazÄ± Boyutu:"))
        self.toolbar_layout.addWidget(self.yazi_boyutu_input)

        # ğŸ¨ Renk butonu
        renk_btn = QPushButton("ğŸ¨ Renk")
        renk_btn.clicked.connect(self.renk_sec)
        renk_btn.setFocusPolicy(Qt.FocusPolicy.NoFocus)
        renk_btn.setAutoDefault(False)
        renk_btn.setDefault(False)
        self.toolbar_layout.addWidget(renk_btn)

        # ğŸ“‹ ComboBox
        self.comboBox = QComboBox()
        self.comboBox.addItems([
            "Kategori SeÃ§in",
            "a- Direk KÄ±rÄ±k/Ã‡atlak/Ã‡Ã¼rÃ¼k",
            "b- Travers veya Konsol KÄ±rÄ±k/EÄŸri",
            "c- Ä°zolatÃ¶r KÄ±rÄ±k/Ã‡atlak",
            "d- AÄŸaÃ§ veya Bitki TemasÄ±/Tehlikesi var.",
            "e- SÄ±kÄ±baÄŸ kopuk veya yenilenmesi gerekiyor",
            "f- Sehim alÄ±nmasÄ± gerekiyor",
            "g- Trafoda yaÄŸ kaÃ§aÄŸÄ± mevcut",
            "h- OG Sigorta yerine tel sarÄ±lÄ±",
            "i- DiÄŸer"
        ])
        self.comboBox.currentIndexChanged.connect(self.kaydet_kategori)
        self.toolbar_layout.addWidget(self.comboBox)

        # Not giriÅŸi
        self.note_input = QLineEdit()
        not_yazisi = self.fotolar[self.index].get("note", "")
        self.note_input.setText(not_yazisi)
        self.note_input.textChanged.connect(self._notu_kaydet)
        self.note_input.setPlaceholderText("ğŸ“ FotoÄŸraf notu...")
        self.note_input.setMinimumHeight(32)
        self.note_input.setStyleSheet("font-size: 14px; padding: 6px;")
        self.note_input.returnPressed.connect(self.note_input.clearFocus)

        # Toolbar ve not alanÄ±
        self.toolbar_full_layout = QVBoxLayout()
        self.toolbar_full_layout.addLayout(self.toolbar_layout)
        
        self.toolbar_full_layout.addWidget(self.note_input)

        self.canvas_layout.addLayout(self.toolbar_full_layout)
        self.layout.addLayout(self.canvas_layout)
        self._yeniden_yukle()
        
    def _btn(self, text, func):
        btn = QPushButton(text)
        btn.clicked.connect(func)
        btn.setFocusPolicy(Qt.FocusPolicy.NoFocus)  # ğŸ”¥ Fokus kapalÄ±
        btn.setAutoDefault(False)
        btn.setDefault(False)
        return btn

    def renk_sec(self):
        color = QColorDialog.getColor()
        if color.isValid():
            self.canvas.pen_color = color

    def sonraki_foto(self):
        if self.index < len(self.fotolar) - 1:
            self.index += 1
            self._yeniden_yukle()

    def onceki_foto(self):
        if self.index > 0:
            self.index -= 1
            self._yeniden_yukle()

    def _yeniden_yukle(self):
        # Eski canvas'Ä± kaldÄ±r
        self.canvas_layout.removeWidget(self.canvas)
        self.canvas.deleteLater()

        # Yeni canvas'Ä± oluÅŸtur
        self.canvas = FotoEditorCanvas(self.fotolar[self.index]["path"], parent=self)
        not_yazisi = self.fotolar[self.index].get("note", "")
        self.note_input.setText(not_yazisi)
        self.canvas.pen_thickness = self.thickness_input.value()
        self.canvas.yazi_boyutu = self.yazi_boyutu_input.value()
        self.canvas.pen_color = self.canvas.pen_color

        self.canvas_layout.insertWidget(0, self.canvas)

        # ComboBox'Ä± gÃ¼ncelle:
        kategori = self.fotolar[self.index].get("kategori", "")
        if kategori:
            self.comboBox.setCurrentText(kategori)
        else:
            self.comboBox.setCurrentIndex(0)  # Kategori SeÃ§in gÃ¶sterilir

        # Toolbar baÄŸlantÄ±larÄ± yeniden
        self.toolbar_layout.itemAt(2).widget().clicked.connect(lambda: self.canvas.set_tool("draw"))
        self.toolbar_layout.itemAt(3).widget().clicked.connect(lambda: self.canvas.set_tool("text"))
        self.toolbar_layout.itemAt(4).widget().clicked.connect(lambda: self.canvas.set_tool("pan"))
        self.toolbar_layout.itemAt(5).widget().clicked.connect(self.canvas.undo)
        self.toolbar_layout.itemAt(6).widget().clicked.connect(self.canvas.kaydet)

        self.thickness_input.valueChanged.connect(lambda val: setattr(self.canvas, 'pen_thickness', val))
        self.yazi_boyutu_input.valueChanged.connect(lambda val: setattr(self.canvas, 'yazi_boyutu', val))

        # âœ… Ã–ncelik seÃ§imini yÃ¼kle (sadece bu kÄ±smÄ± ekliyorsun)
        foto_oncelik = self.fotolar[self.index].get("oncelik", "Bekleyebilir")
        for buton in self.oncelik_grup.buttons():
            if buton.text() == foto_oncelik:
                buton.setChecked(True)
                break
            
    def onceligi_kaydet(self):
        secilen_buton = self.oncelik_grup.checkedButton()
        if secilen_buton:
            secilen_oncelik = secilen_buton.text()
            self.fotolar[self.index]["oncelik"] = secilen_oncelik

            # âœ… JavaScript tarafÄ±ndaki photoInfo dizisine de yaz
            if self.view:
                js_kod = f"""
                (function() {{
                    var dosyaAdi = "{os.path.basename(self.fotolar[self.index]['path']).lower()}";
                    var oncelik = "{secilen_oncelik}";
                    var foto = photoInfo.find(p => p.path.split('/').pop().split('\\\\').pop().toLowerCase() === dosyaAdi);
                    if (foto) {{
                        foto.oncelik = oncelik;
                    }}
                }})();
                """
                self.view.page().runJavaScript(js_kod)

    def keyPressEvent(self, event):
        if event.key() == Qt.Key.Key_Right:
            self.sonraki_foto()
        elif event.key() == Qt.Key.Key_Left:
            self.onceki_foto()
        else:
            event.ignore()

    def update_marker_color(self, image_path):
        parent = self.parent()
        if not parent or not hasattr(parent, "view"):
            return

        js_path = image_path.replace("\\", "/")
        js = f"""
            (function() {{
                const photo = photoInfo.find(p => p.path === "{js_path}");
                if (photo && photo.marker && photo.marker._icon) {{
                    photo.edited = true;
                    const el = photo.marker._icon;
                    el.classList.remove("photo-mavi");
                    el.classList.add("photo-turkuaz");
                }}
            }})();
        """
        parent.view.page().runJavaScript(js)

    def _notu_kaydet(self, yeni_not):
        if 0 <= self.index < len(self.fotolar):
            self.fotolar[self.index]["note"] = yeni_not
            
        if self.view:
            file_name = os.path.basename(self.fotolar[self.index]["path"]).lower()
            js = f"""
            (function() {{
                const fileName = "{file_name}";
                const p = photoInfo.find(p => {{
                    const pName = p.path.split('/').pop().split('\\\\').pop().toLowerCase();
                    return pName === fileName;
                }});
                if (p) {{
                    p.note = `{yeni_not}`;
                }}

                // AyrÄ±ca direÄŸe iliÅŸtirilmiÅŸse onun notunu da gÃ¼ncelle
                direkler.forEach(d => {{
                    if (d.photos) {{
                        d.photos.forEach(f => {{
                            const pName = f.path.split('/').pop().split('\\\\').pop().toLowerCase();
                            if (pName === fileName) {{
                                f.note = `{yeni_not}`;
                            }}
                        }});
                    }}
                }});
            }})();
            """
            self.view.page().runJavaScript(js)
            self.view.page().runJavaScript("guncellePopuplar();")

    def kaydet_kategori(self):
        kategori = self.comboBox.currentText()
        if kategori == "Kategori SeÃ§in":
            self.fotolar[self.index]["kategori"] = ""
        else:
            self.fotolar[self.index]["kategori"] = kategori

        # JavaScript tarafÄ±na da gÃ¶nderelim
        js_kod = f"""
        (function(){{
            var dosyaAdi = "{os.path.basename(self.fotolar[self.index]['path']).lower()}";
            var kategori = "{kategori if kategori != 'Kategori SeÃ§in' else ''}";
            var foto = photoInfo.find(p => p.path.split('/').pop().split('\\\\').pop().toLowerCase() === dosyaAdi);
            if(foto) foto.kategori = kategori;
        }})();
        """
        self.view.page().runJavaScript(js_kod)

class FotoEditorCanvas(QWidget):
    def __init__(self, image_path, parent=None):
        super().__init__(parent)
        self.image_path = image_path
        self.editor_viewer = parent
        self.original_pixmap = QPixmap(image_path)
        self.display_pixmap = self.original_pixmap.copy()
        self.setMinimumSize(800, 600)

        self.pen_color = QColor("red")
        self.pen_thickness = 15
        self.current_tool = "pan"
        self.yazi_kutusu = None
        self.yazi_kutusu_pos = None
        self.yazi_boyutu = 120

        self.drawings = []
        self.texts = []
        self.undo_stack = []

        self.last_pos = None
        self.panning = False
        self.offset = QPoint(0, 0)
        self.temp_offset = QPoint(0, 0)
        self.scale_factor = 1.0

    def _calculate_initial_scale(self):
        if self.original_pixmap.isNull():
            return

        view_width = self.width()
        pixmap_width = self.original_pixmap.width()

        self.scale_factor = view_width / pixmap_width

        self.offset = QPoint(0, 0)
        self.temp_offset = QPoint(0, 0)

    def resizeEvent(self, event):
        super().resizeEvent(event)
        self._calculate_initial_scale()
        self.update()

    def set_tool(self, tool):
        self.current_tool = tool

    def paintEvent(self, event):
        painter = QPainter(self)
        painter.translate(self.offset + self.temp_offset)
        painter.scale(self.scale_factor, self.scale_factor)
        painter.drawPixmap(0, 0, self.display_pixmap)

        for start, end, color, thickness in self.drawings:
            painter.setPen(QPen(color, thickness))
            painter.drawLine(start, end)

        for pos, text, color in self.texts:
            painter.setPen(QPen(color))
            painter.setFont(QFont("Arial", self.yazi_boyutu))
            painter.drawText(pos, text)

    def mousePressEvent(self, event):
        if event.button() == Qt.MouseButton.LeftButton:
            pos = (event.pos() - self.offset - self.temp_offset) / self.scale_factor
            self.last_pos = pos

            if self.current_tool == "pan":
                self.panning = True

            elif self.current_tool == "text":
                if self.yazi_kutusu and self.yazi_kutusu.isVisible():
                    self.yazi_kutusu.setFocus()
                    return

                self.yazi_kutusu_pos = pos
                self.yazi_kutusu = QLineEdit(self)
                self.yazi_kutusu.setFont(QFont("Arial", self.yazi_boyutu))  # âœ… Dinamik yazÄ± boyutu
                self.yazi_kutusu.setStyleSheet(f"""
                    color: {self.pen_color.name()};
                    background-color: rgba(255, 255, 255, 0);
                    border: none;
                """)
                self.yazi_kutusu.resize(200, 30)
                global_pos = self.offset + self.temp_offset + pos * self.scale_factor
                self.yazi_kutusu.move(int(global_pos.x()), int(global_pos.y()))
                self.yazi_kutusu.returnPressed.connect(self.yazi_onayla)
                self.yazi_kutusu.show()
                self.yazi_kutusu.setFocus()

    def mouseMoveEvent(self, event):
        if self.current_tool == "pan" and self.last_pos:
            delta = event.pos() - self.last_pos * self.scale_factor - self.offset
            self.temp_offset = delta
            self.update()
            return

        if self.current_tool == "draw" and event.buttons() & Qt.MouseButton.LeftButton and self.last_pos:
            current_pos = (event.pos() - self.offset - self.temp_offset) / self.scale_factor
            segment = (self.last_pos, current_pos, self.pen_color, self.pen_thickness)
            self.drawings.append(segment)
            self.undo_stack.append(("draw", segment))
            self.last_pos = current_pos
            self.update()

    def mouseReleaseEvent(self, event):
        if event.button() == Qt.MouseButton.LeftButton:
            self.last_pos = None
            self.offset += self.temp_offset
            self.temp_offset = QPoint(0, 0)
            self.panning = False
            self.update()

    def wheelEvent(self, event):
        angle = event.angleDelta().y()
        zoom_factor = 1.25 if angle > 0 else 0.8

        mouse_pos = event.position()
        offset = QPointF(self.offset)
        temp_offset = QPointF(self.temp_offset)

        before_scale = (mouse_pos - offset - temp_offset) / self.scale_factor
        self.scale_factor *= zoom_factor
        after_scale = before_scale * self.scale_factor
        new_offset = mouse_pos - after_scale
        self.offset = new_offset.toPoint()
        self.update()

    def yazi_onayla(self):
        if not self.yazi_kutusu:
            return

        text = self.yazi_kutusu.text().strip()
        if text and self.yazi_kutusu_pos is not None:
            pos = QPointF(self.yazi_kutusu_pos)
            self.texts.append((pos, text, self.pen_color))  # Boyut zaten self.yazi_boyutu'dan alÄ±nÄ±r
            self.undo_stack.append(("text", (pos, text, self.pen_color)))
            self.update()

        self.yazi_kutusu.deleteLater()
        self.yazi_kutusu = None
        self.yazi_kutusu_pos = None

    def undo(self):
        if not self.undo_stack:
            return
        action, value = self.undo_stack.pop()
        if action == "draw" and value in self.drawings:
            self.drawings.remove(value)
        elif action == "text" and value in self.texts:
            self.texts.remove(value)
        self.update()

    def kaydet(self):
        try:
            pil_img = Image.open(self.image_path)
            exif_bytes = piexif.dump(piexif.load(pil_img.info.get("exif", b"")))
        except Exception:
            exif_bytes = None

        final_image = QImage(self.original_pixmap.size(), QImage.Format.Format_RGB32)
        final_image.fill(Qt.GlobalColor.white)

        painter = QPainter(final_image)
        painter.drawPixmap(0, 0, self.original_pixmap)

        for start, end, color, thickness in self.drawings:
            painter.setPen(QPen(color, thickness))
            painter.drawLine(start, end)

        for pos, text, color in self.texts:
            painter.setPen(QPen(color))
            painter.setFont(QFont("Arial", self.yazi_boyutu))
            painter.drawText(pos, text)

        painter.end()

        pil_final = ImageQt.fromqimage(final_image)

        try:
            if exif_bytes:
                pil_final.save(self.image_path, exif=exif_bytes)
            else:
                pil_final.save(self.image_path)

            QMessageBox.information(self, "Kaydedildi", f"âœ… {self.image_path} Ã¼zerine yazÄ±ldÄ±.")

            # Marker rengini gÃ¼ncelle
            if hasattr(self.editor_viewer, "update_marker_color"):
                self.editor_viewer.update_marker_color(self.image_path)

            # Not bilgisini JS tarafÄ±na yansÄ±t ama popup'Ä± zorla aÃ§madan
            if hasattr(self.editor_viewer, "note_input") and hasattr(self.editor_viewer, "view"):
                not_metni = self.editor_viewer.note_input.text().strip()
                if not_metni:
                    js_path = self.image_path.replace("\\", "/")
                    js = f"""
                        (function() {{
                            const photo = photoInfo.find(p => p.path === "{js_path}");
                            if (photo) {{
                                photo.note = `{not_metni}`;
                                if (photo.marker && photo.marker._popup) {{
                                    photo.marker.setPopupContent(getPhotoPopupHTML(photo.path, photo.note));
                                }}
                            }}
                        }})();
                    """
                    self.editor_viewer.view.page().runJavaScript(js)

                # ğŸ› ï¸ Python tarafÄ±nda fotolar listesine kaydet
                if self.editor_viewer:
                    self.editor_viewer.fotolar[self.editor_viewer.index]['note'] = self.editor_viewer.note_input.text().strip()

        except Exception as e:
            QMessageBox.warning(self, "Hata", f"âŒ Kaydedilemedi: {e}")

# -- BAÅLAT --
if __name__ == "__main__":
    app = QApplication(sys.argv)
    window = DroneHarita()
    window.show()
    sys.exit(app.exec())
